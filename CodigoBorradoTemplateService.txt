
async generarNotaUrgencias(datos: any): Promise<any> {
  const pacienteCompleto = datos.pacienteCompleto;
  const medicoCompleto = datos.medicoCompleto;
  const notaUrgenciasData = datos.notaUrgencias || {};
  const signosVitales = datos.signosVitales || {};
  const fechaActual = new Date();

  const documentoFinal = {
    pageSize: 'LETTER',
    pageMargins: [20, 60, 20, 40],
    header: {
      margin: [20, 10, 20, 10],
      table: {
        widths: ['20%', '60%', '20%'],
        body: [
          [
            {
              image: await this.obtenerImagenBase64('/uploads/logos/logo-gobierno-default.svg'),
              fit: [80, 40],
              alignment: 'left',
              margin: [0, 5]
            },
            {
              text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA DE URGENCIAS',
              fontSize: 10,
              bold: true,
              alignment: 'center',
              color: '#1a365d',
              margin: [0, 8]
            },
            {
              image: await this.obtenerImagenBase64('/uploads/logos/logo-principal-default.svg'),
              fit: [80, 40],
              alignment: 'right',
              margin: [0, 5]
            }
          ]
        ]
      },
      layout: 'noBorders',
    },
    content: [
      {
        table: {
          widths: ['15%', '85%'],
          body: [
            [
              {
                text: 'IDENTIFICACIÓN',
                fontSize: 8,
                bold: true,
                fillColor: '#f5f5f5',
                alignment: 'center',
                rowSpan: 6,
              },
              {
                table: {
                  widths: ['20%', '20%', '20%', '20%', '20%'],
                  body: [
                    [
                      { text: 'Fecha de elaboración', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Hora de elaboración', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'No. Expediente', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'No. de cama', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Servicio', fontSize: 7, bold: true, alignment: 'center' }
                    ], [
                      { text: fechaActual.toLocaleDateString('es-MX'), fontSize: 7, alignment: 'center' },
                      { text: fechaActual.toLocaleTimeString('es-MX'), fontSize: 7, alignment: 'center' },
                      { text: this.obtenerNumeroExpedientePreferido(pacienteCompleto.expediente) || 'N/A', fontSize: 7, alignment: 'center', bold: true },
                      { text: notaUrgenciasData.numero_cama || 'NO ASIGNADO', fontSize: 7, alignment: 'center' },
                      { text: medicoCompleto.departamento || 'No especificado', fontSize: 7, alignment: 'center' }
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
            [
              {},
              {
                table: {
                  widths: ['55%', '15%', '15%', '15%'],
                  body: [
                    [
                      { text: 'Nombre completo del paciente', fontSize: 7, bold: true },
                      { text: 'Edad', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Sexo', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Tipo de sangre', fontSize: 7, bold: true, alignment: 'center' }
                    ],
                    [
                      { text: pacienteCompleto.nombre_completo, fontSize: 8, bold: true, margin: [2, 3] },
                      { text: `${pacienteCompleto.edad} años`, fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.sexo, fontSize: 7, alignment: 'center' },
                      { text: datos.pacienteCompleto.tipo_sangre || 'No especificado', fontSize: 7, alignment: 'center', bold: true, color: '#dc2626' }
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
            [
              {},
              {
                table: {
                  widths: ['100%'],
                  body: [
                    [{ text: 'Domicilio del paciente', fontSize: 7, bold: true }],
                    [{ text: this.formatearDireccionMejorada(pacienteCompleto) || 'Sin dirección registrada', fontSize: 7, margin: [2, 3] }]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
            [
              {},
              {
                table: {
                  widths: ['25%', '25%', '25%', '25%'],
                  body: [
                    [
                      { text: 'Fecha nacimiento', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'CURP', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Lugar de nacimiento', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Teléfono', fontSize: 7, bold: true, alignment: 'center' }
                    ],
                    [
                      { text: this.formatearFecha(pacienteCompleto.fecha_nacimiento) || 'No registrada', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.curp || 'No registrado', fontSize: 6, alignment: 'center' },
                      { text: pacienteCompleto.lugar_nacimiento || 'No especificado', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.telefono || 'No registrado', fontSize: 7, alignment: 'center' }
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
            [
              {},
              {
                table: {
                  widths: ['25%', '25%', '25%', '25%'],
                  body: [
                    [
                      { text: 'Ocupación', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Escolaridad', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Estado civil', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Religión', fontSize: 7, bold: true, alignment: 'center' }
                    ],
                    [
                      { text: pacienteCompleto.ocupacion || 'No registrada', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.escolaridad || 'No registrada', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.estado_civil || 'No registrado', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.religion || 'No registrada', fontSize: 7, alignment: 'center' }
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
            [
              {},
              {
                table: {
                  widths: ['60%', '40%'],
                  body: [
                    [
                      { text: 'Familiar responsable/Tutor', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Teléfono de contacto', fontSize: 7, bold: true, alignment: 'center' }
                    ],
                    [
                      { text: pacienteCompleto.familiar_responsable || 'No registrado', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.telefono_familiar || 'No registrado', fontSize: 7, alignment: 'center' }
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
          ]
        }
      },
      { text: '', margin: [0, 15] },
      // 🔹 MOTIVO DE ATENCIÓN
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'MOTIVO DE ATENCIÓN', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Motivo de atención:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.motivo_atencion || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      // 🔹 ESTADO DE CONCIENCIA
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'ESTADO DE CONCIENCIA', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Estado de conciencia:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.estado_conciencia || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      // 🔹 RESUMEN DEL INTERROGATORIO
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'RESUMEN DEL INTERROGATORIO', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Resumen del interrogatorio:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.resumen_interrogatorio || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      // 🔹 EXPLORACIÓN FÍSICA
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'EXPLORACIÓN FÍSICA', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Exploración física:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.exploracion_fisica || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      // 🔹 RESULTADOS DE ESTUDIOS
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'RESULTADOS DE ESTUDIOS', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Resultados de estudios:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.resultados_estudios || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      // 🔹 ESTADO MENTAL
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'ESTADO MENTAL', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Estado mental:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.estado_mental || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      // 🔹 DIAGNÓSTICO
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'DIAGNÓSTICO', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Diagnóstico:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.diagnostico || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      // 🔹 PLAN DE TRATAMIENTO
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'PLAN DE TRATAMIENTO', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Plan de tratamiento:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.plan_tratamiento || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      // 🔹 PRONÓSTICO
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'PRONÓSTICO', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Pronóstico:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.pronostico || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      // 🔹 SIGNOS VITALES
      {
        table: {
          widths: ['25%', '25%', '25%', '25%'],
          body: [
            [
              { text: 'SIGNOS VITALES', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 4 },
              {},
              {},
              {}
            ],
            [
              { text: 'Temperatura (°C)', fontSize: 7, bold: true, alignment: 'center' },
              { text: 'Presión arterial sistólica (mmHg)', fontSize: 7, bold: true, alignment: 'center' },
              { text: 'Presión arterial diastólica (mmHg)', fontSize: 7, bold: true, alignment: 'center' },
              { text: 'Frecuencia cardíaca (lpm)', fontSize: 7, bold: true, alignment: 'center' }
            ],
            [
              { text: signosVitales.temperatura || 'No especificado', fontSize: 7, alignment: 'center' },
              { text: signosVitales.presion_arterial_sistolica || 'No especificado', fontSize: 7, alignment: 'center' },
              { text: signosVitales.presion_arterial_diastolica || 'No especificado', fontSize: 7, alignment: 'center' },
              { text: signosVitales.frecuencia_cardiaca || 'No especificado', fontSize: 7, alignment: 'center' }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      // 🔹 FIRMA DEL MEDICO
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: '__________________________________', fontSize: 7, alignment: 'center' },
              { text: `Firma del médico: ${medicoCompleto.nombre_completo}`, fontSize: 7, alignment: 'center' }
            ]
          ]
        },
        layout: 'noBorders'
      }
    ],
    footer: (currentPage: number, pageCount: number) => {
      return {
        margin: [20, 10],
        table: {
          widths: ['30%', '40%', '30%'],
          body: [
            [
              { text: `Página ${currentPage} de ${pageCount}`, fontSize: 7, color: '#6b7280' },
              { text: 'Nota de Urgencias - SICEG', fontSize: 7, alignment: 'center', color: '#6b7280' },
              { text: fechaActual.toLocaleDateString('es-MX'), fontSize: 7, alignment: 'right', color: '#6b7280' }
            ]
          ]
        },
        layout: 'noBorders'
      };
    }
  };

  return documentoFinal;
}

  // 📄 NOTA DE EVOLUCIÓN  NOM-004-SSA3-2012
  async generarNotaEvolucion(datos: any): Promise<any> {
    console.log('📈 Generando Nota de Evolución según NOM-004...');

    // ✅ CORRECCIÓN: Usar los datos ya preparados
    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const signosVitales = datos.signosVitales;
    const notaEvolucionData = datos.notaEvolucion || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50], //   MÁRGENES OPTIMIZADOS

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA DE EVOLUCIÓN',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        // 🔹 SECCIÓN IDENTIFICACIÓN DEL PACIENTE (NOM-004 5.9)
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIÓN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['18%', '18%', '18%', '18%', '14%', '14%'],
                    body: [
                      [
                        {
                          text: 'Fecha evolución',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora evolución',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. de cama',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Día estancia',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio nota',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: notaEvolucionData.numero_cama || 'Sin asignar',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${datos.diasHospitalizacion}°`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `NE-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['60%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} años`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Servicio hospitalario',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Diagnóstico ingreso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo de sangre',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'No especificado',
                          fontSize: 7,
                          margin: [2, 2],
                        },
                        {
                          text:
                            notaEvolucionData.diagnostico_ingreso ||
                            'Ver expediente',
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.tipo_sangre || 'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['60%', '40%'],
                    body: [
                      [
                        {
                          text: 'Familiar responsable',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Teléfono de contacto',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            pacienteCompleto.familiar_responsable ||
                            'No registrado',
                          fontSize: 7,
                          margin: [2, 2],
                        },
                        {
                          text:
                            pacienteCompleto.telefono_familiar ||
                            'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 NOTA DE EVOLUCIÓN SEGÚN NOM-004 (SECCIÓN 6.2)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'NOTA DE EVOLUCIÓN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'EVOLUCIÓN Y ACTUALIZACIÓN DEL CUADRO CLÍNICO (6.2.1)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.evolucion_analisis ||
                    notaEvolucionData.sintomas_signos ||
                    'Paciente en evolución clínica favorable. Sin cambios significativos en el cuadro clínico inicial.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'SIGNOS VITALES SEGÚN SE CONSIDERE NECESARIO (6.2.2)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Presión arterial',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia cardíaca',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia respiratoria',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Temperatura',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Saturación O2',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            signosVitales.presion_arterial_sistolica || '___'
                          }/${
                            signosVitales.presion_arterial_diastolica || '___'
                          } mmHg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_cardiaca || '___'
                          } lpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_respiratoria || '___'
                          } rpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${signosVitales.temperatura || '___'} °C`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.saturacion_oxigeno || '___'
                          } %`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 2],
                },
              ],
              [
                {},
                {
                  text: 'SOMATOMETRÍA Y ESTADO NUTRICIONAL',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text: `Peso: ${signosVitales.peso || '___'} kg | Talla: ${
                    signosVitales.talla || '___'
                  } cm | Estado nutricional: ${
                    notaEvolucionData.estado_nutricional ||
                    'Adecuado para la edad'
                  }`,
                  fontSize: 7,
                  margin: [5, 3],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 ESTUDIOS Y RESULTADOS (6.2.3)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTUDIOS Y RESULTADOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'RESULTADOS RELEVANTES DE ESTUDIOS DE SERVICIOS AUXILIARES (6.2.3)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.estudios_laboratorio_gabinete ||
                    'Sin estudios nuevos solicitados. Resultados pendientes o no aplicables para la evolución actual.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 EXPLORACIÓN FÍSICA DIRIGIDA
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EXPLORACIÓN FÍSICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'HABITUS EXTERIOR',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.habitus_exterior ||
                    'Paciente consciente, orientado, cooperador. Facies no características, marcha conservada, actitud adecuada.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'EXPLORACIÓN DIRIGIDA POR APARATOS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    `Cardiovascular: ${
                      notaEvolucionData.exploracion_cardiovascular ||
                      'Ruidos cardíacos rítmicos, sin soplos'
                    }\n` +
                    `Respiratorio: ${
                      notaEvolucionData.exploracion_respiratorio ||
                      'Murmullo vesicular presente, sin ruidos agregados'
                    }\n` +
                    `Abdomen: ${
                      notaEvolucionData.exploracion_abdomen ||
                      'Blando, depresible, sin dolor'
                    }\n` +
                    `Neurológico: ${
                      notaEvolucionData.exploracion_neurologico ||
                      'Sin déficit motor ni sensitivo'
                    }`,
                  fontSize: 7,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 DIAGNÓSTICOS Y PROBLEMAS CLÍNICOS (6.2.4)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'DIAGNÓSTICOS ACTUALES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'DIAGNÓSTICOS O PROBLEMAS CLÍNICOS (6.2.4)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.diagnosticos ||
                    'Diagnósticos en seguimiento según nota de ingreso. Sin cambios en impresión diagnóstica.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 PRONÓSTICO (6.2.5)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PRONÓSTICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: `PRONÓSTICO (6.2.5): ${
                    notaEvolucionData.pronostico ||
                    'Favorable para la vida y función. Reservado a evolución clínica.'
                  }`,
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 TRATAMIENTO E INDICACIONES MÉDICAS (6.2.6)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'TRATAMIENTO E INDICACIONES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'TRATAMIENTO E INDICACIONES MÉDICAS (6.2.6)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.plan_estudios_tratamiento ||
                    'Continuar manejo actual. Vigilar evolución clínica. Medidas generales de soporte.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MEDICAMENTOS (DOSIS, VÍA, PERIODICIDAD)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.indicaciones_medicas ||
                    'Medicamentos según prescripción previa. Revisar esquema terapéutico en nota de ingreso.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 INTERCONSULTAS Y PROCEDIMIENTOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INTERCONSULTAS Y PROCEDIMIENTOS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                  alignment: 'center',
                },
              ],
              [
                {
                  text:
                    notaEvolucionData.interconsultas ||
                    'Sin interconsultas programadas para esta evolución. Sin procedimientos especiales indicados.',
                  fontSize: 8,
                  margin: [10, 5],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        // 🔹 MÉDICO RESPONSABLE SEGÚN NOM-004 (5.10)
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: 'NOMBRE COMPLETO Y CÉDULA PROFESIONAL DEL MÉDICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: 'FIRMA AUTÓGRAFA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `Cédula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `${medicoCompleto.cargo} - ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Hospital General San Luis de la Paz\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Fecha: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Hora: ${fechaActual.toLocaleTimeString('es-MX')}`,
                      fontSize: 7,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
                {
                  text: '\n\n\n\n_________________________\nFIRMA DEL MÉDICO TRATANTE\n(NOM-004-SSA3-2012)',
                  fontSize: 8,
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        // 🔹 NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Sección 6.2 "Nota de evolución"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos establecidos en los numerales 6.2.1 al 6.2.6',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota de Evolución - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }

  TENGO ESTOS TEMPLATES BORRADOS ANTERIORMENTE:
  // 📄 NOTA DE CONSENTIMIENTO INFORMADO PARA PROCEDIMIENTOS SEGÚN NOM-004-SSA3-2012
  async generarNotaConsentimientoProcedimientos(datos: any): Promise<any> {
    console.log(
      '📝 Generando Nota de Consentimiento Informado para Procedimientos según NOM-004...'
    );

    // ✅ CORRECCIÓN: Usar los datos ya preparados
    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const consentimientoData = datos.consentimiento || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 80, 40, 80],

      header: {
        margin: [40, 20, 40, 20],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
                fontSize: 14,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'CARTA DE CONSENTIMIENTO INFORMADO PARA',
                fontSize: 12,
                bold: true,
                alignment: 'center',
                margin: [0, 5, 0, 0],
              },
            ],
            [
              {
                text: 'OPERACIÓN O PROCEDIMIENTOS Y ALTERNATIVAS',
                fontSize: 14,
                bold: true,
                alignment: 'center',
                margin: [0, 2, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 DATOS DEL PACIENTE
        {
          table: {
            widths: ['13%', '37%', '8%', '12%', '12%', '18%'],
            body: [
              [
                { text: 'Nombre:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 9, bold: true },
                {
                  text: `${pacienteCompleto.edad} años`,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Fecha:', fontSize: 9, bold: true },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'CURP:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.curp,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Sexo:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'F. Nacimiento:', fontSize: 8, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Cama:', fontSize: 9, bold: true },
                {
                  text: consentimientoData.numero_cama || 'N/A',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 9, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 DECLARACIÓN INICIAL
        {
          table: {
            widths: ['5%', '95%'],
            body: [
              [
                { text: 'YO', fontSize: 11, bold: true },
                {
                  text:
                    consentimientoData.nombre_responsable ||
                    pacienteCompleto.nombre_completo,
                  fontSize: 11,
                  decoration: 'underline',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        {
          text: [
            {
              text: 'en pleno uso de mis facultades mentales, ',
              fontSize: 11,
            },
            { text: 'AUTORIZO', fontSize: 11, bold: true },
            {
              text: ' a este Hospital y a su personal para realizar la siguiente Operación (o Procedimiento):',
              fontSize: 11,
            },
          ],
          lineHeight: 1.1,
          margin: [0, 0, 0, 10],
        },

        // 🔹 NOMBRE DEL PROCEDIMIENTO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text:
                    consentimientoData.nombre_procedimiento ||
                    '________________________________________________________________________',
                  fontSize: 12,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Entendiendo que la ventaja de someterme a este procedimiento quirúrgico o diagnóstico es:',
          fontSize: 11,
          margin: [0, 0, 0, 10],
        },

        // 🔹 BENEFICIOS DEL PROCEDIMIENTO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text:
                    consentimientoData.beneficios_procedimiento ||
                    '_________________________________________________________________\n_________________________________________________________________',
                  fontSize: 10,
                  margin: [10, 10, 10, 10],
                  minHeight: 40,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        // 🔹 RIESGOS
        {
          text: [{ text: 'RIESGOS:', fontSize: 11, bold: true }],
          margin: [0, 0, 0, 10],
        },

        {
          text: 'Se da autorización bajo el entendimiento pleno de que cualquier operación o procedimiento médico-quirúrgico, implica algún(os) riesgo(s) y/o peligro(s). Los riesgos más comunes incluyen: Infección, Hemorragia, Lesión nerviosa, Coágulos sanguíneos, ataque cardiaco, Reacciones alérgicas y neumonía. Estos riesgos pueden ser graves e incluso mortales. Algunos riesgos importantes en especial de este tipo de intervención que se va a realizar son:',
          fontSize: 10,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        // 🔹 RIESGOS ESPECÍFICOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text:
                    consentimientoData.riesgos_especificos ||
                    '_________________________________________________________________\n_________________________________________________________________\n_________________________________________________________________',
                  fontSize: 10,
                  margin: [10, 10, 10, 10],
                  minHeight: 60,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        // 🔹 ANESTESIA
        {
          text: [{ text: 'ANESTESIA:', fontSize: 11, bold: true }],
          margin: [0, 0, 0, 10],
        },

        {
          text: [
            {
              text: 'La aplicación de Anestesia también implica riesgos; el más importante de estos, aunque poco frecuente que suceda, es el riesgo de sufrir alguna reacción a los medicamentos que pueden ser incluso fatales. ',
              fontSize: 11,
            },
            { text: 'Autorizo', fontSize: 11, bold: true },
            {
              text: ' la técnica y el uso de anestésicos que juzgue necesarios la persona de este servicio para la realización del procedimiento autorizado.',
              fontSize: 11,
            },
          ],
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        // 🔹 PROCEDIMIENTOS ADICIONALES
        {
          text: [
            { text: 'PROCEDIMIENTOS ADICIONALES:', fontSize: 11, bold: true },
          ],
          margin: [0, 0, 0, 10],
        },

        {
          text: [
            {
              text: 'Si mi Médico selecciona un procedimiento diferente, por alguna situación especial no sospechada en el transcurso de mi intervención, (sí ó no) ',
              fontSize: 11,
            },
            {
              text:
                consentimientoData.autoriza_procedimientos_adicionales ||
                '______',
              fontSize: 11,
              decoration: 'underline',
            },
            {
              text: ' lo autorizo a realizar si lo considera necesario',
              fontSize: 11,
            },
          ],
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Estoy enterado(a), de que no existe garantía o seguridad sobre resultados del procedimiento y de que existe la posibilidad de que no pueda curarse la enfermedad o padecimiento que presento.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Así también estoy enterado(a) de que nadie puede decir con seguridad cuáles serán las complicaciones que ocurran en mi caso, si es que las hay.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 20],
        },

        // 🔹 CONSENTIMIENTO DEL PACIENTE
        {
          text: [
            {
              text: 'CONSENTIMIENTO DEL PACIENTE, O TUTOR:',
              fontSize: 11,
              bold: true,
            },
          ],
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Tengo que leer y entender esta forma de consentimiento, la que no debo firmar si alguno de los párrafos o de mis dudas no han sido explicadas a mi entera satisfacción o si no entiendo cualquier término o palabra contenida en ese documento.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Si tiene cualquier duda acerca de los riesgos o peligros de la cirugía o tratamiento propuesto, pregunte a su Cirujano, ahora. ¡Antes de firmar el documento! ¡No firme a menos de que entienda por completo este documento!',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 25],
        },

        // 🔹 FIRMAS
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________\nNombre y firma del médico',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 20, 0, 10],
                },
                {
                  text: '\n\n\n_________________________________\nNombre y firma del paciente, tutor o representante',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 20, 0, 10],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________\nTestigo nombre y firma',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 10, 0, 10],
                },
                {
                  text: '\n\n\n_________________________________\nTestigo nombre y firma',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 10, 0, 10],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        // 🔹 LUGAR Y FECHA
        {
          table: {
            widths: ['35%', '10%', '8%', '20%', '8%', '19%'],
            body: [
              [
                { text: 'San Luis de la Paz, Guanajuato a', fontSize: 10 },
                {
                  text: fechaActual.getDate(),
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 10, alignment: 'center' },
                {
                  text: fechaActual.toLocaleDateString('es-MX', {
                    month: 'long',
                  }),
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 10, alignment: 'center' },
                {
                  text: `20${fechaActual.getFullYear().toString().slice(-2)}`,
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: 'noBorders',
          alignment: 'center',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Consentimiento Informado - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 CONSENTIMIENTO INFORMADO PARA HOSPITALIZACIÓN SEGÚN NOM-004-SSA3-2012
  async generarConsentimientoHospitalizacion(datos: any): Promise<any> {
    console.log(
      'Generando Consentimiento Informado para Hospitalización según NOM-004...'
    );

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const consentimientoData = datos.consentimientoHospitalizacion || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 60, 40, 60],

      content: [
        { text: '', margin: [0, 20] },

        // 🔹 DATOS DEL PACIENTE
        {
          table: {
            widths: ['13%', '37%', '8%', '12%', '12%', '18%'],
            body: [
              [
                { text: 'Nombre:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 9, bold: true },
                {
                  text: `${pacienteCompleto.edad} años`,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Fecha:', fontSize: 9, bold: true },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'CURP:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.curp,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Sexo:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'F. Nacimiento:', fontSize: 8, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Cama:', fontSize: 9, bold: true },
                {
                  text: consentimientoData.numero_cama || 'Por asignar',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 9, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 DECLARACIÓN INICIAL
        {
          table: {
            widths: ['5%', '95%'],
            body: [
              [
                { text: 'YO', fontSize: 11, bold: true },
                {
                  text:
                    consentimientoData.nombre_responsable ||
                    pacienteCompleto.nombre_completo,
                  fontSize: 11,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 10],
        },

        {
          text: 'familiar o allegado designado por el paciente, y en caso de menores de edad e incapacitados para otorgar su consentimiento y/o autorización.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 20],
        },

        // 🔹 AUTORIZO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'AUTORIZO',
                  fontSize: 14,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 10, 0, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'En atención a los artículos 80 al 83 de reglamento de la Ley General de Salud en materia de atención médica y a la NOM-168-SSA1-1998 relativa al expediente clínico numerales 4.2, 10.1 al 10.1.2, se otorga la presente autorización al personal Médico y Paramédico del Hospital.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        // 🔹 HOSPITAL
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
                  fontSize: 13,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'para realizar los procedimientos médicos y/o quirúrgicos necesarios al paciente en cuestión, y',
          fontSize: 11,
          margin: [0, 0, 0, 10],
        },

        {
          text: 'para tal efecto, dicho paciente y/o su representante legal DECLARA:',
          fontSize: 11,
          margin: [0, 0, 0, 15],
        },

        // 🔹 DECLARO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DECLARO',
                  fontSize: 14,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 10, 0, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Que los Médicos del Hospital le han explicado de una manera detallada y con un lenguaje que pudo comprender, que los procedimientos médicos y/o quirúrgicos que se planean realizar, tienen como objetivo primordial dar solución a los problemas de salud del enfermo, utilizando las técnicas vigentes para tal efecto, en virtud de que el personal de salud que labora en dicha institución se declara ampliamente capacitado y que cuanta con autorización legal con efectos de patente y cédula profesional correspondiente para el libre ejercicio de su especialidad médica o quirúrgica en su caso, así como la certificación vigente del consejo nacional de dicha especialidad, además de comprometerse a cuidar de la salud y la integridad, del enfermo y actuar con ética y responsabilidad en beneficio del paciente y su entorno biológico, psicológico y social.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        {
          text: 'Que cualquier procedimiento médico implica una serie de riesgo no siempre previsible debido a diversas circunstancias que entre otras se consideran se estado físico previo, enfermedades pre o coexistentes, tratamientos previos, etcétera y que existe la posibilidad de complicaciones debidas al tratamiento médico y/o quirúrgico, ya que cada paciente puede reaccionar en forma diversa a la aplicación de tal fármaco o bien a la realización de determinado procedimiento, dichas complicaciones pueden ser transitorias o permanentes y pueden ir desde leves hasta severas y pueden poner en peligro la vida del paciente e incluso provocar la muerte.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        {
          text: 'Que, en circunstancias especiales, el personal de salud se verá obligado a utilizar técnicas invasivas de diagnóstico y tratamiento, conforme a los protocolos médicos actuales con el objeto de mantener una vigilancia estrecha de las constantes vitales o bien de proporcionar una terapéutica oportuna que puede salvar la vida del paciente, pero las cuales se requiere la aplicación de sondas, catéteres o marcapasos según sea al caso.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        {
          text: 'Que algunas enfermedades pueden requerir de un procedimiento quirúrgico para su resolución y que esta necesidad puede presentarse en cualquier momento de su estancia hospitalaria, para lo cual se solicitará una autorización previa del paciente o su representante legal en su caso, sin embargo, en dado caso que dicha persona no autorice el procedimiento en cuestión, o bien solicite su alta voluntaria por cualquier motivo, el Hospital y el personal que en el labora quedará automáticamente exento de cualquier implicación médica y legal derivada de la decisión, así como de la evolución consecutiva del paciente.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        {
          text: 'Que en ocasiones puede ser necesaria la aplicación de sangre o productos sanguíneos para la resolución de determinados problemas de salud, por lo que se autoriza a los médicos a emplear dicha terapéutica siempre que sea necesaria, con las reservas que marcan las normas vigentes.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        {
          text: 'Que el paciente será sometido a un protocolo terapéutico que se encuentra ampliamente documentado en el expediente clínico y que se apega estrechamente a las consideraciones éticas del tratado de Helsinki modificado en Viena y que el paciente debe seguir estrechamente las indicaciones para el diagnóstico y tratamiento de su enfermedad, ya que de no ser así o bien en el caso que el paciente siga instrucciones ajenas o bien actué de acuerdo a su propio entender o en su caso amita las indicaciones específicas del médico, así como el Hospital',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        // 🔹 HOSPITAL (REPETIDO)
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
                  fontSize: 12,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Queda totalmente exentos de cualquier implicación médica y legal que se deriven de la evolución subsecuente del paciente.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 25],
          alignment: 'justify',
        },

        // 🔹 ACEPTO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'ACEPTO',
                  fontSize: 16,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        // 🔹 FIRMAS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________________\nNombre y firma del paciente y/o Representante legal',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 20, 0, 20],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        {
          table: {
            widths: ['45%', '10%', '45%'],
            body: [
              [
                {
                  text: '\n\n\n_____________________________\nTestigo',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
                { text: '', fontSize: 11 },
                {
                  text: '\n\n\n_____________________________\nTestigo',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: '\n\n\n_____________________________\nTestigo',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Consentimiento Hospitalización - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 CARTA DE CONSENTIMIENTO INFORMADO PARA REFERENCIA DE PACIENTES SEGÚN NOM-004-SSA3-2012
  async generarConsentimientoReferenciaPacientes(datos: any): Promise<any> {
    console.log(
      '  Generando Carta de Consentimiento Informado para Referencia de Pacientes según NOM-004...'
    );

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const referenciaData = datos.referenciaConsentimiento || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 80, 40, 60],

      header: {
        margin: [40, 20, 40, 20],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'CARTA DE CONSENTIMIENTO INFORMADO',
                fontSize: 13,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'PARA REFERENCIA DE PACIENTES',
                fontSize: 14,
                bold: true,
                alignment: 'center',
                margin: [0, 5, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 30] },

        // 🔹 DATOS GENERALES
        {
          table: {
            widths: ['28%', '72%'],
            body: [
              [
                {
                  text: 'Nombre de la Unidad Médica:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: 'Hospital General San Luis de la Paz',
                  fontSize: 10,
                  bold: true,
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 10],
        },

        // 🔹 FECHA Y LUGAR
        {
          table: {
            widths: ['22%', '12%', '5%', '15%', '5%', '15%', '26%'],
            body: [
              [
                {
                  text: 'San Luis de la Paz, Guanajuato a',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: fechaActual.getDate().toString(),
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 10, bold: true, alignment: 'center' },
                {
                  text: fechaActual.toLocaleDateString('es-MX', {
                    month: 'long',
                  }),
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 10, bold: true, alignment: 'center' },
                {
                  text: fechaActual.getFullYear().toString(),
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: '', fontSize: 10 },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 DATOS DEL INGRESO
        {
          table: {
            widths: ['28%', '17%', '10%', '15%', '8%', '22%'],
            body: [
              [
                {
                  text: 'Fecha de Ingreso hospitalario:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text:
                    referenciaData.fecha_ingreso ||
                    fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 10, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Cama:', fontSize: 10, bold: true },
                {
                  text: referenciaData.numero_cama || 'Sin asignar',
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 DATOS DEL PACIENTE
        {
          table: {
            widths: ['28%', '40%', '16%', '16%'],
            body: [
              [
                {
                  text: 'Nombre del (la) paciente:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'No. Expediente:', fontSize: 10, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 10],
        },

        {
          table: {
            widths: ['28%', '25%', '8%', '15%', '12%', '12%'],
            body: [
              [
                { text: 'Fecha de nacimiento:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 10, bold: true },
                {
                  text: `${pacienteCompleto.edad} años`,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Fecha/hora:', fontSize: 10, bold: true },
                {
                  text: fechaActual.toLocaleString('es-MX'),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        // 🔹 CONSENTIMIENTO PRINCIPAL
        {
          table: {
            widths: ['25%', '75%'],
            body: [
              [
                {
                  text: 'Acepto que el (la) Dr (a)',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}`,
                  fontSize: 11,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 10],
        },

        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: [
                    {
                      text: 'Me ha explicado clara y entendible el padecimiento, riesgos, cuidados, tratamientos médicos requeridos para la estabilización de mi salud o la de mi paciente.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: 'Para su atención se requiere de la realización del procedimiento administrativo de referencia de pacientes, que consiste en el envío a otra unidad donde se cuenta con la capacidad física instalada para atender el problema de salud y una vez estabilizado o resuelto se contrarrefiera a la unidad de salud de origen.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: 'Enterado (a) de todo lo anterior y una vez que me han informado a mi entera satisfacción, otorgo el presente consentimiento.',
                      fontSize: 11,
                    },
                  ],
                  alignment: 'justify',
                  lineHeight: 1.1,
                  margin: [10, 15, 10, 15],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 30],
        },

        // 🔹 INFORMACIÓN ADICIONAL DE LA REFERENCIA
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIÓN DE LA REFERENCIA',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Motivo de la referencia: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        referenciaData.motivo_referencia ||
                        'Requiere atención especializada no disponible en esta unidad médica.',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nUnidad médica de destino: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        referenciaData.unidad_destino ||
                        'Por definir según disponibilidad y especialidad requerida.',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nEspecialidad requerida: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        referenciaData.especialidad_requerida ||
                        'Según criterio médico.',
                      fontSize: 10,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 30],
        },

        // 🔹 FIRMAS
        {
          table: {
            widths: ['45%', '10%', '45%'],
            body: [
              [
                {
                  text: `\n\n\n${pacienteCompleto.nombre_completo}\n_______________________________`,
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
                { text: '', fontSize: 10 },
                {
                  text: `\n\n\n${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n_______________________________`,
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
              ],
              [
                {
                  text: 'Nombre completo y firma del (paciente) tutor y/o representante legal',
                  fontSize: 9,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
                { text: '', fontSize: 9 },
                {
                  text: 'Nombre completo y firma del médico tratante',
                  fontSize: 9,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        // 🔹 TESTIGOS
        {
          table: {
            widths: ['45%', '10%', '45%'],
            body: [
              [
                {
                  text: `\n\n\n${
                    referenciaData.testigo1_nombre ||
                    '__________________________'
                  }\n_______________________________`,
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
                { text: '', fontSize: 10 },
                {
                  text: `\n\n\n${
                    referenciaData.testigo2_nombre ||
                    '__________________________'
                  }\n_______________________________`,
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
              ],
              [
                {
                  text: 'Nombre completo y firma testigo',
                  fontSize: 9,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
                { text: '', fontSize: 9 },
                {
                  text: 'Nombre completo y firma testigo',
                  fontSize: 9,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Consentimiento Referencia - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 CARTA DE CONSENTIMIENTO INFORMADO PARA TRANSFUSIÓN SANGUÍNEA O SUS DERIVADOS SEGÚN NOM-004-SSA3-2012
  async generarConsentimientoTransfusionSanguinea(datos: any): Promise<any> {
    console.log(
      '🩸 Generando Carta de Consentimiento Informado para Transfusión Sanguínea según NOM-004...'
    );

    // ✅ CORRECCIÓN: Usar datos ya preparados
    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const transfusionData = datos.consentimientoTransfusion || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 80, 40, 60],

      header: {
        margin: [40, 20, 40, 20],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'CARTA DE CONSENTIMIENTO INFORMADO PARA LA',
                fontSize: 12,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'TRANSFUSIÓN SANGUÍNEA O SUS DERIVADOS',
                fontSize: 16,
                bold: true,
                alignment: 'center',
                margin: [0, 5, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 20] },

        // 🔹 DATOS DEL PACIENTE
        {
          table: {
            widths: ['15%', '35%', '15%', '35%'],
            body: [
              [
                { text: 'Nombre:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 9, bold: true },
                {
                  text: `${pacienteCompleto.edad} años`,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'CURP:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.curp,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Género:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'F. Nacimiento:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Cama:', fontSize: 9, bold: true },
                {
                  text: transfusionData.numero_cama || 'Sin asignar',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 9, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Estado civil:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.estado_civil || 'No registrado',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Diagnóstico:', fontSize: 9, bold: true },
                {
                  text: transfusionData.diagnostico || 'Pendiente',
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Domicilio:', fontSize: 9, bold: true },
                {
                  text: this.formatearDireccionMejorada(pacienteCompleto),
                  fontSize: 9,
                  decoration: 'underline',
                  colSpan: 3,
                },
                {},
                {},
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 INFORMACIÓN SOBRE LA TRANSFUSIÓN
        {
          text: 'Durante su ingreso hospitalario puede ser necesaria la transfusión de sangre y otros hemoderivados como plasma fresco congelado, plaquetas, y crioprecipitados, bien porque se precise durante la intervención quirúrgica, o porque tenga una enfermedad en la que sea necesaria.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        {
          text: 'La transfusión consiste en la administración de sangre humana o alguno de sus componentes, a los pacientes que lo precisen. Se administra por vía intravenosa. También cabe la posibilidad de que durante el procedimiento haya que realizar modificaciones del mismo.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Aunque se haga una adecuada elección del procedimiento y de su correcta aplicación, pueden presentarse efectos indeseables, tanto los comunes derivados del mismo y pueden afectar a todos los órganos y sistemas, como son debidos a la situación vital del paciente (diabetes, cardiopatía, hipertensión, edad avanzada, anemia, obesidad entre otras), y los específicos del procedimiento.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        // 🔹 INFORMACIÓN SOBRE LA SEGURIDAD DE LA SANGRE
        {
          text: 'La sangre y sus derivados proceden de personas que gozan de buena salud. Son personas que, por donar no perciben compensación económica alguna. Todos los donadores son seleccionados con criterios médicos y la sangre se estudia cuidadosamente con los análisis que exigen las leyes. Cualquier unidad de sangre o hemoderivado que vaya usted a recibir habrá sido analizada para SIDA (anticuerpos anti-HIV), HEPATITIS (Hepatitis B/C), SÍFILIS, BRUCELOSIS Y CHAGAS.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        // 🔹 RIESGOS ESPECÍFICOS
        {
          text: 'A pesar de ello puede ocurrir que el donante se encuentre en el periodo ventana (espacio de tiempo en el cual no es posible la detección serológica de la infección) y se pueda transmitir alguna de las infecciones anteriormente mencionadas.',
          fontSize: 11,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 12],
        },

        {
          text: 'Otro riesgo posible que tienen las transfusiones es que el receptor pueda sufrir algún tipo de reacción de rechazo a alguno de los componentes de la sangre. Estas reacciones son frecuentes y, prácticamente, siempre leves.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 12],
        },

        {
          text: 'Ningún procedimiento invasivo está absolutamente exento de riesgos importantes, incluyendo la muerte, aunque esta posibilidad es poco frecuente.',
          fontSize: 11,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        // 🔹 MARCO LEGAL
        {
          text: [
            {
              text: 'En atención a los artículos 80 al 83 de reglamento de la Ley General de Salud en materia de atención médica y a la Norma Oficial Mexicana ',
              fontSize: 11,
            },
            {
              text: 'NOM-004-SSA3-2012',
              fontSize: 11,
              bold: true,
            },
            {
              text: ', relativa al expediente clínico numerales 4.2, 10.1 al 10.1.2, considerando la NORMA Oficial Mexicana ',
              fontSize: 11,
            },
            {
              text: 'NOM-253-SSA1-2012,',
              fontSize: 11,
              bold: true,
            },
            {
              text: ' para la disposición de sangre humana y sus componentes con fines terapéuticos. Se otorga la presente autorización al personal Médico y Paramédico del Hospital para realizar la transfusión de hemoderivados necesarios al paciente en cuestión,',
              fontSize: 11,
            },
          ],
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        {
          text: 'y para tal efecto, dicho paciente y/o su representante legal: DECLARA',
          fontSize: 11,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        // 🔹 DECLARACIÓN
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DECLARO',
                  fontSize: 14,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 10, 0, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Que los médicos me han entregado esta hoja informativa, la cual he leído y he comprendido el significado del procedimiento y los riesgos inherentes al mismo, por lo cual, declaro estar debidamente informado por el personal de salud del Hospital General San Luis de la Paz.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Así mismo he recibido respuesta a todas mis preguntas y las consideraciones suficientes y aceptables, haciendo tomar la decisión en forma libre y voluntaria y autorizo al personal de salud para la atención de contingencias derivadas de este acto.',
          fontSize: 11,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 20],
        },

        // 🔹 FECHA Y LUGAR
        {
          table: {
            widths: ['35%', '5%', '10%', '5%', '15%', '5%', '25%'],
            body: [
              [
                { text: 'San Luis de la Paz, Guanajuato,', fontSize: 11 },
                { text: 'a', fontSize: 11, alignment: 'center' },
                {
                  text: fechaActual.getDate().toString(),
                  fontSize: 11,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 11, alignment: 'center' },
                {
                  text: fechaActual.toLocaleDateString('es-MX', {
                    month: 'long',
                  }),
                  fontSize: 11,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 11, alignment: 'center' },
                {
                  text: fechaActual.getFullYear().toString(),
                  fontSize: 11,
                  decoration: 'underline',
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 ACEPTO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'ACEPTO',
                  fontSize: 16,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        // 🔹 INFORMACIÓN ESPECÍFICA DE LA TRANSFUSIÓN
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIÓN ESPECÍFICA DE LA TRANSFUSIÓN',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Tipo de hemoderivado requerido: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        transfusionData.tipo_hemoderivado ||
                        'Por definir según necesidad clínica (sangre total, concentrado eritrocitario, plasma, plaquetas, crioprecipitados)',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nIndicación médica: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        transfusionData.indicacion_medica ||
                        'Según criterio médico y estado clínico del paciente',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nTipo sanguíneo del paciente: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        pacienteCompleto.tipo_sangre ||
                        'Por determinar mediante tipificación',
                      fontSize: 10,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 25],
        },

        // 🔹 FIRMAS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________________\nNombre y firma del paciente y/o Representante legal',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________________\nNombre, firma y sello del médico tratante',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        {
          table: {
            widths: ['45%', '10%', '45%'],
            body: [
              [
                {
                  text: '\n\n\n_____________________________\nTestigo',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
                { text: '', fontSize: 11 },
                {
                  text: '\n\n\n_____________________________\nTestigo',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Consentimiento Transfusión Sanguínea - SICEG\nNOM-004-SSA3-2012 | NOM-253-SSA1-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 HOJA DE CONSENTIMIENTO INFORMADO PARA TRATAMIENTO MÉDICO SEGÚN NOM-004-SSA3-2012
  async generarConsentimientoTratamientoMedico(datos: any): Promise<any> {
    console.log(
      'Generando Hoja de Consentimiento Informado para Tratamiento Médico según NOM-004...'
    );

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const tratamientoData = datos.consentimientoTratamiento || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [45, 60, 45, 60],

      content: [
        { text: '', margin: [0, 40] },

        // 🔹 TÍTULO
        {
          text: 'HOJA DE CONSENTIMIENTO INFORMADO PARA TRATAMIENTO MÉDICO',
          fontSize: 12,
          bold: true,
          alignment: 'center',
          margin: [0, 0, 0, 25],
        },

        // 🔹 FECHA Y LUGAR
        {
          table: {
            widths: ['42%', '8%', '8%', '12%', '8%', '22%'],
            body: [
              [
                {
                  text: 'San Luis de la Paz, Guanajuato a',
                  fontSize: 9,
                  bold: true,
                },
                {
                  text: fechaActual.getDate().toString(),
                  fontSize: 9,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 9, bold: true, alignment: 'center' },
                {
                  text: fechaActual.toLocaleDateString('es-MX', {
                    month: 'long',
                  }),
                  fontSize: 9,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 9, bold: true, alignment: 'center' },
                {
                  text: `20${fechaActual.getFullYear().toString().slice(-2)}`,
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        // 🔹 DESTINATARIO
        {
          text: `DR. ${medicoCompleto.nombre_completo}`,
          fontSize: 10,
          bold: true,
          margin: [0, 0, 0, 8],
        },

        {
          text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
          fontSize: 10,
          margin: [0, 0, 0, 8],
        },

        {
          text: 'DIRECTOR',
          fontSize: 10,
          margin: [0, 0, 0, 8],
        },

        {
          text: 'PRESENTE.',
          fontSize: 10,
          margin: [0, 0, 0, 20],
        },

        // 🔹 QUIEN SUSCRIBE
        {
          text: 'QUIEN SUSCRIBE:',
          fontSize: 10,
          bold: true,
          margin: [0, 0, 0, 15],
        },

        {
          text: `${pacienteCompleto.apellido_paterno || '_'.repeat(30)} ${
            pacienteCompleto.apellido_materno || '_'.repeat(30)
          } ${pacienteCompleto.nombre || '_'.repeat(30)}`,
          fontSize: 10,
          decoration: 'underline',
          alignment: 'center',
          margin: [0, 0, 0, 8],
        },

        {
          text: 'APELLIDO PATERNO                                           APELLIDO MATERNO                                           NOMBRE(S)',
          fontSize: 8,
          alignment: 'center',
          margin: [0, 0, 0, 25],
        },

        // 🔹 DOMICILIO
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                { text: 'DOMICILIO:', fontSize: 10, bold: true },
                {
                  text: this.formatearDireccionMejorada(pacienteCompleto),
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        // 🔹 DATOS ADICIONALES DEL PACIENTE
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIÓN DEL PACIENTE',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Expediente: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      ),
                      fontSize: 9,
                    },
                    {
                      text: '     Edad: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `${pacienteCompleto.edad} años`,
                      fontSize: 9,
                    },
                    {
                      text: '     Sexo: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: pacienteCompleto.sexo,
                      fontSize: 9,
                    },
                    {
                      text: '\nCURP: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: pacienteCompleto.curp || 'No registrado',
                      fontSize: 9,
                    },
                    {
                      text: '\nFecha de nacimiento: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text:
                        pacienteCompleto.fecha_nacimiento || 'No registrada',
                      fontSize: 9,
                    },
                    {
                      text: '\nServicio médico: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: medicoCompleto.departamento,
                      fontSize: 9,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 25],
        },

        // 🔹 AUTORIZACIÓN PRINCIPAL
        {
          text: 'AUTORIZO PLENAMENTE AL PERSONAL DE ESTE HOSPITAL A SU CARGO PARA EJECUTAR LAS INVESTIGACIONES CLÍNICAS, DE LABORATORIO Y DE GABINETE, QUE SEAN NECESARIAS PARA EL DIAGNÓSTICO DE MI ENFERMEDAD, ASÍ COMO TAMBIÉN PARA REALIZAR LOS TRATAMIENTOS MÉDICOS O QUIRÚRGICOS QUE CONVENGAN. ASÍ MISMO ME COMPROMETO A OBSERVAR EL REGLAMENTO INTERNO DE LA INSTITUCIÓN.',
          fontSize: 10,
          lineHeight: 1.5,
          alignment: 'justify',
          margin: [0, 0, 0, 20],
        },

        // 🔹 INFORMACIÓN ESPECÍFICA DEL TRATAMIENTO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIÓN ESPECÍFICA DEL TRATAMIENTO',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Diagnóstico presuntivo: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text:
                        tratamientoData.diagnostico_presuntivo ||
                        'Por determinar mediante estudios clínicos y de gabinete',
                      fontSize: 9,
                    },
                    {
                      text: '\n\nTratamiento propuesto: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text:
                        tratamientoData.tratamiento_propuesto ||
                        'Según criterio médico y evolución clínica del paciente',
                      fontSize: 9,
                    },
                    {
                      text: '\n\nEstudios de laboratorio y gabinete autorizados: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text:
                        tratamientoData.estudios_autorizados ||
                        'Los que sean médicamente necesarios para el diagnóstico',
                      fontSize: 9,
                    },
                    {
                      text: '\n\nMédico responsable: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}`,
                      fontSize: 9,
                    },
                    {
                      text: ' - Cédula: ',
                      fontSize: 9,
                    },
                    {
                      text: medicoCompleto.numero_cedula || 'No disponible',
                      fontSize: 9,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 25],
        },

        // 🔹 DECLARACIÓN DE CONFORMIDAD
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DECLARACIÓN DE CONFORMIDAD',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: 'Declaro que he sido informado(a) sobre los procedimientos médicos, estudios de diagnóstico y tratamientos que se realizarán. Entiendo los riesgos y beneficios del tratamiento propuesto. He tenido la oportunidad de hacer preguntas y todas han sido respondidas satisfactoriamente. Autorizo voluntariamente el tratamiento médico propuesto y me comprometo a seguir las indicaciones médicas.',
                  fontSize: 10,
                  alignment: 'justify',
                  lineHeight: 1.4,
                  margin: [10, 10, 10, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 30],
        },

        // 🔹 DESPEDIDA
        {
          text: 'A T E N T A M E N T E',
          fontSize: 10,
          bold: true,
          alignment: 'center',
          margin: [0, 0, 0, 30],
        },

        // 🔹 FIRMAS
        {
          table: {
            widths: ['45%', '10%', '45%'],
            body: [
              [
                {
                  text: '\n\n\n\n_________________________________',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 20, 0, 5],
                },
                { text: '', fontSize: 10 },
                {
                  text: '\n\n\n\n_________________________________',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 20, 0, 5],
                },
              ],
              [
                {
                  text: 'NOMBRE Y FIRMA DE LA PERSONA LEGALMENTE RESPONSABLE',
                  fontSize: 8,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
                { text: '', fontSize: 8 },
                {
                  text: 'NOMBRE Y FIRMA DEL PACIENTE',
                  fontSize: 8,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
              [
                { text: '', fontSize: 10, margin: [0, 20, 0, 0] },
                { text: '', fontSize: 10 },
                { text: '', fontSize: 10 },
              ],
              [
                {
                  text: '\n\n\n\n_________________________________',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
                { text: '', fontSize: 10 },
                {
                  text: '\n\n\n\n_________________________________',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
              ],
              [
                {
                  text: 'TESTIGO',
                  fontSize: 8,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
                { text: '', fontSize: 8 },
                {
                  text: 'TESTIGO',
                  fontSize: 8,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },

        { text: '', margin: [0, 15] },

        // 🔹 INFORMACIÓN MÉDICA ADICIONAL
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIÓN DEL MÉDICO TRATANTE',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
              [
                {
                  text: [
                    {
                      text: `Médico: ${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Cédula Profesional: ${
                        medicoCompleto.numero_cedula || 'No disponible'
                      }\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de elaboración: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} ${fechaActual.toLocaleTimeString('es-MX')}`,
                      fontSize: 8,
                    },
                  ],
                  margin: [8, 8, 8, 8],
                  lineHeight: 1.2,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [45, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Consentimiento Tratamiento Médico - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }

  
  // 📄 HOJA DE ALTA VOLUNTARIA SEGÚN NOM-004-SSA3-2012
  async generarHojaAltaVoluntaria(datos: any): Promise<any> {
    console.log('🚪 Generando Hoja de Alta Voluntaria según NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const altaVoluntariaData = datos.altaVoluntaria || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 80, 40, 60],

      header: {
        margin: [40, 20, 40, 20],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOJA DE ALTA VOLUNTARIA',
                fontSize: 15,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 20] },

        // 🔹 DATOS DEL PACIENTE
        {
          table: {
            widths: ['13%', '37%', '8%', '12%', '12%', '18%'],
            body: [
              [
                { text: 'Nombre:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 9, bold: true },
                {
                  text: `${pacienteCompleto.edad} años`,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Fecha:', fontSize: 9, bold: true },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'CURP:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.curp,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Sexo:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'F. Nacimiento:', fontSize: 8, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Cama:', fontSize: 9, bold: true },
                {
                  text: altaVoluntariaData.numero_cama || 'Sin asignar',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 9, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        // 🔹 INFORMACIÓN MÉDICA DEL ALTA VOLUNTARIA
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIÓN MÉDICA',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Fecha de ingreso: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        altaVoluntariaData.fecha_ingreso || 'No especificada',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nMotivo de ingreso: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        altaVoluntariaData.motivo_ingreso || 'No especificado',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nDiagnóstico al momento del alta: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        altaVoluntariaData.diagnostico_alta || 'Por definir',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nEstado general del paciente: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text: altaVoluntariaData.estado_general || 'Estable',
                      fontSize: 10,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        // 🔹 DECLARACIÓN DE ALTA VOLUNTARIA
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DECLARACIÓN DE ALTA VOLUNTARIA',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'YO, ',
                      fontSize: 11,
                      bold: true,
                    },
                    {
                      text:
                        altaVoluntariaData.nombre_responsable ||
                        pacienteCompleto.nombre_completo,
                      fontSize: 11,
                      bold: true,
                      decoration: 'underline',
                    },
                    {
                      text: ', en mi calidad de ',
                      fontSize: 11,
                    },
                    {
                      text: altaVoluntariaData.relacion_paciente || 'paciente',
                      fontSize: 11,
                      decoration: 'underline',
                    },
                    {
                      text: ', manifiesto de manera libre y voluntaria mi decisión de solicitar el alta médica del Hospital General San Luis de la Paz, aún cuando el personal médico considera que mi estado de salud requiere de continuar con la atención hospitalaria.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: 'DECLARO QUE:\n\n',
                      fontSize: 11,
                      bold: true,
                    },
                    {
                      text: '1. He sido informado(a) por el personal médico sobre mi estado de salud, el diagnóstico, el tratamiento recomendado y los riesgos que implica abandonar el tratamiento hospitalario.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: '2. Entiendo que al solicitar el alta voluntaria, asumo todos los riesgos y consecuencias que puedan derivarse de esta decisión, incluyendo el empeoramiento de mi condición de salud o complicaciones graves.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: '3. Eximo de toda responsabilidad médica y legal al Hospital General San Luis de la Paz y a su personal médico y paramédico por las consecuencias que puedan resultar de mi decisión de abandonar el tratamiento.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: '4. Esta decisión la tomo de manera libre, voluntaria y consciente, sin presión alguna.',
                      fontSize: 11,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                  alignment: 'justify',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        // 🔹 RECOMENDACIONES MÉDICAS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'RECOMENDACIONES MÉDICAS PARA EL ALTA',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text:
                    altaVoluntariaData.recomendaciones_medicas ||
                    'Se recomienda:\n• Acudir inmediatamente a la unidad de salud más cercana si presenta deterioro de su estado general\n• Continuar con medicamentos prescritos según indicaciones\n• Seguimiento médico ambulatorio en las próximas 24-48 horas\n• Acudir a urgencias si presenta signos de alarma',
                  fontSize: 10,
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        // 🔹 SIGNOS DE ALARMA
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'SIGNOS DE ALARMA - ACUDIR INMEDIATAMENTE A URGENCIAS',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text:
                    altaVoluntariaData.signos_alarma ||
                    '• Dificultad para respirar o falta de aire\n• Dolor de pecho intenso\n• Pérdida de conocimiento o desmayo\n• Vómito persistente\n• Fiebre alta (mayor a 38.5°C)\n• Sangrado abundante\n• Convulsiones\n• Cambios en el estado de conciencia\n• Cualquier síntoma que considere grave o preocupante',
                  fontSize: 10,
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 25],
        },

        // 🔹 FECHA Y HORA DEL ALTA
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: `Fecha del alta voluntaria: ${fechaActual.toLocaleDateString(
                    'es-MX'
                  )}`,
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: `Hora del alta: ${fechaActual.toLocaleTimeString(
                    'es-MX'
                  )}`,
                  fontSize: 10,
                  bold: true,
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        // 🔹 FIRMAS
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________\nNombre y firma del paciente y/o\nrepresentante legal',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
                {
                  text: `\n\n\n_________________________________\n${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\nMédico tratante`,
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________\nTestigo\nNombre y firma',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
                {
                  text: '\n\n\n_________________________________\nTestigo\nNombre y firma',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 INFORMACIÓN DEL MÉDICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIÓN DEL MÉDICO RESPONSABLE',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: `Médico: ${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                    },
                    {
                      text: `Cédula Profesional: ${
                        medicoCompleto.numero_cedula || 'No disponible'
                      }\n`,
                      fontSize: 9,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 9,
                    },
                    {
                      text: `Servicio: ${medicoCompleto.departamento}\n`,
                      fontSize: 9,
                    },
                    {
                      text: `Hospital General San Luis de la Paz`,
                      fontSize: 9,
                    },
                  ],
                  margin: [10, 8, 10, 8],
                  lineHeight: 1.2,
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Hoja de Alta Voluntaria - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 HOJA DE INFORME DIARIO SEGÚN NOM-004-SSA3-2012
  async generarHojaInformeDiario(datos: any): Promise<any> {
    console.log('  Generando Hoja de Informe Diario según NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const informeDiarioData = datos.informeDiario || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageOrientation: 'landscape', // Horizontal para aprovechar el espacio
      pageMargins: [20, 60, 20, 40],

      header: {
        margin: [20, 15, 20, 15],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOJA DE INFORME DIARIO',
                fontSize: 14,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 DATOS DEL PACIENTE
        {
          table: {
            widths: ['18%', '35%', '12%', '35%'],
            body: [
              [
                { text: 'Nombre del paciente:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'No. de expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Fecha de Nacimiento:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'CURP:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.curp,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Servicio:', fontSize: 9, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Cama:', fontSize: 9, bold: true },
                {
                  text: informeDiarioData.numero_cama || 'Sin asignar',
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 INFORMACIÓN ADICIONAL DEL INFORME
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIÓN DEL INFORME DIARIO',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Período del informe: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} - Turno: ${informeDiarioData.turno || 'Matutino'}`,
                      fontSize: 9,
                    },
                    {
                      text: '\nDiagnóstico principal: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text:
                        informeDiarioData.diagnostico_principal ||
                        'Por definir',
                      fontSize: 9,
                    },
                    {
                      text: '\nMédico responsable: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}`,
                      fontSize: 9,
                    },
                  ],
                  margin: [8, 8, 8, 8],
                  lineHeight: 1.2,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        // 🔹 TABLA DE REGISTROS DIARIOS
        {
          table: {
            widths: ['15%', '25%', '25%', '35%'],
            body: [
              // Encabezados
              [
                {
                  text: 'Fecha y Hora',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'Nombre de quien informa',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'Nombre de quien recibe la información',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'Información comunicada / Observaciones',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
              ],
              // Filas de datos (generar 15 filas vacías para completar a mano)
              ...Array.from({ length: 15 }, (_, index) => [
                {
                  text:
                    index === 0 && informeDiarioData.registros?.[0]?.fecha
                      ? informeDiarioData.registros[0].fecha
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 25,
                },
                {
                  text:
                    index === 0 &&
                    informeDiarioData.registros?.[0]?.quien_informa
                      ? informeDiarioData.registros[0].quien_informa
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 25,
                },
                {
                  text:
                    index === 0 &&
                    informeDiarioData.registros?.[0]?.quien_recibe
                      ? informeDiarioData.registros[0].quien_recibe
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 25,
                },
                {
                  text:
                    index === 0 && informeDiarioData.registros?.[0]?.informacion
                      ? informeDiarioData.registros[0].informacion
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 25,
                },
              ]),
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 15] },

        // 🔹 INSTRUCCIONES Y OBSERVACIONES
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INSTRUCCIONES PARA EL LLENADO',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
              [
                {
                  text:
                    '• Registrar toda comunicación relevante sobre el estado del paciente\n' +
                    '• Incluir fecha y hora exacta de cada comunicación\n' +
                    '• Anotar nombre completo y cargo de quien proporciona la información\n' +
                    '• Registrar nombre completo de quien recibe la información (familiar, médico, etc.)\n' +
                    '• Describir brevemente el contenido de la información comunicada\n' +
                    '• Mantener confidencialidad según normativa de protección de datos\n' +
                    '• Archivar en expediente clínico una vez completado',
                  fontSize: 8,
                  margin: [8, 8, 8, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 10],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Hoja de Informe Diario - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 HOJA FRONTAL DE EXPEDIENTE SEGÚN NOM-004-SSA3-2012
  async generarHojaFrontalExpediente(datos: any): Promise<any> {
    console.log('  Generando Hoja Frontal de Expediente según NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const expedienteData = datos.expediente || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 60, 40, 60],

      content: [
        { text: '', margin: [0, 20] },

        // 🔹 DATOS BÁSICOS DEL PACIENTE
        {
          table: {
            widths: ['40%', '30%', '15%', '15%'],
            body: [
              [
                {
                  text: 'NOMBRE:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  border: [false, false, false, true],
                },
                {
                  text: 'EXPEDIENTE:',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  border: [false, false, false, true],
                },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  border: [false, false, false, true],
                },
              ],
              [
                {
                  text: 'EDAD:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: `${pacienteCompleto.edad} años`,
                  fontSize: 9,
                  border: [false, false, false, true],
                },
                {
                  text: 'CURP:',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.curp || '',
                  fontSize: 8,
                  border: [false, false, false, true],
                },
              ],
              [
                {
                  text: 'FECHA DE NACIMIENTO:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.fecha_nacimiento || '',
                  fontSize: 9,
                  border: [false, false, false, true],
                },
                {
                  text: 'GÉNERO:',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 9,
                  border: [false, false, false, true],
                },
              ],
              [
                {
                  text: 'TRANSFUSIONES:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: expedienteData.transfusiones || '',
                  fontSize: 9,
                  colSpan: 3,
                  border: [false, false, false, true],
                },
                {},
                {},
              ],
              [
                {
                  text: 'TIPO SANGUÍNEO:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.tipo_sangre || '',
                  fontSize: 9,
                  border: [false, false, false, true],
                },
                {
                  text: 'TELÉFONO:',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.telefono || '',
                  fontSize: 9,
                  border: [false, false, false, true],
                },
              ],
              [
                {
                  text: 'NOMBRE DEL PADRE O TUTOR:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.familiar_responsable || '',
                  fontSize: 9,
                  colSpan: 3,
                  border: [false, false, false, true],
                },
                {},
                {},
              ],
              [
                {
                  text: 'DOMICILIO:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: this.formatearDireccionMejorada(pacienteCompleto),
                  fontSize: 9,
                  colSpan: 3,
                  border: [false, false, false, true],
                },
                {},
                {},
              ],
              [
                { text: '', border: [false, false, false, false] },
                { text: '', border: [false, false, false, false] },
                { text: '', border: [false, false, false, false] },
                { text: '', border: [false, false, false, false] },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 TABLA DE REGISTROS DE HOSPITALIZACIONES
        {
          table: {
            widths: ['25%', '25%', '25%', '25%'],
            body: [
              [
                {
                  text: 'FECHA DE INGRESO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'FECHA DE EGRESO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'DIAGNÓSTICO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'MÉDICO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
              ],
              // Generar 25 filas vacías para llenar a mano
              ...Array.from({ length: 25 }, (_, index) => [
                {
                  text:
                    index === 0 && expedienteData.registros?.[0]?.fecha_ingreso
                      ? expedienteData.registros[0].fecha_ingreso
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text:
                    index === 0 && expedienteData.registros?.[0]?.fecha_egreso
                      ? expedienteData.registros[0].fecha_egreso
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text:
                    index === 0 && expedienteData.registros?.[0]?.diagnostico
                      ? expedienteData.registros[0].diagnostico
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text:
                    index === 0 && expedienteData.registros?.[0]?.medico
                      ? expedienteData.registros[0].medico
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
              ]),
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        // 🔹 SEGUNDA TABLA DE REGISTROS ADICIONALES
        {
          table: {
            widths: ['25%', '25%', '25%', '25%'],
            body: [
              [
                {
                  text: 'FECHA DE INGRESO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'FECHA DE EGRESO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'DIAGNÓSTICO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'MÉDICO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
              ],
              // Generar 25 filas vacías adicionales
              ...Array.from({ length: 25 }, () => [
                {
                  text: '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text: '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text: '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text: '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
              ]),
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Hoja Frontal de Expediente - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 SOLICITUD DE LABORATORIO SEGÚN NOM-004-SSA3-2012
  async generarSolicitudLaboratorio(datos: any): Promise<any> {
    console.log('🧪 Generando Solicitud de Laboratorio según NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const laboratorioData = datos.solicitudLaboratorio || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [30, 60, 30, 50],

      header: {
        margin: [30, 15, 30, 15],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'INSTITUTO DE SALUD DEL ESTADO DE GUANAJUATO',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
                fontSize: 12,
                bold: true,
                alignment: 'center',
                margin: [0, 2, 0, 0],
              },
            ],
            [
              {
                text: 'SOLICITUD DE ESTUDIOS DE LABORATORIO',
                fontSize: 10,
                bold: true,
                alignment: 'center',
                margin: [0, 5, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 NOTA IMPORTANTE
        {
          text: 'Nota: Favor de pasar a caja para que le indiquen el monto a pagar de sus estudios, si se le indica',
          fontSize: 8,
          italics: true,
          alignment: 'center',
          margin: [0, 0, 0, 5],
        },
        {
          text: 'SEA PUNTUAL A SU CITA',
          fontSize: 9,
          bold: true,
          alignment: 'center',
          margin: [0, 0, 0, 15],
        },

        // 🔹 DATOS DEL PACIENTE
        {
          table: {
            widths: ['20%', '30%', '20%', '30%'],
            body: [
              [
                { text: 'NOMBRE DEL PACIENTE:', fontSize: 8, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 8,
                  colSpan: 3,
                },
                {},
                {},
              ],
              [
                { text: 'FECHA DE NACIMIENTO:', fontSize: 8, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || '',
                  fontSize: 8,
                },
                { text: 'CURP:', fontSize: 8, bold: true },
                { text: pacienteCompleto.curp || '', fontSize: 7 },
              ],
              [
                { text: 'NÚMERO DE EXPEDIENTE:', fontSize: 8, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 8,
                },
                { text: 'No CAUSAS:', fontSize: 8, bold: true },
                { text: laboratorioData.numero_causas || '', fontSize: 8 },
              ],
              [
                {
                  text: 'DIAGNÓSTICO CAUSAS Y/O SMNG SIN ABREVIATURAS:',
                  fontSize: 8,
                  bold: true,
                  colSpan: 4,
                },
                {},
                {},
                {},
              ],
              [
                {
                  text:
                    laboratorioData.diagnostico ||
                    'Diagnóstico por especificar',
                  fontSize: 8,
                  colSpan: 4,
                  margin: [0, 5, 0, 5],
                },
                {},
                {},
                {},
              ],
              [
                { text: 'FECHA DE SOLICITUD:', fontSize: 8, bold: true },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 8,
                },
                { text: 'FECHA PRÓXIMA CONSULTA:', fontSize: 8, bold: true },
                {
                  text: laboratorioData.fecha_proxima_consulta || '',
                  fontSize: 8,
                },
              ],
              [
                { text: 'EDAD:', fontSize: 8, bold: true },
                { text: `${pacienteCompleto.edad} años`, fontSize: 8 },
                { text: 'SERVICIO:', fontSize: 8, bold: true },
                { text: medicoCompleto.departamento, fontSize: 8 },
              ],
              [
                { text: 'No CAMA:', fontSize: 8, bold: true },
                {
                  text: laboratorioData.numero_cama || 'Ambulatorio',
                  fontSize: 8,
                },
                { text: 'PRIORIDAD:', fontSize: 8, bold: true },
                {
                  text: [
                    { text: '☐ URGENTE  ', fontSize: 8 },
                    { text: '☐ RUTINA', fontSize: 8 },
                  ],
                  fontSize: 8,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        // 🔹 ESTUDIOS DE LABORATORIO
        {
          table: {
            widths: ['25%', '25%', '25%', '25%'],
            body: [
              // HEMATOLOGÍA
              [
                {
                  text: 'HEMATOLOGÍA',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
                {
                  text: 'INMUNOHEMATOLOGÍA',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
              ],
              [
                { text: '☐ BIOMETRÍA HEMÁTICA', fontSize: 7 },
                { text: '20109', fontSize: 7, alignment: 'center' },
                { text: '☐ PRUEBAS CRUZADAS', fontSize: 7 },
                { text: '20107', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ GRUPO SANGUÍNEO', fontSize: 7 },
                { text: '20108', fontSize: 7, alignment: 'center' },
                { text: '☐ COOMBS DIRECTO', fontSize: 7 },
                { text: '19210', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ VEL SEDIMENTACIÓN GLOBULAR', fontSize: 7 },
                { text: '20103', fontSize: 7, alignment: 'center' },
                { text: '☐ COOMBS INDIRECTO', fontSize: 7 },
                { text: '19211', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ RETICULOCITOS', fontSize: 7 },
                { text: '20102', fontSize: 7, alignment: 'center' },
                { text: '', fontSize: 7 },
                { text: '', fontSize: 7 },
              ],
              [
                { text: '☐ FROTIS SANGRE GOTA GRUESA', fontSize: 7 },
                { text: '20105', fontSize: 7, alignment: 'center' },
                {
                  text: 'INMUNOLOGÍA',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
              ],
              [
                { text: '☐ FROTIS SANGRE PERIFÉRICA', fontSize: 7 },
                { text: '20105', fontSize: 7, alignment: 'center' },
                { text: '☐ REACCIONES FEBRILES', fontSize: 7 },
                { text: '19201', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ HEMOGLOBINA GLICOSILADA', fontSize: 7 },
                { text: '19303', fontSize: 7, alignment: 'center' },
                { text: '☐ PROTEÍNA C REACTIVA', fontSize: 7 },
                { text: '19206', fontSize: 7, alignment: 'center' },
              ],
              [
                {
                  text: 'PAQUETES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
                { text: '☐ FACTOR REUMATOIDE', fontSize: 7 },
                { text: '19207', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ BIOMETRÍA,VSG,RETICULOCITOS', fontSize: 7 },
                { text: '20202', fontSize: 7, alignment: 'center' },
                { text: '☐ ANTIESTREPTOLISINAS', fontSize: 7 },
                { text: '19205', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '', fontSize: 7 },
                { text: '', fontSize: 7 },
                { text: '☐ VDRL', fontSize: 7 },
                { text: '22131', fontSize: 7, alignment: 'center' },
              ],
              // COAGULACIÓN
              [
                {
                  text: 'COAGULACIÓN',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
                { text: '☐ ANTÍGENO PROSTÁTICO CUALITATIVO', fontSize: 7 },
                { text: '19212', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ T. PROTROMBINA', fontSize: 7 },
                { text: '20113', fontSize: 7, alignment: 'center' },
                { text: '☐ RPR PRUEBA DE SÍFILIS', fontSize: 7 },
                { text: '19206', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ TROMBOPLASTINA PARCIAL', fontSize: 7 },
                { text: '20114', fontSize: 7, alignment: 'center' },
                { text: '☐ HGC Beta CUALITATIVA sérica', fontSize: 7 },
                { text: '19720', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ FIBRINÓGENO', fontSize: 7 },
                { text: '20116', fontSize: 7, alignment: 'center' },
                { text: '☐ PRUEBA DE EMBARAZO EN ORINA', fontSize: 7 },
                { text: '19715', fontSize: 7, alignment: 'center' },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 10],
        },

        // 🔹 SEGUNDA TABLA - BIOQUÍMICA Y OTROS
        {
          table: {
            widths: ['25%', '25%', '25%', '25%'],
            body: [
              // BIOQUÍMICA CLÍNICA
              [
                {
                  text: 'BIOQUÍMICA CLÍNICA',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
                {
                  text: 'URIANALISIS',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
              ],
              [
                { text: '☐ TAMIZ GESTACIONAL 50 G/1HR', fontSize: 7 },
                { text: '19303', fontSize: 7, alignment: 'center' },
                { text: '☐ EXAMEN GENERAL DE ORINA', fontSize: 7 },
                { text: '20201', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ GLUCOSA POST-PRANDIAL', fontSize: 7 },
                { text: '19302', fontSize: 7, alignment: 'center' },
                { text: '☐ CLORO', fontSize: 7 },
                { text: '19601', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ CURVA TOLERANCIA GLUCOSA', fontSize: 7 },
                { text: '19303', fontSize: 7, alignment: 'center' },
                { text: '☐ POTASIO', fontSize: 7 },
                { text: '19601', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ GLUCOSA', fontSize: 7 },
                { text: '19301', fontSize: 7, alignment: 'center' },
                { text: '☐ SODIO', fontSize: 7 },
                { text: '19601', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ UREA/BUN', fontSize: 7 },
                { text: '19304', fontSize: 7, alignment: 'center' },
                { text: '☐ MICROALBUMINURIA EN ORINA 24 HRS', fontSize: 7 },
                { text: '22803', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ CREATININA', fontSize: 7 },
                { text: '19306', fontSize: 7, alignment: 'center' },
                { text: '☐ DEPURACIÓN DE CREATININA', fontSize: 7 },
                { text: '19501', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ ÁCIDO ÚRICO', fontSize: 7 },
                { text: '19307', fontSize: 7, alignment: 'center' },
                { text: '', fontSize: 7 },
                { text: '', fontSize: 7 },
              ],
              [
                { text: '☐ COLESTEROL TOTAL', fontSize: 7 },
                { text: '19307', fontSize: 7, alignment: 'center' },
                {
                  text: 'PARASITOLOGÍA',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
              ],
              [
                { text: '☐ HDL COLESTEROL', fontSize: 7 },
                { text: '19703', fontSize: 7, alignment: 'center' },
                { text: '☐ COPROPARASITOSCÓPICO 3', fontSize: 7 },
                { text: '20001', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ PERFIL DE LÍPIDOS', fontSize: 7 },
                { text: '20203', fontSize: 7, alignment: 'center' },
                { text: '☐ COPROPARASITOSCÓPICO 1', fontSize: 7 },
                { text: '20001', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ TRIGLICÉRIDOS', fontSize: 7 },
                { text: '19702', fontSize: 7, alignment: 'center' },
                { text: '☐ CITOLOGÍA DE MOCO FECAL', fontSize: 7 },
                { text: '20006', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ BILIRRUBINA DIRECTA', fontSize: 7 },
                { text: '19308', fontSize: 7, alignment: 'center' },
                { text: '☐ COPROLÓGICO', fontSize: 7 },
                { text: '20005', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ BILIRRUBINA TOTAL', fontSize: 7 },
                { text: '22118', fontSize: 7, alignment: 'center' },
                { text: '☐ AMIBA EN FRESCO', fontSize: 7 },
                { text: '20006', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ AST (TGO)', fontSize: 7 },
                { text: '19401', fontSize: 7, alignment: 'center' },
                { text: '☐ SANGRE OCULTA EN HECES', fontSize: 7 },
                { text: '19502', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ ALT (TGP)', fontSize: 7 },
                { text: '19402', fontSize: 7, alignment: 'center' },
                { text: '☐ AZÚCARES REDUCTORES', fontSize: 7 },
                { text: '20005', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '☐ FOSFATASA ALCALINA (ALP)', fontSize: 7 },
                { text: '19403', fontSize: 7, alignment: 'center' },
                { text: '☐ ROTAVIRUS', fontSize: 7 },
                { text: '19215', fontSize: 7, alignment: 'center' },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 10],
        },

        // 🔹 TERCERA TABLA - PAQUETES Y OTROS
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: 'PAQUETES DE ESTUDIOS',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  alignment: 'center',
                },
                {
                  text: 'OTROS ESTUDIOS',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  alignment: 'center',
                },
              ],
              [
                { text: '☐ QUÍMICA SANGUÍNEA III (20204)', fontSize: 7 },
                { text: '☐ GASOMETRÍA ARTERIAL (19606)', fontSize: 7 },
              ],
              [
                { text: '☐ QUÍMICA SANGUÍNEA IV (20207)', fontSize: 7 },
                { text: '☐ GASOMETRÍA VENOSA (17301)', fontSize: 7 },
              ],
              [
                { text: '☐ PERFIL HEPÁTICO (20208)', fontSize: 7 },
                { text: '☐ EOSINÓFILOS EN MOCO NASAL (19203)', fontSize: 7 },
              ],
              [
                { text: '☐ PERFIL QUIRÚRGICO (20209)', fontSize: 7 },
                { text: '', fontSize: 7 },
              ],
              [
                { text: '☐ PERFIL REUMÁTICO (20210)', fontSize: 7 },
                {
                  text: 'OTROS ESTUDIOS ESPECIALES:',
                  fontSize: 8,
                  bold: true,
                },
              ],
              [
                { text: '☐ PERFIL CONTROL DE EMBARAZO (20211)', fontSize: 7 },
                {
                  text:
                    laboratorioData.otros_estudios ||
                    '________________________',
                  fontSize: 7,
                  margin: [0, 10, 0, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        // 🔹 DATOS DEL MÉDICO Y HORARIOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: `NOMBRE Y CÉDULA DEL MÉDICO: ${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - Cédula: ${medicoCompleto.numero_cedula}`,
                  fontSize: 8,
                  bold: true,
                  margin: [5, 5, 5, 5],
                },
              ],
              [
                {
                  table: {
                    widths: ['33%', '33%', '34%'],
                    body: [
                      [
                        {
                          text: 'HORA DE TOMA DE MUESTRA:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'HORA DE RECEPCIÓN:',
                          fontSize: 7,
                          bold: true,
                        },
                        { text: 'HORA DE ENTREGA:', fontSize: 7, bold: true },
                      ],
                      [
                        {
                          text: '________________',
                          fontSize: 8,
                          alignment: 'center',
                        },
                        {
                          text: '________________',
                          fontSize: 8,
                          alignment: 'center',
                        },
                        {
                          text: '________________',
                          fontSize: 8,
                          alignment: 'center',
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 5, 5, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [30, 10],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#000000',
                },
                {
                  text: 'Solicitud de Laboratorio - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 SOLICITUD DE IMAGENOLOGIA
  async generarSolicitudImagenologia(datos: any): Promise<any> {
    console.log('📷 Generando Solicitud de Imagenología...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const solicitudData = datos.solicitudImagenologia || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 60, 40, 60],

      header: {
        margin: [40, 20, 40, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
                fontSize: 14,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'SOLICITUD DE IMAGENOLOGÍA',
                fontSize: 16,
                bold: true,
                alignment: 'center',
                margin: [0, 10, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 DATOS DEL PACIENTE
        {
          table: {
            widths: ['30%', '35%', '15%', '20%'],
            body: [
              [
                {
                  text: 'Nombre del (la) paciente:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'No. Expediente:', fontSize: 10, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        {
          table: {
            widths: ['15%', '35%', '15%', '35%'],
            body: [
              [
                { text: 'CURP:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.curp || 'No registrado',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 10, bold: true },
                {
                  text: medicoCompleto.departamento || 'No especificado',
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Cama:', fontSize: 10, bold: true },
                {
                  text: solicitudData.numero_cama || 'Ambulatorio',
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: '', fontSize: 10 },
                { text: '', fontSize: 10 },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        {
          table: {
            widths: ['25%', '20%', '15%', '20%', '20%'],
            body: [
              [
                { text: 'Fecha de nacimiento:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 10, bold: true },
                {
                  text: `${pacienteCompleto.edad} años`,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Género:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 DIAGNÓSTICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Diagnóstico con clave CIE 10:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    solicitudData.diagnostico_cie10 ||
                    '_________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 INTERVENCIÓN CAUSES
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Intervención CAUSES:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    solicitudData.intervencion_causes ||
                    '_________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 ESTUDIOS SOLICITADOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'ESTUDIOS SOLICITADOS:',
                  fontSize: 11,
                  bold: true,
                  margin: [0, 5],
                },
              ],
              [
                {
                  table: {
                    widths: ['5%', '95%'],
                    body: [
                      [
                        { text: '☐', fontSize: 12 },
                        { text: 'Radiografía simple', fontSize: 10 },
                      ],
                      [
                        { text: '☐', fontSize: 12 },
                        { text: 'Ultrasonido', fontSize: 10 },
                      ],
                      [
                        { text: '☐', fontSize: 12 },
                        { text: 'Tomografía', fontSize: 10 },
                      ],
                      [
                        { text: '☐', fontSize: 12 },
                        { text: 'Resonancia magnética', fontSize: 10 },
                      ],
                      [
                        { text: '☐', fontSize: 12 },
                        {
                          text: 'Otro: ____________________________________',
                          fontSize: 10,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [10, 10, 10, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 30],
        },

        // 🔹 ÁREA ESPECÍFICA
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Área específica a estudiar:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    solicitudData.area_estudio ||
                    '______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 JUSTIFICACIÓN
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Justificación médica:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    solicitudData.justificacion ||
                    '______________________________________________________________________________________\n______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        // 🔹 FIRMAS
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: [
                    {
                      text: 'Médico que solicita:\n',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 10,
                    },
                    {
                      text: `Cédula: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 9,
                    },
                    {
                      text: 'Firma: _________________________\n',
                      fontSize: 10,
                    },
                    {
                      text: `Fecha: ${fechaActual.toLocaleDateString('es-MX')}`,
                      fontSize: 9,
                    },
                  ],
                  margin: [0, 10],
                },
                {
                  text: [
                    {
                      text: 'Firma y hora que recibe (camillero):\n',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text: 'Nombre: _________________________\n',
                      fontSize: 10,
                    },
                    {
                      text: 'Firma: _________________________\n',
                      fontSize: 10,
                    },
                    {
                      text: `Hora: ${fechaActual.toLocaleTimeString('es-MX')}`,
                      fontSize: 9,
                    },
                  ],
                  margin: [0, 10],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                { text: '', fontSize: 10 },
                {
                  text: [
                    {
                      text: 'Firma y hora que recibe (técnico rayos X):\n',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text: 'Nombre: _________________________\n',
                      fontSize: 10,
                    },
                    {
                      text: 'Firma: _________________________\n',
                      fontSize: 10,
                    },
                    {
                      text: `Hora: ${fechaActual.toLocaleTimeString('es-MX')}`,
                      fontSize: 9,
                    },
                  ],
                  margin: [0, 10],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Solicitud de Imagenología - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 SOLICITUD DE CULTIVO HOSPITAL MATERNO
  async generarSolicitudCultivo(datos: any): Promise<any> {
    console.log('🧫 Generando Solicitud de Cultivo para Hospital Materno...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const cultivoData = datos.solicitudCultivo || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 40, 20, 40],

      header: function (currentPage: number) {
        return [
          {
            table: {
              widths: ['100%'],
              body: [
                [
                  {
                    text: 'HOSPITAL MATERNO SAN LUIS DE LA PAZ',
                    fontSize: 12,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 10, 0, 0],
                  },
                ],
                [
                  {
                    text: 'N° acceso: ___________________________',
                    fontSize: 10,
                    alignment: 'right',
                    margin: [0, 5, 0, 5],
                  },
                ],
                [
                  {
                    text: 'LABORATORIO CLINICO',
                    fontSize: 12,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 5, 0, 0],
                  },
                ],
                [
                  {
                    text: 'Blvr. Centenario de la Revolución Mexicana N° 110',
                    fontSize: 9,
                    alignment: 'center',
                    margin: [0, 5, 0, 10],
                  },
                ],
                [
                  {
                    text: 'SOLICITUD DE ESTUDIOS DE MICROBIOLOGIA',
                    fontSize: 14,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 10, 0, 15],
                  },
                ],
              ],
            },
            layout: 'noBorders',
            margin: [20, 20, 20, 0],
          },
        ];
      },

      content: [
        // 🔹 DATOS DEL PACIENTE
        {
          table: {
            widths: ['15%', '35%', '10%', '15%', '10%', '15%'],
            body: [
              [
                { text: 'Nombre:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Género:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 10, bold: true },
                {
                  text: `${pacienteCompleto.edad} años`,
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        {
          table: {
            widths: ['20%', '30%', '15%', '35%'],
            body: [
              [
                { text: 'Fecha de solicitud:', fontSize: 10, bold: true },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 10, bold: true },
                {
                  text: medicoCompleto.departamento || 'No especificado',
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        {
          table: {
            widths: ['15%', '25%', '15%', '25%', '10%', '10%'],
            body: [
              [
                { text: 'Cama:', fontSize: 10, bold: true },
                {
                  text: cultivoData.numero_cama || 'Ambulatorio',
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'No. Expediente:', fontSize: 10, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'CURP:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.curp || 'No registrado',
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 FIRMA MÉDICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Nombre y firma del médico solicitante:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}`,
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
              [
                {
                  text: `Cédula: ${medicoCompleto.numero_cedula}   Firma: ___________________________`,
                  fontSize: 10,
                  margin: [0, 10, 0, 0],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 DIAGNÓSTICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Diagnóstico:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    cultivoData.diagnostico ||
                    '______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 RESPONSABLE DE TOMA
        {
          table: {
            widths: ['30%', '70%'],
            body: [
              [
                {
                  text: 'Responsable de la toma de muestra:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text:
                    cultivoData.responsable_muestra ||
                    '___________________________',
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        // 🔹 TIPO DE MUESTRA
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'Tipo de muestra:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  table: {
                    widths: ['15%', '15%', '15%', '15%', '15%', '25%'],
                    body: [
                      [
                        { text: '☐ Líquido', fontSize: 9 },
                        { text: '☐ Secreción', fontSize: 9 },
                        { text: '☐ Sangre', fontSize: 9 },
                        { text: '☐ Catéter', fontSize: 9 },
                        { text: '☐ Orina', fontSize: 9 },
                        { text: '☐ Otro: ___________', fontSize: 9 },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 SITIO DE ORIGEN
        {
          table: {
            widths: ['30%', '70%'],
            body: [
              [
                {
                  text: 'Sitio de origen de la muestra:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text:
                    cultivoData.sitio_origen ||
                    '______________________________________________________________________________________',
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 TIPO DE MICROORGANISMO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'En caso de requerir cultivo especificar el tipo de microorganismo a buscar:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    cultivoData.microorganismo_buscar ||
                    '______________________________________________________________________________________\n______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 TINCIÓN
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'Tinción:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  table: {
                    widths: ['15%', '15%', '15%', '15%', '40%'],
                    body: [
                      [
                        { text: '☐ Tinta china', fontSize: 9 },
                        { text: '☐ Gram', fontSize: 9 },
                        { text: '☐ BAAR', fontSize: 9 },
                        { text: '☐ KINYOUN', fontSize: 9 },
                        { text: '☐ Otro: ___________', fontSize: 9 },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 ANTIBIÓTICO
        {
          table: {
            widths: ['30%', '15%', '55%'],
            body: [
              [
                {
                  text: '¿El paciente recibe antibiótico?',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: cultivoData.recibe_antibiotico
                    ? '☑ Sí   ☐ No'
                    : '☐ Sí   ☑ No',
                  fontSize: 10,
                },
                {
                  text:
                    '¿Cuál? ' +
                    (cultivoData.antibiotico_actual ||
                      '___________________________'),
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 CULTIVOS ANTERIORES
        {
          table: {
            widths: ['40%', '15%', '45%'],
            body: [
              [
                {
                  text: '¿Se han realizado cultivos anteriormente?',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: cultivoData.cultivos_previos
                    ? '☑ Sí   ☐ No'
                    : '☐ Sí   ☑ No',
                  fontSize: 10,
                },
                {
                  text: '',
                  fontSize: 10,
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 MICROORGANISMOS AISLADOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Microorganismos aislados encontrados:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    cultivoData.microorganismos_aislados ||
                    '______________________________________________________________________________________\n______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        // 🔹 COMENTARIOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Comentarios:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    cultivoData.comentarios ||
                    '______________________________________________________________________________________\n______________________________________________________________________________________\n______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        // 🔹 ETIQUETA DE FOLIO (DUPLICATE HEADER)
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Etiqueta de folio: ___________________________',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 20, 0, 0],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 10],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#666666',
                },
                {
                  text: 'Solicitud de Cultivo - Hospital Materno\nSICEG - NOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 NOTA DE EGRESO SEGÚN NOM-004-SSA3-2012 SECCIÓN D12
  async generarNotaEgreso(datos: any): Promise<any> {
    console.log('   Generando Nota de Egreso según NOM-004-SSA3-2012...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const egresoData = datos.notaEgreso || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA DE EGRESO',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 IDENTIFICACIÓN DEL PACIENTE (NOM-004 5.2)
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIÓN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha egreso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora egreso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. de cama',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio egreso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            egresoData.fecha_egreso ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            egresoData.hora_egreso ||
                            fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: egresoData.numero_cama || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `EG-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['60%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} años`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '50%'],
                    body: [
                      [
                        {
                          text: 'Fecha y hora ingreso hospitalario',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Días de estancia en la unidad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            egresoData.fecha_ingreso || 'No registrada'
                          } - ${egresoData.hora_ingreso || 'No registrada'}`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${
                            egresoData.dias_estancia ||
                            datos.diasHospitalizacion
                          } días`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['60%', '40%'],
                    body: [
                      [
                        {
                          text: 'Servicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Reingreso por la misma afección en el año',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'No especificado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: egresoData.es_reingreso ? 'SÍ' : 'NO',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: egresoData.es_reingreso
                            ? '#dc2626'
                            : '#059669',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 SIGNOS VITALES AL EGRESO (NOM-004 D12.4)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'SIGNOS VITALES AL EGRESO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  table: {
                    widths: ['16%', '16%', '16%', '16%', '16%', '20%'],
                    body: [
                      [
                        {
                          text: 'Peso',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Talla',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Presión arterial',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'FC',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'FR',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Temperatura',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${signosVitales.peso || '___'} kg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${signosVitales.talla || '___'} cm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.presion_arterial_sistolica || '___'
                          }/${
                            signosVitales.presion_arterial_diastolica || '___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_cardiaca || '___'
                          } lpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_respiratoria || '___'
                          } rpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${signosVitales.temperatura || '___'} °C`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Estado general al egreso',
                          fontSize: 7,
                          bold: true,
                          fillColor: '#f9f9f9',
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            egresoData.estado_general_egreso ||
                            'Estable, sin signos de alarma.',
                          fontSize: 8,
                          margin: [3, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 DIAGNÓSTICOS (NOM-004 D12.8 y D12.11)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'DIAGNÓSTICOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'DIAGNÓSTICO(S) DE INGRESO (D12.8)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.diagnosticos_ingreso ||
                    'No especificados en el momento del ingreso.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'DIAGNÓSTICO(S) FINAL(ES) (D12.11)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.diagnosticos_finales ||
                    'Diagnósticos finales por definir.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 EVOLUCIÓN Y MANEJO (NOM-004 D12.9 y D12.10)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EVOLUCIÓN Y MANEJO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'RESUMEN DE LA EVOLUCIÓN Y ESTADO ACTUAL (D12.9)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.resumen_evolucion ||
                    'Evolución clínica favorable durante la estancia hospitalaria.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MANEJO DURANTE LA ESTANCIA HOSPITALARIA (D12.10)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.manejo_hospitalario ||
                    'Manejo médico integral según protocolos institucionales.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 PROCEDIMIENTOS Y MOTIVO DE EGRESO (NOM-004 D12.12 y D12.13)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PROCEDIMIENTOS Y EGRESO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'PROCEDIMIENTOS REALIZADOS (D12.12)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.procedimientos_realizados ||
                    'Sin procedimientos especiales durante la estancia.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MOTIVO DE EGRESO (D12.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text:
                            egresoData.motivo_egreso === 'maximo_beneficio'
                              ? '☑ Máximo beneficio'
                              : '☐ Máximo beneficio',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text:
                            egresoData.motivo_egreso === 'mejoria'
                              ? '☑ Por mejoría'
                              : '☐ Por mejoría',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text:
                            egresoData.motivo_egreso === 'alta_voluntaria'
                              ? '☑ Alta voluntaria'
                              : '☐ Alta voluntaria',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text:
                            egresoData.motivo_egreso === 'exitus'
                              ? '☑ Exitus'
                              : '☐ Exitus',
                          fontSize: 7,
                          alignment: 'center',
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 PROBLEMAS PENDIENTES Y PLAN (NOM-004 D12.14 y D12.15)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'SEGUIMIENTO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'PROBLEMAS CLÍNICOS PENDIENTES (D12.14)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.problemas_pendientes ||
                    'Sin problemas clínicos pendientes al momento del egreso.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'PLAN DE MANEJO Y TRATAMIENTO (D12.15)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.plan_manejo_tratamiento ||
                    'Continuar manejo ambulatorio según indicaciones médicas.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'RECOMENDACIONES PARA VIGILANCIA AMBULATORIA (D12.16)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.recomendaciones_ambulatorias ||
                    'Control médico en consulta externa según programación. Acudir a urgencias en caso de signos de alarma.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        // 🔹 MÉDICO RESPONSABLE SEGÚN NOM-004 (D12.17)
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: 'NOMBRE COMPLETO, CÉDULA PROFESIONAL Y FIRMA DEL MÉDICO (D12.17)',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: 'FIRMA AUTÓGRAFA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `Cédula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `${medicoCompleto.cargo} - ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Hospital General San Luis de la Paz\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Fecha: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Hora: ${fechaActual.toLocaleTimeString('es-MX')}`,
                      fontSize: 7,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
                {
                  text: '\n\n\n\n_________________________\nFIRMA DEL MÉDICO TRATANTE\n(NOM-004-SSA3-2012)',
                  fontSize: 8,
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        // 🔹 NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Sección D12 "Nota de egreso"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos establecidos en los numerales D12.1 al D12.17',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota de Egreso - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 NOTA DE INTERCONSULTA SEGÚN NOM-004-SSA3-2012 SECCIÓN D7
  async generarNotaInterconsulta(datos: any): Promise<any> {
    console.log(
      '  Generando Nota de Interconsulta según NOM-004-SSA3-2012...'
    );

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const interconsultaData = datos.notaInterconsulta || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA DE INTERCONSULTA',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 IDENTIFICACIÓN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIÓN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha interconsulta',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora interconsulta',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. de cama',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio interconsulta',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: interconsultaData.numero_cama || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `IC-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['60%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} años`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '50%'],
                    body: [
                      [
                        {
                          text: 'Servicio solicitante',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Especialidad solicitada',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'No especificado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            interconsultaData.especialidad_solicitada ||
                            'No especificada',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Médico que solicita interconsulta',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - Cédula: ${medicoCompleto.numero_cedula}`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 MOTIVO DE LA CONSULTA (NOM-004 D7.14)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'SOLICITUD DE INTERCONSULTA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'MOTIVO DE LA CONSULTA (D7.14)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.motivo_consulta ||
                    'Motivo de interconsulta no especificado.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'PROBLEMA CLÍNICO ESPECÍFICO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.problema_clinico ||
                    'Se solicita valoración y manejo por especialidad correspondiente.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 ANTECEDENTES RELEVANTES
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ANTECEDENTES RELEVANTES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'ANTECEDENTES PERSONALES PATOLÓGICOS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.antecedentes_patologicos ||
                    'Sin antecedentes patológicos de importancia.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MEDICAMENTOS ACTUALES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.medicamentos_actuales ||
                    'Sin medicamentos de base reportados.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 EXPLORACIÓN FÍSICA RELEVANTE
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EXPLORACIÓN FÍSICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'SIGNOS VITALES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Presión arterial',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia cardíaca',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia respiratoria',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Temperatura',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            signosVitales.presion_arterial_sistolica || '___'
                          }/${
                            signosVitales.presion_arterial_diastolica || '___'
                          } mmHg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_cardiaca || '___'
                          } lpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_respiratoria || '___'
                          } rpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${signosVitales.temperatura || '___'} °C`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 2],
                },
              ],
              [
                {},
                {
                  text: 'HALLAZGOS RELEVANTES PARA INTERCONSULTA',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.hallazgos_relevantes ||
                    'Exploración física dirigida según el motivo de interconsulta.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 ESTUDIOS DISPONIBLES
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTUDIOS DISPONIBLES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'LABORATORIO Y GABINETE',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.estudios_disponibles ||
                    'Se adjuntan estudios de laboratorio y gabinete disponibles en el expediente.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 RESPUESTA DEL ESPECIALISTA
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'RESPUESTA DEL ESPECIALISTA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#e0f2fe',
                  alignment: 'center',
                  rowSpan: 8,
                },
                {
                  text: 'CRITERIO DIAGNÓSTICO (D7.12)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.criterio_diagnostico ||
                    '________________________________________________________________________________________\n________________________________________________________________________________________',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'SUGERENCIAS DIAGNÓSTICAS (D7.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.sugerencias_diagnosticas ||
                    '________________________________________________________________________________________\n________________________________________________________________________________________',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'SUGERENCIAS DE TRATAMIENTO (D7.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.sugerencias_tratamiento ||
                    '________________________________________________________________________________________\n________________________________________________________________________________________',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'ESTUDIOS ADICIONALES SUGERIDOS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.estudios_sugeridos ||
                    '________________________________________________________________________________________',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        // 🔹 FIRMAS
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: 'MÉDICO QUE SOLICITA INTERCONSULTA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: 'MÉDICO ESPECIALISTA CONSULTADO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#e0f2fe',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `Cédula: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )}\n`,
                      fontSize: 7,
                    },
                    {
                      text: '\n_________________________\nFIRMA',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
                {
                  text: [
                    {
                      text: `${
                        interconsultaData.especialista_nombre ||
                        '__________________________'
                      }\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `Cédula: ${
                        interconsultaData.especialista_cedula ||
                        '______________'
                      }\n`,
                      fontSize: 8,
                    },
                    {
                      text: `${
                        interconsultaData.especialidad_solicitada ||
                        '__________________________'
                      }\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha: ${
                        interconsultaData.fecha_respuesta || '______________'
                      }\n`,
                      fontSize: 7,
                    },
                    {
                      text: '\n_________________________\nFIRMA',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        // 🔹 NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Sección D7 "Notas de interconsulta"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos establecidos en los numerales D7.12, D7.13 y D7.14',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota de Interconsulta - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 PRESCRIPCIÓN DE MEDICAMENTOS SEGÚN NOM-004-SSA3-2012
  async generarPrescripcionMedicamentos(datos: any): Promise<any> {
    console.log('💊 Generando Prescripción de Medicamentos según NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const prescripcionData = datos.prescripcionMedicamentos || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [30, 60, 30, 50],

      header: {
        margin: [30, 15, 30, 15],
        table: {
          widths: ['20%', '60%', '20%'],
          body: [
            [
              {
                text: '💊',
                fontSize: 24,
                alignment: 'center',
                color: '#059669',
              },
              {
                text: [
                  {
                    text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ\n',
                    fontSize: 13,
                    bold: true,
                    alignment: 'center',
                  },
                  {
                    text: 'PRESCRIPCIÓN MÉDICA\n',
                    fontSize: 11,
                    bold: true,
                    alignment: 'center',
                  },
                  {
                    text: 'Blvd. Centenario de la Revolución Mexicana #110',
                    fontSize: 8,
                    alignment: 'center',
                  },
                ],
              },
              {
                text: [
                  { text: 'Folio:\n', fontSize: 8, bold: true },
                  {
                    text: `PM-${this.obtenerNumeroExpedientePreferido(
                      pacienteCompleto.expediente
                    )}-${fechaActual.getFullYear()}\n`,
                    fontSize: 7,
                  },
                  { text: 'Fecha:\n', fontSize: 8, bold: true },
                  {
                    text: fechaActual.toLocaleDateString('es-MX'),
                    fontSize: 8,
                  },
                ],
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 DATOS DEL PACIENTE
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DATOS DEL PACIENTE',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  margin: [0, 3, 0, 3],
                },
              ],
              [
                {
                  table: {
                    widths: ['20%', '30%', '20%', '30%'],
                    body: [
                      [
                        { text: 'Nombre:', fontSize: 8, bold: true },
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                        },
                        { text: 'Expediente:', fontSize: 8, bold: true },
                        {
                          text: this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          ),
                          fontSize: 8,
                          bold: true,
                        },
                      ],
                      [
                        { text: 'Edad:', fontSize: 8, bold: true },
                        {
                          text: `${pacienteCompleto.edad} años`,
                          fontSize: 8,
                        },
                        { text: 'Sexo:', fontSize: 8, bold: true },
                        { text: pacienteCompleto.sexo, fontSize: 8 },
                      ],
                      [
                        { text: 'Peso:', fontSize: 8, bold: true },
                        {
                          text: `${prescripcionData.peso_paciente || '___'} kg`,
                          fontSize: 8,
                        },
                        { text: 'Alergias:', fontSize: 8, bold: true },
                        {
                          text:
                            prescripcionData.alergias_conocidas ||
                            'No conocidas',
                          fontSize: 8,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 5, 5, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        // 🔹 DIAGNÓSTICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DIAGNÓSTICO:',
                  fontSize: 9,
                  bold: true,
                  margin: [5, 5, 5, 2],
                },
              ],
              [
                {
                  text:
                    prescripcionData.diagnostico ||
                    'Diagnóstico por especificar',
                  fontSize: 9,
                  margin: [5, 2, 5, 8],
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        // 🔹 MEDICAMENTOS PRESCRITOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Rp/ MEDICAMENTOS PRESCRITOS',
                  fontSize: 10,
                  bold: true,
                  fillColor: '#f0f9ff',
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 5],
        },

        // 🔹 TABLA DE MEDICAMENTOS
        {
          table: {
            widths: ['5%', '35%', '20%', '15%', '25%'],
            body: [
              // Encabezados
              [
                {
                  text: '#',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#e0f2fe',
                },
                {
                  text: 'MEDICAMENTO\n(Denominación genérica)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#e0f2fe',
                },
                {
                  text: 'PRESENTACIÓN\nY CONCENTRACIÓN',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#e0f2fe',
                },
                {
                  text: 'CANTIDAD',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#e0f2fe',
                },
                {
                  text: 'INDICACIONES\n(Dosis, vía, frecuencia)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#e0f2fe',
                },
              ],
              // Generar filas de medicamentos (máximo 10)
              ...Array.from({ length: 10 }, (_, index) => {
                const medicamento = prescripcionData.medicamentos?.[index];
                return [
                  {
                    text: (index + 1).toString(),
                    fontSize: 8,
                    alignment: 'center',
                    margin: [0, 8, 0, 8],
                  },
                  {
                    text: medicamento?.nombre_generico || '',
                    fontSize: 9,
                    margin: [3, 8, 3, 8],
                    bold: !!medicamento?.nombre_generico,
                  },
                  {
                    text: medicamento?.presentacion || '',
                    fontSize: 8,
                    margin: [3, 8, 3, 8],
                    alignment: 'center',
                  },
                  {
                    text: medicamento?.cantidad || '',
                    fontSize: 8,
                    margin: [3, 8, 3, 8],
                    alignment: 'center',
                  },
                  {
                    text: medicamento?.indicaciones || '',
                    fontSize: 8,
                    margin: [3, 8, 3, 8],
                  },
                ];
              }),
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        // 🔹 INSTRUCCIONES GENERALES
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INSTRUCCIONES GENERALES AL PACIENTE:',
                  fontSize: 9,
                  bold: true,
                  margin: [5, 5, 5, 2],
                },
              ],
              [
                {
                  text:
                    prescripcionData.instrucciones_generales ||
                    '• Tomar los medicamentos según las indicaciones médicas\n' +
                      '• Completar el tratamiento aunque se sienta mejor\n' +
                      '• No suspender medicamentos sin autorización médica\n' +
                      '• Acudir a control médico en la fecha indicada\n' +
                      '• En caso de reacciones adversas, suspender y acudir al médico',
                  fontSize: 8,
                  margin: [5, 5, 5, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        // 🔹 PRÓXIMA CITA
        {
          table: {
            widths: ['70%', '30%'],
            body: [
              [
                {
                  text: `PRÓXIMA CITA: ${
                    prescripcionData.proxima_cita || '___________________'
                  }`,
                  fontSize: 9,
                  bold: true,
                  margin: [5, 8, 5, 8],
                },
                {
                  text: `DÍAS DE TRATAMIENTO: ${
                    prescripcionData.dias_tratamiento || '____'
                  } días`,
                  fontSize: 9,
                  bold: true,
                  margin: [5, 8, 5, 8],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        // 🔹 FIRMA DEL MÉDICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DATOS DEL MÉDICO PRESCRIPTOR',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
              [
                {
                  text: [
                    {
                      text: `Nombre: ${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `Cédula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de prescripción: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )}\n`,
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 10, 5, 5],
                  alignment: 'left',
                },
              ],
              [
                {
                  text: '\n\n_____________________________________\nFIRMA Y SELLO DEL MÉDICO',
                  fontSize: 9,
                  alignment: 'center',
                  margin: [0, 10, 0, 15],
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 10] },

        // 🔹 ADVERTENCIAS LEGALES
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: '  ADVERTENCIAS IMPORTANTES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  margin: [0, 3, 0, 3],
                },
              ],
              [
                {
                  text:
                    '• Esta prescripción es válida únicamente para el paciente indicado\n' +
                    '• Los medicamentos controlados requieren presentar receta original\n' +
                    '• Conservar en lugar fresco y seco, fuera del alcance de los niños\n' +
                    '• No automedicarse ni compartir medicamentos\n' +
                    '• En caso de emergencia comunicarse al Hospital: Tel. (468) 688-0001',
                  fontSize: 7,
                  margin: [5, 5, 5, 5],
                  lineHeight: 1.2,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#f59e0b',
            vLineColor: () => '#f59e0b',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [30, 10],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Prescripción Médica - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 REGISTRO DE TRANSFUSIÓN SEGÚN NOM-004-SSA3-2012 SECCIÓN D15
  async generarRegistroTransfusion(datos: any): Promise<any> {
    console.log(
      '🩸 Generando Registro de Transfusión según NOM-004 y NOM-253...'
    );

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const transfusionData = datos.registroTransfusion || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 60, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - REGISTRO DE TRANSFUSIÓN',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'REGISTRO DE TRANSFUSIÓN DE UNIDADES DE SANGRE O COMPONENTES',
                fontSize: 9,
                bold: true,
                alignment: 'center',
                margin: [0, 3, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 IDENTIFICACIÓN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIÓN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha transfusión',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora inicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. de cama',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio registro',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            transfusionData.fecha_transfusion ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            transfusionData.hora_inicio ||
                            fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: transfusionData.numero_cama || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `RT-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} años`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['40%', '30%', '30%'],
                    body: [
                      [
                        {
                          text: 'Servicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Diagnóstico',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo sanguíneo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'No especificado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            transfusionData.diagnostico || 'No especificado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.tipo_sangre || 'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Médico que indica la transfusión',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - Cédula: ${medicoCompleto.numero_cedula}`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 INFORMACIÓN DE LAS UNIDADES TRANSFUNDIDAS (NOM-004 D15.1)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'UNIDADES TRANSFUNDIDAS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fee2e2',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'INFORMACIÓN DE UNIDADES DE SANGRE O COMPONENTES (D15.1)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef2f2',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Tipo de componente',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Cantidad de unidades',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Volumen total (ml)',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. identificación',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            transfusionData.tipo_componente ||
                            'Concentrado eritrocitario',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: transfusionData.cantidad_unidades || '1',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                        {
                          text: transfusionData.volumen_total || '250',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: transfusionData.numero_identificacion || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  text: 'FECHA Y HORA DE INICIO Y FINALIZACIÓN (D15.2)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef2f2',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Fecha inicio',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora inicio',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Fecha finalización',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora finalización',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            transfusionData.fecha_inicio ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            transfusionData.hora_inicio ||
                            fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            transfusionData.fecha_finalizacion ||
                            '______________',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            transfusionData.hora_finalizacion ||
                            '______________',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 CONTROL DE SIGNOS VITALES (NOM-004 D15.3)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'CONTROL SIGNOS VITALES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#dbeafe',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'SIGNOS VITALES ANTES, DURANTE Y DESPUÉS DE LA TRANSFUSIÓN (D15.3)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#eff6ff',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Momento',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Presión arterial',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia cardíaca',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Temperatura',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: 'ANTES',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                          fillColor: '#f0f9ff',
                        },
                        {
                          text: `${
                            signosVitales.presion_arterial_sistolica || '___'
                          }/${
                            signosVitales.presion_arterial_diastolica || '___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_cardiaca || '___'
                          } lpm`,
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: `${signosVitales.temperatura || '___'} °C`,
                          fontSize: 7,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: 'DURANTE',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                          fillColor: '#f0f9ff',
                        },
                        {
                          text: transfusionData.pa_durante || '__________',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: transfusionData.fc_durante || '___ lpm',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: transfusionData.temp_durante || '___ °C',
                          fontSize: 7,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: 'DESPUÉS',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                          fillColor: '#f0f9ff',
                        },
                        {
                          text: transfusionData.pa_despues || '__________',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: transfusionData.fc_despues || '___ lpm',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: transfusionData.temp_despues || '___ °C',
                          fontSize: 7,
                          alignment: 'center',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  text: 'ESTADO GENERAL DEL PACIENTE',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#eff6ff',
                },
              ],
              [
                {},
                {
                  text:
                    transfusionData.estado_general ||
                    'Paciente estable durante todo el procedimiento de transfusión. Sin signos de reacciones adversas.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 REACCIONES ADVERSAS (NOM-004 D15.4)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'REACCIONES ADVERSAS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'REACCIONES ADVERSAS A LA TRANSFUSIÓN (D15.4)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['20%', '80%'],
                    body: [
                      [
                        {
                          text: transfusionData.hubo_reacciones
                            ? '☑ SÍ'
                            : '☑ NO',
                          fontSize: 8,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Se presentaron reacciones adversas durante o después de la transfusión',
                          fontSize: 8,
                          alignment: 'left',
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                },
              ],
              [
                {},
                {
                  text: 'TIPO DE REACCIÓN Y MANEJO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  text:
                    transfusionData.tipo_reaccion_manejo ||
                    (transfusionData.hubo_reacciones
                      ? 'Describir tipo de reacción: _________________________________\nManejo aplicado: _________________________________'
                      : 'Sin reacciones adversas reportadas durante el procedimiento.'),
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 PERSONAL RESPONSABLE (NOM-004 D15.5)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PERSONAL RESPONSABLE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0fdf4',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'MÉDICO QUE INDICÓ LA TRANSFUSIÓN (D15.5)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - Cédula: ${medicoCompleto.numero_cedula}`,
                  fontSize: 8,
                  margin: [5, 3],
                  bold: true,
                },
              ],
              [
                {},
                {
                  text: 'PERSONAL DE SALUD ENCARGADO DE APLICACIÓN Y VIGILANCIA (D15.5)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '50%'],
                    body: [
                      [
                        {
                          text: 'Nombre del personal de enfermería:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Cédula profesional:',
                          fontSize: 7,
                          bold: true,
                        },
                      ],
                      [
                        {
                          text:
                            transfusionData.enfermera_responsable ||
                            '____________________________',
                          fontSize: 8,
                          decoration: 'underline',
                        },
                        {
                          text:
                            transfusionData.cedula_enfermera ||
                            '____________________________',
                          fontSize: 8,
                          decoration: 'underline',
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'OBSERVACIONES ADICIONALES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    transfusionData.observaciones_adicionales ||
                    'Transfusión realizada sin complicaciones. Paciente toleró bien el procedimiento.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        // 🔹 FIRMAS MÚLTIPLES SEGÚN NOM-004
        {
          table: {
            widths: ['33.33%', '33.33%', '33.34%'],
            body: [
              [
                {
                  text: 'MÉDICO QUE INDICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: 'PERSONAL DE ENFERMERÍA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: 'BANCO DE SANGRE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 8,
                      bold: true,
                    },
                    {
                      text: `Cédula: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `${medicoCompleto.especialidad}\n`,
                      fontSize: 7,
                    },
                    {
                      text: '\n\n_____________________\nFIRMA',
                      fontSize: 7,
                    },
                  ],
                  margin: [2, 10],
                  alignment: 'center',
                },
                {
                  text: [
                    {
                      text: `${
                        transfusionData.enfermera_responsable ||
                        '__________________'
                      }\n`,
                      fontSize: 8,
                      bold: true,
                    },
                    {
                      text: `Cédula: ${
                        transfusionData.cedula_enfermera || '__________'
                      }\n`,
                      fontSize: 7,
                    },
                    {
                      text: 'Enfermería\n',
                      fontSize: 7,
                    },
                    {
                      text: '\n\n_____________________\nFIRMA',
                      fontSize: 7,
                    },
                  ],
                  margin: [2, 10],
                  alignment: 'center',
                },
                {
                  text: [
                    {
                      text: `${
                        transfusionData.responsable_banco_sangre ||
                        '__________________'
                      }\n`,
                      fontSize: 8,
                      bold: true,
                    },
                    {
                      text: `Cédula: ${
                        transfusionData.cedula_banco || '__________'
                      }\n`,
                      fontSize: 7,
                    },
                    {
                      text: 'Banco de Sangre\n',
                      fontSize: 7,
                    },
                    {
                      text: '\n\n_____________________\nFIRMA',
                      fontSize: 7,
                    },
                  ],
                  margin: [2, 10],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        // 🔹 NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Registro elaborado conforme a NOM-004-SSA3-2012, Sección D15 "Registro de transfusión"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con NOM-253-SSA1-2012 para disposición de sangre humana y componentes',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Registro de Transfusión - SICEG\nNOM-004-SSA3-2012 | NOM-253-SSA1-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 NOTA PREOPERATORIA SEGÚN NOM-004-SSA3-2012 SECCIÓN 8.5
  async generarNotaPreoperatoria(datos: any): Promise<any> {
    console.log('🔪 Generando Nota Preoperatoria según NOM-004-SSA3-2012...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const preoperatoriaData = datos.notaPreoperatoria || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA PREOPERATORIA',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 IDENTIFICACIÓN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIÓN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha cirugía',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora programada',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Quirófano',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio nota',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            preoperatoriaData.fecha_cirugia ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: preoperatoriaData.hora_programada || '00:00',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: preoperatoriaData.quirofano || 'Por asignar',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `NPO-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} años`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['40%', '30%', '30%'],
                    body: [
                      [
                        {
                          text: 'Servicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Peso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo sanguíneo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'Cirugía General',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${signosVitales.peso || '___'} kg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.tipo_sangre || 'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Cirujano responsable',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - Cédula: ${medicoCompleto.numero_cedula}`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 DIAGNÓSTICO PREOPERATORIO (NOM-004 8.5.2)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EVALUACIÓN PREOPERATORIA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'DIAGNÓSTICO PREOPERATORIO (8.5.2)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.diagnostico_preoperatorio ||
                    'Diagnóstico preoperatorio por especificar.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
              [
                {},
                {
                  text: 'PLAN QUIRÚRGICO (8.5.3)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.plan_quirurgico ||
                    'Plan quirúrgico por definir según evaluación.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'TIPO DE INTERVENCIÓN QUIRÚRGICA (8.5.4)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.tipo_intervencion ||
                    'Tipo de intervención por especificar.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 RIESGO QUIRÚRGICO (NOM-004 8.5.5)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EVALUACIÓN DE RIESGO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'RIESGO QUIRÚRGICO (8.5.5)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text:
                            preoperatoriaData.riesgo_quirurgico === 'bajo'
                              ? '☑ BAJO'
                              : '☐ BAJO',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preoperatoriaData.riesgo_quirurgico === 'moderado'
                              ? '☑ MODERADO'
                              : '☐ MODERADO',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preoperatoriaData.riesgo_quirurgico === 'alto'
                              ? '☑ ALTO'
                              : '☐ ALTO',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preoperatoriaData.riesgo_quirurgico === 'muy_alto'
                              ? '☑ MUY ALTO'
                              : '☐ MUY ALTO',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'JUSTIFICACIÓN DEL RIESGO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.justificacion_riesgo ||
                    'Paciente con riesgo quirúrgico apropiado para el procedimiento programado.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 CUIDADOS PREOPERATORIOS (NOM-004 8.5.6)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'CUIDADOS PREOPERATORIOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#e0f2fe',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'CUIDADOS Y PLAN TERAPÉUTICO PREOPERATORIO (8.5.6)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.cuidados_preoperatorios ||
                    '• Ayuno mínimo 8 horas para sólidos, 2 horas para líquidos claros\n' +
                      '• Baño preoperatorio con jabón antiséptico\n' +
                      '• Verificar retiro de prótesis dentales, joyas y lentes de contacto\n' +
                      '• Administrar premedicación según indicación anestésica\n' +
                      '• Verificar consentimiento informado firmado',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MEDICACIÓN PREOPERATORIA',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.medicacion_preoperatoria ||
                    'Según indicación del anestesiólogo.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 ESTUDIOS PREOPERATORIOS
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTUDIOS PREOPERATORIOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0fdf4',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'LABORATORIO PREOPERATORIO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.laboratorio_preoperatorio ||
                    'Biometría hemática, química sanguínea, tiempos de coagulación según protocolo.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'ESTUDIOS DE GABINETE',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.gabinete_preoperatorio ||
                    'Radiografía de tórax, electrocardiograma según protocolo y edad del paciente.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 PRONÓSTICO (NOM-004 8.5.7)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PRONÓSTICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: `PRONÓSTICO (8.5.7): ${
                    preoperatoriaData.pronostico ||
                    'Favorable para la vida y función, reservado a la evolución transoperatoria y postoperatoria.'
                  }`,
                  fontSize: 8,
                  margin: [5, 8],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        // 🔹 EQUIPO QUIRÚRGICO PROGRAMADO
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EQUIPO QUIRÚRGICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'EQUIPO QUIRÚRGICO PROGRAMADO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Cirujano:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Ayudante:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Anestesiólogo:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Instrumentista:',
                          fontSize: 7,
                          bold: true,
                        },
                      ],
                      [
                        {
                          text: medicoCompleto.nombre_completo,
                          fontSize: 7,
                        },
                        {
                          text:
                            preoperatoriaData.ayudante || '________________',
                          fontSize: 7,
                        },
                        {
                          text:
                            preoperatoriaData.anestesiologo ||
                            '________________',
                          fontSize: 7,
                        },
                        {
                          text:
                            preoperatoriaData.instrumentista ||
                            '________________',
                          fontSize: 7,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [3, 2],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        // 🔹 FIRMA DEL CIRUJANO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'CIRUJANO RESPONSABLE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `Cédula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de elaboración: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} - ${fechaActual.toLocaleTimeString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: '\n\n_____________________________________\nFIRMA DEL CIRUJANO RESPONSABLE',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        // 🔹 NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Sección 8.5 "Nota preoperatoria"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos establecidos en los numerales 8.5.1 al 8.5.7',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota Preoperatoria - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 NOTA POSTOPERATORIA SEGÚN NOM-004-SSA3-2012 SECCIÓN 8.8
  async generarNotaPostoperatoria(datos: any): Promise<any> {
    console.log('   Generando Nota Postoperatoria según NOM-004-SSA3-2012...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const postoperatoriaData = datos.notaPostoperatoria || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA POSTOPERATORIA',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 IDENTIFICACIÓN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIÓN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha cirugía',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora finalización',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Quirófano',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Duración cirugía',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            postoperatoriaData.fecha_cirugia ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text:
                            postoperatoriaData.hora_finalizacion ||
                            fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: postoperatoriaData.quirofano || 'Q1',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            postoperatoriaData.duracion_cirugia || '_____ min',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} años`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['40%', '30%', '30%'],
                    body: [
                      [
                        {
                          text: 'Servicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo sanguíneo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'ASA',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'Cirugía General',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.tipo_sangre || 'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                        {
                          text:
                            postoperatoriaData.clasificacion_asa || 'ASA II',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Cirujano responsable',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - Cédula: ${medicoCompleto.numero_cedula}`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 DIAGNÓSTICOS Y OPERACIONES (NOM-004 8.8.1-8.8.4)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'DIAGNÓSTICOS Y PROCEDIMIENTOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 8,
                },
                {
                  text: 'DIAGNÓSTICO PREOPERATORIO (8.8.1)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.diagnostico_preoperatorio ||
                    'Diagnóstico preoperatorio.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'OPERACIÓN PLANEADA (8.8.2)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.operacion_planeada ||
                    'Operación programada.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'OPERACIÓN REALIZADA (8.8.3)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.operacion_realizada ||
                    'Operación efectivamente realizada.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
              [
                {},
                {
                  text: 'DIAGNÓSTICO POSTOPERATORIO (8.8.4)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.diagnostico_postoperatorio ||
                    'Diagnóstico postoperatorio.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 DESCRIPCIÓN TÉCNICA QUIRÚRGICA (NOM-004 8.8.5)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'TÉCNICA QUIRÚRGICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#e0f2fe',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'DESCRIPCIÓN DE LA TÉCNICA QUIRÚRGICA (8.8.5)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.descripcion_tecnica ||
                    'Descripción detallada de la técnica quirúrgica empleada.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'HALLAZGOS TRANSOPERATORIOS (8.8.6)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.hallazgos_transoperatorios ||
                    'Hallazgos encontrados durante el procedimiento quirúrgico.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 CONTROL QUIRÚRGICO (NOM-004 8.8.7-8.8.9)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'CONTROL QUIRÚRGICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'REPORTE DE CONTEO DE GASAS, COMPRESAS E INSTRUMENTAL (8.8.7)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['33%', '33%', '34%'],
                    body: [
                      [
                        {
                          text: 'Gasas',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Compresas',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Instrumental',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            postoperatoriaData.conteo_gasas || 'Completo ✓'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${
                            postoperatoriaData.conteo_compresas || 'Completo ✓'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${
                            postoperatoriaData.conteo_instrumental ||
                            'Completo ✓'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 2],
                },
              ],
              [
                {},
                {
                  text: 'INCIDENTES Y ACCIDENTES (8.8.8)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.incidentes_accidentes ||
                    'Sin incidentes ni accidentes transoperatorios.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'CUANTIFICACIÓN DE SANGRADO Y TRANSFUSIONES (8.8.9)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '50%'],
                    body: [
                      [
                        {
                          text: `Sangrado: ${
                            postoperatoriaData.sangrado_ml || '___'
                          } ml`,
                          fontSize: 8,
                          bold: true,
                        },
                        {
                          text: `Transfusiones: ${
                            postoperatoriaData.transfusiones || 'No'
                          }`,
                          fontSize: 8,
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 ESTUDIOS TRANSOPERATORIOS (NOM-004 8.8.10)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTUDIOS TRANSOPERATORIOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0fdf4',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'ESTUDIOS DE SERVICIOS AUXILIARES DE DIAGNÓSTICO Y TRATAMIENTO (8.8.10)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.estudios_transoperatorios ||
                    'No se realizaron estudios transoperatorios.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 EQUIPO QUIRÚRGICO (NOM-004 8.8.11)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EQUIPO QUIRÚRGICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fdf2f8',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'AYUDANTES, INSTRUMENTISTAS, ANESTESIÓLOGO Y CIRCULANTE (8.8.11)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef7ff',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Cirujano:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Ayudante:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Anestesiólogo:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Instrumentista:',
                          fontSize: 7,
                          bold: true,
                        },
                      ],
                      [
                        {
                          text: medicoCompleto.nombre_completo,
                          fontSize: 7,
                        },
                        {
                          text: postoperatoriaData.ayudante || 'N/A',
                          fontSize: 7,
                        },
                        {
                          text: postoperatoriaData.anestesiologo || 'N/A',
                          fontSize: 7,
                        },
                        {
                          text: postoperatoriaData.instrumentista || 'N/A',
                          fontSize: 7,
                        },
                      ],
                      [
                        {
                          text: 'Circulante:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: postoperatoriaData.circulante || 'N/A',
                          fontSize: 7,
                          colSpan: 3,
                        },
                        {},
                        {},
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [3, 2],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 ESTADO POSTQUIRÚRGICO Y PLAN (NOM-004 8.8.12-8.8.13)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTADO POSTQUIRÚRGICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'ESTADO POST-QUIRÚRGICO INMEDIATO (8.8.12)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.estado_postquirurgico ||
                    'Paciente estable al término del procedimiento quirúrgico.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'PLAN DE MANEJO Y TRATAMIENTO POSTOPERATORIO INMEDIATO (8.8.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.plan_postoperatorio ||
                    'Plan de manejo postoperatorio inmediato según protocolo.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 PRONÓSTICO Y BIOPSIAS (NOM-004 8.8.14-8.8.15)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PRONÓSTICO Y BIOPSIAS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'PRONÓSTICO (8.8.14)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.pronostico ||
                    'Favorable para la vida y función.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
              [
                {},
                {
                  text: 'ENVÍO DE PIEZAS O BIOPSIAS QUIRÚRGICAS (8.8.15)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.envio_biopsias ||
                    'No se enviaron piezas quirúrgicas para estudio histopatológico.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 OTROS HALLAZGOS (NOM-004 8.8.16)
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'OTROS HALLAZGOS DE IMPORTANCIA (8.8.16)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                  alignment: 'center',
                },
              ],
              [
                {
                  text:
                    postoperatoriaData.otros_hallazgos ||
                    'Sin otros hallazgos de importancia para reportar.',
                  fontSize: 8,
                  margin: [5, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        // 🔹 FIRMA DEL CIRUJANO RESPONSABLE (NOM-004 8.8.17)
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'CIRUJANO RESPONSABLE (8.8.17)',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `Cédula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de elaboración: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} - ${fechaActual.toLocaleTimeString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: '\n\n_____________________________________\nNOMBRE COMPLETO Y FIRMA DEL RESPONSABLE DE LA CIRUGÍA',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        // 🔹 NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Sección 8.8 "Nota postoperatoria"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos establecidos en los numerales 8.8.1 al 8.8.17',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota Postoperatoria - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 NOTA PREANESTÉSICA SEGÚN NOM-004-SSA3-2012 SECCIÓN 8.7 Y NOM-006-SSA3-2011
  async generarNotaPreanestesica(datos: any): Promise<any> {
    console.log('💉 Generando Nota Preanestésica según NOM-004 y NOM-006...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const preanestesicaData = datos.notaPreanestesica || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA PREANESTÉSICA',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 IDENTIFICACIÓN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIÓN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha cirugía',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora programada',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Quirófano',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'ASA',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            preanestesicaData.fecha_cirugia ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: preanestesicaData.hora_programada || '00:00',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: preanestesicaData.quirofano || 'Q1',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: preanestesicaData.clasificacion_asa || 'ASA II',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} años`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['30%', '25%', '25%', '20%'],
                    body: [
                      [
                        {
                          text: 'Peso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Talla',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'IMC',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo sanguíneo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${signosVitales.peso || '___'} kg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${signosVitales.talla || '___'} cm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: this.calcularIMC(
                            signosVitales.peso,
                            signosVitales.talla
                          ),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.tipo_sangre || 'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Procedimiento quirúrgico programado',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            preanestesicaData.procedimiento_programado ||
                            'Procedimiento quirúrgico por especificar',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 EVALUACIÓN CLÍNICA DEL PACIENTE (NOM-004 D9.12)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EVALUACIÓN CLÍNICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#dbeafe',
                  alignment: 'center',
                  rowSpan: 8,
                },
                {
                  text: 'EVALUACIÓN CLÍNICA DEL PACIENTE (D9.12)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#eff6ff',
                },
              ],
              [
                {},
                {
                  text: 'ANTECEDENTES ANESTÉSICOS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.antecedentes_anestesicos ||
                    'Sin antecedentes anestésicos previos conocidos.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'ANTECEDENTES PATOLÓGICOS RELEVANTES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.antecedentes_patologicos ||
                    'Sin antecedentes patológicos de importancia para anestesia.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MEDICAMENTOS ACTUALES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.medicamentos_actuales ||
                    'Sin medicamentos de importancia anestésica.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'ALERGIAS Y REACCIONES ADVERSAS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.alergias ||
                    'Sin alergias conocidas a medicamentos.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 EXPLORACIÓN FÍSICA ANESTÉSICA
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EXPLORACIÓN FÍSICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'SIGNOS VITALES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Presión arterial',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia cardíaca',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia respiratoria',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Saturación O2',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            signosVitales.presion_arterial_sistolica || '___'
                          }/${
                            signosVitales.presion_arterial_diastolica || '___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_cardiaca || '___'
                          } lpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_respiratoria || '___'
                          } rpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.saturacion_oxigeno || '___'
                          } %`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 2],
                },
              ],
              [
                {},
                {
                  text: 'VÍA AÉREA Y CUELLO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.via_aerea ||
                    'Vía aérea permeable, cuello móvil, apertura oral adecuada, clasificación Mallampati I-II.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'SISTEMAS CARDIOVASCULAR Y RESPIRATORIO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.cardiovascular_respiratorio ||
                    'Ruidos cardíacos rítmicos, sin soplos. Murmullo vesicular presente bilateral.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 TIPO DE ANESTESIA (NOM-004 D9.13)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PLAN ANESTÉSICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0fdf4',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'TIPO DE ANESTESIA PLANEADA (D9.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text:
                            preanestesicaData.tipo_anestesia === 'general'
                              ? '☑ GENERAL'
                              : '☐ GENERAL',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.tipo_anestesia === 'regional'
                              ? '☑ REGIONAL'
                              : '☐ REGIONAL',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.tipo_anestesia === 'local'
                              ? '☑ LOCAL'
                              : '☐ LOCAL',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.tipo_anestesia === 'combinada'
                              ? '☑ COMBINADA'
                              : '☐ COMBINADA',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'TÉCNICA ANESTÉSICA ESPECÍFICA',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.tecnica_especifica ||
                    'Técnica anestésica por definir según evaluación y tipo de cirugía.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 RIESGO ANESTÉSICO (NOM-004 D9.14)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'RIESGO ANESTÉSICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fee2e2',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'CLASIFICACIÓN ASA Y RIESGO ANESTÉSICO (D9.14)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef2f2',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text:
                            preanestesicaData.clasificacion_asa === 'ASA I'
                              ? '☑ ASA I'
                              : '☐ ASA I',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.clasificacion_asa === 'ASA II'
                              ? '☑ ASA II'
                              : '☐ ASA II',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.clasificacion_asa === 'ASA III'
                              ? '☑ ASA III'
                              : '☐ ASA III',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.clasificacion_asa === 'ASA IV'
                              ? '☑ ASA IV'
                              : '☐ ASA IV',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.clasificacion_asa === 'ASA V'
                              ? '☑ ASA V'
                              : '☐ ASA V',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'JUSTIFICACIÓN DEL RIESGO ANESTÉSICO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef2f2',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.justificacion_riesgo ||
                    'Paciente con estado físico apropiado para anestesia y cirugía programada.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 PREMEDICACIÓN (NOM-004 D9.15)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PREMEDICACIÓN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f3e8ff',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'MEDICACIÓN PREANESTÉSICA (D9.15)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#faf5ff',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.premedicacion ||
                    'Premedicación según protocolo anestésico y estado del paciente.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 AYUNO Y PREPARACIÓN
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PREPARACIÓN PREOPERATORIA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'AYUNO PREOPERATORIO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text: `Ayuno de sólidos: ${
                    preanestesicaData.ayuno_solidos || '8 horas'
                  } | Ayuno de líquidos: ${
                    preanestesicaData.ayuno_liquidos || '2 horas'
                  }`,
                  fontSize: 8,
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'PREPARACIÓN ESPECIAL',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.preparacion_especial ||
                    'Preparación estándar preoperatoria.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        // 🔹 ANESTESIÓLOGO RESPONSABLE
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'ANESTESIÓLOGO RESPONSABLE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `Cédula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: Anestesiología\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de evaluación: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} - ${fechaActual.toLocaleTimeString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: '\n\n_____________________________________\nFIRMA DEL ANESTESIÓLOGO',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        // 🔹 NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Sección 8.7 "Nota preanestésica"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con NOM-006-SSA3-2011 para la práctica de la anestesiología',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota Preanestésica - SICEG\nNOM-004-SSA3-2012 | NOM-006-SSA3-2011',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 HOJA DE QUIRÓFANO SEGÚN NOM-004-SSA3-2012
  async generarHojaQuirofano(datos: any): Promise<any> {
    console.log('   Generando Hoja de Quirófano según NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const quirofanoData = datos.hojaQuirofano || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageOrientation: 'landscape',
      pageMargins: [15, 50, 15, 40],

      header: {
        margin: [15, 10, 15, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - HOJA DE QUIRÓFANO',
                fontSize: 12,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 5] },

        // 🔹 DATOS GENERALES
        {
          table: {
            widths: ['20%', '30%', '15%', '35%'],
            body: [
              [
                { text: 'Paciente:', fontSize: 9, bold: true },
                { text: pacienteCompleto.nombre_completo, fontSize: 9 },
                { text: 'Expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  bold: true,
                },
              ],
              [
                { text: 'Procedimiento:', fontSize: 9, bold: true },
                {
                  text: quirofanoData.procedimiento || 'Por especificar',
                  fontSize: 9,
                  colSpan: 3,
                },
                {},
                {},
              ],
              [
                { text: 'Cirujano:', fontSize: 9, bold: true },
                {
                  text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}`,
                  fontSize: 9,
                },
                { text: 'Quirófano:', fontSize: 9, bold: true },
                { text: quirofanoData.numero_quirofano || 'Q1', fontSize: 9 },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        // 🔹 TABLA DE REGISTRO HORARIO
        {
          table: {
            widths: ['15%', '15%', '15%', '15%', '15%', '25%'],
            body: [
              [
                {
                  text: 'HORA',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
                {
                  text: 'PA (mmHg)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
                {
                  text: 'FC (lpm)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
                {
                  text: 'FR (rpm)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
                {
                  text: 'TEMP (°C)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
                {
                  text: 'OBSERVACIONES',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
              ],
              // Generar 20 filas vacías para llenar manualmente
              ...Array.from({ length: 20 }, () => [
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
              ]),
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        // 🔹 DATOS DEL EQUIPO QUIRÚRGICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'EQUIPO QUIRÚRGICO',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        { text: 'Cirujano:', fontSize: 8, bold: true },
                        { text: 'Anestesiólogo:', fontSize: 8, bold: true },
                        { text: 'Instrumentista:', fontSize: 8, bold: true },
                        { text: 'Circulante:', fontSize: 8, bold: true },
                      ],
                      [
                        { text: medicoCompleto.nombre_completo, fontSize: 8 },
                        {
                          text: quirofanoData.anestesiologo || '____________',
                          fontSize: 8,
                        },
                        {
                          text: quirofanoData.instrumentista || '____________',
                          fontSize: 8,
                        },
                        {
                          text: quirofanoData.circulante || '____________',
                          fontSize: 8,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 5, 5, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [15, 10],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#666666',
                },
                {
                  text: 'Hoja de Quirófano - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 8,
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  // 📄 NOTA POSTANESTÉSICA SEGÚN NOM-004-SSA3-2012 SECCIÓN D11
  async generarNotaPostanestesica(datos: any): Promise<any> {
    console.log('   Generando Nota Postanestésica según NOM-004-SSA3-2012...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const postanestesicaData = datos.notaPostanestesica || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA POSTANESTÉSICA',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // 🔹 IDENTIFICACIÓN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIÓN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha cirugía',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora término',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Quirófano',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio nota',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            postanestesicaData.fecha_cirugia ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text:
                            postanestesicaData.hora_termino ||
                            fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: postanestesicaData.quirofano || 'Q1',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `NPA-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} años`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['40%', '30%', '30%'],
                    body: [
                      [
                        {
                          text: 'Servicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Peso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'ASA',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: medicoCompleto.departamento || 'Anestesiología',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${signosVitales.peso || '___'} kg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            postanestesicaData.clasificacion_asa || 'ASA II',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Procedimiento quirúrgico realizado',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            postanestesicaData.procedimiento_realizado ||
                            'Procedimiento quirúrgico por especificar',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 MEDICAMENTOS UTILIZADOS (NOM-004 D11.12)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'MEDICAMENTOS UTILIZADOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#dbeafe',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'MEDICAMENTOS UTILIZADOS DURANTE LA ANESTESIA (D11.12)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#eff6ff',
                },
              ],
              [
                {},
                {
                  text:
                    postanestesicaData.medicamentos_utilizados ||
                    'Medicamentos anestésicos y coadyuvantes utilizados durante el procedimiento:\n' +
                      '• Agentes anestésicos principales\n' +
                      '• Medicamentos de inducción\n' +
                      '• Relajantes musculares\n' +
                      '• Analgésicos\n' +
                      '• Otros medicamentos según protocolo',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 DURACIÓN DE LA ANESTESIA (NOM-004 D11.13)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'DURACIÓN ANESTESIA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'DURACIÓN DE LA ANESTESIA (D11.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Inicio anestesia',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Término anestesia',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Duración total',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo anestesia',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: postanestesicaData.hora_inicio || '__:__',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                        },
                        {
                          text: postanestesicaData.hora_termino || '__:__',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                        },
                        {
                          text: `${
                            postanestesicaData.duracion_anestesia || '___'
                          } minutos`,
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                          bold: true,
                        },
                        {
                          text: postanestesicaData.tipo_anestesia || 'General',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 3],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 INCIDENTES Y ACCIDENTES (NOM-004 D11.14)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'INCIDENTES Y ACCIDENTES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fee2e2',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'INCIDENTES Y ACCIDENTES ATRIBUIBLES A LA ANESTESIA (D11.14)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef2f2',
                },
              ],
              [
                {},
                {
                  text:
                    postanestesicaData.incidentes_accidentes ||
                    'Sin incidentes ni accidentes atribuibles a la anestesia durante el procedimiento.',
                  fontSize: 8,
                  margin: [5, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 CANTIDAD DE SANGRE Y SOLUCIONES (NOM-004 D11.15)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'BALANCE HÍDRICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0fdf4',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'CANTIDAD DE SANGRE O SOLUCIONES APLICADAS (D11.15)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['33%', '33%', '34%'],
                    body: [
                      [
                        {
                          text: 'Líquidos administrados',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Pérdidas sanguíneas',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hemoderivados',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            postanestesicaData.liquidos_administrados || '___'
                          } ml`,
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                          bold: true,
                        },
                        {
                          text: `${postanestesicaData.sangrado || '___'} ml`,
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                          bold: true,
                        },
                        {
                          text:
                            postanestesicaData.hemoderivados_transfundidos ||
                            'Ninguno',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'BALANCE HÍDRICO DETALLADO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    postanestesicaData.balance_hidrico ||
                    'Balance hídrico equilibrado durante el procedimiento anestésico.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 ESTADO CLÍNICO AL EGRESO (NOM-004 D11.16)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTADO CLÍNICO EGRESO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#e0f2fe',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'ESTADO CLÍNICO DEL ENFERMO A SU EGRESO DE QUIRÓFANO (D11.16)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text: 'SIGNOS VITALES AL EGRESO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'PA',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'FC',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'FR',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'SatO2',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Temp',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            postanestesicaData.presion_arterial_egreso ||
                            '___/___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            postanestesicaData.frecuencia_cardiaca_egreso ||
                            '___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            postanestesicaData.frecuencia_respiratoria_egreso ||
                            '___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            postanestesicaData.saturacion_oxigeno_egreso ||
                            '___'
                          }%`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            postanestesicaData.temperatura_egreso || '___'
                          }°C`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 2],
                },
              ],
              [
                {},
                {
                  text:
                    postanestesicaData.estado_clinico_egreso ||
                    'Paciente estable, consciente, orientado, con signos vitales dentro de parámetros normales. Egresa de quirófano en condiciones satisfactorias.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 PLAN DE MANEJO (NOM-004 D11.17)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PLAN POSTANESTÉSICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f3e8ff',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'PLAN DE MANEJO Y TRATAMIENTO INMEDIATO (D11.17)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#faf5ff',
                },
              ],
              [
                {},
                {
                  text:
                    postanestesicaData.plan_tratamiento ||
                    '• Vigilancia estricta en sala de recuperación\n' +
                      '• Monitoreo continuo de signos vitales\n' +
                      '• Control del dolor postoperatorio\n' +
                      '• Manejo de náusea y vómito postoperatorio si aplica\n' +
                      '• Evaluación neurológica continua\n' +
                      '• Indicaciones específicas según evolución',
                  fontSize: 8,
                  margin: [5, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        // 🔹 ESCALA DE RECUPERACIÓN ANESTÉSICA
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESCALA ALDRETE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fdf2f8',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'ESCALA DE RECUPERACIÓN POSTANESTÉSICA (ALDRETE)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef7ff',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Actividad motora',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Respiración',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Circulación',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Conciencia',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Saturación O2',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            postanestesicaData.aldrete_actividad || '2'
                          } / 2`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                        {
                          text: `${
                            postanestesicaData.aldrete_respiracion || '2'
                          } / 2`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                        {
                          text: `${
                            postanestesicaData.aldrete_circulacion || '2'
                          } / 2`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                        {
                          text: `${
                            postanestesicaData.aldrete_conciencia || '2'
                          } / 2`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                        {
                          text: `${
                            postanestesicaData.aldrete_saturacion || '2'
                          } / 2`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                      ],
                      [
                        {
                          text: `TOTAL ALDRETE: ${this.calcularTotalAldrete(
                            postanestesicaData
                          )} / 10`,
                          fontSize: 8,
                          alignment: 'center',
                          bold: true,
                          colSpan: 5,
                          fillColor: '#f0f9ff',
                          margin: [0, 3],
                        },
                        {},
                        {},
                        {},
                        {},
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 3],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        // 🔹 ANESTESIÓLOGO RESPONSABLE
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'ANESTESIÓLOGO RESPONSABLE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `Cédula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: Anestesiología\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de elaboración: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} - ${fechaActual.toLocaleTimeString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: '\n\n_____________________________________\nFIRMA DEL ANESTESIÓLOGO RESPONSABLE',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        // 🔹 NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Sección D11 "Nota postanestésica"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos D11.12 al D11.17 establecidos en la norma oficial',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `Página ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota Postanestésica - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }

  async generarConsentimientoProcedimientos(datos: any): Promise<any> {
    console.log(
      '📄 PdfTemplatesService: Creando definición Consentimiento Procedimientos...'
    );

    const pacienteCompleto = datos.pacienteCompleto;
    const medicoCompleto = datos.medicoCompleto;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [30, 60, 30, 50],

      header: {
        margin: [30, 20, 30, 20],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: [
                  {
                    text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ\n',
                    fontSize: 12,
                    bold: true,
                    color: '#1a365d',
                  },
                  {
                    text: 'CONSENTIMIENTO INFORMADO PARA PROCEDIMIENTOS MÉDICOS\n',
                    fontSize: 10,
                    bold: true,
                  },
                  {
                    text: 'Conforme a la NOM-004-SSA3-2012 del Expediente Clínico',
                    fontSize: 8,
                    color: '#666666',
                  },
                ],
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // Datos del paciente
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DATOS DEL PACIENTE',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  alignment: 'center',
                  margin: [0, 3],
                },
              ],
              [
                {
                  columns: [
                    {
                      width: '50%',
                      text: [
                        { text: 'Nombre completo:\n', fontSize: 8, bold: true },
                        {
                          text: `${pacienteCompleto.nombre_completo}\n\n`,
                          fontSize: 9,
                        },
                        { text: 'Edad: ', fontSize: 8, bold: true },
                        { text: `${pacienteCompleto.edad} años`, fontSize: 9 },
                      ],
                    },
                    {
                      width: '50%',
                      text: [
                        { text: 'Expediente:\n', fontSize: 8, bold: true },
                        {
                          text: `${pacienteCompleto.numero_expediente}\n\n`,
                          fontSize: 9,
                        },
                        { text: 'Sexo: ', fontSize: 8, bold: true },
                        { text: pacienteCompleto.sexo, fontSize: 9 },
                      ],
                    },
                  ],
                  margin: [10, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#cccccc',
            vLineColor: () => '#cccccc',
          },
        },

        { text: '', margin: [0, 15] },

        // Procedimiento
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'PROCEDIMIENTO AUTORIZADO',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#e6f3ff',
                  alignment: 'center',
                  margin: [0, 3],
                },
              ],
              [
                {
                  text: [
                    { text: 'Procedimiento: ', bold: true, fontSize: 9 },
                    {
                      text:
                        datos.consentimiento?.nombre_procedimiento ||
                        '[PROCEDIMIENTO A REALIZAR]',
                      fontSize: 9,
                    },
                    {
                      text: '\n\nDescripción del procedimiento:\n',
                      bold: true,
                      fontSize: 9,
                    },
                    {
                      text:
                        datos.consentimiento?.descripcion_procedimiento ||
                        'El médico explicará en detalle el procedimiento a realizar, sus objetivos y metodología.',
                      fontSize: 8,
                    },
                  ],
                  margin: [10, 8],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#cccccc',
            vLineColor: () => '#cccccc',
          },
        },

        { text: '', margin: [0, 15] },

        // Beneficios y riesgos
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: 'BENEFICIOS ESPERADOS',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#e8f5e8',
                  alignment: 'center',
                  margin: [0, 3],
                },
                {
                  text: 'RIESGOS Y COMPLICACIONES',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#ffe8e8',
                  alignment: 'center',
                  margin: [0, 3],
                },
              ],
              [
                {
                  text:
                    datos.consentimiento?.beneficios_procedimiento ||
                    '• Mejoría de la condición médica\n• Alivio de síntomas\n• Mejor calidad de vida\n• Prevención de complicaciones',
                  fontSize: 8,
                  margin: [8, 8],
                  lineHeight: 1.1,
                },
                {
                  text:
                    datos.consentimiento?.riesgos_especificos ||
                    '• Sangrado\n• Infección\n• Reacciones alérgicas\n• Dolor temporal\n• Complicaciones específicas del procedimiento',
                  fontSize: 8,
                  margin: [8, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#cccccc',
            vLineColor: () => '#cccccc',
          },
        },

        { text: '', margin: [0, 15] },

        // Declaración del paciente
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DECLARACIÓN DEL PACIENTE O RESPONSABLE LEGAL',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#fff5e6',
                  alignment: 'center',
                  margin: [0, 3],
                },
              ],
              [
                {
                  text: [
                    { text: 'YO, ', fontSize: 9, bold: true },
                    {
                      text: `${pacienteCompleto.nombre_completo}`,
                      fontSize: 9,
                      bold: true,
                      decoration: 'underline',
                    },
                    {
                      text: ', por mi propio derecho / en mi calidad de representante legal del paciente antes mencionado, DECLARO que:\n\n',
                      fontSize: 9,
                    },

                    { text: '1. ', fontSize: 9, bold: true },
                    {
                      text: 'He sido informado(a) de manera clara y comprensible sobre el procedimiento médico propuesto, sus beneficios, riesgos y alternativas.\n\n',
                      fontSize: 8,
                    },

                    { text: '2. ', fontSize: 9, bold: true },
                    {
                      text: 'He tenido la oportunidad de hacer preguntas, las cuales han sido respondidas satisfactoriamente por el médico tratante.\n\n',
                      fontSize: 8,
                    },

                    { text: '3. ', fontSize: 9, bold: true },
                    {
                      text: 'Entiendo que ningún procedimiento médico garantiza resultados al 100% y que pueden presentarse complicaciones imprevistas.\n\n',
                      fontSize: 8,
                    },

                    { text: '4. ', fontSize: 9, bold: true },
                    { text: 'AUTORIZO al Dr. ', fontSize: 8 },
                    {
                      text: `${medicoCompleto.nombre_completo}`,
                      fontSize: 8,
                      bold: true,
                    },
                    {
                      text: ' y su equipo médico a realizar el procedimiento descrito.\n\n',
                      fontSize: 8,
                    },

                    { text: '5. ', fontSize: 9, bold: true },
                    {
                      text: 'Este consentimiento es otorgado de manera libre, voluntaria e informada.',
                      fontSize: 8,
                    },
                  ],
                  margin: [10, 8],
                  lineHeight: 1.4,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#cccccc',
            vLineColor: () => '#cccccc',
          },
        },

        { text: '', margin: [0, 20] },

        // Firmas
        {
          table: {
            widths: ['33%', '33%', '34%'],
            body: [
              [
                {
                  text: 'PACIENTE O RESPONSABLE',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f9f9f9',
                },
                {
                  text: 'MÉDICO TRATANTE',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f9f9f9',
                },
                {
                  text: 'TESTIGO',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {
                  text: '\n\n\n_____________________\nFirma\n\nNombre:\n_____________________',
                  fontSize: 7,
                  alignment: 'center',
                  margin: [5, 15],
                },
                {
                  text: [
                    { text: '\n\n\n_____________________\n', fontSize: 7 },
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 7,
                      bold: true,
                    },
                    {
                      text: `Cédula: ${medicoCompleto.numero_cedula}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'center',
                  margin: [5, 15],
                },
                {
                  text: '\n\n\n_____________________\nFirma\n\nNombre:\n_____________________',
                  fontSize: 7,
                  alignment: 'center',
                  margin: [5, 15],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#cccccc',
            vLineColor: () => '#cccccc',
          },
        },

        { text: '', margin: [0, 15] },

        // Fecha y lugar
        {
          columns: [
            {
              width: '50%',
              text: [
                { text: 'Lugar: ', fontSize: 8, bold: true },
                { text: 'San Luis de la Paz, Guanajuato', fontSize: 8 },
              ],
            },
            {
              width: '50%',
              text: [
                { text: 'Fecha: ', fontSize: 8, bold: true },
                { text: fechaActual.toLocaleDateString('es-MX'), fontSize: 8 },
              ],
              alignment: 'right',
            },
          ],
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [30, 10],
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Consentimiento Informado - Hospital General San Luis de la Paz - NOM-004-SSA3-2012',
                  fontSize: 6,
                  alignment: 'center',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }








































































































































<!-- FORMULARIO DE NOTA DE URGENCIAS -->
      <div *ngIf="formularioActivo === 'notaUrgencias'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-ambulance mr-2 text-red-500"></i>
            Nota de Urgencias
          </h3>
          <p class="text-sm text-gray-600 mt-1">Documentar la atención de urgencias</p>
        </div>

        <form [formGroup]="notaUrgenciasForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Motivo de Atención *</label>
                <textarea formControlName="motivo_atencion" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Motivo principal de la consulta de urgencia..."></textarea>
                <div *ngIf="notaUrgenciasForm.get('motivo_atencion')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Estado de Conciencia *</label>
                <select formControlName="estado_conciencia"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione...</option>

                  <option value="Consciente y orientado">Consciente y orientado</option>
                  <option value="Consciente desorientado">Consciente desorientado</option>
                  <option value="Somnoliento">Somnoliento</option>
                  <option value="Estuporoso">Estuporoso</option>
                  <option value="Coma superficial">Coma superficial</option>
                  <option value="Coma profundo">Coma profundo</option>
                </select>
                <div *ngIf="notaUrgenciasForm.get('estado_conciencia')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Resumen del Interrogatorio *</label>
              <textarea formControlName="resumen_interrogatorio" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Resumen del interrogatorio dirigido..."></textarea>
              <div *ngIf="notaUrgenciasForm.get('resumen_interrogatorio')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Exploración Física *</label>
              <textarea formControlName="exploracion_fisica" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Hallazgos de la exploración física..."></textarea>
              <div *ngIf="notaUrgenciasForm.get('exploracion_fisica')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Resultados de Estudios</label>
                <textarea formControlName="resultados_estudios" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Laboratorios, radiografías, ECG..."></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Estado Mental</label>
                <textarea formControlName="estado_mental" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Evaluación del estado mental..."></textarea>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Diagnóstico *</label>
              <textarea formControlName="diagnostico" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Diagnóstico de urgencias..."></textarea>
              <div *ngIf="notaUrgenciasForm.get('diagnostico')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Guía Clínica de Diagnóstico
                <span class="text-blue-500 ml-1 cursor-help"
                  title="Seleccione una guía clínica oficial para el diagnóstico">
                  <i class="fas fa-question-circle"></i>
                </span>
              </label>

              <div class="relative">
                <div class="flex">
                  <input type="text" [ngModel]="filtroGuiaClinica" (ngModelChange)="onGuiaClinicaInputChange($event)"
                    [ngModelOptions]="{standalone: true}" (input)="onGuiaClinicaInputChange($any($event.target).value)"
                    (focus)="toggleDropdownGuias()" (click)="toggleDropdownGuias()"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Buscar guía clínica por nombre, código o área..."
                    [readonly]="!!guiaClinicaSeleccionada">

                  <button type="button" (click)="toggleDropdownGuias()"
                    class="px-3 py-2 bg-blue-500 text-white border border-blue-500 rounded-r-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search"></i>
                  </button>
                </div>

                <div *ngIf="guiaClinicaSeleccionada" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-medium text-blue-900">{{ guiaClinicaSeleccionada.nombre }}</div>
                      <div class="text-sm text-blue-700">
                        <span *ngIf="guiaClinicaSeleccionada.codigo">Código: {{ guiaClinicaSeleccionada.codigo }}</span>
                        <span *ngIf="guiaClinicaSeleccionada.area" class="ml-3">Área: {{ guiaClinicaSeleccionada.area
                          }}</span>
                        <span *ngIf="guiaClinicaSeleccionada.fuente" class="ml-3">Fuente: {{
                          guiaClinicaSeleccionada.fuente }}</span>
                      </div>
                    </div>
                    <button type="button" (click)="limpiarGuiaClinica()" class="text-red-500 hover:text-red-700 ml-4">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>

                <div *ngIf="mostrarDropdownGuias && guiasClinicasFiltradas"
                  class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-64 overflow-y-auto">

                  <div *ngIf="guiasClinicasFiltradas.length === 0" class="p-4 text-gray-500 text-center">
                    No se encontraron guías clínicas
                  </div>

                  <div *ngFor="let guia of guiasClinicasFiltradas; trackBy: trackByGuiaId"
                    (click)="seleccionarGuiaClinica(guia)"
                    class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100">
                    <div class="font-medium text-gray-900">{{ guia.nombre }}</div>
                    <div class="text-sm text-gray-600">
                      <span *ngIf="guia.codigo">{{ guia.codigo }}</span>
                      <span *ngIf="guia.area" class="ml-2">• {{ guia.area }}</span>
                      <span *ngIf="guia.fuente" class="ml-2">• {{ guia.fuente }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Plan de Tratamiento *</label>
              <textarea formControlName="plan_tratamiento" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Tratamiento inmediato y plan de manejo..."></textarea>
              <div *ngIf="notaUrgenciasForm.get('plan_tratamiento')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Pronóstico *</label>
              <select formControlName="pronostico"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione...</option>
                <option value="Bueno para la vida">Bueno para la vida</option>
                <option value="Bueno para la función">Bueno para la función</option>
                <option value="Reservado">Reservado</option>
                <option value="Grave">Grave</option>
                <option value="Malo">Malo</option>
              </select>
              <div *ngIf="notaUrgenciasForm.get('pronostico')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!notaUrgenciasForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Nota de Urgencias' }}
            </button>

            <button type="button" (click)="generarPDF('Nota de Urgencias')" [disabled]="!formularioEstado.notaUrgencias"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.notaUrgencias">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.notaUrgencias">Guardar primero</span>
            </button>
          </div>


        </form>
      </div>

      <!-- FORMULARIO DE NOTA DE EVOLUCIÓN -->
      <div *ngIf="formularioActivo === 'notaEvolucion'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-chart-line mr-2 text-green-500"></i>
            Nota de Evolución
          </h3>
          <p class="text-sm text-gray-600 mt-1">Evolución diaria del paciente</p>
        </div>

        <form [formGroup]="notaEvolucionForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <!-- Síntomas y Signos -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Síntomas y Signos *
              </label>
              <textarea formControlName="sintomas_signos" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Describir síntomas y signos del paciente..."></textarea>
              <div *ngIf="notaEvolucionForm.get('sintomas_signos')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Habitus Exterior -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Habitus Exterior *
              </label>
              <textarea formControlName="habitus_exterior" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Descripción del aspecto general del paciente..."></textarea>
              <div *ngIf="notaEvolucionForm.get('habitus_exterior')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Estado Nutricional -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Estado Nutricional *
              </label>
              <textarea formControlName="estado_nutricional" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Evaluación del estado nutricional..."></textarea>
              <div *ngIf="notaEvolucionForm.get('estado_nutricional')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Estudios de Laboratorio -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Estudios de Laboratorio y Gabinete *
              </label>
              <textarea formControlName="estudios_laboratorio_gabinete" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Resultados de laboratorio y estudios de gabinete..."></textarea>
              <div *ngIf="notaEvolucionForm.get('estudios_laboratorio_gabinete')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Evolución y Análisis -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Evolución y Análisis *
              </label>
              <textarea formControlName="evolucion_analisis" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Análisis de la evolución clínica del paciente..."></textarea>
              <div *ngIf="notaEvolucionForm.get('evolucion_analisis')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Diagnósticos -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Diagnósticos *
              </label>
              <textarea formControlName="diagnosticos" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Diagnósticos actuales del paciente..."></textarea>
              <div *ngIf="notaEvolucionForm.get('diagnosticos')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- 🔥 COMPONENTE DE SELECTOR DE GUÍAS CLÍNICAS CORREGIDO -->
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Guía Clínica de Diagnóstico
                <span class="text-blue-500 ml-1 cursor-help"
                  title="Seleccione una guía clínica oficial para el diagnóstico">
                  <i class="fas fa-question-circle"></i>
                </span>
              </label>

              <div class="relative">
                <div class="flex">
                  <input type="text" [ngModel]="filtroGuiaClinica" (ngModelChange)="onGuiaClinicaInputChange($event)"
                    [ngModelOptions]="{standalone: true}" (input)="onGuiaClinicaInputChange($any($event.target).value)"
                    (focus)="toggleDropdownGuias()" (click)="toggleDropdownGuias()"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Buscar guía clínica por nombre, código o área..."
                    [readonly]="!!guiaClinicaSeleccionada">

                  <button type="button" (click)="toggleDropdownGuias()"
                    class="px-3 py-2 bg-blue-500 text-white border border-blue-500 rounded-r-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search"></i>
                  </button>
                </div>

                <!-- Información de la guía seleccionada -->
                <div *ngIf="guiaClinicaSeleccionada" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-medium text-blue-900">{{ guiaClinicaSeleccionada.nombre }}</div>
                      <div class="text-sm text-blue-700">
                        <span *ngIf="guiaClinicaSeleccionada.codigo">Código: {{ guiaClinicaSeleccionada.codigo }}</span>
                        <span *ngIf="guiaClinicaSeleccionada.area" class="ml-3">Área: {{ guiaClinicaSeleccionada.area
                          }}</span>
                        <span *ngIf="guiaClinicaSeleccionada.fuente" class="ml-3">Fuente: {{
                          guiaClinicaSeleccionada.fuente }}</span>
                      </div>
                    </div>
                    <button type="button" (click)="limpiarGuiaClinica()" class="text-red-500 hover:text-red-700 ml-4">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>

                <!-- Dropdown de guías clínicas -->
                <div *ngIf="mostrarDropdownGuias && guiasClinicasFiltradas"
                  class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-64 overflow-y-auto">

                  <div *ngIf="guiasClinicasFiltradas.length === 0" class="p-4 text-gray-500 text-center">
                    No se encontraron guías clínicas
                  </div>

                  <div *ngFor="let guia of guiasClinicasFiltradas; trackBy: trackByGuiaId"
                    (click)="seleccionarGuiaClinica(guia)"
                    class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100">
                    <div class="font-medium text-gray-900">{{ guia.nombre }}</div>
                    <div class="text-sm text-gray-600">
                      <span *ngIf="guia.codigo">{{ guia.codigo }}</span>
                      <span *ngIf="guia.area" class="ml-2">• {{ guia.area }}</span>
                      <span *ngIf="guia.fuente" class="ml-2">• {{ guia.fuente }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Plan de Estudios y Tratamiento -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Plan de Estudios y Tratamiento *
              </label>
              <textarea formControlName="plan_estudios_tratamiento" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Plan de manejo, medicamentos, estudios adicionales..."></textarea>
              <div *ngIf="notaEvolucionForm.get('plan_estudios_tratamiento')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Pronóstico -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Pronóstico *
              </label>
              <textarea formControlName="pronostico" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Pronóstico del paciente..."></textarea>
              <div *ngIf="notaEvolucionForm.get('pronostico')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!notaEvolucionForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Nota de Evolución' }}
            </button>

            <button type="button" (click)="generarPDF('Nota de Evolución')" [disabled]="!formularioEstado.notaEvolucion"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.notaEvolucion">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.notaEvolucion">Guardar primero</span>
            </button>
          </div>


        </form>
      </div>


      <!-- ==========================================
       FORMULARIO DE NOTA DE INTERCONSULTA (NOM-004)
       Sección 6.3 - Nota de Interconsulta
       ========================================== -->
      <div *ngIf="formularioActivo === 'notaInterconsulta'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-user-md mr-2 text-purple-500"></i>
            Nota de Interconsulta - NOM-004
          </h3>
          <p class="text-gray-600 text-sm mt-1">
            Solicitud y respuesta de interconsulta médica especializada
          </p>
        </div>

        <form [formGroup]="notaInterconsultaForm" class="p-6 space-y-6">
          <!-- Sección: Información de la Solicitud -->
          <div class="bg-purple-50 rounded-lg p-4 space-y-4">
            <h4 class="font-semibold text-purple-800 flex items-center">
              <i class="fas fa-clipboard-list mr-2"></i>
              Información de la Solicitud
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Área de Interconsulta -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Área de Interconsulta <span class="text-red-500">*</span>
                </label>
                <select formControlName="area_interconsulta"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <option value="">Seleccionar área</option>
                  <option value="1">Cardiología</option>
                  <option value="2">Ginecología</option>
                  <option value="3">Pediatría</option>
                  <option value="4">Neurología</option>
                  <option value="5">Traumatología</option>
                  <option value="6">Oftalmología</option>
                  <option value="7">Otorrinolaringología</option>
                  <option value="8">Dermatología</option>
                  <option value="9">Psicología</option>
                  <option value="10">Nutrición</option>
                  <option value="11">Trabajo Social</option>
                  <option value="12">Medicina Interna</option>
                </select>
              </div>

              <!-- Prioridad -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Prioridad
                </label>
                <select formControlName="prioridad"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <option value="baja">Baja (72 horas)</option>
                  <option value="media">Media (24 horas)</option>
                  <option value="alta">Alta (8 horas)</option>
                  <option value="urgente">Urgente (2 horas)</option>
                </select>
              </div>
            </div>

            <!-- Motivo de Interconsulta -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Motivo de la Interconsulta <span class="text-red-500">*</span>
              </label>
              <textarea formControlName="motivo_interconsulta" rows="3"
                placeholder="Describir claramente el motivo por el cual se solicita la interconsulta..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </textarea>
            </div>

            <!-- Diagnóstico Presuntivo -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Diagnóstico Presuntivo
              </label>
              <textarea formControlName="diagnostico_presuntivo" rows="2"
                placeholder="Diagnóstico presuntivo del médico solicitante..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </textarea>
            </div>

            <!-- Estudios Solicitados -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex items-center space-x-2">
                <input type="checkbox" formControlName="examenes_laboratorio" id="examenes_laboratorio"
                  class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <label for="examenes_laboratorio" class="text-sm text-gray-700">
                  Se requieren exámenes de laboratorio
                </label>
              </div>

              <div class="flex items-center space-x-2">
                <input type="checkbox" formControlName="examenes_gabinete" id="examenes_gabinete"
                  class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <label for="examenes_gabinete" class="text-sm text-gray-700">
                  Se requieren estudios de gabinete
                </label>
              </div>
            </div>
          </div>

          <!-- Sección: Respuesta de Interconsulta -->
          <div class="bg-blue-50 rounded-lg p-4 space-y-4">
            <h4 class="font-semibold text-blue-800 flex items-center">
              <i class="fas fa-stethoscope mr-2"></i>
              Respuesta de la Interconsulta
              <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full ml-2">
                Completar por el médico interconsultante
              </span>
            </h4>

            <!-- Hallazgos -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Hallazgos Relevantes
              </label>
              <textarea formControlName="hallazgos" rows="4"
                placeholder="Hallazgos encontrados durante la interconsulta..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </textarea>
            </div>

            <!-- Impresión Diagnóstica -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Impresión Diagnóstica
              </label>
              <textarea formControlName="impresion_diagnostica" rows="3"
                placeholder="Impresión diagnóstica del médico interconsultante..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </textarea>
            </div>

            <!-- Recomendaciones -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Recomendaciones y Plan de Tratamiento
              </label>
              <textarea formControlName="recomendaciones" rows="4"
                placeholder="Recomendaciones terapéuticas y plan de seguimiento..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </textarea>
            </div>

            <!-- Seguimiento Requerido -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Seguimiento Requerido
                </label>
                <select formControlName="seguimiento_requerido"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">No especificado</option>
                  <option value="no_requerido">No se requiere seguimiento</option>
                  <option value="seguimiento_ambulatorio">Seguimiento ambulatorio</option>
                  <option value="nueva_cita">Nueva cita programada</option>
                  <option value="seguimiento_urgente">Seguimiento urgente</option>
                  <option value="referencia_tercer_nivel">Referencia a tercer nivel</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Tiempo de Seguimiento
                </label>
                <input type="text" formControlName="tiempo_seguimiento" placeholder="ej: 1 semana, 15 días, 1 mes"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
          </div>

          <!-- Sección: Información del Médico -->
          <div class="bg-gray-50 rounded-lg p-4 space-y-4">
            <h4 class="font-semibold text-gray-800 flex items-center">
              <i class="fas fa-user-doctor mr-2"></i>
              Información del Personal Médico
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Médico Solicitante -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Médico Solicitante
                </label>
                <input type="text" formControlName="medico_solicitante" readonly
                  [value]="medicoCompleto?.['nombre_completo'] || 'No especificado'"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100">
              </div>

              <!-- Cédula Solicitante -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Cédula Profesional Solicitante
                </label>
                <input type="text" formControlName="cedula_solicitante" readonly
                  [value]="medicoCompleto?.cedula_profesional || 'No especificada'"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100">
              </div>

              <!-- Médico Interconsultante -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Médico Interconsultante
                </label>
                <select formControlName="id_medico_interconsulta"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-500">
                  <option value="">Seleccionar médico interconsultante</option>
                  <!-- Las opciones se cargarán dinámicamente -->
                </select>
              </div>

              <!-- Especialidad -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Especialidad del Interconsultante
                </label>
                <input type="text" formControlName="especialidad_interconsulta" placeholder="Especialidad médica"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-500">
              </div>
            </div>
          </div>

          <!-- Botones de Acción -->
          <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-gray-200">
            <button type="button" (click)="guardarNotaInterconsulta()"
              [disabled]="!notaInterconsultaForm.valid || guardandoFormulario"
              class="flex-1 px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:bg-gray-300 transition-colors flex items-center justify-center">
              <i class="fas fa-save mr-2"></i>
              <span *ngIf="!guardandoFormulario">Guardar Interconsulta</span>
              <span *ngIf="guardandoFormulario">Guardando...</span>
            </button>

            <button type="button" (click)="generarPDFInterconsulta()" [disabled]="!formularioEstado.notaInterconsulta"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors flex items-center justify-center">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.notaInterconsulta">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.notaInterconsulta">Guardar primero</span>
            </button>

            <button type="button" (click)="limpiarFormulario('notaInterconsulta')"
              class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors flex items-center justify-center">
              <i class="fas fa-broom mr-2"></i>
              Limpiar
            </button>
          </div>

          <!-- Información de Estado -->
          <div *ngIf="formularioEstado.notaInterconsulta" class="bg-green-50 border border-green-200 rounded-lg p-3">
            <div class="flex items-center">
              <i class="fas fa-check-circle text-green-500 mr-2"></i>
              <span class="text-green-800 text-sm font-medium">
                Nota de interconsulta guardada exitosamente
              </span>
            </div>
          </div>

          <!-- Validaciones -->
          <div *ngIf="notaInterconsultaForm.errors && notaInterconsultaForm.touched"
            class="bg-red-50 border border-red-200 rounded-lg p-3">
            <div class="flex items-start">
              <i class="fas fa-exclamation-triangle text-red-500 mr-2 mt-0.5"></i>
              <div class="text-red-800 text-sm">
                <p class="font-medium">Por favor corrige los siguientes errores:</p>
                <ul class="list-disc list-inside mt-1 space-y-1">
                  <li *ngIf="notaInterconsultaForm.get('motivo_interconsulta')?.hasError('required')">
                    El motivo de interconsulta es obligatorio
                  </li>
                  <li *ngIf="notaInterconsultaForm.get('area_interconsulta')?.hasError('required')">
                    Debe seleccionar un área de interconsulta
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </form>
      </div>
      <!-- sIGUE FORMULARIO DE REFERENCIA -->

      <!-- FORMULARIO DE CONSENTIMIENTO INFORMADO -->
      <div *ngIf="formularioActivo === 'consentimiento'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-file-signature mr-2 text-orange-500"></i>
            Consentimiento Informado
          </h3>
          <p class="text-sm text-gray-600 mt-1">Autorización para procedimientos médicos</p>
        </div>

        <form [formGroup]="consentimientoForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <!-- Procedimiento -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Procedimiento Autorizado *</label>
              <textarea formControlName="procedimiento" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Describa el procedimiento para el cual se solicita autorización..."></textarea>
              <div *ngIf="consentimientoForm.get('procedimiento')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Riesgos -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Riesgos Explicados</label>
              <textarea formControlName="riesgos" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Riesgos y complicaciones posibles del procedimiento..."></textarea>
            </div>

            <!-- Alternativas -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Alternativas de Tratamiento</label>
              <textarea formControlName="alternativas" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Opciones alternativas de tratamiento disponibles..."></textarea>
            </div>

            <!-- Testigos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Testigo 1</label>
                <input type="text" formControlName="nombre_testigo1"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre completo del primer testigo">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Testigo 2</label>
                <input type="text" formControlName="nombre_testigo2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre completo del segundo testigo">
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!consentimientoForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Consentimiento' }}
            </button>

            <button type="button" (click)="generarPDF('Consentimiento Informado')"
              [disabled]="!formularioEstado.consentimiento"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.consentimiento">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.consentimiento">Guardar primero</span>
            </button>
          </div>
        </form>
      </div>


      <!-- FORMULARIO DE SOLICITUD DE ESTUDIO -->
      <div *ngIf="formularioActivo === 'solicitudEstudio'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-vial mr-2 text-gray-500"></i>
            Solicitud de Estudios
          </h3>
          <p class="text-sm text-gray-600 mt-1">Solicitar estudios de laboratorio o gabinete</p>
        </div>

        <form [formGroup]="solicitudEstudioForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <!-- Tipo de Estudio -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Estudio *</label>
              <select formControlName="tipo_estudio"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione el tipo de estudio...</option>
                <option value="LABORATORIO">Laboratorio Clínico</option>
                <option value="RADIOLOGIA">Radiología</option>
                <option value="ULTRASONIDO">Ultrasonido</option>
                <option value="TOMOGRAFIA">Tomografía</option>
                <option value="RESONANCIA">Resonancia Magnética</option>
                <option value="ENDOSCOPIA">Endoscopia</option>
                <option value="ELECTROCARDIOGRAMA">Electrocardiograma</option>
                <option value="ELECTROENCEFALOGRAMA">Electroencefalograma</option>
                <option value="BIOPSIA">Biopsia</option>
                <option value="OTROS">Otros</option>
              </select>
              <div *ngIf="solicitudEstudioForm.get('tipo_estudio')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Estudios Solicitados -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Estudios Solicitados *</label>
              <textarea formControlName="estudios_solicitados" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Liste los estudios específicos que solicita..."></textarea>
              <div *ngIf="solicitudEstudioForm.get('estudios_solicitados')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Indicación Clínica -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Indicación Clínica *</label>
              <textarea formControlName="indicacion_clinica" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Motivo médico para la solicitud del estudio..."></textarea>
              <div *ngIf="solicitudEstudioForm.get('indicacion_clinica')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Datos Clínicos y Urgencia -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Datos Clínicos Relevantes</label>
                <textarea formControlName="datos_clinicos_relevantes" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Información adicional relevante..."></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Urgencia del Estudio *</label>
                <select formControlName="urgencia_estudio"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="rutina">Rutina</option>
                  <option value="urgente">Urgente</option>
                  <option value="stat">STAT (Inmediato)</option>
                </select>

                <div class="mt-3">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Diagnóstico Presuntivo</label>
                  <input type="text" formControlName="diagnostico_presuntivo"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Diagnóstico presuntivo">
                </div>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!solicitudEstudioForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Solicitud' }}
            </button>

            <button type="button" (click)="generarPDF('Solicitud de Estudio')"
              [disabled]="!formularioEstado.solicitudEstudio"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.solicitudEstudio">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.solicitudEstudio">Guardar primero</span>
            </button>
          </div>
        </form>
      </div>
      <!-- FORMULARIO DE REFERENCIA Y TRASLADO -->
      <div *ngIf="formularioActivo === 'referenciaTraslado'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-ambulance mr-2 text-amber-500"></i>
            Referencia y Traslado
          </h3>
          <p class="text-sm text-gray-600 mt-1">Referir paciente a otra unidad médica</p>
        </div>

        <form [formGroup]="referenciaForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <!-- Instituciones -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Institución de Origen *</label>
                <input type="text" formControlName="institucion_origen"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Hospital o clínica de origen">
                <div *ngIf="referenciaForm.get('institucion_origen')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Institución de Destino *</label>
                <input type="text" formControlName="institucion_destino"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Hospital o clínica de destino">
                <div *ngIf="referenciaForm.get('institucion_destino')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>
            </div>

            <!-- Médico y Especialidad -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Médico de Destino</label>
                <input type="text" formControlName="medico_destino"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre del médico especialista">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Especialidad de Destino</label>
                <input type="text" formControlName="especialidad_destino"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Especialidad médica requerida">
              </div>
            </div>

            <!-- Motivo y Tipo -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Referencia *</label>
                <select formControlName="tipo_referencia"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione el tipo...</option>
                  <option value="INTERCONSULTA">Interconsulta</option>
                  <option value="TRASLADO_DEFINITIVO">Traslado Definitivo</option>
                  <option value="SEGUNDA_OPINION">Segunda Opinión</option>
                  <option value="PROCEDIMIENTO_ESPECIAL">Procedimiento Especial</option>
                  <option value="NIVEL_SUPERIOR">Nivel Superior de Atención</option>
                  <option value="REHABILITACION">Rehabilitación</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Urgencia del Traslado *</label>
                <select formControlName="urgencia_traslado"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="baja">Baja</option>
                  <option value="media">Media</option>
                  <option value="alta">Alta</option>
                  <option value="critica">Crítica</option>
                </select>
              </div>
            </div>

            <!-- Motivo de Referencia -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Motivo de Referencia *</label>
              <textarea formControlName="motivo_referencia" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Explique el motivo de la referencia..."></textarea>
              <div *ngIf="referenciaForm.get('motivo_referencia')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Estado del Paciente -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Estado del Paciente *</label>
              <textarea formControlName="estado_paciente" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Describe el estado clínico actual del paciente..."></textarea>
              <div *ngIf="referenciaForm.get('estado_paciente')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Resumen del Caso -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Resumen del Caso *</label>
              <textarea formControlName="resumen_caso" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Resumen clínico del caso, antecedentes relevantes..."></textarea>
              <div *ngIf="referenciaForm.get('resumen_caso')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Información Adicional -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tratamiento Actual</label>
                <textarea formControlName="tratamiento_actual" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Medicamentos y tratamientos actuales..."></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Estudios Realizados</label>
                <textarea formControlName="estudios_realizados" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Estudios y resultados previos..."></textarea>
              </div>
            </div>

            <!-- Contacto -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Contacto de la Institución</label>
              <input type="text" formControlName="contacto_institucion"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Teléfono o correo electrónico de contacto">
            </div>
          </div>

          <!-- Botones -->
          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!referenciaForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Referencia' }}
            </button>

            <button type="button" (click)="generarPDF('Referencia y Traslado')"
              [disabled]="!formularioEstado.referenciaTraslado"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.referenciaTraslado">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.referenciaTraslado">Guardar primero</span>
            </button>
          </div>
        </form>
      </div>




      <!-- FORMULARIO DE PRESCRIPCIÓN DE MEDICAMENTOS -->
      <div *ngIf="formularioActivo === 'prescripcionMedicamento'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-pills mr-2 text-green-500"></i>
            Prescripción de Medicamentos
          </h3>
          <p class="text-sm text-gray-600 mt-1">Prescribir medicamentos al paciente</p>
        </div>

        <form [formGroup]="prescripcionForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Medicamento *</label>
                <input type="text" formControlName="medicamento"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre del medicamento">
                <div *ngIf="prescripcionForm.get('medicamento')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Genérico</label>
                <input type="text" formControlName="nombre_generico"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Denominación genérica">
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Concentración</label>
                <input type="text" formControlName="concentracion"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ej: 500mg">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Forma Farmacéutica</label>
                <select formControlName="forma_farmaceutica"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione...</option>
                  <option value="Tableta">Tableta</option>
                  <option value="Cápsula">Cápsula</option>
                  <option value="Jarabe">Jarabe</option>
                  <option value="Suspensión">Suspensión</option>
                  <option value="Solución">Solución</option>
                  <option value="Ampolleta">Ampolleta</option>
                  <option value="Crema">Crema</option>
                  <option value="Ungüento">Ungüento</option>
                  <option value="Supositorio">Supositorio</option>
                  <option value="Inhalador">Inhalador</option>
                </select>
              </div>
            </div>


            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Dosis *</label>
                <input type="text" formControlName="dosis"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ej: 1 tableta, 5ml">
                <div *ngIf="prescripcionForm.get('dosis')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Vía de Administración *</label>
                <select formControlName="via_administracion"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione la vía...</option>
                  <option value="ORAL">Oral (VO)</option>
                  <option value="INTRAVENOSA">Intravenosa (IV)</option>
                  <option value="INTRAMUSCULAR">Intramuscular (IM)</option>
                  <option value="SUBCUTANEA">Subcutánea (SC)</option>
                  <option value="TOPICA">Tópica</option>
                  <option value="INHALATORIA">Inhalatoria</option>
                  <option value="RECTAL">Rectal</option>
                  <option value="VAGINAL">Vaginal</option>
                  <option value="SUBLINGUAL">Sublingual</option>
                  <option value="TRANSDERMICA">Transdérmica</option>
                  <option value="OFTÁLMICA">Oftálmica</option>
                  <option value="OTICA">Ótica</option>
                  <option value="NASAL">Nasal</option>
                  <option value="OTROS">Otros</option>
                </select>
                <div *ngIf="prescripcionForm.get('via_administracion')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>
            </div>


            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia *</label>
                <select formControlName="frecuencia"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione la frecuencia...</option>
                  <option value="Cada 4 horas">Cada 4 horas (6 veces/día)</option>
                  <option value="Cada 6 horas">Cada 6 horas (4 veces/día)</option>
                  <option value="Cada 8 horas">Cada 8 horas (3 veces/día)</option>
                  <option value="Cada 12 horas">Cada 12 horas (2 veces/día)</option>
                  <option value="Cada 24 horas">Cada 24 horas (1 vez/día)</option>
                  <option value="Cada 48 horas">Cada 48 horas</option>
                  <option value="Cada 72 horas">Cada 72 horas</option>
                  <option value="PRN">Según necesidad (PRN)</option>
                  <option value="Antes de comidas">Antes de comidas</option>
                  <option value="Con alimentos">Con alimentos</option>
                  <option value="En ayunas">En ayunas</option>
                  <option value="Al acostarse">Al acostarse</option>
                  <option value="Personalizada">Personalizada</option>
                </select>
                <div *ngIf="prescripcionForm.get('frecuencia')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Duración del Tratamiento *</label>
                <input type="text" formControlName="duracion_tratamiento"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ej: 7 días, 2 semanas, 1 mes">
                <div *ngIf="prescripcionForm.get('duracion_tratamiento')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>
            </div>


            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad Prescrita</label>
                <input type="text" formControlName="cantidad_prescrita"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ej: 30 tabletas">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio</label>
                <input type="date" formControlName="fecha_inicio"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                <input type="date" formControlName="fecha_fin"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>


            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Indicaciones Especiales</label>
              <textarea formControlName="indicaciones_especiales" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Instrucciones especiales para el paciente (tomar con agua, evitar alcohol, etc.)"></textarea>
            </div>


            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Contraindicaciones</label>
              <textarea formControlName="contraindicaciones" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Situaciones en las que no debe tomarse este medicamento"></textarea>
            </div>


            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Renovaciones Permitidas</label>
                <input type="number" formControlName="renovaciones_permitidas" min="0" max="10"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="0">
              </div>

              <div class="flex items-center space-x-4 pt-6">
                <label class="flex items-center">
                  <input type="checkbox" formControlName="activo"
                    class="mr-2 rounded border-gray-300 focus:ring-blue-500">
                  <span class="text-sm text-gray-700">Prescripción activa</span>
                </label>
              </div>
            </div>


            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
              <textarea formControlName="observaciones" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Observaciones adicionales sobre la prescripción"></textarea>
            </div>
          </div>


          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!prescripcionForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Prescripción' }}
            </button>

            <button type="button" (click)="generarPDF('Prescripción de Medicamentos')"
              [disabled]="!formularioEstado.prescripcionMedicamento"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.prescripcionMedicamento">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.prescripcionMedicamento">Guardar primero</span>
            </button>
          </div>
        </form>

      </div>
    </div>


    <!-- FORMULARIO DE NOTA PREOPERATORIA -->
    <div *ngIf="formularioActivo === 'notaPreoperatoria'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-clipboard-check mr-2 text-orange-500"></i>
          Nota Preoperatoria - NOM-004
        </h3>
        <p class="text-sm text-gray-600 mt-1">Evaluación previa a cirugía según NOM-004</p>
      </div>

      <form [formGroup]="notaPreoperatoriaForm" class="px-6 py-4">
        <div class="grid grid-cols-1 gap-6">

          <!-- Fecha de Cirugía -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de la Cirugía *</label>
            <input type="date" formControlName="fecha_cirugia"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div *ngIf="notaPreoperatoriaForm.get('fecha_cirugia')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

          <!-- Diagnóstico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Diagnóstico *</label>
            <textarea formControlName="diagnostico" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Diagnóstico preoperatorio principal..."></textarea>
            <div *ngIf="notaPreoperatoriaForm.get('diagnostico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

          <!-- Plan Quirúrgico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Plan Quirúrgico *</label>
            <textarea formControlName="plan_quirurgico" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Descripción del plan quirúrgico propuesto..."></textarea>
            <div *ngIf="notaPreoperatoriaForm.get('plan_quirurgico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

          <!-- Tipo de Intervención Quirúrgica -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Intervención Quirúrgica *</label>
            <select formControlName="tipo_intervencion"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione el tipo...</option>
              <option value="Electiva">Electiva</option>
              <option value="Urgente">Urgente</option>
              <option value="Emergencia">Emergencia</option>
              <option value="Programada">Programada</option>
            </select>
            <div *ngIf="notaPreoperatoriaForm.get('tipo_intervencion')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

          <!-- Riesgo Quirúrgico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Riesgo Quirúrgico *</label>
            <select formControlName="riesgo_quirurgico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione el riesgo...</option>
              <option value="ASA I">ASA I - Paciente sano</option>
              <option value="ASA II">ASA II - Enfermedad sistémica leve</option>
              <option value="ASA III">ASA III - Enfermedad sistémica severa</option>
              <option value="ASA IV">ASA IV - Enfermedad sistémica que amenaza la vida</option>
              <option value="ASA V">ASA V - Paciente moribundo</option>
              <option value="ASA VI">ASA VI - Muerte cerebral declarada</option>
            </select>
            <div *ngIf="notaPreoperatoriaForm.get('riesgo_quirurgico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

          <!-- Cuidados y Plan Terapéutico Preoperatorios -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cuidados y Plan Terapéutico Preoperatorios
              *</label>
            <textarea formControlName="cuidados_preoperatorios" rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Cuidados específicos, medicación preoperatoria, preparación del paciente..."></textarea>
            <div *ngIf="notaPreoperatoriaForm.get('cuidados_preoperatorios')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

          <!-- Pronóstico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Pronóstico *</label>
            <select formControlName="pronostico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione el pronóstico...</option>
              <option value="Excelente">Excelente</option>
              <option value="Bueno">Bueno</option>
              <option value="Regular">Regular</option>
              <option value="Reservado">Reservado</option>
              <option value="Grave">Grave</option>
              <option value="Malo">Malo</option>
            </select>
            <div *ngIf="notaPreoperatoriaForm.get('pronostico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

          <!-- Información Adicional -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Comorbilidades</label>
              <textarea formControlName="comorbilidades" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enfermedades coexistentes relevantes..."></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Estudios Preoperatorios</label>
              <textarea formControlName="estudios_preoperatorios" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Laboratorios, radiografías, ECG realizados..."></textarea>
            </div>
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
            <textarea formControlName="observaciones" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Observaciones adicionales importantes..."></textarea>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" (click)="guardarFormularioActivo()"
            [disabled]="!notaPreoperatoriaForm.valid || isCreatingDocument"
            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
            <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
            <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
            {{ isCreatingDocument ? 'Guardando...' : 'Guardar Nota Preoperatoria' }}
          </button>

          <button type="button" (click)="generarPDF('Nota Preoperatoria')"
            [disabled]="!formularioEstado.notaPreoperatoria"
            class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
            <i class="fas fa-file-pdf mr-2"></i>
            <span *ngIf="formularioEstado.notaPreoperatoria">📄 Descargar PDF</span>
            <span *ngIf="!formularioEstado.notaPreoperatoria">Guardar primero</span>
          </button>
        </div>
      </form>
    </div>


    <!-- FORMULARIO DE NOTA PREANESTÉSICA -->
    <div *ngIf="formularioActivo === 'notaPreanestesica'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-syringe mr-2 text-yellow-500"></i>
          Nota Preanestésica - NOM-006
        </h3>
        <p class="text-sm text-gray-600 mt-1">Evaluación anestésica preoperatoria según NOM-006</p>
      </div>

      <form [formGroup]="notaPreanestesicaForm" class="px-6 py-4">
        <div class="grid grid-cols-1 gap-6">

          <!-- Fecha de Cirugía -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de la Cirugía</label>
            <input type="date" formControlName="fecha_cirugia"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <!-- Antecedentes Anestésicos -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Antecedentes Anestésicos *</label>
            <textarea formControlName="antecedentes_anestesicos" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Antecedentes de anestesia previa, reacciones adversas, complicaciones..."></textarea>
            <div *ngIf="notaPreanestesicaForm.get('antecedentes_anestesicos')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Valoración de Vía Aérea -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Valoración de Vía Aérea *</label>
            <textarea formControlName="valoracion_via_aerea" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Mallampati, distancia tiromentoniana, movilidad cervical, dentadura..."></textarea>
            <div *ngIf="notaPreanestesicaForm.get('valoracion_via_aerea')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Clasificación ASA -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Clasificación ASA *</label>
            <select formControlName="clasificacion_asa"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione clasificación ASA...</option>
              <option value="ASA I">ASA I - Paciente sano normal</option>
              <option value="ASA II">ASA II - Paciente con enfermedad sistémica leve</option>
              <option value="ASA III">ASA III - Paciente con enfermedad sistémica severa</option>
              <option value="ASA IV">ASA IV - Paciente con enfermedad sistémica severa que amenaza la vida</option>
              <option value="ASA V">ASA V - Paciente moribundo que no se espera sobreviva sin la operación</option>
              <option value="ASA VI">ASA VI - Paciente con muerte cerebral declarada</option>
            </select>
            <div *ngIf="notaPreanestesicaForm.get('clasificacion_asa')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Plan Anestésico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Plan Anestésico *</label>
            <select formControlName="plan_anestesico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione tipo de anestesia...</option>
              <option value="General balanceada">General balanceada</option>
              <option value="General intravenosa">General intravenosa</option>
              <option value="General inhalatoria">General inhalatoria</option>
              <option value="Neuroaxial espinal">Neuroaxial espinal</option>
              <option value="Neuroaxial epidural">Neuroaxial epidural</option>
              <option value="Bloqueo regional">Bloqueo regional</option>
              <option value="Sedación consciente">Sedación consciente</option>
              <option value="Anestesia local">Anestesia local</option>
              <option value="Combinada">Combinada</option>
            </select>
            <div *ngIf="notaPreanestesicaForm.get('plan_anestesico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Riesgo Anestésico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Riesgo Anestésico *</label>
            <select formControlName="riesgo_anestesico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione el riesgo...</option>
              <option value="Bajo">Bajo</option>
              <option value="Moderado">Moderado</option>
              <option value="Alto">Alto</option>
              <option value="Muy alto">Muy alto</option>
            </select>
            <div *ngIf="notaPreanestesicaForm.get('riesgo_anestesico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Medicación Preanestésica -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Medicación Preanestésica</label>
            <textarea formControlName="medicacion_preanestesica" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Medicamentos administrados previos a la anestesia..."></textarea>
          </div>

          <!-- Consideraciones Especiales -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Consideraciones Especiales</label>
              <textarea formControlName="consideraciones_especiales" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Alergias, comorbilidades, medicamentos actuales..."></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Estado de Ayuno</label>
              <textarea formControlName="estado_ayuno" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Tiempo de ayuno, última ingesta de sólidos y líquidos..."></textarea>
            </div>
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
            <textarea formControlName="observaciones" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Observaciones adicionales sobre la evaluación preanestésica..."></textarea>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" (click)="guardarFormularioActivo()"
            [disabled]="!notaPreanestesicaForm.valid || isCreatingDocument"
            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
            <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
            <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
            {{ isCreatingDocument ? 'Guardando...' : 'Guardar Nota Preanestésica' }}
          </button>

          <button type="button" (click)="generarPDF('Nota Preanestésica')"
            [disabled]="!formularioEstado.notaPreanestesica"
            class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
            <i class="fas fa-file-pdf mr-2"></i>
            <span *ngIf="formularioEstado.notaPreanestesica">📄 Descargar PDF</span>
            <span *ngIf="!formularioEstado.notaPreanestesica">Guardar primero</span>
          </button>
        </div>
      </form>
    </div>





    <!-- FORMULARIO DE NOTA POSTANESTÉSICA -->
    <div *ngIf="formularioActivo === 'notaPostanestesica'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-heartbeat mr-2 text-teal-500"></i>
          Nota Postanestésica - NOM-006
        </h3>
        <p class="text-sm text-gray-600 mt-1">Registro de recuperación post-anestésica según NOM-006</p>
      </div>

      <form [formGroup]="notaPostanestesicaForm" class="px-6 py-4">
        <div class="grid grid-cols-1 gap-6">

          <!-- Tipo y Duración de Anestesia -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Anestesia *</label>
              <select formControlName="tipo_anestesia"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione tipo de anestesia...</option>
                <option value="General balanceada">General balanceada</option>
                <option value="General intravenosa">General intravenosa</option>
                <option value="General inhalatoria">General inhalatoria</option>
                <option value="Neuroaxial espinal">Neuroaxial espinal</option>
                <option value="Neuroaxial epidural">Neuroaxial epidural</option>
                <option value="Bloqueo regional">Bloqueo regional</option>
                <option value="Sedación consciente">Sedación consciente</option>
                <option value="Anestesia local">Anestesia local</option>
                <option value="Combinada">Combinada</option>
              </select>
              <div *ngIf="notaPostanestesicaForm.get('tipo_anestesia')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Duración de la Anestesia (minutos)</label>
              <input type="number" formControlName="duracion_anestesia" min="0" step="5"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="120">
            </div>
          </div>

          <!-- Medicamentos Utilizados -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Medicamentos Utilizados *</label>
            <textarea formControlName="medicamentos_utilizados" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Detallar medicamentos anestésicos utilizados, dosis y vías de administración..."></textarea>
            <div *ngIf="notaPostanestesicaForm.get('medicamentos_utilizados')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Estado Clínico de Egreso -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Estado Clínico de Egreso *</label>
            <textarea formControlName="estado_clinico_egreso" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Describir el estado del paciente al egreso de la sala de recuperación..."></textarea>
            <div *ngIf="notaPostanestesicaForm.get('estado_clinico_egreso')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Incidentes y Accidentes -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Incidentes y Accidentes Anestésicos</label>
            <textarea formControlName="incidentes_accidentes" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Describir cualquier complicación anestésica (escribir 'Ninguno' si no hubo)..."></textarea>
          </div>

          <!-- Balance Hídrico -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Líquidos Administrados (ml)</label>
              <input type="number" formControlName="liquidos_administrados" min="0" step="50"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="1000">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Sangrado Estimado (ml)</label>
              <input type="number" formControlName="sangrado" min="0" step="10"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="100">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Diuresis (ml)</label>
              <input type="number" formControlName="diuresis" min="0" step="10"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="200">
            </div>
          </div>

          <!-- Balance Hídrico Detallado -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Balance Hídrico Detallado</label>
            <textarea formControlName="balance_hidrico" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Resumen del balance de líquidos durante el procedimiento..."></textarea>
          </div>

          <!-- Hemoderivados -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Hemoderivados Transfundidos</label>
            <textarea formControlName="hemoderivados_transfundidos" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Describir hemoderivados administrados (escribir 'Ninguno' si no se transfundió)..."></textarea>
          </div>

          <!-- Signos Vitales de Egreso -->
          <div class="bg-blue-50 rounded-lg p-4">
            <h4 class="font-medium text-blue-900 mb-3">Signos Vitales de Egreso</h4>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Presión Arterial</label>
                <input type="text" formControlName="presion_arterial_egreso"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="120/80">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia Cardíaca</label>
                <input type="number" formControlName="frecuencia_cardiaca_egreso" min="0" max="200"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="72">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia Respiratoria</label>
                <input type="number" formControlName="frecuencia_respiratoria_egreso" min="0" max="60"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="16">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Saturación O2 (%)</label>
                <input type="number" formControlName="saturacion_oxigeno_egreso" min="0" max="100"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="98">
              </div>
            </div>
          </div>

          <!-- Plan de Tratamiento -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Plan de Tratamiento Postanestésico</label>
            <textarea formControlName="plan_tratamiento" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Indicaciones para el manejo postanestésico del paciente..."></textarea>
          </div>

          <!-- Pronóstico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Pronóstico Anestésico</label>
            <select formControlName="pronostico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione el pronóstico...</option>
              <option value="Excelente">Excelente</option>
              <option value="Bueno">Bueno</option>
              <option value="Regular">Regular</option>
              <option value="Reservado">Reservado</option>
              <option value="Complicado">Complicado</option>
            </select>
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
            <textarea formControlName="observaciones" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Observaciones adicionales sobre la recuperación anestésica..."></textarea>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" (click)="guardarFormularioActivo()"
            [disabled]="!notaPostanestesicaForm.valid || isCreatingDocument"
            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
            <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
            <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
            {{ isCreatingDocument ? 'Guardando...' : 'Guardar Nota Postanestésica' }}
          </button>

          <button type="button" (click)="generarPDF('Nota Postanestésica')"
            [disabled]="!formularioEstado.notaPostanestesica"
            class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
            <i class="fas fa-file-pdf mr-2"></i>
            <span *ngIf="formularioEstado.notaPostanestesica">📄 Descargar PDF</span>
            <span *ngIf="!formularioEstado.notaPostanestesica">Guardar primero</span>
          </button>
        </div>
      </form>
    </div>




    <!-- FORMULARIO DE NOTA POSTOPERATORIA NOM-004 -->
    <div *ngIf="formularioActivo === 'notaPostoperatoria'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-band-aid mr-2 text-indigo-500"></i>
          Nota Postoperatoria - NOM-004 Sección 8.8
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Resumen de la operación practicada. Debe elaborarla el cirujano que intervino al paciente al término de la
          cirugía
        </p>
        <div class="mt-2 text-xs text-blue-700 bg-blue-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-info-circle mr-1"></i>
          Todos los campos marcados con (*) son obligatorios según NOM-004-SSA3-2012
        </div>
      </div>

      <form [formGroup]="notaPostoperatoriaForm" class="px-6 py-4">
        <div class="grid grid-cols-1 gap-6">

          <!-- SECCIÓN 1: INFORMACIÓN BÁSICA DE LA CIRUGÍA -->
          <div class="bg-blue-50 rounded-lg p-4">
            <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
              <i class="fas fa-calendar-alt mr-2"></i>
              Información Básica de la Cirugía
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Fecha de la Cirugía <span class="text-red-500">*</span>
                </label>
                <input type="date" formControlName="fecha_cirugia"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div *ngIf="notaPostoperatoriaForm.get('fecha_cirugia')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Duración de la Cirugía (minutos)
                </label>
                <input type="number" formControlName="duracion_cirugia" min="0" step="15"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="120">
                <p class="text-xs text-gray-500 mt-1">Tiempo total del procedimiento quirúrgico</p>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 2: DIAGNÓSTICOS (NOM-004 8.8.1 y 8.8.4) -->
          <div class="bg-green-50 rounded-lg p-4">
            <h4 class="font-semibold text-green-800 mb-3 flex items-center">
              <i class="fas fa-stethoscope mr-2"></i>
              Diagnósticos (NOM-004: 8.8.1 y 8.8.4)
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Diagnóstico Preoperatorio <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="diagnostico_preoperatorio" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  placeholder="Diagnóstico establecido antes de la cirugía..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('diagnostico_preoperatorio')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.1)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Diagnóstico Postoperatorio <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="diagnostico_postoperatorio" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  placeholder="Diagnóstico confirmado después de la cirugía..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('diagnostico_postoperatorio')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.4)
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 3: PROCEDIMIENTOS QUIRÚRGICOS (NOM-004 8.8.2 y 8.8.3) -->
          <div class="bg-purple-50 rounded-lg p-4">
            <h4 class="font-semibold text-purple-800 mb-3 flex items-center">
              <i class="fas fa-scissors mr-2"></i>
              Procedimientos Quirúrgicos (NOM-004: 8.8.2 y 8.8.3)
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Operación Planeada <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="operacion_planeada" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                  placeholder="Procedimiento quirúrgico programado inicialmente..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('operacion_planeada')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.2)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Operación Realizada <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="operacion_realizada" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                  placeholder="Procedimiento quirúrgico efectivamente realizado..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('operacion_realizada')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.3)
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 4: DESCRIPCIÓN TÉCNICA Y HALLAZGOS (NOM-004 8.8.5 y 8.8.6) -->
          <div class="bg-yellow-50 rounded-lg p-4">
            <h4 class="font-semibold text-yellow-800 mb-3 flex items-center">
              <i class="fas fa-search mr-2"></i>
              Técnica Quirúrgica y Hallazgos (NOM-004: 8.8.5 y 8.8.6)
            </h4>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Descripción de la Técnica Quirúrgica <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="descripcion_tecnica" rows="4"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                  placeholder="Descripción detallada paso a paso de la técnica quirúrgica empleada, abordajes, instrumentos utilizados..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('descripcion_tecnica')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.5)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Hallazgos Transoperatorios <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="hallazgos_transoperatorios" rows="4"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                  placeholder="Hallazgos anatomopatológicos, adherencias, lesiones encontradas durante la cirugía..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('hallazgos_transoperatorios')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.6)
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 5: CONTEO Y CONTROL QUIRÚRGICO (NOM-004 8.8.7) -->
          <div class="bg-red-50 rounded-lg p-4">
            <h4 class="font-semibold text-red-800 mb-3 flex items-center">
              <i class="fas fa-list-ol mr-2"></i>
              Conteo y Control Quirúrgico (NOM-004: 8.8.7)
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Conteo de Gasas y Compresas <span class="text-red-500">*</span>
                </label>
                <select formControlName="conteo_gasas_completo"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                  <option value="">Seleccione el estado...</option>
                  <option value="true">✅ Completo y correcto</option>
                  <option value="false">❌ Incompleto o con discrepancias</option>
                </select>
                <div *ngIf="notaPostoperatoriaForm.get('conteo_gasas_completo')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.7)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Conteo de Instrumental Quirúrgico <span class="text-red-500">*</span>
                </label>
                <select formControlName="conteo_instrumental_completo"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                  <option value="">Seleccione el estado...</option>
                  <option value="true">✅ Completo y correcto</option>
                  <option value="false">❌ Incompleto o con discrepancias</option>
                </select>
                <div *ngIf="notaPostoperatoriaForm.get('conteo_instrumental_completo')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.7)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Observaciones del Conteo
                </label>
                <textarea formControlName="observaciones_conteo" rows="2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                  placeholder="Detalles sobre discrepancias o hallazgos en el conteo..."></textarea>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 6: INCIDENTES Y SANGRADO (NOM-004 8.8.8 y 8.8.9) -->
          <div class="bg-orange-50 rounded-lg p-4">
            <h4 class="font-semibold text-orange-800 mb-3 flex items-center">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              Incidentes y Sangrado (NOM-004: 8.8.8 y 8.8.9)
            </h4>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Incidentes y Accidentes <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="incidentes_accidentes" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                  placeholder="Describir cualquier incidente, accidente o complicación durante la cirugía. Si no hubo, escribir 'Ninguno'"></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('incidentes_accidentes')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.8)
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Cuantificación de Sangrado (ml) <span class="text-red-500">*</span>
                  </label>
                  <input type="number" formControlName="sangrado" min="0" step="10"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                    placeholder="0">
                  <div *ngIf="notaPostoperatoriaForm.get('sangrado')?.errors?.['required']"
                    class="text-red-500 text-xs mt-1">
                    Campo obligatorio según NOM-004 (8.8.9)
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Transfusiones Realizadas
                  </label>
                  <select formControlName="transfusiones_realizadas"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="false">No se realizaron transfusiones</option>
                    <option value="true">Sí se realizaron transfusiones</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Detalles de Transfusiones
                  </label>
                  <textarea formControlName="detalles_transfusiones" rows="2"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                    placeholder="Tipo, cantidad y detalles de hemoderivados..."></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 7: ESTUDIOS TRANSOPERATORIOS (NOM-004 8.8.10) -->
          <div class="bg-teal-50 rounded-lg p-4">
            <h4 class="font-semibold text-teal-800 mb-3 flex items-center">
              <i class="fas fa-microscope mr-2"></i>
              Estudios Transoperatorios (NOM-004: 8.8.10)
            </h4>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Estudios de Servicios Auxiliares Transoperatorios <span class="text-red-500">*</span>
              </label>
              <textarea formControlName="estudios_transoperatorios" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500"
                placeholder="Estudios realizados durante la cirugía: patología rápida, radiografías intraoperatorias, etc. Si no se realizaron, escribir 'Ninguno'"></textarea>
              <div *ngIf="notaPostoperatoriaForm.get('estudios_transoperatorios')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004 (8.8.10)
              </div>
            </div>
          </div>

          <!-- SECCIÓN 8: EQUIPO QUIRÚRGICO (NOM-004 8.8.11) -->
          <div class="bg-indigo-50 rounded-lg p-4">
            <h4 class="font-semibold text-indigo-800 mb-3 flex items-center">
              <i class="fas fa-users mr-2"></i>
              Equipo Quirúrgico (NOM-004: 8.8.11)
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Cirujano Principal <span class="text-red-500">*</span>
                </label>
                <input type="text" formControlName="cirujano_principal"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Nombre completo del cirujano principal">
                <div *ngIf="notaPostoperatoriaForm.get('cirujano_principal')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.11)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Ayudantes <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="ayudantes" rows="2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Nombres de los cirujanos ayudantes..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('ayudantes')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.11)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Instrumentista <span class="text-red-500">*</span>
                </label>
                <input type="text" formControlName="instrumentista"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Nombre del instrumentista">
                <div *ngIf="notaPostoperatoriaForm.get('instrumentista')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.11)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Anestesiólogo <span class="text-red-500">*</span>
                </label>
                <input type="text" formControlName="anestesiologo"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Nombre del anestesiólogo">
                <div *ngIf="notaPostoperatoriaForm.get('anestesiologo')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.11)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Circulante <span class="text-red-500">*</span>
                </label>
                <input type="text" formControlName="circulante"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Nombre del circulante">
                <div *ngIf="notaPostoperatoriaForm.get('circulante')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.11)
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 9: ESTADO Y PLAN POSTQUIRÚRGICO (NOM-004 8.8.12 y 8.8.13) -->
          <div class="bg-cyan-50 rounded-lg p-4">
            <h4 class="font-semibold text-cyan-800 mb-3 flex items-center">
              <i class="fas fa-clipboard-list mr-2"></i>
              Estado y Plan Postquirúrgico (NOM-004: 8.8.12 y 8.8.13)
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Estado Post-quirúrgico Inmediato <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="estado_postquirurgico" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                  placeholder="Estado del paciente al finalizar la cirugía: estable, signos vitales, estado de conciencia..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('estado_postquirurgico')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.12)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Plan de Manejo y Tratamiento Postoperatorio Inmediato <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="plan_postoperatorio" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                  placeholder="Indicaciones inmediatas: medicamentos, cuidados, dieta, movilización..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('plan_postoperatorio')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.13)
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 10: PRONÓSTICO (NOM-004 8.8.14) -->
          <div class="bg-emerald-50 rounded-lg p-4">
            <h4 class="font-semibold text-emerald-800 mb-3 flex items-center">
              <i class="fas fa-chart-line mr-2"></i>
              Pronóstico (NOM-004: 8.8.14)
            </h4>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Pronóstico <span class="text-red-500">*</span>
              </label>
              <select formControlName="pronostico"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <option value="">Seleccione el pronóstico...</option>
                <option value="Excelente">Excelente</option>
                <option value="Bueno">Bueno</option>
                <option value="Regular">Regular</option>
                <option value="Reservado">Reservado</option>
                <option value="Grave">Grave</option>
                <option value="Malo">Malo</option>
              </select>
              <div *ngIf="notaPostoperatoriaForm.get('pronostico')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004 (8.8.14)
              </div>
            </div>
          </div>

          <!-- SECCIÓN 11: ENVÍO DE PIEZAS (NOM-004 8.8.15) -->
          <div class="bg-pink-50 rounded-lg p-4">
            <h4 class="font-semibold text-pink-800 mb-3 flex items-center">
              <i class="fas fa-flask mr-2"></i>
              Envío de Piezas Quirúrgicas (NOM-004: 8.8.15)
            </h4>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Envío de Piezas o Biopsias Quirúrgicas <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="piezas_enviadas_patologia" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500"
                  placeholder="Describir piezas enviadas para examen macroscópico e histopatológico. Si no se enviaron, escribir 'No se enviaron piezas'"></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('piezas_enviadas_patologia')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004 (8.8.15)
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    ¿Se enviaron piezas a patología?
                  </label>
                  <select formControlName="se_enviaron_piezas"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <option value="false">No se enviaron piezas</option>
                    <option value="true">Sí se enviaron piezas</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Número de Registro de Patología
                  </label>
                  <input type="text" formControlName="numero_registro_patologia"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500"
                    placeholder="Número de folio asignado por patología">
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIÓN 12: OTROS HALLAZGOS (NOM-004 8.8.16) -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
              <i class="fas fa-plus-circle mr-2"></i>
              Otros Hallazgos de Importancia (NOM-004: 8.8.16)
            </h4>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Otros Hallazgos de Importancia para el Paciente <span class="text-red-500">*</span>
              </label>
              <textarea formControlName="otros_hallazgos" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                placeholder="Otros hallazgos importantes relacionados con el quehacer médico. Si no hay hallazgos adicionales, escribir 'Sin otros hallazgos relevantes'"></textarea>
              <div *ngIf="notaPostoperatoriaForm.get('otros_hallazgos')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004 (8.8.16)
              </div>
            </div>

            <!-- SECCIÓN 13: FIRMAS Y RESPONSABILIDAD (NOM-004 8.8.17) -->
            <div class="bg-slate-50 rounded-lg p-4">
              <h4 class="font-semibold text-slate-800 mb-3 flex items-center">
                <i class="fas fa-signature mr-2"></i>
                Responsabilidad Médica (NOM-004: 8.8.17)
              </h4>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Nombre Completo del Responsable de la Cirugía <span class="text-red-500">*</span>
                  </label>
                  <input type="text" formControlName="nombre_responsable_cirugia"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500"
                    placeholder="Nombre completo del cirujano responsable">
                  <div *ngIf="notaPostoperatoriaForm.get('nombre_responsable_cirugia')?.errors?.['required']"
                    class="text-red-500 text-xs mt-1">
                    Campo obligatorio según NOM-004 (8.8.17)
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Cédula Profesional del Responsable
                  </label>
                  <input type="text" formControlName="cedula_responsable_cirugia"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500"
                    placeholder="Número de cédula profesional">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Especialidad del Responsable
                  </label>
                  <input type="text" formControlName="especialidad_responsable"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500"
                    placeholder="Especialidad médica">
                </div>

                <div class="flex items-center pt-6">
                  <label class="flex items-center">
                    <input type="checkbox" formControlName="firma_responsable_verificada"
                      class="mr-2 rounded border-gray-300 focus:ring-slate-500">
                    <span class="text-sm text-gray-700">
                      Confirmo que soy el cirujano responsable de esta operación
                    </span>
                  </label>
                </div>
              </div>

            </div>

            <!-- SECCIÓN 14: INFORMACIÓN ADICIONAL -->
            <div class="bg-blue-50 rounded-lg p-4">
              <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                <i class="fas fa-info mr-2"></i>
                Información Adicional
              </h4>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Quirófano Utilizado
                  </label>
                  <input type="text" formControlName="quirofano"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ej: Quirófano 1, Sala A">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Tipo de Anestesia Utilizada
                  </label>
                  <select formControlName="tipo_anestesia"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Seleccione tipo de anestesia...</option>
                    <option value="General">General</option>
                    <option value="Regional">Regional</option>
                    <option value="Local">Local</option>
                    <option value="Sedación">Sedación</option>
                    <option value="Combinada">Combinada</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Hora de Inicio de la Cirugía
                  </label>
                  <input type="time" formControlName="hora_inicio"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Hora de Finalización de la Cirugía
                  </label>
                  <input type="time" formControlName="hora_fin"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>

              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Observaciones Adicionales
                </label>
                <textarea formControlName="observaciones_adicionales" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Cualquier observación adicional relevante sobre la cirugía..."></textarea>
              </div>
            </div>

          </div>

          <!-- SECCIÓN DE BOTONES DE ACCIÓN -->
          <div class="mt-8 border-t border-gray-200 pt-6">
            <div class="flex flex-col sm:flex-row gap-3">

              <!-- Botón Guardar -->
              <button type="button" (click)="guardarFormularioActivo()"
                [disabled]="!notaPostoperatoriaForm.valid || isCreatingDocument"
                class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
                <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
                {{ isCreatingDocument ? 'Guardando Nota...' : 'Guardar Nota Postoperatoria' }}
              </button>

              <!-- Botón Generar PDF -->
              <button type="button" (click)="generarPDF('Nota Postoperatoria')"
                [disabled]="!formularioEstado.notaPostoperatoria"
                class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300 transition-colors flex items-center justify-center">
                <i class="fas fa-file-pdf mr-2"></i>
                <span *ngIf="formularioEstado.notaPostoperatoria">📄 Descargar PDF</span>
                <span *ngIf="!formularioEstado.notaPostoperatoria">Guardar primero</span>
              </button>

              <!-- Botón Limpiar -->
              <button type="button" (click)="limpiarFormulario('notaPostoperatoria')"
                class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center">
                <i class="fas fa-broom mr-2"></i>
                Limpiar Formulario
              </button>

            </div>

            <!-- Información de Estado del Formulario -->
            <div class="mt-4">
              <div *ngIf="formularioEstado.notaPostoperatoria"
                class="bg-green-50 border border-green-200 rounded-lg p-3">
                <div class="flex items-center">
                  <i class="fas fa-check-circle text-green-500 mr-2"></i>
                  <span class="text-green-800 text-sm font-medium">
                    ✅ Nota postoperatoria guardada exitosamente y cumple con NOM-004-SSA3-2012
                  </span>
                </div>
              </div>

              <!-- Mensajes de Validación -->
              <div *ngIf="notaPostoperatoriaForm.errors && notaPostoperatoriaForm.touched"
                class="bg-red-50 border border-red-200 rounded-lg p-3 mt-3">
                <div class="flex items-start">
                  <i class="fas fa-exclamation-triangle text-red-500 mr-2 mt-0.5"></i>
                  <div class="text-red-800 text-sm">
                    <p class="font-medium">Por favor corrige los siguientes errores:</p>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                      <li *ngIf="notaPostoperatoriaForm.get('diagnostico_preoperatorio')?.hasError('required')">
                        Diagnóstico preoperatorio es obligatorio (NOM-004: 8.8.1)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('operacion_planeada')?.hasError('required')">
                        Operación planeada es obligatoria (NOM-004: 8.8.2)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('operacion_realizada')?.hasError('required')">
                        Operación realizada es obligatoria (NOM-004: 8.8.3)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('diagnostico_postoperatorio')?.hasError('required')">
                        Diagnóstico postoperatorio es obligatorio (NOM-004: 8.8.4)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('descripcion_tecnica')?.hasError('required')">
                        Descripción de técnica quirúrgica es obligatoria (NOM-004: 8.8.5)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('hallazgos_transoperatorios')?.hasError('required')">
                        Hallazgos transoperatorios son obligatorios (NOM-004: 8.8.6)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('conteo_gasas_completo')?.hasError('required')">
                        Reporte de conteo de gasas es obligatorio (NOM-004: 8.8.7)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('incidentes_accidentes')?.hasError('required')">
                        Reporte de incidentes y accidentes es obligatorio (NOM-004: 8.8.8)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('sangrado')?.hasError('required')">
                        Cuantificación de sangrado es obligatoria (NOM-004: 8.8.9)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('estudios_transoperatorios')?.hasError('required')">
                        Estudios transoperatorios son obligatorios (NOM-004: 8.8.10)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('ayudantes')?.hasError('required')">
                        Nombres de ayudantes son obligatorios (NOM-004: 8.8.11)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('estado_postquirurgico')?.hasError('required')">
                        Estado post-quirúrgico inmediato es obligatorio (NOM-004: 8.8.12)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('plan_postoperatorio')?.hasError('required')">
                        Plan de manejo postoperatorio es obligatorio (NOM-004: 8.8.13)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('pronostico')?.hasError('required')">
                        Pronóstico es obligatorio (NOM-004: 8.8.14)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('piezas_enviadas_patologia')?.hasError('required')">
                        Envío de piezas quirúrgicas es obligatorio (NOM-004: 8.8.15)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('otros_hallazgos')?.hasError('required')">
                        Otros hallazgos de importancia son obligatorios (NOM-004: 8.8.16)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('nombre_responsable_cirugia')?.hasError('required')">
                        Nombre del responsable de la cirugía es obligatorio (NOM-004: 8.8.17)
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Información sobre Cumplimiento de NOM-004 -->
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
                <div class="flex items-start">
                  <i class="fas fa-info-circle text-blue-500 mr-2 mt-0.5"></i>
                  <div class="text-blue-800 text-sm">
                    <p class="font-medium"> Cumplimiento NOM-004-SSA3-2012 - Sección 8.8</p>
                    <p class="mt-1">
                      Esta nota postoperatoria cumple con todos los requisitos establecidos en la
                      Norma Oficial Mexicana NOM-004-SSA3-2012, Del expediente clínico.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>


    <!-- FORMULARIO DE SOLICITUD DE CULTIVO -->
    <div *ngIf="formularioActivo === 'solicitudCultivo'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-microscope mr-2 text-green-500"></i>
          Solicitud de Cultivo - NOM-004 Sección 9.2
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Solicitud de estudio microbiológico para identificación de agentes patógenos
        </p>
        <div class="mt-2 text-xs text-blue-700 bg-blue-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-info-circle mr-1"></i>
          Campos obligatorios según NOM-004-SSA3-2012 para servicios auxiliares de diagnóstico
        </div>
      </div>

      <form [formGroup]="solicitudCultivoForm" class="px-6 py-4">
        <div class="space-y-6">

          <!-- Información del Estudio -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cultivo *</label>
              <select formControlName="tipo_cultivo"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione el tipo de cultivo...</option>
                <option value="Urocultivo">Urocultivo</option>
                <option value="Hemocultivo">Hemocultivo</option>
                <option value="Coprocultivo">Coprocultivo</option>
                <option value="Cultivo de expectoración">Cultivo de expectoración</option>
                <option value="Cultivo de herida">Cultivo de herida</option>
                <option value="Cultivo de líquido cefalorraquídeo">Cultivo de líquido cefalorraquídeo</option>
                <option value="Cultivo vaginal">Cultivo vaginal</option>
                <option value="Cultivo faríngeo">Cultivo faríngeo</option>
                <option value="Otro">Otro</option>
              </select>
              <div *ngIf="solicitudCultivoForm.get('tipo_cultivo')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Muestra Requerida *</label>
              <input type="text" formControlName="muestra_requerida"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Especifique el tipo de muestra...">
              <div *ngIf="solicitudCultivoForm.get('muestra_requerida')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004
              </div>
            </div>
          </div>

          <!-- Información Clínica -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Información Clínica Relevante *</label>
            <textarea formControlName="informacion_clinica" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Síntomas, signos clínicos, sospecha diagnóstica..."></textarea>
            <div *ngIf="solicitudCultivoForm.get('informacion_clinica')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

          <!-- Sospecha Diagnóstica y Prioridad -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Sospecha Diagnóstica</label>
              <input type="text" formControlName="sospecha_diagnostica"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Diagnóstico presuntivo...">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Prioridad *</label>
              <select formControlName="prioridad"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Normal">Normal</option>
                <option value="Urgente">Urgente</option>
                <option value="Stat">Stat (inmediato)</option>
              </select>
            </div>
          </div>

          <!-- Instrucciones de Toma -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Instrucciones para la Toma de Muestra</label>
            <textarea formControlName="instrucciones_toma" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Condiciones de ayuno, asepsia, momento de toma, etc."></textarea>
          </div>

          <!-- Antibióticos -->
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div class="flex items-center mb-3">
              <i class="fas fa-pills text-yellow-600 mr-2"></i>
              <h4 class="text-sm font-semibold text-yellow-800">Uso de Antibióticos</h4>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="flex items-center text-sm">
                  <input type="checkbox" formControlName="antibioticos_previos" class="mr-2">
                  <span>Paciente con antibióticos previos</span>
                </label>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Antibiótico Utilizado</label>
                <input type="text" formControlName="antibiotico_usado"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre del antibiótico...">
              </div>
            </div>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div class="flex justify-end space-x-3">
            <button type="button" (click)="limpiarFormulario('solicitudCultivo')"
              class="px-6 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
              <i class="fas fa-eraser mr-2"></i>
              Limpiar
            </button>

            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!solicitudCultivoForm.valid || isCreatingDocument"
              class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Solicitud' }}
            </button>

            <button type="button" (click)="generarPDF('Solicitud de Cultivo')"
              [disabled]="!formularioEstado.solicitudCultivo"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.solicitudCultivo">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.solicitudCultivo">Guardar primero</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- FORMULARIO DE SOLICITUD DE GASOMETRÍA -->
    <div *ngIf="formularioActivo === 'solicitudGasometria'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-lungs mr-2 text-teal-500"></i>
          Solicitud de Gasometría - NOM-004 Sección 9.2
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Solicitud de análisis de gases arteriales para evaluación del estado ácido-base
        </p>
        <div class="mt-2 text-xs text-blue-700 bg-blue-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-info-circle mr-1"></i>
          Campos obligatorios según NOM-004-SSA3-2012 para servicios auxiliares de diagnóstico
        </div>
      </div>

      <form [formGroup]="solicitudGasometriaForm" class="px-6 py-4">
        <div class="space-y-6">

          <!-- Tipo de Gasometría -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Gasometría *</label>
              <select formControlName="tipo_gasometria"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione el tipo...</option>
                <option value="Arterial">Gasometría Arterial</option>
                <option value="Venosa">Gasometría Venosa</option>
                <option value="Capilar">Gasometría Capilar</option>
              </select>
              <div *ngIf="solicitudGasometriaForm.get('tipo_gasometria')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Sitio de Punción *</label>
              <select formControlName="sitio_puncion"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione el sitio...</option>
                <option value="Arteria radial">Arteria radial</option>
                <option value="Arteria braquial">Arteria braquial</option>
                <option value="Arteria femoral">Arteria femoral</option>
                <option value="Vena periférica">Vena periférica</option>
                <option value="Línea arterial">Línea arterial</option>
                <option value="Capilar">Capilar (talón/dedo)</option>
              </select>
              <div *ngIf="solicitudGasometriaForm.get('sitio_puncion')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004
              </div>
            </div>
          </div>

          <!-- Condiciones del Paciente -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-blue-800 mb-3">
              <i class="fas fa-user-injured mr-2"></i>
              Condiciones del Paciente
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Temperatura Corporal (°C)</label>
                <input type="number" step="0.1" min="30" max="45" formControlName="temperatura_corporal"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="36.5">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FiO2 (%)</label>
                <input type="number" min="21" max="100" formControlName="fio2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="21">
              </div>
            </div>
          </div>

          <!-- Soporte Ventilatorio -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Soporte Ventilatorio</label>
              <select formControlName="soporte_ventilatorio"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Aire ambiente">Aire ambiente</option>
                <option value="Oxígeno suplementario">Oxígeno suplementario</option>
                <option value="Ventilación mecánica">Ventilación mecánica</option>
                <option value="CPAP">CPAP</option>
                <option value="BiPAP">BiPAP</option>
                <option value="Cánula nasal de alto flujo">Cánula nasal de alto flujo</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Prioridad *</label>
              <select formControlName="prioridad"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Normal">Normal</option>
                <option value="Urgente">Urgente</option>
                <option value="Stat">Stat (inmediato)</option>
              </select>
            </div>
          </div>

          <!-- Información Clínica -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Información Clínica Relevante *</label>
            <textarea formControlName="informacion_clinica" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Estado respiratorio, sospecha diagnóstica, alteraciones ácido-base..."></textarea>
            <div *ngIf="solicitudGasometriaForm.get('informacion_clinica')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

          <!-- Sospecha Diagnóstica -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Sospecha Diagnóstica</label>
            <input type="text" formControlName="sospecha_diagnostica"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Insuficiencia respiratoria, acidosis metabólica, etc.">
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
            <textarea formControlName="observaciones" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Observaciones adicionales..."></textarea>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div class="flex justify-end space-x-3">
            <button type="button" (click)="limpiarFormulario('solicitudGasometria')"
              class="px-6 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
              <i class="fas fa-eraser mr-2"></i>
              Limpiar
            </button>

            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!solicitudGasometriaForm.valid || isCreatingDocument"
              class="bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Solicitud' }}
            </button>

            <button type="button" (click)="generarPDF('Solicitud de Gasometría')"
              [disabled]="!formularioEstado.solicitudGasometria"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.solicitudGasometria">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.solicitudGasometria">Guardar primero</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- FORMULARIO DE REGISTRO DE TRANSFUSIÓN -->
    <div *ngIf="formularioActivo === 'registroTransfusion'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-tint mr-2 text-red-500"></i>
          Registro de Transfusión - NOM-003-SSA2-1993 y NOM-004 Sección D15
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Registro obligatorio de transfusión de sangre o sus componentes según normatividad vigente
        </p>
        <div class="mt-2 text-xs text-blue-700 bg-blue-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-info-circle mr-1"></i>
          Campos obligatorios según NOM-003-SSA2-1993 y NOM-004-SSA3-2012
        </div>
      </div>

      <form [formGroup]="registroTransfusionForm" class="px-6 py-4">
        <div class="space-y-6">

          <!-- Información del Componente -->
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-red-800 mb-3">
              <i class="fas fa-flask mr-2"></i>
              Información del Componente Sanguíneo
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Componente *</label>
                <select formControlName="tipo_componente"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione el componente...</option>
                  <option value="Sangre total">Sangre total</option>
                  <option value="Concentrado eritrocitario">Concentrado eritrocitario</option>
                  <option value="Plasma fresco congelado">Plasma fresco congelado</option>
                  <option value="Concentrado plaquetario">Concentrado plaquetario</option>
                  <option value="Crioprecipitado">Crioprecipitado</option>
                  <option value="Albúmina">Albúmina</option>
                  <option value="Inmunoglobulina">Inmunoglobulina</option>
                </select>
                <div *ngIf="registroTransfusionForm.get('tipo_componente')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-003-SSA2-1993
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Número de Unidad *</label>
                <input type="text" formControlName="numero_unidad"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Número de identificación de la unidad">
                <div *ngIf="registroTransfusionForm.get('numero_unidad')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-003-SSA2-1993
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Volumen (mL) *</label>
                <input type="number" min="50" max="2000" formControlName="volumen"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="250">
                <div *ngIf="registroTransfusionForm.get('volumen')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-003-SSA2-1993
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Grupo Sanguíneo *</label>
                <select formControlName="grupo_sanguineo"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione grupo sanguíneo...</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                </select>
                <div *ngIf="registroTransfusionForm.get('grupo_sanguineo')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-003-SSA2-1993
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Banco de Sangre *</label>
                <input type="text" formControlName="banco_sangre"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre del banco de sangre">
              </div>
            </div>
          </div>

          <!-- Fechas y Horarios -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora de Inicio *</label>
              <input type="datetime-local" formControlName="fecha_hora_inicio"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div *ngIf="registroTransfusionForm.get('fecha_hora_inicio')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora de Finalización</label>
              <input type="datetime-local" formControlName="fecha_hora_fin"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>

          <!-- Signos Vitales -->
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-yellow-800 mb-3">
              <i class="fas fa-heartbeat mr-2"></i>
              Control de Signos Vitales (Antes, Durante y Después)
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Presión Arterial Inicial</label>
                <input type="text" formControlName="presion_arterial_inicial"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="120/80">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Temperatura Inicial (°C)</label>
                <input type="number" step="0.1" min="30" max="45" formControlName="temperatura_inicial"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="36.5">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Pulso Inicial (lpm)</label>
                <input type="number" min="40" max="200" formControlName="pulso_inicial"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="72">
              </div>
            </div>
          </div>

          <!-- Médico Responsable -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Médico que Indica la Transfusión *</label>
            <input type="text" formControlName="medico_responsable"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Dr. Juan Pérez García"
              [value]="pacienteCompleto?.persona?.['nombre_completo'] || 'Dr. ' + (pacienteCompleto?.persona?.nombre || '')">
            <div *ngIf="registroTransfusionForm.get('medico_responsable')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

          <!-- Reacciones Adversas -->
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
            <div class="flex items-center mb-3">
              <input type="checkbox" formControlName="presenta_reacciones" class="mr-2">
              <label class="text-sm font-semibold text-orange-800">
                El paciente presentó reacciones adversas durante la transfusión
              </label>
            </div>
            <div *ngIf="registroTransfusionForm.get('presenta_reacciones')?.value">
              <label class="block text-sm font-medium text-gray-700 mb-1">Descripción de Reacciones Adversas</label>
              <textarea formControlName="reacciones_adversas" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Descripción detallada de las reacciones presentadas..."></textarea>
            </div>
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
            <textarea formControlName="observaciones" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Observaciones adicionales sobre el procedimiento..."></textarea>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div class="flex justify-end space-x-3">
            <button type="button" (click)="limpiarFormulario('registroTransfusion')"
              class="px-6 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
              <i class="fas fa-eraser mr-2"></i>
              Limpiar
            </button>

            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!registroTransfusionForm.valid || isCreatingDocument"
              class="bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Registro' }}
            </button>

            <button type="button" (click)="generarPDF('Registro de Transfusión')"
              [disabled]="!formularioEstado.registroTransfusion"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.registroTransfusion">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.registroTransfusion">Guardar primero</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- FORMULARIO DE ALTA VOLUNTARIA -->
    <div *ngIf="formularioActivo === 'altaVoluntaria'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-sign-out-alt mr-2 text-orange-500"></i>
          Hoja de Egreso Voluntario - NOM-004 Sección 10.2
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Documento mediante el cual el paciente solicita el egreso voluntario con conocimiento de las consecuencias
        </p>
        <div class="mt-2 text-xs text-blue-700 bg-blue-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-info-circle mr-1"></i>
          Campos obligatorios según NOM-004-SSA3-2012 Sección 10.2
        </div>
        <div class="mt-2 text-xs text-red-700 bg-red-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-exclamation-triangle mr-1"></i>
          Este documento exime de responsabilidad al establecimiento y al médico tratante
        </div>
      </div>

      <form [formGroup]="altaVoluntariaForm" class="px-6 py-4">
        <div class="space-y-6">

          <!-- Información del Egreso -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Egreso *</label>
              <input type="date" formControlName="fecha_egreso"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div *ngIf="altaVoluntariaForm.get('fecha_egreso')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Hora de Egreso *</label>
              <input type="time" formControlName="hora_egreso"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div *ngIf="altaVoluntariaForm.get('hora_egreso')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004
              </div>
            </div>
          </div>

          <!-- Persona que Solicita -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-blue-800 mb-3">
              <i class="fas fa-user mr-2"></i>
              Persona que Solicita el Egreso
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                <input type="text" formControlName="nombre_solicitante"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre completo de quien solicita">
                <div *ngIf="altaVoluntariaForm.get('nombre_solicitante')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Parentesco con el Paciente *</label>
                <select formControlName="parentesco"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione parentesco...</option>
                  <option value="Paciente">El mismo paciente</option>
                  <option value="Padre">Padre</option>
                  <option value="Madre">Madre</option>
                  <option value="Esposo(a)">Esposo(a)</option>
                  <option value="Hijo(a)">Hijo(a)</option>
                  <option value="Hermano(a)">Hermano(a)</option>
                  <option value="Tutor">Tutor legal</option>
                  <option value="Representante legal">Representante legal</option>
                  <option value="Otro">Otro</option>
                </select>
                <div *ngIf="altaVoluntariaForm.get('parentesco')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004
                </div>
              </div>
            </div>

            <div class="mt-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Edad del Solicitante *</label>
              <input type="number" min="18" max="120" formControlName="edad_solicitante"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Edad en años">
              <div *ngIf="altaVoluntariaForm.get('edad_solicitante')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004
              </div>
            </div>
          </div>

          <!-- Resumen Clínico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Resumen Clínico *</label>
            <textarea formControlName="resumen_clinico" rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Motivo de ingreso, diagnóstico actual, tratamiento proporcionado..."></textarea>
            <div *ngIf="altaVoluntariaForm.get('resumen_clinico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004 Sección 6.4.3
            </div>
            <p class="text-xs text-gray-500 mt-1">Debe incluir: motivo de envío, impresión diagnóstica y terapéutica
              empleada</p>
          </div>

          <!-- Motivo del Egreso Voluntario -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Motivo del Egreso Voluntario</label>
            <textarea formControlName="motivo_egreso" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Razón por la cual se solicita el egreso voluntario..."></textarea>
          </div>

          <!-- Recomendaciones Médicas -->
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-yellow-800 mb-3">
              <i class="fas fa-stethoscope mr-2"></i>
              Medidas Recomendadas para la Protección de la Salud
            </h4>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Recomendaciones Médicas *</label>
              <textarea formControlName="recomendaciones_medicas" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Cuidados específicos, medicamentos, signos de alarma, cuándo acudir a urgencias..."></textarea>
              <div *ngIf="altaVoluntariaForm.get('recomendaciones_medicas')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio según NOM-004
              </div>
            </div>

            <div class="mt-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Atención de Factores de Riesgo</label>
              <textarea formControlName="factores_riesgo" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Factores de riesgo a vigilar y controlar..."></textarea>
            </div>
          </div>

          <!-- Continuidad del Tratamiento -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="flex items-center text-sm">
                <input type="checkbox" formControlName="continua_tratamiento_externo" class="mr-2">
                <span>Continuará tratamiento en otro establecimiento</span>
              </label>
            </div>
            <div *ngIf="altaVoluntariaForm.get('continua_tratamiento_externo')?.value">
              <label class="block text-sm font-medium text-gray-700 mb-1">Establecimiento de Destino</label>
              <input type="text" formControlName="establecimiento_destino"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Nombre del establecimiento donde continuará tratamiento">
            </div>
          </div>

          <!-- Testigos -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-gray-800 mb-3">
              <i class="fas fa-users mr-2"></i>
              Testigos (2 requeridos)
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Primer Testigo *</label>
                <input type="text" formControlName="testigo1_nombre"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre completo del primer testigo">
                <div *ngIf="altaVoluntariaForm.get('testigo1_nombre')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Segundo Testigo *</label>
                <input type="text" formControlName="testigo2_nombre"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre completo del segundo testigo">
                <div *ngIf="altaVoluntariaForm.get('testigo2_nombre')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio según NOM-004
                </div>
              </div>
            </div>
          </div>

          <!-- Médico que Autoriza -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Médico que Emite la Hoja *</label>
            <input type="text" formControlName="medico_autoriza"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Dr. Juan Pérez García"
              [value]="pacienteCompleto?.persona?.['nombre_completo'] || 'Dr. ' + (pacienteCompleto?.persona?.nombre || '')">
            <div *ngIf="altaVoluntariaForm.get('medico_autoriza')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio según NOM-004
            </div>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div class="flex justify-end space-x-3">
            <button type="button" (click)="limpiarFormulario('altaVoluntaria')"
              class="px-6 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
              <i class="fas fa-eraser mr-2"></i>
              Limpiar
            </button>

            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!altaVoluntariaForm.valid || isCreatingDocument"
              class="bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Hoja de Egreso' }}
            </button>

            <button type="button" (click)="generarPDF('Hoja de Egreso Voluntario')"
              [disabled]="!formularioEstado.altaVoluntaria"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.altaVoluntaria">📄 Descargar PDF</span>
              <span *ngIf="!formularioEstado.altaVoluntaria">Guardar primero</span>
            </button>
          </div>
        </div>
      </form>
    </div>

