
async generarNotaUrgencias(datos: any): Promise<any> {
  const pacienteCompleto = datos.pacienteCompleto;
  const medicoCompleto = datos.medicoCompleto;
  const notaUrgenciasData = datos.notaUrgencias || {};
  const signosVitales = datos.signosVitales || {};
  const fechaActual = new Date();

  const documentoFinal = {
    pageSize: 'LETTER',
    pageMargins: [20, 60, 20, 40],
    header: {
      margin: [20, 10, 20, 10],
      table: {
        widths: ['20%', '60%', '20%'],
        body: [
          [
            {
              image: await this.obtenerImagenBase64('/uploads/logos/logo-gobierno-default.svg'),
              fit: [80, 40],
              alignment: 'left',
              margin: [0, 5]
            },
            {
              text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA DE URGENCIAS',
              fontSize: 10,
              bold: true,
              alignment: 'center',
              color: '#1a365d',
              margin: [0, 8]
            },
            {
              image: await this.obtenerImagenBase64('/uploads/logos/logo-principal-default.svg'),
              fit: [80, 40],
              alignment: 'right',
              margin: [0, 5]
            }
          ]
        ]
      },
      layout: 'noBorders',
    },
    content: [
      {
        table: {
          widths: ['15%', '85%'],
          body: [
            [
              {
                text: 'IDENTIFICACIN',
                fontSize: 8,
                bold: true,
                fillColor: '#f5f5f5',
                alignment: 'center',
                rowSpan: 6,
              },
              {
                table: {
                  widths: ['20%', '20%', '20%', '20%', '20%'],
                  body: [
                    [
                      { text: 'Fecha de elaboraci贸n', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Hora de elaboraci贸n', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'No. Expediente', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'No. de cama', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Servicio', fontSize: 7, bold: true, alignment: 'center' }
                    ], [
                      { text: fechaActual.toLocaleDateString('es-MX'), fontSize: 7, alignment: 'center' },
                      { text: fechaActual.toLocaleTimeString('es-MX'), fontSize: 7, alignment: 'center' },
                      { text: this.obtenerNumeroExpedientePreferido(pacienteCompleto.expediente) || 'N/A', fontSize: 7, alignment: 'center', bold: true },
                      { text: notaUrgenciasData.numero_cama || 'NO ASIGNADO', fontSize: 7, alignment: 'center' },
                      { text: medicoCompleto.departamento || 'No especificado', fontSize: 7, alignment: 'center' }
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
            [
              {},
              {
                table: {
                  widths: ['55%', '15%', '15%', '15%'],
                  body: [
                    [
                      { text: 'Nombre completo del paciente', fontSize: 7, bold: true },
                      { text: 'Edad', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Sexo', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Tipo de sangre', fontSize: 7, bold: true, alignment: 'center' }
                    ],
                    [
                      { text: pacienteCompleto.nombre_completo, fontSize: 8, bold: true, margin: [2, 3] },
                      { text: `${pacienteCompleto.edad} a帽os`, fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.sexo, fontSize: 7, alignment: 'center' },
                      { text: datos.pacienteCompleto.tipo_sangre || 'No especificado', fontSize: 7, alignment: 'center', bold: true, color: '#dc2626' }
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
            [
              {},
              {
                table: {
                  widths: ['100%'],
                  body: [
                    [{ text: 'Domicilio del paciente', fontSize: 7, bold: true }],
                    [{ text: this.formatearDireccionMejorada(pacienteCompleto) || 'Sin direcci贸n registrada', fontSize: 7, margin: [2, 3] }]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
            [
              {},
              {
                table: {
                  widths: ['25%', '25%', '25%', '25%'],
                  body: [
                    [
                      { text: 'Fecha nacimiento', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'CURP', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Lugar de nacimiento', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Tel茅fono', fontSize: 7, bold: true, alignment: 'center' }
                    ],
                    [
                      { text: this.formatearFecha(pacienteCompleto.fecha_nacimiento) || 'No registrada', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.curp || 'No registrado', fontSize: 6, alignment: 'center' },
                      { text: pacienteCompleto.lugar_nacimiento || 'No especificado', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.telefono || 'No registrado', fontSize: 7, alignment: 'center' }
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
            [
              {},
              {
                table: {
                  widths: ['25%', '25%', '25%', '25%'],
                  body: [
                    [
                      { text: 'Ocupaci贸n', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Escolaridad', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Estado civil', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Religi贸n', fontSize: 7, bold: true, alignment: 'center' }
                    ],
                    [
                      { text: pacienteCompleto.ocupacion || 'No registrada', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.escolaridad || 'No registrada', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.estado_civil || 'No registrado', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.religion || 'No registrada', fontSize: 7, alignment: 'center' }
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
            [
              {},
              {
                table: {
                  widths: ['60%', '40%'],
                  body: [
                    [
                      { text: 'Familiar responsable/Tutor', fontSize: 7, bold: true, alignment: 'center' },
                      { text: 'Tel茅fono de contacto', fontSize: 7, bold: true, alignment: 'center' }
                    ],
                    [
                      { text: pacienteCompleto.familiar_responsable || 'No registrado', fontSize: 7, alignment: 'center' },
                      { text: pacienteCompleto.telefono_familiar || 'No registrado', fontSize: 7, alignment: 'center' }
                    ]
                  ]
                },
                layout: {
                  hLineWidth: () => 0.3,
                  vLineWidth: () => 0.3,
                  hLineColor: () => '#000000',
                  vLineColor: () => '#000000',
                }
              }
            ],
          ]
        }
      },
      { text: '', margin: [0, 15] },
      //  MOTIVO DE ATENCIN
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'MOTIVO DE ATENCIN', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Motivo de atenci贸n:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.motivo_atencion || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      //  ESTADO DE CONCIENCIA
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'ESTADO DE CONCIENCIA', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Estado de conciencia:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.estado_conciencia || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      //  RESUMEN DEL INTERROGATORIO
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'RESUMEN DEL INTERROGATORIO', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Resumen del interrogatorio:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.resumen_interrogatorio || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      //  EXPLORACIN FSICA
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'EXPLORACIN FSICA', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Exploraci贸n f铆sica:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.exploracion_fisica || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      //  RESULTADOS DE ESTUDIOS
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'RESULTADOS DE ESTUDIOS', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Resultados de estudios:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.resultados_estudios || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      //  ESTADO MENTAL
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'ESTADO MENTAL', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Estado mental:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.estado_mental || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      //  DIAGNSTICO
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'DIAGNSTICO', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Diagn贸stico:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.diagnostico || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      //  PLAN DE TRATAMIENTO
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'PLAN DE TRATAMIENTO', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Plan de tratamiento:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.plan_tratamiento || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      //  PRONSTICO
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: 'PRONSTICO', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 2 },
              {}
            ],
            [
              { text: 'Pron贸stico:', fontSize: 7, bold: true },
              { text: notaUrgenciasData.pronostico || 'No especificado', fontSize: 7 }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      //  SIGNOS VITALES
      {
        table: {
          widths: ['25%', '25%', '25%', '25%'],
          body: [
            [
              { text: 'SIGNOS VITALES', fontSize: 10, bold: true, fillColor: '#fef3c7', alignment: 'center', colSpan: 4 },
              {},
              {},
              {}
            ],
            [
              { text: 'Temperatura (掳C)', fontSize: 7, bold: true, alignment: 'center' },
              { text: 'Presi贸n arterial sist贸lica (mmHg)', fontSize: 7, bold: true, alignment: 'center' },
              { text: 'Presi贸n arterial diast贸lica (mmHg)', fontSize: 7, bold: true, alignment: 'center' },
              { text: 'Frecuencia card铆aca (lpm)', fontSize: 7, bold: true, alignment: 'center' }
            ],
            [
              { text: signosVitales.temperatura || 'No especificado', fontSize: 7, alignment: 'center' },
              { text: signosVitales.presion_arterial_sistolica || 'No especificado', fontSize: 7, alignment: 'center' },
              { text: signosVitales.presion_arterial_diastolica || 'No especificado', fontSize: 7, alignment: 'center' },
              { text: signosVitales.frecuencia_cardiaca || 'No especificado', fontSize: 7, alignment: 'center' }
            ]
          ]
        },
        layout: 'noBorders'
      },
      { text: '', margin: [0, 15] },
      //  FIRMA DEL MEDICO
      {
        table: {
          widths: ['100%'],
          body: [
            [
              { text: '__________________________________', fontSize: 7, alignment: 'center' },
              { text: `Firma del m茅dico: ${medicoCompleto.nombre_completo}`, fontSize: 7, alignment: 'center' }
            ]
          ]
        },
        layout: 'noBorders'
      }
    ],
    footer: (currentPage: number, pageCount: number) => {
      return {
        margin: [20, 10],
        table: {
          widths: ['30%', '40%', '30%'],
          body: [
            [
              { text: `P谩gina ${currentPage} de ${pageCount}`, fontSize: 7, color: '#6b7280' },
              { text: 'Nota de Urgencias - SICEG', fontSize: 7, alignment: 'center', color: '#6b7280' },
              { text: fechaActual.toLocaleDateString('es-MX'), fontSize: 7, alignment: 'right', color: '#6b7280' }
            ]
          ]
        },
        layout: 'noBorders'
      };
    }
  };

  return documentoFinal;
}

  //  NOTA DE EVOLUCIN  NOM-004-SSA3-2012
  async generarNotaEvolucion(datos: any): Promise<any> {
    console.log(' Generando Nota de Evoluci贸n seg煤n NOM-004...');

    //    CORRECCIN: Usar los datos ya preparados
    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const signosVitales = datos.signosVitales;
    const notaEvolucionData = datos.notaEvolucion || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50], //   MRGENES OPTIMIZADOS

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA DE EVOLUCIN',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        //  SECCIN IDENTIFICACIN DEL PACIENTE (NOM-004 5.9)
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['18%', '18%', '18%', '18%', '14%', '14%'],
                    body: [
                      [
                        {
                          text: 'Fecha evoluci贸n',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora evoluci贸n',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. de cama',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'D铆a estancia',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio nota',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: notaEvolucionData.numero_cama || 'Sin asignar',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${datos.diasHospitalizacion}掳`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `NE-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['60%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} a帽os`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Servicio hospitalario',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Diagn贸stico ingreso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo de sangre',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'No especificado',
                          fontSize: 7,
                          margin: [2, 2],
                        },
                        {
                          text:
                            notaEvolucionData.diagnostico_ingreso ||
                            'Ver expediente',
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.tipo_sangre || 'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['60%', '40%'],
                    body: [
                      [
                        {
                          text: 'Familiar responsable',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Tel茅fono de contacto',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            pacienteCompleto.familiar_responsable ||
                            'No registrado',
                          fontSize: 7,
                          margin: [2, 2],
                        },
                        {
                          text:
                            pacienteCompleto.telefono_familiar ||
                            'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  NOTA DE EVOLUCIN SEGN NOM-004 (SECCIN 6.2)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'NOTA DE EVOLUCIN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'EVOLUCIN Y ACTUALIZACIN DEL CUADRO CLNICO (6.2.1)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.evolucion_analisis ||
                    notaEvolucionData.sintomas_signos ||
                    'Paciente en evoluci贸n cl铆nica favorable. Sin cambios significativos en el cuadro cl铆nico inicial.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'SIGNOS VITALES SEGN SE CONSIDERE NECESARIO (6.2.2)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Presi贸n arterial',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia card铆aca',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia respiratoria',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Temperatura',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Saturaci贸n O2',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            signosVitales.presion_arterial_sistolica || '___'
                          }/${
                            signosVitales.presion_arterial_diastolica || '___'
                          } mmHg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_cardiaca || '___'
                          } lpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_respiratoria || '___'
                          } rpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${signosVitales.temperatura || '___'} 掳C`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.saturacion_oxigeno || '___'
                          } %`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 2],
                },
              ],
              [
                {},
                {
                  text: 'SOMATOMETRA Y ESTADO NUTRICIONAL',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text: `Peso: ${signosVitales.peso || '___'} kg | Talla: ${
                    signosVitales.talla || '___'
                  } cm | Estado nutricional: ${
                    notaEvolucionData.estado_nutricional ||
                    'Adecuado para la edad'
                  }`,
                  fontSize: 7,
                  margin: [5, 3],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  ESTUDIOS Y RESULTADOS (6.2.3)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTUDIOS Y RESULTADOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'RESULTADOS RELEVANTES DE ESTUDIOS DE SERVICIOS AUXILIARES (6.2.3)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.estudios_laboratorio_gabinete ||
                    'Sin estudios nuevos solicitados. Resultados pendientes o no aplicables para la evoluci贸n actual.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  EXPLORACIN FSICA DIRIGIDA
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EXPLORACIN FSICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'HABITUS EXTERIOR',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.habitus_exterior ||
                    'Paciente consciente, orientado, cooperador. Facies no caracter铆sticas, marcha conservada, actitud adecuada.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'EXPLORACIN DIRIGIDA POR APARATOS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    `Cardiovascular: ${
                      notaEvolucionData.exploracion_cardiovascular ||
                      'Ruidos card铆acos r铆tmicos, sin soplos'
                    }\n` +
                    `Respiratorio: ${
                      notaEvolucionData.exploracion_respiratorio ||
                      'Murmullo vesicular presente, sin ruidos agregados'
                    }\n` +
                    `Abdomen: ${
                      notaEvolucionData.exploracion_abdomen ||
                      'Blando, depresible, sin dolor'
                    }\n` +
                    `Neurol贸gico: ${
                      notaEvolucionData.exploracion_neurologico ||
                      'Sin d茅ficit motor ni sensitivo'
                    }`,
                  fontSize: 7,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  DIAGNSTICOS Y PROBLEMAS CLNICOS (6.2.4)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'DIAGNSTICOS ACTUALES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'DIAGNSTICOS O PROBLEMAS CLNICOS (6.2.4)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.diagnosticos ||
                    'Diagn贸sticos en seguimiento seg煤n nota de ingreso. Sin cambios en impresi贸n diagn贸stica.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  PRONSTICO (6.2.5)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PRONSTICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: `PRONSTICO (6.2.5): ${
                    notaEvolucionData.pronostico ||
                    'Favorable para la vida y funci贸n. Reservado a evoluci贸n cl铆nica.'
                  }`,
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  TRATAMIENTO E INDICACIONES MDICAS (6.2.6)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'TRATAMIENTO E INDICACIONES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'TRATAMIENTO E INDICACIONES MDICAS (6.2.6)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.plan_estudios_tratamiento ||
                    'Continuar manejo actual. Vigilar evoluci贸n cl铆nica. Medidas generales de soporte.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MEDICAMENTOS (DOSIS, VA, PERIODICIDAD)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    notaEvolucionData.indicaciones_medicas ||
                    'Medicamentos seg煤n prescripci贸n previa. Revisar esquema terap茅utico en nota de ingreso.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  INTERCONSULTAS Y PROCEDIMIENTOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INTERCONSULTAS Y PROCEDIMIENTOS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                  alignment: 'center',
                },
              ],
              [
                {
                  text:
                    notaEvolucionData.interconsultas ||
                    'Sin interconsultas programadas para esta evoluci贸n. Sin procedimientos especiales indicados.',
                  fontSize: 8,
                  margin: [10, 5],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        //  MDICO RESPONSABLE SEGN NOM-004 (5.10)
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: 'NOMBRE COMPLETO Y CDULA PROFESIONAL DEL MDICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: 'FIRMA AUTGRAFA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `C茅dula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `${medicoCompleto.cargo} - ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Hospital General San Luis de la Paz\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Fecha: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Hora: ${fechaActual.toLocaleTimeString('es-MX')}`,
                      fontSize: 7,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
                {
                  text: '\n\n\n\n_________________________\nFIRMA DEL MDICO TRATANTE\n(NOM-004-SSA3-2012)',
                  fontSize: 8,
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        //  NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Secci贸n 6.2 "Nota de evoluci贸n"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos establecidos en los numerales 6.2.1 al 6.2.6',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota de Evoluci贸n - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }

  TENGO ESTOS TEMPLATES BORRADOS ANTERIORMENTE:
  //  NOTA DE CONSENTIMIENTO INFORMADO PARA PROCEDIMIENTOS SEGN NOM-004-SSA3-2012
  async generarNotaConsentimientoProcedimientos(datos: any): Promise<any> {
    console.log(
      ' Generando Nota de Consentimiento Informado para Procedimientos seg煤n NOM-004...'
    );

    //    CORRECCIN: Usar los datos ya preparados
    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const consentimientoData = datos.consentimiento || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 80, 40, 80],

      header: {
        margin: [40, 20, 40, 20],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
                fontSize: 14,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'CARTA DE CONSENTIMIENTO INFORMADO PARA',
                fontSize: 12,
                bold: true,
                alignment: 'center',
                margin: [0, 5, 0, 0],
              },
            ],
            [
              {
                text: 'OPERACIN O PROCEDIMIENTOS Y ALTERNATIVAS',
                fontSize: 14,
                bold: true,
                alignment: 'center',
                margin: [0, 2, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  DATOS DEL PACIENTE
        {
          table: {
            widths: ['13%', '37%', '8%', '12%', '12%', '18%'],
            body: [
              [
                { text: 'Nombre:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 9, bold: true },
                {
                  text: `${pacienteCompleto.edad} a帽os`,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Fecha:', fontSize: 9, bold: true },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'CURP:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.curp,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Sexo:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'F. Nacimiento:', fontSize: 8, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Cama:', fontSize: 9, bold: true },
                {
                  text: consentimientoData.numero_cama || 'N/A',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 9, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  DECLARACIN INICIAL
        {
          table: {
            widths: ['5%', '95%'],
            body: [
              [
                { text: 'YO', fontSize: 11, bold: true },
                {
                  text:
                    consentimientoData.nombre_responsable ||
                    pacienteCompleto.nombre_completo,
                  fontSize: 11,
                  decoration: 'underline',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        {
          text: [
            {
              text: 'en pleno uso de mis facultades mentales, ',
              fontSize: 11,
            },
            { text: 'AUTORIZO', fontSize: 11, bold: true },
            {
              text: ' a este Hospital y a su personal para realizar la siguiente Operaci贸n (o Procedimiento):',
              fontSize: 11,
            },
          ],
          lineHeight: 1.1,
          margin: [0, 0, 0, 10],
        },

        //  NOMBRE DEL PROCEDIMIENTO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text:
                    consentimientoData.nombre_procedimiento ||
                    '________________________________________________________________________',
                  fontSize: 12,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Entendiendo que la ventaja de someterme a este procedimiento quir煤rgico o diagn贸stico es:',
          fontSize: 11,
          margin: [0, 0, 0, 10],
        },

        //  BENEFICIOS DEL PROCEDIMIENTO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text:
                    consentimientoData.beneficios_procedimiento ||
                    '_________________________________________________________________\n_________________________________________________________________',
                  fontSize: 10,
                  margin: [10, 10, 10, 10],
                  minHeight: 40,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        //  RIESGOS
        {
          text: [{ text: 'RIESGOS:', fontSize: 11, bold: true }],
          margin: [0, 0, 0, 10],
        },

        {
          text: 'Se da autorizaci贸n bajo el entendimiento pleno de que cualquier operaci贸n o procedimiento m茅dico-quir煤rgico, implica alg煤n(os) riesgo(s) y/o peligro(s). Los riesgos m谩s comunes incluyen: Infecci贸n, Hemorragia, Lesi贸n nerviosa, Co谩gulos sangu铆neos, ataque cardiaco, Reacciones al茅rgicas y neumon铆a. Estos riesgos pueden ser graves e incluso mortales. Algunos riesgos importantes en especial de este tipo de intervenci贸n que se va a realizar son:',
          fontSize: 10,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        //  RIESGOS ESPECFICOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text:
                    consentimientoData.riesgos_especificos ||
                    '_________________________________________________________________\n_________________________________________________________________\n_________________________________________________________________',
                  fontSize: 10,
                  margin: [10, 10, 10, 10],
                  minHeight: 60,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        //  ANESTESIA
        {
          text: [{ text: 'ANESTESIA:', fontSize: 11, bold: true }],
          margin: [0, 0, 0, 10],
        },

        {
          text: [
            {
              text: 'La aplicaci贸n de Anestesia tambi茅n implica riesgos; el m谩s importante de estos, aunque poco frecuente que suceda, es el riesgo de sufrir alguna reacci贸n a los medicamentos que pueden ser incluso fatales. ',
              fontSize: 11,
            },
            { text: 'Autorizo', fontSize: 11, bold: true },
            {
              text: ' la t茅cnica y el uso de anest茅sicos que juzgue necesarios la persona de este servicio para la realizaci贸n del procedimiento autorizado.',
              fontSize: 11,
            },
          ],
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        //  PROCEDIMIENTOS ADICIONALES
        {
          text: [
            { text: 'PROCEDIMIENTOS ADICIONALES:', fontSize: 11, bold: true },
          ],
          margin: [0, 0, 0, 10],
        },

        {
          text: [
            {
              text: 'Si mi M茅dico selecciona un procedimiento diferente, por alguna situaci贸n especial no sospechada en el transcurso de mi intervenci贸n, (s铆 贸 no) ',
              fontSize: 11,
            },
            {
              text:
                consentimientoData.autoriza_procedimientos_adicionales ||
                '______',
              fontSize: 11,
              decoration: 'underline',
            },
            {
              text: ' lo autorizo a realizar si lo considera necesario',
              fontSize: 11,
            },
          ],
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Estoy enterado(a), de que no existe garant铆a o seguridad sobre resultados del procedimiento y de que existe la posibilidad de que no pueda curarse la enfermedad o padecimiento que presento.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        {
          text: 'As铆 tambi茅n estoy enterado(a) de que nadie puede decir con seguridad cu谩les ser谩n las complicaciones que ocurran en mi caso, si es que las hay.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 20],
        },

        //  CONSENTIMIENTO DEL PACIENTE
        {
          text: [
            {
              text: 'CONSENTIMIENTO DEL PACIENTE, O TUTOR:',
              fontSize: 11,
              bold: true,
            },
          ],
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Tengo que leer y entender esta forma de consentimiento, la que no debo firmar si alguno de los p谩rrafos o de mis dudas no han sido explicadas a mi entera satisfacci贸n o si no entiendo cualquier t茅rmino o palabra contenida en ese documento.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Si tiene cualquier duda acerca de los riesgos o peligros de la cirug铆a o tratamiento propuesto, pregunte a su Cirujano, ahora. 隆Antes de firmar el documento! 隆No firme a menos de que entienda por completo este documento!',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 25],
        },

        //  FIRMAS
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________\nNombre y firma del m茅dico',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 20, 0, 10],
                },
                {
                  text: '\n\n\n_________________________________\nNombre y firma del paciente, tutor o representante',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 20, 0, 10],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________\nTestigo nombre y firma',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 10, 0, 10],
                },
                {
                  text: '\n\n\n_________________________________\nTestigo nombre y firma',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 10, 0, 10],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        //  LUGAR Y FECHA
        {
          table: {
            widths: ['35%', '10%', '8%', '20%', '8%', '19%'],
            body: [
              [
                { text: 'San Luis de la Paz, Guanajuato a', fontSize: 10 },
                {
                  text: fechaActual.getDate(),
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 10, alignment: 'center' },
                {
                  text: fechaActual.toLocaleDateString('es-MX', {
                    month: 'long',
                  }),
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 10, alignment: 'center' },
                {
                  text: `20${fechaActual.getFullYear().toString().slice(-2)}`,
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: 'noBorders',
          alignment: 'center',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Consentimiento Informado - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  CONSENTIMIENTO INFORMADO PARA HOSPITALIZACIN SEGN NOM-004-SSA3-2012
  async generarConsentimientoHospitalizacion(datos: any): Promise<any> {
    console.log(
      'Generando Consentimiento Informado para Hospitalizaci贸n seg煤n NOM-004...'
    );

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const consentimientoData = datos.consentimientoHospitalizacion || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 60, 40, 60],

      content: [
        { text: '', margin: [0, 20] },

        //  DATOS DEL PACIENTE
        {
          table: {
            widths: ['13%', '37%', '8%', '12%', '12%', '18%'],
            body: [
              [
                { text: 'Nombre:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 9, bold: true },
                {
                  text: `${pacienteCompleto.edad} a帽os`,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Fecha:', fontSize: 9, bold: true },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'CURP:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.curp,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Sexo:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'F. Nacimiento:', fontSize: 8, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Cama:', fontSize: 9, bold: true },
                {
                  text: consentimientoData.numero_cama || 'Por asignar',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 9, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  DECLARACIN INICIAL
        {
          table: {
            widths: ['5%', '95%'],
            body: [
              [
                { text: 'YO', fontSize: 11, bold: true },
                {
                  text:
                    consentimientoData.nombre_responsable ||
                    pacienteCompleto.nombre_completo,
                  fontSize: 11,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 10],
        },

        {
          text: 'familiar o allegado designado por el paciente, y en caso de menores de edad e incapacitados para otorgar su consentimiento y/o autorizaci贸n.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 20],
        },

        //  AUTORIZO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'AUTORIZO',
                  fontSize: 14,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 10, 0, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'En atenci贸n a los art铆culos 80 al 83 de reglamento de la Ley General de Salud en materia de atenci贸n m茅dica y a la NOM-168-SSA1-1998 relativa al expediente cl铆nico numerales 4.2, 10.1 al 10.1.2, se otorga la presente autorizaci贸n al personal M茅dico y Param茅dico del Hospital.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
        },

        //  HOSPITAL
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
                  fontSize: 13,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'para realizar los procedimientos m茅dicos y/o quir煤rgicos necesarios al paciente en cuesti贸n, y',
          fontSize: 11,
          margin: [0, 0, 0, 10],
        },

        {
          text: 'para tal efecto, dicho paciente y/o su representante legal DECLARA:',
          fontSize: 11,
          margin: [0, 0, 0, 15],
        },

        //  DECLARO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DECLARO',
                  fontSize: 14,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 10, 0, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Que los M茅dicos del Hospital le han explicado de una manera detallada y con un lenguaje que pudo comprender, que los procedimientos m茅dicos y/o quir煤rgicos que se planean realizar, tienen como objetivo primordial dar soluci贸n a los problemas de salud del enfermo, utilizando las t茅cnicas vigentes para tal efecto, en virtud de que el personal de salud que labora en dicha instituci贸n se declara ampliamente capacitado y que cuanta con autorizaci贸n legal con efectos de patente y c茅dula profesional correspondiente para el libre ejercicio de su especialidad m茅dica o quir煤rgica en su caso, as铆 como la certificaci贸n vigente del consejo nacional de dicha especialidad, adem谩s de comprometerse a cuidar de la salud y la integridad, del enfermo y actuar con 茅tica y responsabilidad en beneficio del paciente y su entorno biol贸gico, psicol贸gico y social.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        {
          text: 'Que cualquier procedimiento m茅dico implica una serie de riesgo no siempre previsible debido a diversas circunstancias que entre otras se consideran se estado f铆sico previo, enfermedades pre o coexistentes, tratamientos previos, etc茅tera y que existe la posibilidad de complicaciones debidas al tratamiento m茅dico y/o quir煤rgico, ya que cada paciente puede reaccionar en forma diversa a la aplicaci贸n de tal f谩rmaco o bien a la realizaci贸n de determinado procedimiento, dichas complicaciones pueden ser transitorias o permanentes y pueden ir desde leves hasta severas y pueden poner en peligro la vida del paciente e incluso provocar la muerte.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        {
          text: 'Que, en circunstancias especiales, el personal de salud se ver谩 obligado a utilizar t茅cnicas invasivas de diagn贸stico y tratamiento, conforme a los protocolos m茅dicos actuales con el objeto de mantener una vigilancia estrecha de las constantes vitales o bien de proporcionar una terap茅utica oportuna que puede salvar la vida del paciente, pero las cuales se requiere la aplicaci贸n de sondas, cat茅teres o marcapasos seg煤n sea al caso.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        {
          text: 'Que algunas enfermedades pueden requerir de un procedimiento quir煤rgico para su resoluci贸n y que esta necesidad puede presentarse en cualquier momento de su estancia hospitalaria, para lo cual se solicitar谩 una autorizaci贸n previa del paciente o su representante legal en su caso, sin embargo, en dado caso que dicha persona no autorice el procedimiento en cuesti贸n, o bien solicite su alta voluntaria por cualquier motivo, el Hospital y el personal que en el labora quedar谩 autom谩ticamente exento de cualquier implicaci贸n m茅dica y legal derivada de la decisi贸n, as铆 como de la evoluci贸n consecutiva del paciente.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        {
          text: 'Que en ocasiones puede ser necesaria la aplicaci贸n de sangre o productos sangu铆neos para la resoluci贸n de determinados problemas de salud, por lo que se autoriza a los m茅dicos a emplear dicha terap茅utica siempre que sea necesaria, con las reservas que marcan las normas vigentes.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        {
          text: 'Que el paciente ser谩 sometido a un protocolo terap茅utico que se encuentra ampliamente documentado en el expediente cl铆nico y que se apega estrechamente a las consideraciones 茅ticas del tratado de Helsinki modificado en Viena y que el paciente debe seguir estrechamente las indicaciones para el diagn贸stico y tratamiento de su enfermedad, ya que de no ser as铆 o bien en el caso que el paciente siga instrucciones ajenas o bien actu茅 de acuerdo a su propio entender o en su caso amita las indicaciones espec铆ficas del m茅dico, as铆 como el Hospital',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 15],
          alignment: 'justify',
        },

        //  HOSPITAL (REPETIDO)
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
                  fontSize: 12,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Queda totalmente exentos de cualquier implicaci贸n m茅dica y legal que se deriven de la evoluci贸n subsecuente del paciente.',
          fontSize: 11,
          lineHeight: 1.1,
          margin: [0, 0, 0, 25],
          alignment: 'justify',
        },

        //  ACEPTO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'ACEPTO',
                  fontSize: 16,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        //  FIRMAS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________________\nNombre y firma del paciente y/o Representante legal',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 20, 0, 20],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        {
          table: {
            widths: ['45%', '10%', '45%'],
            body: [
              [
                {
                  text: '\n\n\n_____________________________\nTestigo',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
                { text: '', fontSize: 11 },
                {
                  text: '\n\n\n_____________________________\nTestigo',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: '\n\n\n_____________________________\nTestigo',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Consentimiento Hospitalizaci贸n - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  CARTA DE CONSENTIMIENTO INFORMADO PARA REFERENCIA DE PACIENTES SEGN NOM-004-SSA3-2012
  async generarConsentimientoReferenciaPacientes(datos: any): Promise<any> {
    console.log(
      '  Generando Carta de Consentimiento Informado para Referencia de Pacientes seg煤n NOM-004...'
    );

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const referenciaData = datos.referenciaConsentimiento || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 80, 40, 60],

      header: {
        margin: [40, 20, 40, 20],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'CARTA DE CONSENTIMIENTO INFORMADO',
                fontSize: 13,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'PARA REFERENCIA DE PACIENTES',
                fontSize: 14,
                bold: true,
                alignment: 'center',
                margin: [0, 5, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 30] },

        //  DATOS GENERALES
        {
          table: {
            widths: ['28%', '72%'],
            body: [
              [
                {
                  text: 'Nombre de la Unidad M茅dica:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: 'Hospital General San Luis de la Paz',
                  fontSize: 10,
                  bold: true,
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 10],
        },

        //  FECHA Y LUGAR
        {
          table: {
            widths: ['22%', '12%', '5%', '15%', '5%', '15%', '26%'],
            body: [
              [
                {
                  text: 'San Luis de la Paz, Guanajuato a',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: fechaActual.getDate().toString(),
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 10, bold: true, alignment: 'center' },
                {
                  text: fechaActual.toLocaleDateString('es-MX', {
                    month: 'long',
                  }),
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 10, bold: true, alignment: 'center' },
                {
                  text: fechaActual.getFullYear().toString(),
                  fontSize: 10,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: '', fontSize: 10 },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  DATOS DEL INGRESO
        {
          table: {
            widths: ['28%', '17%', '10%', '15%', '8%', '22%'],
            body: [
              [
                {
                  text: 'Fecha de Ingreso hospitalario:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text:
                    referenciaData.fecha_ingreso ||
                    fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 10, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Cama:', fontSize: 10, bold: true },
                {
                  text: referenciaData.numero_cama || 'Sin asignar',
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  DATOS DEL PACIENTE
        {
          table: {
            widths: ['28%', '40%', '16%', '16%'],
            body: [
              [
                {
                  text: 'Nombre del (la) paciente:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'No. Expediente:', fontSize: 10, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 10],
        },

        {
          table: {
            widths: ['28%', '25%', '8%', '15%', '12%', '12%'],
            body: [
              [
                { text: 'Fecha de nacimiento:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 10, bold: true },
                {
                  text: `${pacienteCompleto.edad} a帽os`,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Fecha/hora:', fontSize: 10, bold: true },
                {
                  text: fechaActual.toLocaleString('es-MX'),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        //  CONSENTIMIENTO PRINCIPAL
        {
          table: {
            widths: ['25%', '75%'],
            body: [
              [
                {
                  text: 'Acepto que el (la) Dr (a)',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}`,
                  fontSize: 11,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 10],
        },

        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: [
                    {
                      text: 'Me ha explicado clara y entendible el padecimiento, riesgos, cuidados, tratamientos m茅dicos requeridos para la estabilizaci贸n de mi salud o la de mi paciente.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: 'Para su atenci贸n se requiere de la realizaci贸n del procedimiento administrativo de referencia de pacientes, que consiste en el env铆o a otra unidad donde se cuenta con la capacidad f铆sica instalada para atender el problema de salud y una vez estabilizado o resuelto se contrarrefiera a la unidad de salud de origen.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: 'Enterado (a) de todo lo anterior y una vez que me han informado a mi entera satisfacci贸n, otorgo el presente consentimiento.',
                      fontSize: 11,
                    },
                  ],
                  alignment: 'justify',
                  lineHeight: 1.1,
                  margin: [10, 15, 10, 15],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 30],
        },

        //  INFORMACIN ADICIONAL DE LA REFERENCIA
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIN DE LA REFERENCIA',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Motivo de la referencia: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        referenciaData.motivo_referencia ||
                        'Requiere atenci贸n especializada no disponible en esta unidad m茅dica.',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nUnidad m茅dica de destino: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        referenciaData.unidad_destino ||
                        'Por definir seg煤n disponibilidad y especialidad requerida.',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nEspecialidad requerida: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        referenciaData.especialidad_requerida ||
                        'Seg煤n criterio m茅dico.',
                      fontSize: 10,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 30],
        },

        //  FIRMAS
        {
          table: {
            widths: ['45%', '10%', '45%'],
            body: [
              [
                {
                  text: `\n\n\n${pacienteCompleto.nombre_completo}\n_______________________________`,
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
                { text: '', fontSize: 10 },
                {
                  text: `\n\n\n${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n_______________________________`,
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
              ],
              [
                {
                  text: 'Nombre completo y firma del (paciente) tutor y/o representante legal',
                  fontSize: 9,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
                { text: '', fontSize: 9 },
                {
                  text: 'Nombre completo y firma del m茅dico tratante',
                  fontSize: 9,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        //  TESTIGOS
        {
          table: {
            widths: ['45%', '10%', '45%'],
            body: [
              [
                {
                  text: `\n\n\n${
                    referenciaData.testigo1_nombre ||
                    '__________________________'
                  }\n_______________________________`,
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
                { text: '', fontSize: 10 },
                {
                  text: `\n\n\n${
                    referenciaData.testigo2_nombre ||
                    '__________________________'
                  }\n_______________________________`,
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
              ],
              [
                {
                  text: 'Nombre completo y firma testigo',
                  fontSize: 9,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
                { text: '', fontSize: 9 },
                {
                  text: 'Nombre completo y firma testigo',
                  fontSize: 9,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Consentimiento Referencia - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  CARTA DE CONSENTIMIENTO INFORMADO PARA TRANSFUSIN SANGUNEA O SUS DERIVADOS SEGN NOM-004-SSA3-2012
  async generarConsentimientoTransfusionSanguinea(datos: any): Promise<any> {
    console.log(
      '└ Generando Carta de Consentimiento Informado para Transfusi贸n Sangu铆nea seg煤n NOM-004...'
    );

    //    CORRECCIN: Usar datos ya preparados
    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const transfusionData = datos.consentimientoTransfusion || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 80, 40, 60],

      header: {
        margin: [40, 20, 40, 20],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'CARTA DE CONSENTIMIENTO INFORMADO PARA LA',
                fontSize: 12,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'TRANSFUSIN SANGUNEA O SUS DERIVADOS',
                fontSize: 16,
                bold: true,
                alignment: 'center',
                margin: [0, 5, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 20] },

        //  DATOS DEL PACIENTE
        {
          table: {
            widths: ['15%', '35%', '15%', '35%'],
            body: [
              [
                { text: 'Nombre:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 9, bold: true },
                {
                  text: `${pacienteCompleto.edad} a帽os`,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'CURP:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.curp,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'G茅nero:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'F. Nacimiento:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Cama:', fontSize: 9, bold: true },
                {
                  text: transfusionData.numero_cama || 'Sin asignar',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 9, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Estado civil:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.estado_civil || 'No registrado',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Diagn贸stico:', fontSize: 9, bold: true },
                {
                  text: transfusionData.diagnostico || 'Pendiente',
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Domicilio:', fontSize: 9, bold: true },
                {
                  text: this.formatearDireccionMejorada(pacienteCompleto),
                  fontSize: 9,
                  decoration: 'underline',
                  colSpan: 3,
                },
                {},
                {},
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  INFORMACIN SOBRE LA TRANSFUSIN
        {
          text: 'Durante su ingreso hospitalario puede ser necesaria la transfusi贸n de sangre y otros hemoderivados como plasma fresco congelado, plaquetas, y crioprecipitados, bien porque se precise durante la intervenci贸n quir煤rgica, o porque tenga una enfermedad en la que sea necesaria.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        {
          text: 'La transfusi贸n consiste en la administraci贸n de sangre humana o alguno de sus componentes, a los pacientes que lo precisen. Se administra por v铆a intravenosa. Tambi茅n cabe la posibilidad de que durante el procedimiento haya que realizar modificaciones del mismo.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Aunque se haga una adecuada elecci贸n del procedimiento y de su correcta aplicaci贸n, pueden presentarse efectos indeseables, tanto los comunes derivados del mismo y pueden afectar a todos los 贸rganos y sistemas, como son debidos a la situaci贸n vital del paciente (diabetes, cardiopat铆a, hipertensi贸n, edad avanzada, anemia, obesidad entre otras), y los espec铆ficos del procedimiento.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        //  INFORMACIN SOBRE LA SEGURIDAD DE LA SANGRE
        {
          text: 'La sangre y sus derivados proceden de personas que gozan de buena salud. Son personas que, por donar no perciben compensaci贸n econ贸mica alguna. Todos los donadores son seleccionados con criterios m茅dicos y la sangre se estudia cuidadosamente con los an谩lisis que exigen las leyes. Cualquier unidad de sangre o hemoderivado que vaya usted a recibir habr谩 sido analizada para SIDA (anticuerpos anti-HIV), HEPATITIS (Hepatitis B/C), SFILIS, BRUCELOSIS Y CHAGAS.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        //  RIESGOS ESPECFICOS
        {
          text: 'A pesar de ello puede ocurrir que el donante se encuentre en el periodo ventana (espacio de tiempo en el cual no es posible la detecci贸n serol贸gica de la infecci贸n) y se pueda transmitir alguna de las infecciones anteriormente mencionadas.',
          fontSize: 11,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 12],
        },

        {
          text: 'Otro riesgo posible que tienen las transfusiones es que el receptor pueda sufrir alg煤n tipo de reacci贸n de rechazo a alguno de los componentes de la sangre. Estas reacciones son frecuentes y, pr谩cticamente, siempre leves.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 12],
        },

        {
          text: 'Ning煤n procedimiento invasivo est谩 absolutamente exento de riesgos importantes, incluyendo la muerte, aunque esta posibilidad es poco frecuente.',
          fontSize: 11,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        //  MARCO LEGAL
        {
          text: [
            {
              text: 'En atenci贸n a los art铆culos 80 al 83 de reglamento de la Ley General de Salud en materia de atenci贸n m茅dica y a la Norma Oficial Mexicana ',
              fontSize: 11,
            },
            {
              text: 'NOM-004-SSA3-2012',
              fontSize: 11,
              bold: true,
            },
            {
              text: ', relativa al expediente cl铆nico numerales 4.2, 10.1 al 10.1.2, considerando la NORMA Oficial Mexicana ',
              fontSize: 11,
            },
            {
              text: 'NOM-253-SSA1-2012,',
              fontSize: 11,
              bold: true,
            },
            {
              text: ' para la disposici贸n de sangre humana y sus componentes con fines terap茅uticos. Se otorga la presente autorizaci贸n al personal M茅dico y Param茅dico del Hospital para realizar la transfusi贸n de hemoderivados necesarios al paciente en cuesti贸n,',
              fontSize: 11,
            },
          ],
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        {
          text: 'y para tal efecto, dicho paciente y/o su representante legal: DECLARA',
          fontSize: 11,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        //  DECLARACIN
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DECLARO',
                  fontSize: 14,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 10, 0, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        {
          text: 'Que los m茅dicos me han entregado esta hoja informativa, la cual he le铆do y he comprendido el significado del procedimiento y los riesgos inherentes al mismo, por lo cual, declaro estar debidamente informado por el personal de salud del Hospital General San Luis de la Paz.',
          fontSize: 12,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 15],
        },

        {
          text: 'As铆 mismo he recibido respuesta a todas mis preguntas y las consideraciones suficientes y aceptables, haciendo tomar la decisi贸n en forma libre y voluntaria y autorizo al personal de salud para la atenci贸n de contingencias derivadas de este acto.',
          fontSize: 11,
          lineHeight: 1.4,
          alignment: 'justify',
          margin: [0, 0, 0, 20],
        },

        //  FECHA Y LUGAR
        {
          table: {
            widths: ['35%', '5%', '10%', '5%', '15%', '5%', '25%'],
            body: [
              [
                { text: 'San Luis de la Paz, Guanajuato,', fontSize: 11 },
                { text: 'a', fontSize: 11, alignment: 'center' },
                {
                  text: fechaActual.getDate().toString(),
                  fontSize: 11,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 11, alignment: 'center' },
                {
                  text: fechaActual.toLocaleDateString('es-MX', {
                    month: 'long',
                  }),
                  fontSize: 11,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 11, alignment: 'center' },
                {
                  text: fechaActual.getFullYear().toString(),
                  fontSize: 11,
                  decoration: 'underline',
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  ACEPTO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'ACEPTO',
                  fontSize: 16,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        //  INFORMACIN ESPECFICA DE LA TRANSFUSIN
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIN ESPECFICA DE LA TRANSFUSIN',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Tipo de hemoderivado requerido: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        transfusionData.tipo_hemoderivado ||
                        'Por definir seg煤n necesidad cl铆nica (sangre total, concentrado eritrocitario, plasma, plaquetas, crioprecipitados)',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nIndicaci贸n m茅dica: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        transfusionData.indicacion_medica ||
                        'Seg煤n criterio m茅dico y estado cl铆nico del paciente',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nTipo sangu铆neo del paciente: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        pacienteCompleto.tipo_sangre ||
                        'Por determinar mediante tipificaci贸n',
                      fontSize: 10,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 25],
        },

        //  FIRMAS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________________\nNombre y firma del paciente y/o Representante legal',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________________\nNombre, firma y sello del m茅dico tratante',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        {
          table: {
            widths: ['45%', '10%', '45%'],
            body: [
              [
                {
                  text: '\n\n\n_____________________________\nTestigo',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
                { text: '', fontSize: 11 },
                {
                  text: '\n\n\n_____________________________\nTestigo',
                  fontSize: 11,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Consentimiento Transfusi贸n Sangu铆nea - SICEG\nNOM-004-SSA3-2012 | NOM-253-SSA1-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  HOJA DE CONSENTIMIENTO INFORMADO PARA TRATAMIENTO MDICO SEGN NOM-004-SSA3-2012
  async generarConsentimientoTratamientoMedico(datos: any): Promise<any> {
    console.log(
      'Generando Hoja de Consentimiento Informado para Tratamiento M茅dico seg煤n NOM-004...'
    );

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const tratamientoData = datos.consentimientoTratamiento || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [45, 60, 45, 60],

      content: [
        { text: '', margin: [0, 40] },

        //  TTULO
        {
          text: 'HOJA DE CONSENTIMIENTO INFORMADO PARA TRATAMIENTO MDICO',
          fontSize: 12,
          bold: true,
          alignment: 'center',
          margin: [0, 0, 0, 25],
        },

        //  FECHA Y LUGAR
        {
          table: {
            widths: ['42%', '8%', '8%', '12%', '8%', '22%'],
            body: [
              [
                {
                  text: 'San Luis de la Paz, Guanajuato a',
                  fontSize: 9,
                  bold: true,
                },
                {
                  text: fechaActual.getDate().toString(),
                  fontSize: 9,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 9, bold: true, alignment: 'center' },
                {
                  text: fechaActual.toLocaleDateString('es-MX', {
                    month: 'long',
                  }),
                  fontSize: 9,
                  decoration: 'underline',
                  alignment: 'center',
                },
                { text: 'de', fontSize: 9, bold: true, alignment: 'center' },
                {
                  text: `20${fechaActual.getFullYear().toString().slice(-2)}`,
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        //  DESTINATARIO
        {
          text: `DR. ${medicoCompleto.nombre_completo}`,
          fontSize: 10,
          bold: true,
          margin: [0, 0, 0, 8],
        },

        {
          text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
          fontSize: 10,
          margin: [0, 0, 0, 8],
        },

        {
          text: 'DIRECTOR',
          fontSize: 10,
          margin: [0, 0, 0, 8],
        },

        {
          text: 'PRESENTE.',
          fontSize: 10,
          margin: [0, 0, 0, 20],
        },

        //  QUIEN SUSCRIBE
        {
          text: 'QUIEN SUSCRIBE:',
          fontSize: 10,
          bold: true,
          margin: [0, 0, 0, 15],
        },

        {
          text: `${pacienteCompleto.apellido_paterno || '_'.repeat(30)} ${
            pacienteCompleto.apellido_materno || '_'.repeat(30)
          } ${pacienteCompleto.nombre || '_'.repeat(30)}`,
          fontSize: 10,
          decoration: 'underline',
          alignment: 'center',
          margin: [0, 0, 0, 8],
        },

        {
          text: 'APELLIDO PATERNO                                           APELLIDO MATERNO                                           NOMBRE(S)',
          fontSize: 8,
          alignment: 'center',
          margin: [0, 0, 0, 25],
        },

        //  DOMICILIO
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                { text: 'DOMICILIO:', fontSize: 10, bold: true },
                {
                  text: this.formatearDireccionMejorada(pacienteCompleto),
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        //  DATOS ADICIONALES DEL PACIENTE
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIN DEL PACIENTE',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Expediente: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      ),
                      fontSize: 9,
                    },
                    {
                      text: '     Edad: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `${pacienteCompleto.edad} a帽os`,
                      fontSize: 9,
                    },
                    {
                      text: '     Sexo: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: pacienteCompleto.sexo,
                      fontSize: 9,
                    },
                    {
                      text: '\nCURP: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: pacienteCompleto.curp || 'No registrado',
                      fontSize: 9,
                    },
                    {
                      text: '\nFecha de nacimiento: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text:
                        pacienteCompleto.fecha_nacimiento || 'No registrada',
                      fontSize: 9,
                    },
                    {
                      text: '\nServicio m茅dico: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: medicoCompleto.departamento,
                      fontSize: 9,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 25],
        },

        //  AUTORIZACIN PRINCIPAL
        {
          text: 'AUTORIZO PLENAMENTE AL PERSONAL DE ESTE HOSPITAL A SU CARGO PARA EJECUTAR LAS INVESTIGACIONES CLNICAS, DE LABORATORIO Y DE GABINETE, QUE SEAN NECESARIAS PARA EL DIAGNSTICO DE MI ENFERMEDAD, AS COMO TAMBIN PARA REALIZAR LOS TRATAMIENTOS MDICOS O QUIRRGICOS QUE CONVENGAN. AS MISMO ME COMPROMETO A OBSERVAR EL REGLAMENTO INTERNO DE LA INSTITUCIN.',
          fontSize: 10,
          lineHeight: 1.5,
          alignment: 'justify',
          margin: [0, 0, 0, 20],
        },

        //  INFORMACIN ESPECFICA DEL TRATAMIENTO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIN ESPECFICA DEL TRATAMIENTO',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Diagn贸stico presuntivo: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text:
                        tratamientoData.diagnostico_presuntivo ||
                        'Por determinar mediante estudios cl铆nicos y de gabinete',
                      fontSize: 9,
                    },
                    {
                      text: '\n\nTratamiento propuesto: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text:
                        tratamientoData.tratamiento_propuesto ||
                        'Seg煤n criterio m茅dico y evoluci贸n cl铆nica del paciente',
                      fontSize: 9,
                    },
                    {
                      text: '\n\nEstudios de laboratorio y gabinete autorizados: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text:
                        tratamientoData.estudios_autorizados ||
                        'Los que sean m茅dicamente necesarios para el diagn贸stico',
                      fontSize: 9,
                    },
                    {
                      text: '\n\nM茅dico responsable: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}`,
                      fontSize: 9,
                    },
                    {
                      text: ' - C茅dula: ',
                      fontSize: 9,
                    },
                    {
                      text: medicoCompleto.numero_cedula || 'No disponible',
                      fontSize: 9,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 25],
        },

        //  DECLARACIN DE CONFORMIDAD
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DECLARACIN DE CONFORMIDAD',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: 'Declaro que he sido informado(a) sobre los procedimientos m茅dicos, estudios de diagn贸stico y tratamientos que se realizar谩n. Entiendo los riesgos y beneficios del tratamiento propuesto. He tenido la oportunidad de hacer preguntas y todas han sido respondidas satisfactoriamente. Autorizo voluntariamente el tratamiento m茅dico propuesto y me comprometo a seguir las indicaciones m茅dicas.',
                  fontSize: 10,
                  alignment: 'justify',
                  lineHeight: 1.4,
                  margin: [10, 10, 10, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 30],
        },

        //  DESPEDIDA
        {
          text: 'A T E N T A M E N T E',
          fontSize: 10,
          bold: true,
          alignment: 'center',
          margin: [0, 0, 0, 30],
        },

        //  FIRMAS
        {
          table: {
            widths: ['45%', '10%', '45%'],
            body: [
              [
                {
                  text: '\n\n\n\n_________________________________',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 20, 0, 5],
                },
                { text: '', fontSize: 10 },
                {
                  text: '\n\n\n\n_________________________________',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 20, 0, 5],
                },
              ],
              [
                {
                  text: 'NOMBRE Y FIRMA DE LA PERSONA LEGALMENTE RESPONSABLE',
                  fontSize: 8,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
                { text: '', fontSize: 8 },
                {
                  text: 'NOMBRE Y FIRMA DEL PACIENTE',
                  fontSize: 8,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
              [
                { text: '', fontSize: 10, margin: [0, 20, 0, 0] },
                { text: '', fontSize: 10 },
                { text: '', fontSize: 10 },
              ],
              [
                {
                  text: '\n\n\n\n_________________________________',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
                { text: '', fontSize: 10 },
                {
                  text: '\n\n\n\n_________________________________',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 5],
                },
              ],
              [
                {
                  text: 'TESTIGO',
                  fontSize: 8,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
                { text: '', fontSize: 8 },
                {
                  text: 'TESTIGO',
                  fontSize: 8,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },

        { text: '', margin: [0, 15] },

        //  INFORMACIN MDICA ADICIONAL
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIN DEL MDICO TRATANTE',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
              [
                {
                  text: [
                    {
                      text: `M茅dico: ${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `C茅dula Profesional: ${
                        medicoCompleto.numero_cedula || 'No disponible'
                      }\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de elaboraci贸n: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} ${fechaActual.toLocaleTimeString('es-MX')}`,
                      fontSize: 8,
                    },
                  ],
                  margin: [8, 8, 8, 8],
                  lineHeight: 1.2,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [45, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Consentimiento Tratamiento M茅dico - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }

  
  //  HOJA DE ALTA VOLUNTARIA SEGN NOM-004-SSA3-2012
  async generarHojaAltaVoluntaria(datos: any): Promise<any> {
    console.log(' Generando Hoja de Alta Voluntaria seg煤n NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const altaVoluntariaData = datos.altaVoluntaria || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 80, 40, 60],

      header: {
        margin: [40, 20, 40, 20],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOJA DE ALTA VOLUNTARIA',
                fontSize: 15,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 20] },

        //  DATOS DEL PACIENTE
        {
          table: {
            widths: ['13%', '37%', '8%', '12%', '12%', '18%'],
            body: [
              [
                { text: 'Nombre:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 9, bold: true },
                {
                  text: `${pacienteCompleto.edad} a帽os`,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Fecha:', fontSize: 9, bold: true },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'CURP:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.curp,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Sexo:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'F. Nacimiento:', fontSize: 8, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Cama:', fontSize: 9, bold: true },
                {
                  text: altaVoluntariaData.numero_cama || 'Sin asignar',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 9, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        //  INFORMACIN MDICA DEL ALTA VOLUNTARIA
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIN MDICA',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Fecha de ingreso: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        altaVoluntariaData.fecha_ingreso || 'No especificada',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nMotivo de ingreso: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        altaVoluntariaData.motivo_ingreso || 'No especificado',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nDiagn贸stico al momento del alta: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text:
                        altaVoluntariaData.diagnostico_alta || 'Por definir',
                      fontSize: 10,
                    },
                    {
                      text: '\n\nEstado general del paciente: ',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text: altaVoluntariaData.estado_general || 'Estable',
                      fontSize: 10,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        //  DECLARACIN DE ALTA VOLUNTARIA
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DECLARACIN DE ALTA VOLUNTARIA',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'YO, ',
                      fontSize: 11,
                      bold: true,
                    },
                    {
                      text:
                        altaVoluntariaData.nombre_responsable ||
                        pacienteCompleto.nombre_completo,
                      fontSize: 11,
                      bold: true,
                      decoration: 'underline',
                    },
                    {
                      text: ', en mi calidad de ',
                      fontSize: 11,
                    },
                    {
                      text: altaVoluntariaData.relacion_paciente || 'paciente',
                      fontSize: 11,
                      decoration: 'underline',
                    },
                    {
                      text: ', manifiesto de manera libre y voluntaria mi decisi贸n de solicitar el alta m茅dica del Hospital General San Luis de la Paz, a煤n cuando el personal m茅dico considera que mi estado de salud requiere de continuar con la atenci贸n hospitalaria.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: 'DECLARO QUE:\n\n',
                      fontSize: 11,
                      bold: true,
                    },
                    {
                      text: '1. He sido informado(a) por el personal m茅dico sobre mi estado de salud, el diagn贸stico, el tratamiento recomendado y los riesgos que implica abandonar el tratamiento hospitalario.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: '2. Entiendo que al solicitar el alta voluntaria, asumo todos los riesgos y consecuencias que puedan derivarse de esta decisi贸n, incluyendo el empeoramiento de mi condici贸n de salud o complicaciones graves.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: '3. Eximo de toda responsabilidad m茅dica y legal al Hospital General San Luis de la Paz y a su personal m茅dico y param茅dico por las consecuencias que puedan resultar de mi decisi贸n de abandonar el tratamiento.\n\n',
                      fontSize: 11,
                    },
                    {
                      text: '4. Esta decisi贸n la tomo de manera libre, voluntaria y consciente, sin presi贸n alguna.',
                      fontSize: 11,
                    },
                  ],
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                  alignment: 'justify',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        //  RECOMENDACIONES MDICAS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'RECOMENDACIONES MDICAS PARA EL ALTA',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text:
                    altaVoluntariaData.recomendaciones_medicas ||
                    'Se recomienda:\n Acudir inmediatamente a la unidad de salud m谩s cercana si presenta deterioro de su estado general\n Continuar con medicamentos prescritos seg煤n indicaciones\n Seguimiento m茅dico ambulatorio en las pr贸ximas 24-48 horas\n Acudir a urgencias si presenta signos de alarma',
                  fontSize: 10,
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        //  SIGNOS DE ALARMA
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'SIGNOS DE ALARMA - ACUDIR INMEDIATAMENTE A URGENCIAS',
                  fontSize: 11,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text:
                    altaVoluntariaData.signos_alarma ||
                    ' Dificultad para respirar o falta de aire\n Dolor de pecho intenso\n P茅rdida de conocimiento o desmayo\n V贸mito persistente\n Fiebre alta (mayor a 38.5掳C)\n Sangrado abundante\n Convulsiones\n Cambios en el estado de conciencia\n Cualquier s铆ntoma que considere grave o preocupante',
                  fontSize: 10,
                  margin: [10, 10, 10, 10],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 25],
        },

        //  FECHA Y HORA DEL ALTA
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: `Fecha del alta voluntaria: ${fechaActual.toLocaleDateString(
                    'es-MX'
                  )}`,
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: `Hora del alta: ${fechaActual.toLocaleTimeString(
                    'es-MX'
                  )}`,
                  fontSize: 10,
                  bold: true,
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 25],
        },

        //  FIRMAS
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________\nNombre y firma del paciente y/o\nrepresentante legal',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
                {
                  text: `\n\n\n_________________________________\n${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\nM茅dico tratante`,
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: '\n\n\n_________________________________\nTestigo\nNombre y firma',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
                {
                  text: '\n\n\n_________________________________\nTestigo\nNombre y firma',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 15, 0, 15],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  INFORMACIN DEL MDICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIN DEL MDICO RESPONSABLE',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 8, 0, 8],
                },
              ],
              [
                {
                  text: [
                    {
                      text: `M茅dico: ${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                    },
                    {
                      text: `C茅dula Profesional: ${
                        medicoCompleto.numero_cedula || 'No disponible'
                      }\n`,
                      fontSize: 9,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 9,
                    },
                    {
                      text: `Servicio: ${medicoCompleto.departamento}\n`,
                      fontSize: 9,
                    },
                    {
                      text: `Hospital General San Luis de la Paz`,
                      fontSize: 9,
                    },
                  ],
                  margin: [10, 8, 10, 8],
                  lineHeight: 1.2,
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Hoja de Alta Voluntaria - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  HOJA DE INFORME DIARIO SEGN NOM-004-SSA3-2012
  async generarHojaInformeDiario(datos: any): Promise<any> {
    console.log('  Generando Hoja de Informe Diario seg煤n NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const informeDiarioData = datos.informeDiario || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageOrientation: 'landscape', // Horizontal para aprovechar el espacio
      pageMargins: [20, 60, 20, 40],

      header: {
        margin: [20, 15, 20, 15],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOJA DE INFORME DIARIO',
                fontSize: 14,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  DATOS DEL PACIENTE
        {
          table: {
            widths: ['18%', '35%', '12%', '35%'],
            body: [
              [
                { text: 'Nombre del paciente:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'No. de expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Fecha de Nacimiento:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'CURP:', fontSize: 9, bold: true },
                {
                  text: pacienteCompleto.curp,
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Servicio:', fontSize: 9, bold: true },
                {
                  text: medicoCompleto.departamento,
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Cama:', fontSize: 9, bold: true },
                {
                  text: informeDiarioData.numero_cama || 'Sin asignar',
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  INFORMACIN ADICIONAL DEL INFORME
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INFORMACIN DEL INFORME DIARIO',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
              [
                {
                  text: [
                    {
                      text: 'Per铆odo del informe: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} - Turno: ${informeDiarioData.turno || 'Matutino'}`,
                      fontSize: 9,
                    },
                    {
                      text: '\nDiagn贸stico principal: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text:
                        informeDiarioData.diagnostico_principal ||
                        'Por definir',
                      fontSize: 9,
                    },
                    {
                      text: '\nM茅dico responsable: ',
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}`,
                      fontSize: 9,
                    },
                  ],
                  margin: [8, 8, 8, 8],
                  lineHeight: 1.2,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        //  TABLA DE REGISTROS DIARIOS
        {
          table: {
            widths: ['15%', '25%', '25%', '35%'],
            body: [
              // Encabezados
              [
                {
                  text: 'Fecha y Hora',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'Nombre de quien informa',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'Nombre de quien recibe la informaci贸n',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'Informaci贸n comunicada / Observaciones',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
              ],
              // Filas de datos (generar 15 filas vac铆as para completar a mano)
              ...Array.from({ length: 15 }, (_, index) => [
                {
                  text:
                    index === 0 && informeDiarioData.registros?.[0]?.fecha
                      ? informeDiarioData.registros[0].fecha
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 25,
                },
                {
                  text:
                    index === 0 &&
                    informeDiarioData.registros?.[0]?.quien_informa
                      ? informeDiarioData.registros[0].quien_informa
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 25,
                },
                {
                  text:
                    index === 0 &&
                    informeDiarioData.registros?.[0]?.quien_recibe
                      ? informeDiarioData.registros[0].quien_recibe
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 25,
                },
                {
                  text:
                    index === 0 && informeDiarioData.registros?.[0]?.informacion
                      ? informeDiarioData.registros[0].informacion
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 25,
                },
              ]),
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 15] },

        //  INSTRUCCIONES Y OBSERVACIONES
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INSTRUCCIONES PARA EL LLENADO',
                  fontSize: 10,
                  bold: true,
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
              [
                {
                  text:
                    ' Registrar toda comunicaci贸n relevante sobre el estado del paciente\n' +
                    ' Incluir fecha y hora exacta de cada comunicaci贸n\n' +
                    ' Anotar nombre completo y cargo de quien proporciona la informaci贸n\n' +
                    ' Registrar nombre completo de quien recibe la informaci贸n (familiar, m茅dico, etc.)\n' +
                    ' Describir brevemente el contenido de la informaci贸n comunicada\n' +
                    ' Mantener confidencialidad seg煤n normativa de protecci贸n de datos\n' +
                    ' Archivar en expediente cl铆nico una vez completado',
                  fontSize: 8,
                  margin: [8, 8, 8, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 10],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Hoja de Informe Diario - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  HOJA FRONTAL DE EXPEDIENTE SEGN NOM-004-SSA3-2012
  async generarHojaFrontalExpediente(datos: any): Promise<any> {
    console.log('  Generando Hoja Frontal de Expediente seg煤n NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const expedienteData = datos.expediente || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 60, 40, 60],

      content: [
        { text: '', margin: [0, 20] },

        //  DATOS BSICOS DEL PACIENTE
        {
          table: {
            widths: ['40%', '30%', '15%', '15%'],
            body: [
              [
                {
                  text: 'NOMBRE:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 9,
                  border: [false, false, false, true],
                },
                {
                  text: 'EXPEDIENTE:',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  border: [false, false, false, true],
                },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  border: [false, false, false, true],
                },
              ],
              [
                {
                  text: 'EDAD:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: `${pacienteCompleto.edad} a帽os`,
                  fontSize: 9,
                  border: [false, false, false, true],
                },
                {
                  text: 'CURP:',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.curp || '',
                  fontSize: 8,
                  border: [false, false, false, true],
                },
              ],
              [
                {
                  text: 'FECHA DE NACIMIENTO:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.fecha_nacimiento || '',
                  fontSize: 9,
                  border: [false, false, false, true],
                },
                {
                  text: 'GNERO:',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 9,
                  border: [false, false, false, true],
                },
              ],
              [
                {
                  text: 'TRANSFUSIONES:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: expedienteData.transfusiones || '',
                  fontSize: 9,
                  colSpan: 3,
                  border: [false, false, false, true],
                },
                {},
                {},
              ],
              [
                {
                  text: 'TIPO SANGUNEO:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.tipo_sangre || '',
                  fontSize: 9,
                  border: [false, false, false, true],
                },
                {
                  text: 'TELFONO:',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.telefono || '',
                  fontSize: 9,
                  border: [false, false, false, true],
                },
              ],
              [
                {
                  text: 'NOMBRE DEL PADRE O TUTOR:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: pacienteCompleto.familiar_responsable || '',
                  fontSize: 9,
                  colSpan: 3,
                  border: [false, false, false, true],
                },
                {},
                {},
              ],
              [
                {
                  text: 'DOMICILIO:',
                  fontSize: 9,
                  bold: true,
                  border: [false, false, false, true],
                },
                {
                  text: this.formatearDireccionMejorada(pacienteCompleto),
                  fontSize: 9,
                  colSpan: 3,
                  border: [false, false, false, true],
                },
                {},
                {},
              ],
              [
                { text: '', border: [false, false, false, false] },
                { text: '', border: [false, false, false, false] },
                { text: '', border: [false, false, false, false] },
                { text: '', border: [false, false, false, false] },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  TABLA DE REGISTROS DE HOSPITALIZACIONES
        {
          table: {
            widths: ['25%', '25%', '25%', '25%'],
            body: [
              [
                {
                  text: 'FECHA DE INGRESO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'FECHA DE EGRESO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'DIAGNSTICO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'MDICO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
              ],
              // Generar 25 filas vac铆as para llenar a mano
              ...Array.from({ length: 25 }, (_, index) => [
                {
                  text:
                    index === 0 && expedienteData.registros?.[0]?.fecha_ingreso
                      ? expedienteData.registros[0].fecha_ingreso
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text:
                    index === 0 && expedienteData.registros?.[0]?.fecha_egreso
                      ? expedienteData.registros[0].fecha_egreso
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text:
                    index === 0 && expedienteData.registros?.[0]?.diagnostico
                      ? expedienteData.registros[0].diagnostico
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text:
                    index === 0 && expedienteData.registros?.[0]?.medico
                      ? expedienteData.registros[0].medico
                      : '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
              ]),
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        //  SEGUNDA TABLA DE REGISTROS ADICIONALES
        {
          table: {
            widths: ['25%', '25%', '25%', '25%'],
            body: [
              [
                {
                  text: 'FECHA DE INGRESO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'FECHA DE EGRESO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'DIAGNSTICO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
                {
                  text: 'MDICO',
                  fontSize: 9,
                  bold: true,
                  alignment: 'center',
                  margin: [3, 5, 3, 5],
                },
              ],
              // Generar 25 filas vac铆as adicionales
              ...Array.from({ length: 25 }, () => [
                {
                  text: '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text: '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text: '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
                {
                  text: '',
                  fontSize: 8,
                  margin: [3, 8, 3, 8],
                  minHeight: 20,
                },
              ]),
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Hoja Frontal de Expediente - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  SOLICITUD DE LABORATORIO SEGN NOM-004-SSA3-2012
  async generarSolicitudLaboratorio(datos: any): Promise<any> {
    console.log('И Generando Solicitud de Laboratorio seg煤n NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const laboratorioData = datos.solicitudLaboratorio || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [30, 60, 30, 50],

      header: {
        margin: [30, 15, 30, 15],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'INSTITUTO DE SALUD DEL ESTADO DE GUANAJUATO',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
                fontSize: 12,
                bold: true,
                alignment: 'center',
                margin: [0, 2, 0, 0],
              },
            ],
            [
              {
                text: 'SOLICITUD DE ESTUDIOS DE LABORATORIO',
                fontSize: 10,
                bold: true,
                alignment: 'center',
                margin: [0, 5, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  NOTA IMPORTANTE
        {
          text: 'Nota: Favor de pasar a caja para que le indiquen el monto a pagar de sus estudios, si se le indica',
          fontSize: 8,
          italics: true,
          alignment: 'center',
          margin: [0, 0, 0, 5],
        },
        {
          text: 'SEA PUNTUAL A SU CITA',
          fontSize: 9,
          bold: true,
          alignment: 'center',
          margin: [0, 0, 0, 15],
        },

        //  DATOS DEL PACIENTE
        {
          table: {
            widths: ['20%', '30%', '20%', '30%'],
            body: [
              [
                { text: 'NOMBRE DEL PACIENTE:', fontSize: 8, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 8,
                  colSpan: 3,
                },
                {},
                {},
              ],
              [
                { text: 'FECHA DE NACIMIENTO:', fontSize: 8, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || '',
                  fontSize: 8,
                },
                { text: 'CURP:', fontSize: 8, bold: true },
                { text: pacienteCompleto.curp || '', fontSize: 7 },
              ],
              [
                { text: 'NMERO DE EXPEDIENTE:', fontSize: 8, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 8,
                },
                { text: 'No CAUSAS:', fontSize: 8, bold: true },
                { text: laboratorioData.numero_causas || '', fontSize: 8 },
              ],
              [
                {
                  text: 'DIAGNSTICO CAUSAS Y/O SMNG SIN ABREVIATURAS:',
                  fontSize: 8,
                  bold: true,
                  colSpan: 4,
                },
                {},
                {},
                {},
              ],
              [
                {
                  text:
                    laboratorioData.diagnostico ||
                    'Diagn贸stico por especificar',
                  fontSize: 8,
                  colSpan: 4,
                  margin: [0, 5, 0, 5],
                },
                {},
                {},
                {},
              ],
              [
                { text: 'FECHA DE SOLICITUD:', fontSize: 8, bold: true },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 8,
                },
                { text: 'FECHA PRXIMA CONSULTA:', fontSize: 8, bold: true },
                {
                  text: laboratorioData.fecha_proxima_consulta || '',
                  fontSize: 8,
                },
              ],
              [
                { text: 'EDAD:', fontSize: 8, bold: true },
                { text: `${pacienteCompleto.edad} a帽os`, fontSize: 8 },
                { text: 'SERVICIO:', fontSize: 8, bold: true },
                { text: medicoCompleto.departamento, fontSize: 8 },
              ],
              [
                { text: 'No CAMA:', fontSize: 8, bold: true },
                {
                  text: laboratorioData.numero_cama || 'Ambulatorio',
                  fontSize: 8,
                },
                { text: 'PRIORIDAD:', fontSize: 8, bold: true },
                {
                  text: [
                    { text: ' URGENTE  ', fontSize: 8 },
                    { text: ' RUTINA', fontSize: 8 },
                  ],
                  fontSize: 8,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        //  ESTUDIOS DE LABORATORIO
        {
          table: {
            widths: ['25%', '25%', '25%', '25%'],
            body: [
              // HEMATOLOGA
              [
                {
                  text: 'HEMATOLOGA',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
                {
                  text: 'INMUNOHEMATOLOGA',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
              ],
              [
                { text: ' BIOMETRA HEMTICA', fontSize: 7 },
                { text: '20109', fontSize: 7, alignment: 'center' },
                { text: ' PRUEBAS CRUZADAS', fontSize: 7 },
                { text: '20107', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' GRUPO SANGUNEO', fontSize: 7 },
                { text: '20108', fontSize: 7, alignment: 'center' },
                { text: ' COOMBS DIRECTO', fontSize: 7 },
                { text: '19210', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' VEL SEDIMENTACIN GLOBULAR', fontSize: 7 },
                { text: '20103', fontSize: 7, alignment: 'center' },
                { text: ' COOMBS INDIRECTO', fontSize: 7 },
                { text: '19211', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' RETICULOCITOS', fontSize: 7 },
                { text: '20102', fontSize: 7, alignment: 'center' },
                { text: '', fontSize: 7 },
                { text: '', fontSize: 7 },
              ],
              [
                { text: ' FROTIS SANGRE GOTA GRUESA', fontSize: 7 },
                { text: '20105', fontSize: 7, alignment: 'center' },
                {
                  text: 'INMUNOLOGA',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
              ],
              [
                { text: ' FROTIS SANGRE PERIFRICA', fontSize: 7 },
                { text: '20105', fontSize: 7, alignment: 'center' },
                { text: ' REACCIONES FEBRILES', fontSize: 7 },
                { text: '19201', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' HEMOGLOBINA GLICOSILADA', fontSize: 7 },
                { text: '19303', fontSize: 7, alignment: 'center' },
                { text: ' PROTENA C REACTIVA', fontSize: 7 },
                { text: '19206', fontSize: 7, alignment: 'center' },
              ],
              [
                {
                  text: 'PAQUETES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
                { text: ' FACTOR REUMATOIDE', fontSize: 7 },
                { text: '19207', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' BIOMETRA,VSG,RETICULOCITOS', fontSize: 7 },
                { text: '20202', fontSize: 7, alignment: 'center' },
                { text: ' ANTIESTREPTOLISINAS', fontSize: 7 },
                { text: '19205', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: '', fontSize: 7 },
                { text: '', fontSize: 7 },
                { text: ' VDRL', fontSize: 7 },
                { text: '22131', fontSize: 7, alignment: 'center' },
              ],
              // COAGULACIN
              [
                {
                  text: 'COAGULACIN',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
                { text: ' ANTGENO PROSTTICO CUALITATIVO', fontSize: 7 },
                { text: '19212', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' T. PROTROMBINA', fontSize: 7 },
                { text: '20113', fontSize: 7, alignment: 'center' },
                { text: ' RPR PRUEBA DE SFILIS', fontSize: 7 },
                { text: '19206', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' TROMBOPLASTINA PARCIAL', fontSize: 7 },
                { text: '20114', fontSize: 7, alignment: 'center' },
                { text: ' HGC Beta CUALITATIVA s茅rica', fontSize: 7 },
                { text: '19720', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' FIBRINGENO', fontSize: 7 },
                { text: '20116', fontSize: 7, alignment: 'center' },
                { text: ' PRUEBA DE EMBARAZO EN ORINA', fontSize: 7 },
                { text: '19715', fontSize: 7, alignment: 'center' },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 10],
        },

        //  SEGUNDA TABLA - BIOQUMICA Y OTROS
        {
          table: {
            widths: ['25%', '25%', '25%', '25%'],
            body: [
              // BIOQUMICA CLNICA
              [
                {
                  text: 'BIOQUMICA CLNICA',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
                {
                  text: 'URIANALISIS',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
              ],
              [
                { text: ' TAMIZ GESTACIONAL 50 G/1HR', fontSize: 7 },
                { text: '19303', fontSize: 7, alignment: 'center' },
                { text: ' EXAMEN GENERAL DE ORINA', fontSize: 7 },
                { text: '20201', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' GLUCOSA POST-PRANDIAL', fontSize: 7 },
                { text: '19302', fontSize: 7, alignment: 'center' },
                { text: ' CLORO', fontSize: 7 },
                { text: '19601', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' CURVA TOLERANCIA GLUCOSA', fontSize: 7 },
                { text: '19303', fontSize: 7, alignment: 'center' },
                { text: ' POTASIO', fontSize: 7 },
                { text: '19601', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' GLUCOSA', fontSize: 7 },
                { text: '19301', fontSize: 7, alignment: 'center' },
                { text: ' SODIO', fontSize: 7 },
                { text: '19601', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' UREA/BUN', fontSize: 7 },
                { text: '19304', fontSize: 7, alignment: 'center' },
                { text: ' MICROALBUMINURIA EN ORINA 24 HRS', fontSize: 7 },
                { text: '22803', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' CREATININA', fontSize: 7 },
                { text: '19306', fontSize: 7, alignment: 'center' },
                { text: ' DEPURACIN DE CREATININA', fontSize: 7 },
                { text: '19501', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' CIDO RICO', fontSize: 7 },
                { text: '19307', fontSize: 7, alignment: 'center' },
                { text: '', fontSize: 7 },
                { text: '', fontSize: 7 },
              ],
              [
                { text: ' COLESTEROL TOTAL', fontSize: 7 },
                { text: '19307', fontSize: 7, alignment: 'center' },
                {
                  text: 'PARASITOLOGA',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  colSpan: 2,
                  alignment: 'center',
                },
                {},
              ],
              [
                { text: ' HDL COLESTEROL', fontSize: 7 },
                { text: '19703', fontSize: 7, alignment: 'center' },
                { text: ' COPROPARASITOSCPICO 3', fontSize: 7 },
                { text: '20001', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' PERFIL DE LPIDOS', fontSize: 7 },
                { text: '20203', fontSize: 7, alignment: 'center' },
                { text: ' COPROPARASITOSCPICO 1', fontSize: 7 },
                { text: '20001', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' TRIGLICRIDOS', fontSize: 7 },
                { text: '19702', fontSize: 7, alignment: 'center' },
                { text: ' CITOLOGA DE MOCO FECAL', fontSize: 7 },
                { text: '20006', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' BILIRRUBINA DIRECTA', fontSize: 7 },
                { text: '19308', fontSize: 7, alignment: 'center' },
                { text: ' COPROLGICO', fontSize: 7 },
                { text: '20005', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' BILIRRUBINA TOTAL', fontSize: 7 },
                { text: '22118', fontSize: 7, alignment: 'center' },
                { text: ' AMIBA EN FRESCO', fontSize: 7 },
                { text: '20006', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' AST (TGO)', fontSize: 7 },
                { text: '19401', fontSize: 7, alignment: 'center' },
                { text: ' SANGRE OCULTA EN HECES', fontSize: 7 },
                { text: '19502', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' ALT (TGP)', fontSize: 7 },
                { text: '19402', fontSize: 7, alignment: 'center' },
                { text: ' AZCARES REDUCTORES', fontSize: 7 },
                { text: '20005', fontSize: 7, alignment: 'center' },
              ],
              [
                { text: ' FOSFATASA ALCALINA (ALP)', fontSize: 7 },
                { text: '19403', fontSize: 7, alignment: 'center' },
                { text: ' ROTAVIRUS', fontSize: 7 },
                { text: '19215', fontSize: 7, alignment: 'center' },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 10],
        },

        //  TERCERA TABLA - PAQUETES Y OTROS
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: 'PAQUETES DE ESTUDIOS',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  alignment: 'center',
                },
                {
                  text: 'OTROS ESTUDIOS',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  alignment: 'center',
                },
              ],
              [
                { text: ' QUMICA SANGUNEA III (20204)', fontSize: 7 },
                { text: ' GASOMETRA ARTERIAL (19606)', fontSize: 7 },
              ],
              [
                { text: ' QUMICA SANGUNEA IV (20207)', fontSize: 7 },
                { text: ' GASOMETRA VENOSA (17301)', fontSize: 7 },
              ],
              [
                { text: ' PERFIL HEPTICO (20208)', fontSize: 7 },
                { text: ' EOSINFILOS EN MOCO NASAL (19203)', fontSize: 7 },
              ],
              [
                { text: ' PERFIL QUIRRGICO (20209)', fontSize: 7 },
                { text: '', fontSize: 7 },
              ],
              [
                { text: ' PERFIL REUMTICO (20210)', fontSize: 7 },
                {
                  text: 'OTROS ESTUDIOS ESPECIALES:',
                  fontSize: 8,
                  bold: true,
                },
              ],
              [
                { text: ' PERFIL CONTROL DE EMBARAZO (20211)', fontSize: 7 },
                {
                  text:
                    laboratorioData.otros_estudios ||
                    '________________________',
                  fontSize: 7,
                  margin: [0, 10, 0, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        //  DATOS DEL MDICO Y HORARIOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: `NOMBRE Y CDULA DEL MDICO: ${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - C茅dula: ${medicoCompleto.numero_cedula}`,
                  fontSize: 8,
                  bold: true,
                  margin: [5, 5, 5, 5],
                },
              ],
              [
                {
                  table: {
                    widths: ['33%', '33%', '34%'],
                    body: [
                      [
                        {
                          text: 'HORA DE TOMA DE MUESTRA:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'HORA DE RECEPCIN:',
                          fontSize: 7,
                          bold: true,
                        },
                        { text: 'HORA DE ENTREGA:', fontSize: 7, bold: true },
                      ],
                      [
                        {
                          text: '________________',
                          fontSize: 8,
                          alignment: 'center',
                        },
                        {
                          text: '________________',
                          fontSize: 8,
                          alignment: 'center',
                        },
                        {
                          text: '________________',
                          fontSize: 8,
                          alignment: 'center',
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 5, 5, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [30, 10],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#000000',
                },
                {
                  text: 'Solicitud de Laboratorio - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  SOLICITUD DE IMAGENOLOGIA
  async generarSolicitudImagenologia(datos: any): Promise<any> {
    console.log(' Generando Solicitud de Imagenolog铆a...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const solicitudData = datos.solicitudImagenologia || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [40, 60, 40, 60],

      header: {
        margin: [40, 20, 40, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ',
                fontSize: 14,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'SOLICITUD DE IMAGENOLOGA',
                fontSize: 16,
                bold: true,
                alignment: 'center',
                margin: [0, 10, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  DATOS DEL PACIENTE
        {
          table: {
            widths: ['30%', '35%', '15%', '20%'],
            body: [
              [
                {
                  text: 'Nombre del (la) paciente:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'No. Expediente:', fontSize: 10, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        {
          table: {
            widths: ['15%', '35%', '15%', '35%'],
            body: [
              [
                { text: 'CURP:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.curp || 'No registrado',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 10, bold: true },
                {
                  text: medicoCompleto.departamento || 'No especificado',
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
              [
                { text: 'Cama:', fontSize: 10, bold: true },
                {
                  text: solicitudData.numero_cama || 'Ambulatorio',
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: '', fontSize: 10 },
                { text: '', fontSize: 10 },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        {
          table: {
            widths: ['25%', '20%', '15%', '20%', '20%'],
            body: [
              [
                { text: 'Fecha de nacimiento:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.fecha_nacimiento || 'No registrada',
                  fontSize: 9,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 10, bold: true },
                {
                  text: `${pacienteCompleto.edad} a帽os`,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'G茅nero:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  DIAGNSTICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Diagn贸stico con clave CIE 10:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    solicitudData.diagnostico_cie10 ||
                    '_________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  INTERVENCIN CAUSES
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Intervenci贸n CAUSES:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    solicitudData.intervencion_causes ||
                    '_________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  ESTUDIOS SOLICITADOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'ESTUDIOS SOLICITADOS:',
                  fontSize: 11,
                  bold: true,
                  margin: [0, 5],
                },
              ],
              [
                {
                  table: {
                    widths: ['5%', '95%'],
                    body: [
                      [
                        { text: '', fontSize: 12 },
                        { text: 'Radiograf铆a simple', fontSize: 10 },
                      ],
                      [
                        { text: '', fontSize: 12 },
                        { text: 'Ultrasonido', fontSize: 10 },
                      ],
                      [
                        { text: '', fontSize: 12 },
                        { text: 'Tomograf铆a', fontSize: 10 },
                      ],
                      [
                        { text: '', fontSize: 12 },
                        { text: 'Resonancia magn茅tica', fontSize: 10 },
                      ],
                      [
                        { text: '', fontSize: 12 },
                        {
                          text: 'Otro: ____________________________________',
                          fontSize: 10,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [10, 10, 10, 10],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 30],
        },

        //  REA ESPECFICA
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'rea espec铆fica a estudiar:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    solicitudData.area_estudio ||
                    '______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  JUSTIFICACIN
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Justificaci贸n m茅dica:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    solicitudData.justificacion ||
                    '______________________________________________________________________________________\n______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        //  FIRMAS
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: [
                    {
                      text: 'M茅dico que solicita:\n',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 10,
                    },
                    {
                      text: `C茅dula: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 9,
                    },
                    {
                      text: 'Firma: _________________________\n',
                      fontSize: 10,
                    },
                    {
                      text: `Fecha: ${fechaActual.toLocaleDateString('es-MX')}`,
                      fontSize: 9,
                    },
                  ],
                  margin: [0, 10],
                },
                {
                  text: [
                    {
                      text: 'Firma y hora que recibe (camillero):\n',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text: 'Nombre: _________________________\n',
                      fontSize: 10,
                    },
                    {
                      text: 'Firma: _________________________\n',
                      fontSize: 10,
                    },
                    {
                      text: `Hora: ${fechaActual.toLocaleTimeString('es-MX')}`,
                      fontSize: 9,
                    },
                  ],
                  margin: [0, 10],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                { text: '', fontSize: 10 },
                {
                  text: [
                    {
                      text: 'Firma y hora que recibe (t茅cnico rayos X):\n',
                      fontSize: 10,
                      bold: true,
                    },
                    {
                      text: 'Nombre: _________________________\n',
                      fontSize: 10,
                    },
                    {
                      text: 'Firma: _________________________\n',
                      fontSize: 10,
                    },
                    {
                      text: `Hora: ${fechaActual.toLocaleTimeString('es-MX')}`,
                      fontSize: 9,
                    },
                  ],
                  margin: [0, 10],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [40, 20],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#000000',
                },
                {
                  text: 'Solicitud de Imagenolog铆a - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#000000',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#000000',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  SOLICITUD DE CULTIVO HOSPITAL MATERNO
  async generarSolicitudCultivo(datos: any): Promise<any> {
    console.log('Й Generando Solicitud de Cultivo para Hospital Materno...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const cultivoData = datos.solicitudCultivo || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 40, 20, 40],

      header: function (currentPage: number) {
        return [
          {
            table: {
              widths: ['100%'],
              body: [
                [
                  {
                    text: 'HOSPITAL MATERNO SAN LUIS DE LA PAZ',
                    fontSize: 12,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 10, 0, 0],
                  },
                ],
                [
                  {
                    text: 'N掳 acceso: ___________________________',
                    fontSize: 10,
                    alignment: 'right',
                    margin: [0, 5, 0, 5],
                  },
                ],
                [
                  {
                    text: 'LABORATORIO CLINICO',
                    fontSize: 12,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 5, 0, 0],
                  },
                ],
                [
                  {
                    text: 'Blvr. Centenario de la Revoluci贸n Mexicana N掳 110',
                    fontSize: 9,
                    alignment: 'center',
                    margin: [0, 5, 0, 10],
                  },
                ],
                [
                  {
                    text: 'SOLICITUD DE ESTUDIOS DE MICROBIOLOGIA',
                    fontSize: 14,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 10, 0, 15],
                  },
                ],
              ],
            },
            layout: 'noBorders',
            margin: [20, 20, 20, 0],
          },
        ];
      },

      content: [
        //  DATOS DEL PACIENTE
        {
          table: {
            widths: ['15%', '35%', '10%', '15%', '10%', '15%'],
            body: [
              [
                { text: 'Nombre:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.nombre_completo,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'G茅nero:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.sexo,
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Edad:', fontSize: 10, bold: true },
                {
                  text: `${pacienteCompleto.edad} a帽os`,
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        {
          table: {
            widths: ['20%', '30%', '15%', '35%'],
            body: [
              [
                { text: 'Fecha de solicitud:', fontSize: 10, bold: true },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'Servicio:', fontSize: 10, bold: true },
                {
                  text: medicoCompleto.departamento || 'No especificado',
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        {
          table: {
            widths: ['15%', '25%', '15%', '25%', '10%', '10%'],
            body: [
              [
                { text: 'Cama:', fontSize: 10, bold: true },
                {
                  text: cultivoData.numero_cama || 'Ambulatorio',
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'No. Expediente:', fontSize: 10, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 10,
                  decoration: 'underline',
                },
                { text: 'CURP:', fontSize: 10, bold: true },
                {
                  text: pacienteCompleto.curp || 'No registrado',
                  fontSize: 9,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  FIRMA MDICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Nombre y firma del m茅dico solicitante:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}`,
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
              [
                {
                  text: `C茅dula: ${medicoCompleto.numero_cedula}   Firma: ___________________________`,
                  fontSize: 10,
                  margin: [0, 10, 0, 0],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  DIAGNSTICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Diagn贸stico:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    cultivoData.diagnostico ||
                    '______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  RESPONSABLE DE TOMA
        {
          table: {
            widths: ['30%', '70%'],
            body: [
              [
                {
                  text: 'Responsable de la toma de muestra:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text:
                    cultivoData.responsable_muestra ||
                    '___________________________',
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 20],
        },

        //  TIPO DE MUESTRA
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'Tipo de muestra:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  table: {
                    widths: ['15%', '15%', '15%', '15%', '15%', '25%'],
                    body: [
                      [
                        { text: ' L铆quido', fontSize: 9 },
                        { text: ' Secreci贸n', fontSize: 9 },
                        { text: ' Sangre', fontSize: 9 },
                        { text: ' Cat茅ter', fontSize: 9 },
                        { text: ' Orina', fontSize: 9 },
                        { text: ' Otro: ___________', fontSize: 9 },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  SITIO DE ORIGEN
        {
          table: {
            widths: ['30%', '70%'],
            body: [
              [
                {
                  text: 'Sitio de origen de la muestra:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text:
                    cultivoData.sitio_origen ||
                    '______________________________________________________________________________________',
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  TIPO DE MICROORGANISMO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'En caso de requerir cultivo especificar el tipo de microorganismo a buscar:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    cultivoData.microorganismo_buscar ||
                    '______________________________________________________________________________________\n______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  TINCIN
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'Tinci贸n:',
                  fontSize: 10,
                  bold: true,
                },
                {
                  table: {
                    widths: ['15%', '15%', '15%', '15%', '40%'],
                    body: [
                      [
                        { text: ' Tinta china', fontSize: 9 },
                        { text: ' Gram', fontSize: 9 },
                        { text: ' BAAR', fontSize: 9 },
                        { text: ' KINYOUN', fontSize: 9 },
                        { text: ' Otro: ___________', fontSize: 9 },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  ANTIBITICO
        {
          table: {
            widths: ['30%', '15%', '55%'],
            body: [
              [
                {
                  text: '驴El paciente recibe antibi贸tico?',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: cultivoData.recibe_antibiotico
                    ? ' S铆    No'
                    : ' S铆    No',
                  fontSize: 10,
                },
                {
                  text:
                    '驴Cu谩l? ' +
                    (cultivoData.antibiotico_actual ||
                      '___________________________'),
                  fontSize: 10,
                  decoration: 'underline',
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  CULTIVOS ANTERIORES
        {
          table: {
            widths: ['40%', '15%', '45%'],
            body: [
              [
                {
                  text: '驴Se han realizado cultivos anteriormente?',
                  fontSize: 10,
                  bold: true,
                },
                {
                  text: cultivoData.cultivos_previos
                    ? ' S铆    No'
                    : ' S铆    No',
                  fontSize: 10,
                },
                {
                  text: '',
                  fontSize: 10,
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  MICROORGANISMOS AISLADOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Microorganismos aislados encontrados:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    cultivoData.microorganismos_aislados ||
                    '______________________________________________________________________________________\n______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 15],
        },

        //  COMENTARIOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Comentarios:',
                  fontSize: 10,
                  bold: true,
                },
              ],
              [
                {
                  text:
                    cultivoData.comentarios ||
                    '______________________________________________________________________________________\n______________________________________________________________________________________\n______________________________________________________________________________________',
                  fontSize: 10,
                  margin: [0, 5],
                },
              ],
            ],
          },
          layout: 'noBorders',
          margin: [0, 0, 0, 30],
        },

        //  ETIQUETA DE FOLIO (DUPLICATE HEADER)
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Etiqueta de folio: ___________________________',
                  fontSize: 10,
                  alignment: 'center',
                  margin: [0, 20, 0, 0],
                },
              ],
            ],
          },
          layout: 'noBorders',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 10],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#666666',
                },
                {
                  text: 'Solicitud de Cultivo - Hospital Materno\nSICEG - NOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 7,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  NOTA DE EGRESO SEGN NOM-004-SSA3-2012 SECCIN D12
  async generarNotaEgreso(datos: any): Promise<any> {
    console.log('   Generando Nota de Egreso seg煤n NOM-004-SSA3-2012...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const egresoData = datos.notaEgreso || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA DE EGRESO',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  IDENTIFICACIN DEL PACIENTE (NOM-004 5.2)
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha egreso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora egreso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. de cama',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio egreso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            egresoData.fecha_egreso ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            egresoData.hora_egreso ||
                            fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: egresoData.numero_cama || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `EG-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['60%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} a帽os`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '50%'],
                    body: [
                      [
                        {
                          text: 'Fecha y hora ingreso hospitalario',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'D铆as de estancia en la unidad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            egresoData.fecha_ingreso || 'No registrada'
                          } - ${egresoData.hora_ingreso || 'No registrada'}`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${
                            egresoData.dias_estancia ||
                            datos.diasHospitalizacion
                          } d铆as`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['60%', '40%'],
                    body: [
                      [
                        {
                          text: 'Servicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Reingreso por la misma afecci贸n en el a帽o',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'No especificado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: egresoData.es_reingreso ? 'S' : 'NO',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: egresoData.es_reingreso
                            ? '#dc2626'
                            : '#059669',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  SIGNOS VITALES AL EGRESO (NOM-004 D12.4)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'SIGNOS VITALES AL EGRESO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  table: {
                    widths: ['16%', '16%', '16%', '16%', '16%', '20%'],
                    body: [
                      [
                        {
                          text: 'Peso',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Talla',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Presi贸n arterial',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'FC',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'FR',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Temperatura',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${signosVitales.peso || '___'} kg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${signosVitales.talla || '___'} cm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.presion_arterial_sistolica || '___'
                          }/${
                            signosVitales.presion_arterial_diastolica || '___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_cardiaca || '___'
                          } lpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_respiratoria || '___'
                          } rpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${signosVitales.temperatura || '___'} 掳C`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Estado general al egreso',
                          fontSize: 7,
                          bold: true,
                          fillColor: '#f9f9f9',
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            egresoData.estado_general_egreso ||
                            'Estable, sin signos de alarma.',
                          fontSize: 8,
                          margin: [3, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  DIAGNSTICOS (NOM-004 D12.8 y D12.11)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'DIAGNSTICOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'DIAGNSTICO(S) DE INGRESO (D12.8)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.diagnosticos_ingreso ||
                    'No especificados en el momento del ingreso.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'DIAGNSTICO(S) FINAL(ES) (D12.11)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.diagnosticos_finales ||
                    'Diagn贸sticos finales por definir.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  EVOLUCIN Y MANEJO (NOM-004 D12.9 y D12.10)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EVOLUCIN Y MANEJO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'RESUMEN DE LA EVOLUCIN Y ESTADO ACTUAL (D12.9)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.resumen_evolucion ||
                    'Evoluci贸n cl铆nica favorable durante la estancia hospitalaria.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MANEJO DURANTE LA ESTANCIA HOSPITALARIA (D12.10)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.manejo_hospitalario ||
                    'Manejo m茅dico integral seg煤n protocolos institucionales.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  PROCEDIMIENTOS Y MOTIVO DE EGRESO (NOM-004 D12.12 y D12.13)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PROCEDIMIENTOS Y EGRESO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'PROCEDIMIENTOS REALIZADOS (D12.12)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.procedimientos_realizados ||
                    'Sin procedimientos especiales durante la estancia.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MOTIVO DE EGRESO (D12.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text:
                            egresoData.motivo_egreso === 'maximo_beneficio'
                              ? ' M谩ximo beneficio'
                              : ' M谩ximo beneficio',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text:
                            egresoData.motivo_egreso === 'mejoria'
                              ? ' Por mejor铆a'
                              : ' Por mejor铆a',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text:
                            egresoData.motivo_egreso === 'alta_voluntaria'
                              ? ' Alta voluntaria'
                              : ' Alta voluntaria',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text:
                            egresoData.motivo_egreso === 'exitus'
                              ? ' Exitus'
                              : ' Exitus',
                          fontSize: 7,
                          alignment: 'center',
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  PROBLEMAS PENDIENTES Y PLAN (NOM-004 D12.14 y D12.15)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'SEGUIMIENTO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'PROBLEMAS CLNICOS PENDIENTES (D12.14)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.problemas_pendientes ||
                    'Sin problemas cl铆nicos pendientes al momento del egreso.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'PLAN DE MANEJO Y TRATAMIENTO (D12.15)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.plan_manejo_tratamiento ||
                    'Continuar manejo ambulatorio seg煤n indicaciones m茅dicas.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'RECOMENDACIONES PARA VIGILANCIA AMBULATORIA (D12.16)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    egresoData.recomendaciones_ambulatorias ||
                    'Control m茅dico en consulta externa seg煤n programaci贸n. Acudir a urgencias en caso de signos de alarma.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        //  MDICO RESPONSABLE SEGN NOM-004 (D12.17)
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: 'NOMBRE COMPLETO, CDULA PROFESIONAL Y FIRMA DEL MDICO (D12.17)',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: 'FIRMA AUTGRAFA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `C茅dula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `${medicoCompleto.cargo} - ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Hospital General San Luis de la Paz\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Fecha: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Hora: ${fechaActual.toLocaleTimeString('es-MX')}`,
                      fontSize: 7,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
                {
                  text: '\n\n\n\n_________________________\nFIRMA DEL MDICO TRATANTE\n(NOM-004-SSA3-2012)',
                  fontSize: 8,
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        //  NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Secci贸n D12 "Nota de egreso"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos establecidos en los numerales D12.1 al D12.17',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota de Egreso - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  NOTA DE INTERCONSULTA SEGN NOM-004-SSA3-2012 SECCIN D7
  async generarNotaInterconsulta(datos: any): Promise<any> {
    console.log(
      '  Generando Nota de Interconsulta seg煤n NOM-004-SSA3-2012...'
    );

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const interconsultaData = datos.notaInterconsulta || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA DE INTERCONSULTA',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  IDENTIFICACIN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha interconsulta',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora interconsulta',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. de cama',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio interconsulta',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: interconsultaData.numero_cama || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `IC-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['60%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} a帽os`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '50%'],
                    body: [
                      [
                        {
                          text: 'Servicio solicitante',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Especialidad solicitada',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'No especificado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            interconsultaData.especialidad_solicitada ||
                            'No especificada',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'M茅dico que solicita interconsulta',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - C茅dula: ${medicoCompleto.numero_cedula}`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  MOTIVO DE LA CONSULTA (NOM-004 D7.14)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'SOLICITUD DE INTERCONSULTA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'MOTIVO DE LA CONSULTA (D7.14)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.motivo_consulta ||
                    'Motivo de interconsulta no especificado.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'PROBLEMA CLNICO ESPECFICO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.problema_clinico ||
                    'Se solicita valoraci贸n y manejo por especialidad correspondiente.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  ANTECEDENTES RELEVANTES
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ANTECEDENTES RELEVANTES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'ANTECEDENTES PERSONALES PATOLGICOS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.antecedentes_patologicos ||
                    'Sin antecedentes patol贸gicos de importancia.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MEDICAMENTOS ACTUALES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.medicamentos_actuales ||
                    'Sin medicamentos de base reportados.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  EXPLORACIN FSICA RELEVANTE
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EXPLORACIN FSICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'SIGNOS VITALES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Presi贸n arterial',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia card铆aca',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia respiratoria',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Temperatura',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            signosVitales.presion_arterial_sistolica || '___'
                          }/${
                            signosVitales.presion_arterial_diastolica || '___'
                          } mmHg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_cardiaca || '___'
                          } lpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_respiratoria || '___'
                          } rpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${signosVitales.temperatura || '___'} 掳C`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 2],
                },
              ],
              [
                {},
                {
                  text: 'HALLAZGOS RELEVANTES PARA INTERCONSULTA',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.hallazgos_relevantes ||
                    'Exploraci贸n f铆sica dirigida seg煤n el motivo de interconsulta.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  ESTUDIOS DISPONIBLES
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTUDIOS DISPONIBLES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'LABORATORIO Y GABINETE',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.estudios_disponibles ||
                    'Se adjuntan estudios de laboratorio y gabinete disponibles en el expediente.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  RESPUESTA DEL ESPECIALISTA
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'RESPUESTA DEL ESPECIALISTA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#e0f2fe',
                  alignment: 'center',
                  rowSpan: 8,
                },
                {
                  text: 'CRITERIO DIAGNSTICO (D7.12)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.criterio_diagnostico ||
                    '________________________________________________________________________________________\n________________________________________________________________________________________',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'SUGERENCIAS DIAGNSTICAS (D7.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.sugerencias_diagnosticas ||
                    '________________________________________________________________________________________\n________________________________________________________________________________________',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'SUGERENCIAS DE TRATAMIENTO (D7.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.sugerencias_tratamiento ||
                    '________________________________________________________________________________________\n________________________________________________________________________________________',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'ESTUDIOS ADICIONALES SUGERIDOS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    interconsultaData.estudios_sugeridos ||
                    '________________________________________________________________________________________',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        //  FIRMAS
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: 'MDICO QUE SOLICITA INTERCONSULTA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: 'MDICO ESPECIALISTA CONSULTADO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#e0f2fe',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `C茅dula: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )}\n`,
                      fontSize: 7,
                    },
                    {
                      text: '\n_________________________\nFIRMA',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
                {
                  text: [
                    {
                      text: `${
                        interconsultaData.especialista_nombre ||
                        '__________________________'
                      }\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `C茅dula: ${
                        interconsultaData.especialista_cedula ||
                        '______________'
                      }\n`,
                      fontSize: 8,
                    },
                    {
                      text: `${
                        interconsultaData.especialidad_solicitada ||
                        '__________________________'
                      }\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha: ${
                        interconsultaData.fecha_respuesta || '______________'
                      }\n`,
                      fontSize: 7,
                    },
                    {
                      text: '\n_________________________\nFIRMA',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        //  NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Secci贸n D7 "Notas de interconsulta"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos establecidos en los numerales D7.12, D7.13 y D7.14',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota de Interconsulta - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  PRESCRIPCIN DE MEDICAMENTOS SEGN NOM-004-SSA3-2012
  async generarPrescripcionMedicamentos(datos: any): Promise<any> {
    console.log(' Generando Prescripci贸n de Medicamentos seg煤n NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const prescripcionData = datos.prescripcionMedicamentos || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [30, 60, 30, 50],

      header: {
        margin: [30, 15, 30, 15],
        table: {
          widths: ['20%', '60%', '20%'],
          body: [
            [
              {
                text: '',
                fontSize: 24,
                alignment: 'center',
                color: '#059669',
              },
              {
                text: [
                  {
                    text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ\n',
                    fontSize: 13,
                    bold: true,
                    alignment: 'center',
                  },
                  {
                    text: 'PRESCRIPCIN MDICA\n',
                    fontSize: 11,
                    bold: true,
                    alignment: 'center',
                  },
                  {
                    text: 'Blvd. Centenario de la Revoluci贸n Mexicana #110',
                    fontSize: 8,
                    alignment: 'center',
                  },
                ],
              },
              {
                text: [
                  { text: 'Folio:\n', fontSize: 8, bold: true },
                  {
                    text: `PM-${this.obtenerNumeroExpedientePreferido(
                      pacienteCompleto.expediente
                    )}-${fechaActual.getFullYear()}\n`,
                    fontSize: 7,
                  },
                  { text: 'Fecha:\n', fontSize: 8, bold: true },
                  {
                    text: fechaActual.toLocaleDateString('es-MX'),
                    fontSize: 8,
                  },
                ],
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  DATOS DEL PACIENTE
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DATOS DEL PACIENTE',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  margin: [0, 3, 0, 3],
                },
              ],
              [
                {
                  table: {
                    widths: ['20%', '30%', '20%', '30%'],
                    body: [
                      [
                        { text: 'Nombre:', fontSize: 8, bold: true },
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                        },
                        { text: 'Expediente:', fontSize: 8, bold: true },
                        {
                          text: this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          ),
                          fontSize: 8,
                          bold: true,
                        },
                      ],
                      [
                        { text: 'Edad:', fontSize: 8, bold: true },
                        {
                          text: `${pacienteCompleto.edad} a帽os`,
                          fontSize: 8,
                        },
                        { text: 'Sexo:', fontSize: 8, bold: true },
                        { text: pacienteCompleto.sexo, fontSize: 8 },
                      ],
                      [
                        { text: 'Peso:', fontSize: 8, bold: true },
                        {
                          text: `${prescripcionData.peso_paciente || '___'} kg`,
                          fontSize: 8,
                        },
                        { text: 'Alergias:', fontSize: 8, bold: true },
                        {
                          text:
                            prescripcionData.alergias_conocidas ||
                            'No conocidas',
                          fontSize: 8,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 5, 5, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        //  DIAGNSTICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DIAGNSTICO:',
                  fontSize: 9,
                  bold: true,
                  margin: [5, 5, 5, 2],
                },
              ],
              [
                {
                  text:
                    prescripcionData.diagnostico ||
                    'Diagn贸stico por especificar',
                  fontSize: 9,
                  margin: [5, 2, 5, 8],
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        //  MEDICAMENTOS PRESCRITOS
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Rp/ MEDICAMENTOS PRESCRITOS',
                  fontSize: 10,
                  bold: true,
                  fillColor: '#f0f9ff',
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 5],
        },

        //  TABLA DE MEDICAMENTOS
        {
          table: {
            widths: ['5%', '35%', '20%', '15%', '25%'],
            body: [
              // Encabezados
              [
                {
                  text: '#',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#e0f2fe',
                },
                {
                  text: 'MEDICAMENTO\n(Denominaci贸n gen茅rica)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#e0f2fe',
                },
                {
                  text: 'PRESENTACIN\nY CONCENTRACIN',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#e0f2fe',
                },
                {
                  text: 'CANTIDAD',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#e0f2fe',
                },
                {
                  text: 'INDICACIONES\n(Dosis, v铆a, frecuencia)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#e0f2fe',
                },
              ],
              // Generar filas de medicamentos (m谩ximo 10)
              ...Array.from({ length: 10 }, (_, index) => {
                const medicamento = prescripcionData.medicamentos?.[index];
                return [
                  {
                    text: (index + 1).toString(),
                    fontSize: 8,
                    alignment: 'center',
                    margin: [0, 8, 0, 8],
                  },
                  {
                    text: medicamento?.nombre_generico || '',
                    fontSize: 9,
                    margin: [3, 8, 3, 8],
                    bold: !!medicamento?.nombre_generico,
                  },
                  {
                    text: medicamento?.presentacion || '',
                    fontSize: 8,
                    margin: [3, 8, 3, 8],
                    alignment: 'center',
                  },
                  {
                    text: medicamento?.cantidad || '',
                    fontSize: 8,
                    margin: [3, 8, 3, 8],
                    alignment: 'center',
                  },
                  {
                    text: medicamento?.indicaciones || '',
                    fontSize: 8,
                    margin: [3, 8, 3, 8],
                  },
                ];
              }),
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        //  INSTRUCCIONES GENERALES
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'INSTRUCCIONES GENERALES AL PACIENTE:',
                  fontSize: 9,
                  bold: true,
                  margin: [5, 5, 5, 2],
                },
              ],
              [
                {
                  text:
                    prescripcionData.instrucciones_generales ||
                    ' Tomar los medicamentos seg煤n las indicaciones m茅dicas\n' +
                      ' Completar el tratamiento aunque se sienta mejor\n' +
                      ' No suspender medicamentos sin autorizaci贸n m茅dica\n' +
                      ' Acudir a control m茅dico en la fecha indicada\n' +
                      ' En caso de reacciones adversas, suspender y acudir al m茅dico',
                  fontSize: 8,
                  margin: [5, 5, 5, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        //  PRXIMA CITA
        {
          table: {
            widths: ['70%', '30%'],
            body: [
              [
                {
                  text: `PRXIMA CITA: ${
                    prescripcionData.proxima_cita || '___________________'
                  }`,
                  fontSize: 9,
                  bold: true,
                  margin: [5, 8, 5, 8],
                },
                {
                  text: `DAS DE TRATAMIENTO: ${
                    prescripcionData.dias_tratamiento || '____'
                  } d铆as`,
                  fontSize: 9,
                  bold: true,
                  margin: [5, 8, 5, 8],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 20],
        },

        //  FIRMA DEL MDICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DATOS DEL MDICO PRESCRIPTOR',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  margin: [0, 5, 0, 5],
                },
              ],
              [
                {
                  text: [
                    {
                      text: `Nombre: ${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `C茅dula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de prescripci贸n: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )}\n`,
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 10, 5, 5],
                  alignment: 'left',
                },
              ],
              [
                {
                  text: '\n\n_____________________________________\nFIRMA Y SELLO DEL MDICO',
                  fontSize: 9,
                  alignment: 'center',
                  margin: [0, 10, 0, 15],
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 10] },

        //  ADVERTENCIAS LEGALES
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: '  ADVERTENCIAS IMPORTANTES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  margin: [0, 3, 0, 3],
                },
              ],
              [
                {
                  text:
                    ' Esta prescripci贸n es v谩lida 煤nicamente para el paciente indicado\n' +
                    ' Los medicamentos controlados requieren presentar receta original\n' +
                    ' Conservar en lugar fresco y seco, fuera del alcance de los ni帽os\n' +
                    ' No automedicarse ni compartir medicamentos\n' +
                    ' En caso de emergencia comunicarse al Hospital: Tel. (468) 688-0001',
                  fontSize: 7,
                  margin: [5, 5, 5, 5],
                  lineHeight: 1.2,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#f59e0b',
            vLineColor: () => '#f59e0b',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [30, 10],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Prescripci贸n M茅dica - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  REGISTRO DE TRANSFUSIN SEGN NOM-004-SSA3-2012 SECCIN D15
  async generarRegistroTransfusion(datos: any): Promise<any> {
    console.log(
      '└ Generando Registro de Transfusi贸n seg煤n NOM-004 y NOM-253...'
    );

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const transfusionData = datos.registroTransfusion || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 60, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - REGISTRO DE TRANSFUSIN',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
            [
              {
                text: 'REGISTRO DE TRANSFUSIN DE UNIDADES DE SANGRE O COMPONENTES',
                fontSize: 9,
                bold: true,
                alignment: 'center',
                margin: [0, 3, 0, 0],
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  IDENTIFICACIN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha transfusi贸n',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora inicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. de cama',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio registro',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            transfusionData.fecha_transfusion ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            transfusionData.hora_inicio ||
                            fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: transfusionData.numero_cama || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `RT-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} a帽os`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['40%', '30%', '30%'],
                    body: [
                      [
                        {
                          text: 'Servicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Diagn贸stico',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo sangu铆neo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'No especificado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            transfusionData.diagnostico || 'No especificado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.tipo_sangre || 'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'M茅dico que indica la transfusi贸n',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - C茅dula: ${medicoCompleto.numero_cedula}`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  INFORMACIN DE LAS UNIDADES TRANSFUNDIDAS (NOM-004 D15.1)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'UNIDADES TRANSFUNDIDAS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fee2e2',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'INFORMACIN DE UNIDADES DE SANGRE O COMPONENTES (D15.1)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef2f2',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Tipo de componente',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Cantidad de unidades',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Volumen total (ml)',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. identificaci贸n',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            transfusionData.tipo_componente ||
                            'Concentrado eritrocitario',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: transfusionData.cantidad_unidades || '1',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                        {
                          text: transfusionData.volumen_total || '250',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: transfusionData.numero_identificacion || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  text: 'FECHA Y HORA DE INICIO Y FINALIZACIN (D15.2)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef2f2',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Fecha inicio',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora inicio',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Fecha finalizaci贸n',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora finalizaci贸n',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            transfusionData.fecha_inicio ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            transfusionData.hora_inicio ||
                            fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            transfusionData.fecha_finalizacion ||
                            '______________',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            transfusionData.hora_finalizacion ||
                            '______________',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  CONTROL DE SIGNOS VITALES (NOM-004 D15.3)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'CONTROL SIGNOS VITALES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#dbeafe',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'SIGNOS VITALES ANTES, DURANTE Y DESPUS DE LA TRANSFUSIN (D15.3)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#eff6ff',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Momento',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Presi贸n arterial',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia card铆aca',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Temperatura',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: 'ANTES',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                          fillColor: '#f0f9ff',
                        },
                        {
                          text: `${
                            signosVitales.presion_arterial_sistolica || '___'
                          }/${
                            signosVitales.presion_arterial_diastolica || '___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_cardiaca || '___'
                          } lpm`,
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: `${signosVitales.temperatura || '___'} 掳C`,
                          fontSize: 7,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: 'DURANTE',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                          fillColor: '#f0f9ff',
                        },
                        {
                          text: transfusionData.pa_durante || '__________',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: transfusionData.fc_durante || '___ lpm',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: transfusionData.temp_durante || '___ 掳C',
                          fontSize: 7,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: 'DESPUS',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                          fillColor: '#f0f9ff',
                        },
                        {
                          text: transfusionData.pa_despues || '__________',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: transfusionData.fc_despues || '___ lpm',
                          fontSize: 7,
                          alignment: 'center',
                        },
                        {
                          text: transfusionData.temp_despues || '___ 掳C',
                          fontSize: 7,
                          alignment: 'center',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  text: 'ESTADO GENERAL DEL PACIENTE',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#eff6ff',
                },
              ],
              [
                {},
                {
                  text:
                    transfusionData.estado_general ||
                    'Paciente estable durante todo el procedimiento de transfusi贸n. Sin signos de reacciones adversas.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  REACCIONES ADVERSAS (NOM-004 D15.4)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'REACCIONES ADVERSAS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'REACCIONES ADVERSAS A LA TRANSFUSIN (D15.4)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['20%', '80%'],
                    body: [
                      [
                        {
                          text: transfusionData.hubo_reacciones
                            ? ' S'
                            : ' NO',
                          fontSize: 8,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Se presentaron reacciones adversas durante o despu茅s de la transfusi贸n',
                          fontSize: 8,
                          alignment: 'left',
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                },
              ],
              [
                {},
                {
                  text: 'TIPO DE REACCIN Y MANEJO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  text:
                    transfusionData.tipo_reaccion_manejo ||
                    (transfusionData.hubo_reacciones
                      ? 'Describir tipo de reacci贸n: _________________________________\nManejo aplicado: _________________________________'
                      : 'Sin reacciones adversas reportadas durante el procedimiento.'),
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  PERSONAL RESPONSABLE (NOM-004 D15.5)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PERSONAL RESPONSABLE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0fdf4',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'MDICO QUE INDIC LA TRANSFUSIN (D15.5)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - C茅dula: ${medicoCompleto.numero_cedula}`,
                  fontSize: 8,
                  margin: [5, 3],
                  bold: true,
                },
              ],
              [
                {},
                {
                  text: 'PERSONAL DE SALUD ENCARGADO DE APLICACIN Y VIGILANCIA (D15.5)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '50%'],
                    body: [
                      [
                        {
                          text: 'Nombre del personal de enfermer铆a:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'C茅dula profesional:',
                          fontSize: 7,
                          bold: true,
                        },
                      ],
                      [
                        {
                          text:
                            transfusionData.enfermera_responsable ||
                            '____________________________',
                          fontSize: 8,
                          decoration: 'underline',
                        },
                        {
                          text:
                            transfusionData.cedula_enfermera ||
                            '____________________________',
                          fontSize: 8,
                          decoration: 'underline',
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'OBSERVACIONES ADICIONALES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    transfusionData.observaciones_adicionales ||
                    'Transfusi贸n realizada sin complicaciones. Paciente toler贸 bien el procedimiento.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        //  FIRMAS MLTIPLES SEGN NOM-004
        {
          table: {
            widths: ['33.33%', '33.33%', '33.34%'],
            body: [
              [
                {
                  text: 'MDICO QUE INDICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: 'PERSONAL DE ENFERMERA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: 'BANCO DE SANGRE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 8,
                      bold: true,
                    },
                    {
                      text: `C茅dula: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `${medicoCompleto.especialidad}\n`,
                      fontSize: 7,
                    },
                    {
                      text: '\n\n_____________________\nFIRMA',
                      fontSize: 7,
                    },
                  ],
                  margin: [2, 10],
                  alignment: 'center',
                },
                {
                  text: [
                    {
                      text: `${
                        transfusionData.enfermera_responsable ||
                        '__________________'
                      }\n`,
                      fontSize: 8,
                      bold: true,
                    },
                    {
                      text: `C茅dula: ${
                        transfusionData.cedula_enfermera || '__________'
                      }\n`,
                      fontSize: 7,
                    },
                    {
                      text: 'Enfermer铆a\n',
                      fontSize: 7,
                    },
                    {
                      text: '\n\n_____________________\nFIRMA',
                      fontSize: 7,
                    },
                  ],
                  margin: [2, 10],
                  alignment: 'center',
                },
                {
                  text: [
                    {
                      text: `${
                        transfusionData.responsable_banco_sangre ||
                        '__________________'
                      }\n`,
                      fontSize: 8,
                      bold: true,
                    },
                    {
                      text: `C茅dula: ${
                        transfusionData.cedula_banco || '__________'
                      }\n`,
                      fontSize: 7,
                    },
                    {
                      text: 'Banco de Sangre\n',
                      fontSize: 7,
                    },
                    {
                      text: '\n\n_____________________\nFIRMA',
                      fontSize: 7,
                    },
                  ],
                  margin: [2, 10],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        //  NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Registro elaborado conforme a NOM-004-SSA3-2012, Secci贸n D15 "Registro de transfusi贸n"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con NOM-253-SSA1-2012 para disposici贸n de sangre humana y componentes',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Registro de Transfusi贸n - SICEG\nNOM-004-SSA3-2012 | NOM-253-SSA1-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  NOTA PREOPERATORIA SEGN NOM-004-SSA3-2012 SECCIN 8.5
  async generarNotaPreoperatoria(datos: any): Promise<any> {
    console.log(' Generando Nota Preoperatoria seg煤n NOM-004-SSA3-2012...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const preoperatoriaData = datos.notaPreoperatoria || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA PREOPERATORIA',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  IDENTIFICACIN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha cirug铆a',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora programada',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Quir贸fano',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio nota',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            preoperatoriaData.fecha_cirugia ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: preoperatoriaData.hora_programada || '00:00',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: preoperatoriaData.quirofano || 'Por asignar',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `NPO-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} a帽os`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['40%', '30%', '30%'],
                    body: [
                      [
                        {
                          text: 'Servicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Peso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo sangu铆neo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'Cirug铆a General',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${signosVitales.peso || '___'} kg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.tipo_sangre || 'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Cirujano responsable',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - C茅dula: ${medicoCompleto.numero_cedula}`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  DIAGNSTICO PREOPERATORIO (NOM-004 8.5.2)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EVALUACIN PREOPERATORIA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'DIAGNSTICO PREOPERATORIO (8.5.2)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.diagnostico_preoperatorio ||
                    'Diagn贸stico preoperatorio por especificar.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
              [
                {},
                {
                  text: 'PLAN QUIRRGICO (8.5.3)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.plan_quirurgico ||
                    'Plan quir煤rgico por definir seg煤n evaluaci贸n.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'TIPO DE INTERVENCIN QUIRRGICA (8.5.4)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.tipo_intervencion ||
                    'Tipo de intervenci贸n por especificar.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  RIESGO QUIRRGICO (NOM-004 8.5.5)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EVALUACIN DE RIESGO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'RIESGO QUIRRGICO (8.5.5)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text:
                            preoperatoriaData.riesgo_quirurgico === 'bajo'
                              ? ' BAJO'
                              : ' BAJO',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preoperatoriaData.riesgo_quirurgico === 'moderado'
                              ? ' MODERADO'
                              : ' MODERADO',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preoperatoriaData.riesgo_quirurgico === 'alto'
                              ? ' ALTO'
                              : ' ALTO',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preoperatoriaData.riesgo_quirurgico === 'muy_alto'
                              ? ' MUY ALTO'
                              : ' MUY ALTO',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'JUSTIFICACIN DEL RIESGO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.justificacion_riesgo ||
                    'Paciente con riesgo quir煤rgico apropiado para el procedimiento programado.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  CUIDADOS PREOPERATORIOS (NOM-004 8.5.6)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'CUIDADOS PREOPERATORIOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#e0f2fe',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'CUIDADOS Y PLAN TERAPUTICO PREOPERATORIO (8.5.6)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.cuidados_preoperatorios ||
                    ' Ayuno m铆nimo 8 horas para s贸lidos, 2 horas para l铆quidos claros\n' +
                      ' Ba帽o preoperatorio con jab贸n antis茅ptico\n' +
                      ' Verificar retiro de pr贸tesis dentales, joyas y lentes de contacto\n' +
                      ' Administrar premedicaci贸n seg煤n indicaci贸n anest茅sica\n' +
                      ' Verificar consentimiento informado firmado',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MEDICACIN PREOPERATORIA',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.medicacion_preoperatoria ||
                    'Seg煤n indicaci贸n del anestesi贸logo.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  ESTUDIOS PREOPERATORIOS
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTUDIOS PREOPERATORIOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0fdf4',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'LABORATORIO PREOPERATORIO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.laboratorio_preoperatorio ||
                    'Biometr铆a hem谩tica, qu铆mica sangu铆nea, tiempos de coagulaci贸n seg煤n protocolo.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'ESTUDIOS DE GABINETE',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    preoperatoriaData.gabinete_preoperatorio ||
                    'Radiograf铆a de t贸rax, electrocardiograma seg煤n protocolo y edad del paciente.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  PRONSTICO (NOM-004 8.5.7)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PRONSTICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
                {
                  text: `PRONSTICO (8.5.7): ${
                    preoperatoriaData.pronostico ||
                    'Favorable para la vida y funci贸n, reservado a la evoluci贸n transoperatoria y postoperatoria.'
                  }`,
                  fontSize: 8,
                  margin: [5, 8],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        //  EQUIPO QUIRRGICO PROGRAMADO
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EQUIPO QUIRRGICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'EQUIPO QUIRRGICO PROGRAMADO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Cirujano:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Ayudante:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Anestesi贸logo:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Instrumentista:',
                          fontSize: 7,
                          bold: true,
                        },
                      ],
                      [
                        {
                          text: medicoCompleto.nombre_completo,
                          fontSize: 7,
                        },
                        {
                          text:
                            preoperatoriaData.ayudante || '________________',
                          fontSize: 7,
                        },
                        {
                          text:
                            preoperatoriaData.anestesiologo ||
                            '________________',
                          fontSize: 7,
                        },
                        {
                          text:
                            preoperatoriaData.instrumentista ||
                            '________________',
                          fontSize: 7,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [3, 2],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        //  FIRMA DEL CIRUJANO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'CIRUJANO RESPONSABLE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `C茅dula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de elaboraci贸n: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} - ${fechaActual.toLocaleTimeString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: '\n\n_____________________________________\nFIRMA DEL CIRUJANO RESPONSABLE',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        //  NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Secci贸n 8.5 "Nota preoperatoria"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos establecidos en los numerales 8.5.1 al 8.5.7',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota Preoperatoria - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  NOTA POSTOPERATORIA SEGN NOM-004-SSA3-2012 SECCIN 8.8
  async generarNotaPostoperatoria(datos: any): Promise<any> {
    console.log('   Generando Nota Postoperatoria seg煤n NOM-004-SSA3-2012...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const postoperatoriaData = datos.notaPostoperatoria || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA POSTOPERATORIA',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  IDENTIFICACIN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha cirug铆a',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora finalizaci贸n',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Quir贸fano',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Duraci贸n cirug铆a',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            postoperatoriaData.fecha_cirugia ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text:
                            postoperatoriaData.hora_finalizacion ||
                            fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: postoperatoriaData.quirofano || 'Q1',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            postoperatoriaData.duracion_cirugia || '_____ min',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} a帽os`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['40%', '30%', '30%'],
                    body: [
                      [
                        {
                          text: 'Servicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo sangu铆neo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'ASA',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            medicoCompleto.departamento || 'Cirug铆a General',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.tipo_sangre || 'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                        {
                          text:
                            postoperatoriaData.clasificacion_asa || 'ASA II',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Cirujano responsable',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo} - C茅dula: ${medicoCompleto.numero_cedula}`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  DIAGNSTICOS Y OPERACIONES (NOM-004 8.8.1-8.8.4)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'DIAGNSTICOS Y PROCEDIMIENTOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 8,
                },
                {
                  text: 'DIAGNSTICO PREOPERATORIO (8.8.1)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.diagnostico_preoperatorio ||
                    'Diagn贸stico preoperatorio.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'OPERACIN PLANEADA (8.8.2)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.operacion_planeada ||
                    'Operaci贸n programada.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'OPERACIN REALIZADA (8.8.3)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.operacion_realizada ||
                    'Operaci贸n efectivamente realizada.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
              [
                {},
                {
                  text: 'DIAGNSTICO POSTOPERATORIO (8.8.4)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.diagnostico_postoperatorio ||
                    'Diagn贸stico postoperatorio.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  DESCRIPCIN TCNICA QUIRRGICA (NOM-004 8.8.5)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'TCNICA QUIRRGICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#e0f2fe',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'DESCRIPCIN DE LA TCNICA QUIRRGICA (8.8.5)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.descripcion_tecnica ||
                    'Descripci贸n detallada de la t茅cnica quir煤rgica empleada.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'HALLAZGOS TRANSOPERATORIOS (8.8.6)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.hallazgos_transoperatorios ||
                    'Hallazgos encontrados durante el procedimiento quir煤rgico.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  CONTROL QUIRRGICO (NOM-004 8.8.7-8.8.9)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'CONTROL QUIRRGICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'REPORTE DE CONTEO DE GASAS, COMPRESAS E INSTRUMENTAL (8.8.7)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['33%', '33%', '34%'],
                    body: [
                      [
                        {
                          text: 'Gasas',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Compresas',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Instrumental',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            postoperatoriaData.conteo_gasas || 'Completo '
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${
                            postoperatoriaData.conteo_compresas || 'Completo '
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${
                            postoperatoriaData.conteo_instrumental ||
                            'Completo '
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 2],
                },
              ],
              [
                {},
                {
                  text: 'INCIDENTES Y ACCIDENTES (8.8.8)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.incidentes_accidentes ||
                    'Sin incidentes ni accidentes transoperatorios.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'CUANTIFICACIN DE SANGRADO Y TRANSFUSIONES (8.8.9)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '50%'],
                    body: [
                      [
                        {
                          text: `Sangrado: ${
                            postoperatoriaData.sangrado_ml || '___'
                          } ml`,
                          fontSize: 8,
                          bold: true,
                        },
                        {
                          text: `Transfusiones: ${
                            postoperatoriaData.transfusiones || 'No'
                          }`,
                          fontSize: 8,
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  ESTUDIOS TRANSOPERATORIOS (NOM-004 8.8.10)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTUDIOS TRANSOPERATORIOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0fdf4',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'ESTUDIOS DE SERVICIOS AUXILIARES DE DIAGNSTICO Y TRATAMIENTO (8.8.10)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.estudios_transoperatorios ||
                    'No se realizaron estudios transoperatorios.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  EQUIPO QUIRRGICO (NOM-004 8.8.11)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EQUIPO QUIRRGICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fdf2f8',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'AYUDANTES, INSTRUMENTISTAS, ANESTESILOGO Y CIRCULANTE (8.8.11)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef7ff',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Cirujano:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Ayudante:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Anestesi贸logo:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Instrumentista:',
                          fontSize: 7,
                          bold: true,
                        },
                      ],
                      [
                        {
                          text: medicoCompleto.nombre_completo,
                          fontSize: 7,
                        },
                        {
                          text: postoperatoriaData.ayudante || 'N/A',
                          fontSize: 7,
                        },
                        {
                          text: postoperatoriaData.anestesiologo || 'N/A',
                          fontSize: 7,
                        },
                        {
                          text: postoperatoriaData.instrumentista || 'N/A',
                          fontSize: 7,
                        },
                      ],
                      [
                        {
                          text: 'Circulante:',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: postoperatoriaData.circulante || 'N/A',
                          fontSize: 7,
                          colSpan: 3,
                        },
                        {},
                        {},
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [3, 2],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  ESTADO POSTQUIRRGICO Y PLAN (NOM-004 8.8.12-8.8.13)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTADO POSTQUIRRGICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'ESTADO POST-QUIRRGICO INMEDIATO (8.8.12)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.estado_postquirurgico ||
                    'Paciente estable al t茅rmino del procedimiento quir煤rgico.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'PLAN DE MANEJO Y TRATAMIENTO POSTOPERATORIO INMEDIATO (8.8.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.plan_postoperatorio ||
                    'Plan de manejo postoperatorio inmediato seg煤n protocolo.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  PRONSTICO Y BIOPSIAS (NOM-004 8.8.14-8.8.15)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PRONSTICO Y BIOPSIAS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'PRONSTICO (8.8.14)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.pronostico ||
                    'Favorable para la vida y funci贸n.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
              [
                {},
                {
                  text: 'ENVO DE PIEZAS O BIOPSIAS QUIRRGICAS (8.8.15)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    postoperatoriaData.envio_biopsias ||
                    'No se enviaron piezas quir煤rgicas para estudio histopatol贸gico.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  OTROS HALLAZGOS (NOM-004 8.8.16)
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'OTROS HALLAZGOS DE IMPORTANCIA (8.8.16)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                  alignment: 'center',
                },
              ],
              [
                {
                  text:
                    postoperatoriaData.otros_hallazgos ||
                    'Sin otros hallazgos de importancia para reportar.',
                  fontSize: 8,
                  margin: [5, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        //  FIRMA DEL CIRUJANO RESPONSABLE (NOM-004 8.8.17)
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'CIRUJANO RESPONSABLE (8.8.17)',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `C茅dula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: ${medicoCompleto.departamento}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de elaboraci贸n: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} - ${fechaActual.toLocaleTimeString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: '\n\n_____________________________________\nNOMBRE COMPLETO Y FIRMA DEL RESPONSABLE DE LA CIRUGA',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        //  NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Secci贸n 8.8 "Nota postoperatoria"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos establecidos en los numerales 8.8.1 al 8.8.17',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota Postoperatoria - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  NOTA PREANESTSICA SEGN NOM-004-SSA3-2012 SECCIN 8.7 Y NOM-006-SSA3-2011
  async generarNotaPreanestesica(datos: any): Promise<any> {
    console.log(' Generando Nota Preanest茅sica seg煤n NOM-004 y NOM-006...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const preanestesicaData = datos.notaPreanestesica || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA PREANESTSICA',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  IDENTIFICACIN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha cirug铆a',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora programada',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Quir贸fano',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'ASA',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            preanestesicaData.fecha_cirugia ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: preanestesicaData.hora_programada || '00:00',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: preanestesicaData.quirofano || 'Q1',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: preanestesicaData.clasificacion_asa || 'ASA II',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} a帽os`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['30%', '25%', '25%', '20%'],
                    body: [
                      [
                        {
                          text: 'Peso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Talla',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'IMC',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo sangu铆neo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${signosVitales.peso || '___'} kg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${signosVitales.talla || '___'} cm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: this.calcularIMC(
                            signosVitales.peso,
                            signosVitales.talla
                          ),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.tipo_sangre || 'No registrado',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Procedimiento quir煤rgico programado',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            preanestesicaData.procedimiento_programado ||
                            'Procedimiento quir煤rgico por especificar',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  EVALUACIN CLNICA DEL PACIENTE (NOM-004 D9.12)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EVALUACIN CLNICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#dbeafe',
                  alignment: 'center',
                  rowSpan: 8,
                },
                {
                  text: 'EVALUACIN CLNICA DEL PACIENTE (D9.12)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#eff6ff',
                },
              ],
              [
                {},
                {
                  text: 'ANTECEDENTES ANESTSICOS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.antecedentes_anestesicos ||
                    'Sin antecedentes anest茅sicos previos conocidos.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'ANTECEDENTES PATOLGICOS RELEVANTES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.antecedentes_patologicos ||
                    'Sin antecedentes patol贸gicos de importancia para anestesia.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'MEDICAMENTOS ACTUALES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.medicamentos_actuales ||
                    'Sin medicamentos de importancia anest茅sica.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'ALERGIAS Y REACCIONES ADVERSAS',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.alergias ||
                    'Sin alergias conocidas a medicamentos.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  EXPLORACIN FSICA ANESTSICA
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'EXPLORACIN FSICA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  rowSpan: 6,
                },
                {
                  text: 'SIGNOS VITALES',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Presi贸n arterial',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia card铆aca',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Frecuencia respiratoria',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Saturaci贸n O2',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            signosVitales.presion_arterial_sistolica || '___'
                          }/${
                            signosVitales.presion_arterial_diastolica || '___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_cardiaca || '___'
                          } lpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.frecuencia_respiratoria || '___'
                          } rpm`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            signosVitales.saturacion_oxigeno || '___'
                          } %`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 2],
                },
              ],
              [
                {},
                {
                  text: 'VA AREA Y CUELLO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.via_aerea ||
                    'V铆a a茅rea permeable, cuello m贸vil, apertura oral adecuada, clasificaci贸n Mallampati I-II.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
              [
                {},
                {
                  text: 'SISTEMAS CARDIOVASCULAR Y RESPIRATORIO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.cardiovascular_respiratorio ||
                    'Ruidos card铆acos r铆tmicos, sin soplos. Murmullo vesicular presente bilateral.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  TIPO DE ANESTESIA (NOM-004 D9.13)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PLAN ANESTSICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0fdf4',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'TIPO DE ANESTESIA PLANEADA (D9.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text:
                            preanestesicaData.tipo_anestesia === 'general'
                              ? ' GENERAL'
                              : ' GENERAL',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.tipo_anestesia === 'regional'
                              ? ' REGIONAL'
                              : ' REGIONAL',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.tipo_anestesia === 'local'
                              ? ' LOCAL'
                              : ' LOCAL',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.tipo_anestesia === 'combinada'
                              ? ' COMBINADA'
                              : ' COMBINADA',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'TCNICA ANESTSICA ESPECFICA',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.tecnica_especifica ||
                    'T茅cnica anest茅sica por definir seg煤n evaluaci贸n y tipo de cirug铆a.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  RIESGO ANESTSICO (NOM-004 D9.14)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'RIESGO ANESTSICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fee2e2',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'CLASIFICACIN ASA Y RIESGO ANESTSICO (D9.14)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef2f2',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text:
                            preanestesicaData.clasificacion_asa === 'ASA I'
                              ? ' ASA I'
                              : ' ASA I',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.clasificacion_asa === 'ASA II'
                              ? ' ASA II'
                              : ' ASA II',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.clasificacion_asa === 'ASA III'
                              ? ' ASA III'
                              : ' ASA III',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.clasificacion_asa === 'ASA IV'
                              ? ' ASA IV'
                              : ' ASA IV',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                        {
                          text:
                            preanestesicaData.clasificacion_asa === 'ASA V'
                              ? ' ASA V'
                              : ' ASA V',
                          fontSize: 7,
                          alignment: 'center',
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'JUSTIFICACIN DEL RIESGO ANESTSICO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef2f2',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.justificacion_riesgo ||
                    'Paciente con estado f铆sico apropiado para anestesia y cirug铆a programada.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  PREMEDICACIN (NOM-004 D9.15)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PREMEDICACIN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f3e8ff',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'MEDICACIN PREANESTSICA (D9.15)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#faf5ff',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.premedicacion ||
                    'Premedicaci贸n seg煤n protocolo anest茅sico y estado del paciente.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  AYUNO Y PREPARACIN
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PREPARACIN PREOPERATORIA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'AYUNO PREOPERATORIO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text: `Ayuno de s贸lidos: ${
                    preanestesicaData.ayuno_solidos || '8 horas'
                  } | Ayuno de l铆quidos: ${
                    preanestesicaData.ayuno_liquidos || '2 horas'
                  }`,
                  fontSize: 8,
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'PREPARACIN ESPECIAL',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {},
                {
                  text:
                    preanestesicaData.preparacion_especial ||
                    'Preparaci贸n est谩ndar preoperatoria.',
                  fontSize: 8,
                  margin: [5, 3],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        //  ANESTESILOGO RESPONSABLE
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'ANESTESILOGO RESPONSABLE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `C茅dula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: Anestesiolog铆a\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de evaluaci贸n: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} - ${fechaActual.toLocaleTimeString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: '\n\n_____________________________________\nFIRMA DEL ANESTESILOGO',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        //  NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Secci贸n 8.7 "Nota preanest茅sica"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con NOM-006-SSA3-2011 para la pr谩ctica de la anestesiolog铆a',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota Preanest茅sica - SICEG\nNOM-004-SSA3-2012 | NOM-006-SSA3-2011',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  HOJA DE QUIRFANO SEGN NOM-004-SSA3-2012
  async generarHojaQuirofano(datos: any): Promise<any> {
    console.log('   Generando Hoja de Quir贸fano seg煤n NOM-004...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const quirofanoData = datos.hojaQuirofano || {};
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageOrientation: 'landscape',
      pageMargins: [15, 50, 15, 40],

      header: {
        margin: [15, 10, 15, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - HOJA DE QUIRFANO',
                fontSize: 12,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 5] },

        //  DATOS GENERALES
        {
          table: {
            widths: ['20%', '30%', '15%', '35%'],
            body: [
              [
                { text: 'Paciente:', fontSize: 9, bold: true },
                { text: pacienteCompleto.nombre_completo, fontSize: 9 },
                { text: 'Expediente:', fontSize: 9, bold: true },
                {
                  text: this.obtenerNumeroExpedientePreferido(
                    pacienteCompleto.expediente
                  ),
                  fontSize: 9,
                  bold: true,
                },
              ],
              [
                { text: 'Procedimiento:', fontSize: 9, bold: true },
                {
                  text: quirofanoData.procedimiento || 'Por especificar',
                  fontSize: 9,
                  colSpan: 3,
                },
                {},
                {},
              ],
              [
                { text: 'Cirujano:', fontSize: 9, bold: true },
                {
                  text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}`,
                  fontSize: 9,
                },
                { text: 'Quir贸fano:', fontSize: 9, bold: true },
                { text: quirofanoData.numero_quirofano || 'Q1', fontSize: 9 },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        //  TABLA DE REGISTRO HORARIO
        {
          table: {
            widths: ['15%', '15%', '15%', '15%', '15%', '25%'],
            body: [
              [
                {
                  text: 'HORA',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
                {
                  text: 'PA (mmHg)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
                {
                  text: 'FC (lpm)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
                {
                  text: 'FR (rpm)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
                {
                  text: 'TEMP (掳C)',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
                {
                  text: 'OBSERVACIONES',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f5f5f5',
                },
              ],
              // Generar 20 filas vac铆as para llenar manualmente
              ...Array.from({ length: 20 }, () => [
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
                { text: '', fontSize: 8, margin: [2, 8, 2, 8] },
              ]),
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
          margin: [0, 0, 0, 15],
        },

        //  DATOS DEL EQUIPO QUIRRGICO
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'EQUIPO QUIRRGICO',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        { text: 'Cirujano:', fontSize: 8, bold: true },
                        { text: 'Anestesi贸logo:', fontSize: 8, bold: true },
                        { text: 'Instrumentista:', fontSize: 8, bold: true },
                        { text: 'Circulante:', fontSize: 8, bold: true },
                      ],
                      [
                        { text: medicoCompleto.nombre_completo, fontSize: 8 },
                        {
                          text: quirofanoData.anestesiologo || '____________',
                          fontSize: 8,
                        },
                        {
                          text: quirofanoData.instrumentista || '____________',
                          fontSize: 8,
                        },
                        {
                          text: quirofanoData.circulante || '____________',
                          fontSize: 8,
                        },
                      ],
                    ],
                  },
                  layout: 'noBorders',
                  margin: [5, 5, 5, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 1,
            vLineWidth: () => 1,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [15, 10],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 8,
                  color: '#666666',
                },
                {
                  text: 'Hoja de Quir贸fano - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 8,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: fechaActual.toLocaleDateString('es-MX'),
                  fontSize: 8,
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }
  //  NOTA POSTANESTSICA SEGN NOM-004-SSA3-2012 SECCIN D11
  async generarNotaPostanestesica(datos: any): Promise<any> {
    console.log('   Generando Nota Postanest茅sica seg煤n NOM-004-SSA3-2012...');

    const medicoCompleto = datos.medicoCompleto;
    const pacienteCompleto = datos.pacienteCompleto;
    const postanestesicaData = datos.notaPostanestesica || {};
    const signosVitales = datos.signosVitales;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [20, 70, 20, 50],

      header: {
        margin: [20, 10, 20, 10],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ - NOTA POSTANESTSICA',
                fontSize: 11,
                bold: true,
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        //  IDENTIFICACIN DEL PACIENTE
        {
          table: {
            widths: ['15%', '85%'],
            body: [
              [
                {
                  text: 'IDENTIFICACIN',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Fecha cirug铆a',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hora t茅rmino',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'No. Expediente',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Quir贸fano',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Folio nota',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            postanestesicaData.fecha_cirugia ||
                            fechaActual.toLocaleDateString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text:
                            postanestesicaData.hora_termino ||
                            fechaActual.toLocaleTimeString('es-MX'),
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text:
                            this.obtenerNumeroExpedientePreferido(
                              pacienteCompleto.expediente
                            ) || 'N/A',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                          bold: true,
                        },
                        {
                          text: postanestesicaData.quirofano || 'Q1',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `NPA-${this.obtenerNumeroExpedientePreferido(
                            pacienteCompleto.expediente
                          )}-${fechaActual.getFullYear()}`,
                          fontSize: 6,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['50%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Nombre completo del paciente',
                          fontSize: 7,
                          bold: true,
                        },
                        {
                          text: 'Edad',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Sexo',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: pacienteCompleto.nombre_completo,
                          fontSize: 8,
                          bold: true,
                          margin: [2, 2],
                        },
                        {
                          text: `${pacienteCompleto.edad} a帽os`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: pacienteCompleto.sexo,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['40%', '30%', '30%'],
                    body: [
                      [
                        {
                          text: 'Servicio',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Peso',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'ASA',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: medicoCompleto.departamento || 'Anestesiolog铆a',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text: `${signosVitales.peso || '___'} kg`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                        },
                        {
                          text:
                            postanestesicaData.clasificacion_asa || 'ASA II',
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                          color: '#dc2626',
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['100%'],
                    body: [
                      [
                        {
                          text: 'Procedimiento quir煤rgico realizado',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text:
                            postanestesicaData.procedimiento_realizado ||
                            'Procedimiento quir煤rgico por especificar',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  MEDICAMENTOS UTILIZADOS (NOM-004 D11.12)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'MEDICAMENTOS UTILIZADOS',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#dbeafe',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'MEDICAMENTOS UTILIZADOS DURANTE LA ANESTESIA (D11.12)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#eff6ff',
                },
              ],
              [
                {},
                {
                  text:
                    postanestesicaData.medicamentos_utilizados ||
                    'Medicamentos anest茅sicos y coadyuvantes utilizados durante el procedimiento:\n' +
                      ' Agentes anest茅sicos principales\n' +
                      ' Medicamentos de inducci贸n\n' +
                      ' Relajantes musculares\n' +
                      ' Analg茅sicos\n' +
                      ' Otros medicamentos seg煤n protocolo',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  DURACIN DE LA ANESTESIA (NOM-004 D11.13)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'DURACIN ANESTESIA',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fef3c7',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'DURACIN DE LA ANESTESIA (D11.13)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fffbeb',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['25%', '25%', '25%', '25%'],
                    body: [
                      [
                        {
                          text: 'Inicio anestesia',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'T茅rmino anestesia',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Duraci贸n total',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Tipo anestesia',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: postanestesicaData.hora_inicio || '__:__',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                        },
                        {
                          text: postanestesicaData.hora_termino || '__:__',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                        },
                        {
                          text: `${
                            postanestesicaData.duracion_anestesia || '___'
                          } minutos`,
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                          bold: true,
                        },
                        {
                          text: postanestesicaData.tipo_anestesia || 'General',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 3],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  INCIDENTES Y ACCIDENTES (NOM-004 D11.14)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'INCIDENTES Y ACCIDENTES',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fee2e2',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'INCIDENTES Y ACCIDENTES ATRIBUIBLES A LA ANESTESIA (D11.14)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef2f2',
                },
              ],
              [
                {},
                {
                  text:
                    postanestesicaData.incidentes_accidentes ||
                    'Sin incidentes ni accidentes atribuibles a la anestesia durante el procedimiento.',
                  fontSize: 8,
                  margin: [5, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  CANTIDAD DE SANGRE Y SOLUCIONES (NOM-004 D11.15)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'BALANCE HDRICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f0fdf4',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'CANTIDAD DE SANGRE O SOLUCIONES APLICADAS (D11.15)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['33%', '33%', '34%'],
                    body: [
                      [
                        {
                          text: 'L铆quidos administrados',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'P茅rdidas sangu铆neas',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Hemoderivados',
                          fontSize: 7,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            postanestesicaData.liquidos_administrados || '___'
                          } ml`,
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                          bold: true,
                        },
                        {
                          text: `${postanestesicaData.sangrado || '___'} ml`,
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                          bold: true,
                        },
                        {
                          text:
                            postanestesicaData.hemoderivados_transfundidos ||
                            'Ninguno',
                          fontSize: 8,
                          alignment: 'center',
                          margin: [0, 3],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 3],
                },
              ],
              [
                {},
                {
                  text: 'BALANCE HDRICO DETALLADO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f7fee7',
                },
              ],
              [
                {},
                {
                  text:
                    postanestesicaData.balance_hidrico ||
                    'Balance h铆drico equilibrado durante el procedimiento anest茅sico.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  ESTADO CLNICO AL EGRESO (NOM-004 D11.16)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESTADO CLNICO EGRESO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#e0f2fe',
                  alignment: 'center',
                  rowSpan: 4,
                },
                {
                  text: 'ESTADO CLNICO DEL ENFERMO A SU EGRESO DE QUIRFANO (D11.16)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  text: 'SIGNOS VITALES AL EGRESO',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#f0f9ff',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'PA',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'FC',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'FR',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'SatO2',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Temp',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            postanestesicaData.presion_arterial_egreso ||
                            '___/___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            postanestesicaData.frecuencia_cardiaca_egreso ||
                            '___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            postanestesicaData.frecuencia_respiratoria_egreso ||
                            '___'
                          }`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            postanestesicaData.saturacion_oxigeno_egreso ||
                            '___'
                          }%`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                        {
                          text: `${
                            postanestesicaData.temperatura_egreso || '___'
                          }掳C`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 1],
                        },
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 2],
                },
              ],
              [
                {},
                {
                  text:
                    postanestesicaData.estado_clinico_egreso ||
                    'Paciente estable, consciente, orientado, con signos vitales dentro de par谩metros normales. Egresa de quir贸fano en condiciones satisfactorias.',
                  fontSize: 8,
                  margin: [3, 2],
                  lineHeight: 1.1,
                  bold: true,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  PLAN DE MANEJO (NOM-004 D11.17)
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'PLAN POSTANESTSICO',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f3e8ff',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'PLAN DE MANEJO Y TRATAMIENTO INMEDIATO (D11.17)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#faf5ff',
                },
              ],
              [
                {},
                {
                  text:
                    postanestesicaData.plan_tratamiento ||
                    ' Vigilancia estricta en sala de recuperaci贸n\n' +
                      ' Monitoreo continuo de signos vitales\n' +
                      ' Control del dolor postoperatorio\n' +
                      ' Manejo de n谩usea y v贸mito postoperatorio si aplica\n' +
                      ' Evaluaci贸n neurol贸gica continua\n' +
                      ' Indicaciones espec铆ficas seg煤n evoluci贸n',
                  fontSize: 8,
                  margin: [5, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 3] },

        //  ESCALA DE RECUPERACIN ANESTSICA
        {
          table: {
            widths: ['20%', '80%'],
            body: [
              [
                {
                  text: 'ESCALA ALDRETE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#fdf2f8',
                  alignment: 'center',
                  rowSpan: 2,
                },
                {
                  text: 'ESCALA DE RECUPERACIN POSTANESTSICA (ALDRETE)',
                  fontSize: 7,
                  bold: true,
                  fillColor: '#fef7ff',
                },
              ],
              [
                {},
                {
                  table: {
                    widths: ['20%', '20%', '20%', '20%', '20%'],
                    body: [
                      [
                        {
                          text: 'Actividad motora',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Respiraci贸n',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Circulaci贸n',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Conciencia',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                        {
                          text: 'Saturaci贸n O2',
                          fontSize: 6,
                          bold: true,
                          alignment: 'center',
                        },
                      ],
                      [
                        {
                          text: `${
                            postanestesicaData.aldrete_actividad || '2'
                          } / 2`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                        {
                          text: `${
                            postanestesicaData.aldrete_respiracion || '2'
                          } / 2`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                        {
                          text: `${
                            postanestesicaData.aldrete_circulacion || '2'
                          } / 2`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                        {
                          text: `${
                            postanestesicaData.aldrete_conciencia || '2'
                          } / 2`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                        {
                          text: `${
                            postanestesicaData.aldrete_saturacion || '2'
                          } / 2`,
                          fontSize: 7,
                          alignment: 'center',
                          margin: [0, 2],
                          bold: true,
                        },
                      ],
                      [
                        {
                          text: `TOTAL ALDRETE: ${this.calcularTotalAldrete(
                            postanestesicaData
                          )} / 10`,
                          fontSize: 8,
                          alignment: 'center',
                          bold: true,
                          colSpan: 5,
                          fillColor: '#f0f9ff',
                          margin: [0, 3],
                        },
                        {},
                        {},
                        {},
                        {},
                      ],
                    ],
                  },
                  layout: {
                    hLineWidth: () => 0.3,
                    vLineWidth: () => 0.3,
                    hLineColor: () => '#000000',
                    vLineColor: () => '#000000',
                  },
                  margin: [5, 3],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 5] },

        //  ANESTESILOGO RESPONSABLE
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'ANESTESILOGO RESPONSABLE',
                  fontSize: 8,
                  bold: true,
                  fillColor: '#f5f5f5',
                  alignment: 'center',
                },
              ],
              [
                {
                  text: [
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 9,
                      bold: true,
                    },
                    {
                      text: `C茅dula Profesional: ${medicoCompleto.numero_cedula}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Especialidad: ${medicoCompleto.especialidad}\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Servicio: Anestesiolog铆a\n`,
                      fontSize: 8,
                    },
                    {
                      text: `Fecha de elaboraci贸n: ${fechaActual.toLocaleDateString(
                        'es-MX'
                      )} - ${fechaActual.toLocaleTimeString('es-MX')}\n`,
                      fontSize: 8,
                    },
                    {
                      text: '\n\n_____________________________________\nFIRMA DEL ANESTESILOGO RESPONSABLE',
                      fontSize: 8,
                    },
                  ],
                  margin: [5, 15],
                  alignment: 'center',
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#000000',
            vLineColor: () => '#000000',
          },
        },

        { text: '', margin: [0, 2] },

        //  NOTA REFERENCIAL
        {
          text: [
            {
              text: '* Nota elaborada conforme a NOM-004-SSA3-2012, Secci贸n D11 "Nota postanest茅sica"\n',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
            {
              text: '* Cumple con los requisitos D11.12 al D11.17 establecidos en la norma oficial',
              fontSize: 6,
              italics: true,
              color: '#666666',
            },
          ],
          alignment: 'left',
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [20, 5],
          table: {
            widths: ['25%', '50%', '25%'],
            body: [
              [
                {
                  text: `P谩gina ${currentPage} de ${pageCount}`,
                  fontSize: 7,
                  color: '#666666',
                },
                {
                  text: 'Nota Postanest茅sica - SICEG\nNOM-004-SSA3-2012',
                  fontSize: 7,
                  alignment: 'center',
                  color: '#666666',
                },
                {
                  text: [
                    {
                      text: `${fechaActual.toLocaleDateString('es-MX')}\n`,
                      fontSize: 7,
                    },
                    {
                      text: `Exp: ${this.obtenerNumeroExpedientePreferido(
                        pacienteCompleto.expediente
                      )}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'right',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }

  async generarConsentimientoProcedimientos(datos: any): Promise<any> {
    console.log(
      ' PdfTemplatesService: Creando definici贸n Consentimiento Procedimientos...'
    );

    const pacienteCompleto = datos.pacienteCompleto;
    const medicoCompleto = datos.medicoCompleto;
    const fechaActual = new Date();

    return {
      pageSize: 'LETTER',
      pageMargins: [30, 60, 30, 50],

      header: {
        margin: [30, 20, 30, 20],
        table: {
          widths: ['100%'],
          body: [
            [
              {
                text: [
                  {
                    text: 'HOSPITAL GENERAL SAN LUIS DE LA PAZ\n',
                    fontSize: 12,
                    bold: true,
                    color: '#1a365d',
                  },
                  {
                    text: 'CONSENTIMIENTO INFORMADO PARA PROCEDIMIENTOS MDICOS\n',
                    fontSize: 10,
                    bold: true,
                  },
                  {
                    text: 'Conforme a la NOM-004-SSA3-2012 del Expediente Cl铆nico',
                    fontSize: 8,
                    color: '#666666',
                  },
                ],
                alignment: 'center',
              },
            ],
          ],
        },
        layout: 'noBorders',
      },

      content: [
        { text: '', margin: [0, 10] },

        // Datos del paciente
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DATOS DEL PACIENTE',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#f0f0f0',
                  alignment: 'center',
                  margin: [0, 3],
                },
              ],
              [
                {
                  columns: [
                    {
                      width: '50%',
                      text: [
                        { text: 'Nombre completo:\n', fontSize: 8, bold: true },
                        {
                          text: `${pacienteCompleto.nombre_completo}\n\n`,
                          fontSize: 9,
                        },
                        { text: 'Edad: ', fontSize: 8, bold: true },
                        { text: `${pacienteCompleto.edad} a帽os`, fontSize: 9 },
                      ],
                    },
                    {
                      width: '50%',
                      text: [
                        { text: 'Expediente:\n', fontSize: 8, bold: true },
                        {
                          text: `${pacienteCompleto.numero_expediente}\n\n`,
                          fontSize: 9,
                        },
                        { text: 'Sexo: ', fontSize: 8, bold: true },
                        { text: pacienteCompleto.sexo, fontSize: 9 },
                      ],
                    },
                  ],
                  margin: [10, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#cccccc',
            vLineColor: () => '#cccccc',
          },
        },

        { text: '', margin: [0, 15] },

        // Procedimiento
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'PROCEDIMIENTO AUTORIZADO',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#e6f3ff',
                  alignment: 'center',
                  margin: [0, 3],
                },
              ],
              [
                {
                  text: [
                    { text: 'Procedimiento: ', bold: true, fontSize: 9 },
                    {
                      text:
                        datos.consentimiento?.nombre_procedimiento ||
                        '[PROCEDIMIENTO A REALIZAR]',
                      fontSize: 9,
                    },
                    {
                      text: '\n\nDescripci贸n del procedimiento:\n',
                      bold: true,
                      fontSize: 9,
                    },
                    {
                      text:
                        datos.consentimiento?.descripcion_procedimiento ||
                        'El m茅dico explicar谩 en detalle el procedimiento a realizar, sus objetivos y metodolog铆a.',
                      fontSize: 8,
                    },
                  ],
                  margin: [10, 8],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#cccccc',
            vLineColor: () => '#cccccc',
          },
        },

        { text: '', margin: [0, 15] },

        // Beneficios y riesgos
        {
          table: {
            widths: ['50%', '50%'],
            body: [
              [
                {
                  text: 'BENEFICIOS ESPERADOS',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#e8f5e8',
                  alignment: 'center',
                  margin: [0, 3],
                },
                {
                  text: 'RIESGOS Y COMPLICACIONES',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#ffe8e8',
                  alignment: 'center',
                  margin: [0, 3],
                },
              ],
              [
                {
                  text:
                    datos.consentimiento?.beneficios_procedimiento ||
                    ' Mejor铆a de la condici贸n m茅dica\n Alivio de s铆ntomas\n Mejor calidad de vida\n Prevenci贸n de complicaciones',
                  fontSize: 8,
                  margin: [8, 8],
                  lineHeight: 1.1,
                },
                {
                  text:
                    datos.consentimiento?.riesgos_especificos ||
                    ' Sangrado\n Infecci贸n\n Reacciones al茅rgicas\n Dolor temporal\n Complicaciones espec铆ficas del procedimiento',
                  fontSize: 8,
                  margin: [8, 8],
                  lineHeight: 1.1,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#cccccc',
            vLineColor: () => '#cccccc',
          },
        },

        { text: '', margin: [0, 15] },

        // Declaraci贸n del paciente
        {
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'DECLARACIN DEL PACIENTE O RESPONSABLE LEGAL',
                  fontSize: 9,
                  bold: true,
                  fillColor: '#fff5e6',
                  alignment: 'center',
                  margin: [0, 3],
                },
              ],
              [
                {
                  text: [
                    { text: 'YO, ', fontSize: 9, bold: true },
                    {
                      text: `${pacienteCompleto.nombre_completo}`,
                      fontSize: 9,
                      bold: true,
                      decoration: 'underline',
                    },
                    {
                      text: ', por mi propio derecho / en mi calidad de representante legal del paciente antes mencionado, DECLARO que:\n\n',
                      fontSize: 9,
                    },

                    { text: '1. ', fontSize: 9, bold: true },
                    {
                      text: 'He sido informado(a) de manera clara y comprensible sobre el procedimiento m茅dico propuesto, sus beneficios, riesgos y alternativas.\n\n',
                      fontSize: 8,
                    },

                    { text: '2. ', fontSize: 9, bold: true },
                    {
                      text: 'He tenido la oportunidad de hacer preguntas, las cuales han sido respondidas satisfactoriamente por el m茅dico tratante.\n\n',
                      fontSize: 8,
                    },

                    { text: '3. ', fontSize: 9, bold: true },
                    {
                      text: 'Entiendo que ning煤n procedimiento m茅dico garantiza resultados al 100% y que pueden presentarse complicaciones imprevistas.\n\n',
                      fontSize: 8,
                    },

                    { text: '4. ', fontSize: 9, bold: true },
                    { text: 'AUTORIZO al Dr. ', fontSize: 8 },
                    {
                      text: `${medicoCompleto.nombre_completo}`,
                      fontSize: 8,
                      bold: true,
                    },
                    {
                      text: ' y su equipo m茅dico a realizar el procedimiento descrito.\n\n',
                      fontSize: 8,
                    },

                    { text: '5. ', fontSize: 9, bold: true },
                    {
                      text: 'Este consentimiento es otorgado de manera libre, voluntaria e informada.',
                      fontSize: 8,
                    },
                  ],
                  margin: [10, 8],
                  lineHeight: 1.4,
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#cccccc',
            vLineColor: () => '#cccccc',
          },
        },

        { text: '', margin: [0, 20] },

        // Firmas
        {
          table: {
            widths: ['33%', '33%', '34%'],
            body: [
              [
                {
                  text: 'PACIENTE O RESPONSABLE',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f9f9f9',
                },
                {
                  text: 'MDICO TRATANTE',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f9f9f9',
                },
                {
                  text: 'TESTIGO',
                  fontSize: 8,
                  bold: true,
                  alignment: 'center',
                  fillColor: '#f9f9f9',
                },
              ],
              [
                {
                  text: '\n\n\n_____________________\nFirma\n\nNombre:\n_____________________',
                  fontSize: 7,
                  alignment: 'center',
                  margin: [5, 15],
                },
                {
                  text: [
                    { text: '\n\n\n_____________________\n', fontSize: 7 },
                    {
                      text: `${medicoCompleto.titulo_profesional} ${medicoCompleto.nombre_completo}\n`,
                      fontSize: 7,
                      bold: true,
                    },
                    {
                      text: `C茅dula: ${medicoCompleto.numero_cedula}`,
                      fontSize: 6,
                    },
                  ],
                  alignment: 'center',
                  margin: [5, 15],
                },
                {
                  text: '\n\n\n_____________________\nFirma\n\nNombre:\n_____________________',
                  fontSize: 7,
                  alignment: 'center',
                  margin: [5, 15],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
            hLineColor: () => '#cccccc',
            vLineColor: () => '#cccccc',
          },
        },

        { text: '', margin: [0, 15] },

        // Fecha y lugar
        {
          columns: [
            {
              width: '50%',
              text: [
                { text: 'Lugar: ', fontSize: 8, bold: true },
                { text: 'San Luis de la Paz, Guanajuato', fontSize: 8 },
              ],
            },
            {
              width: '50%',
              text: [
                { text: 'Fecha: ', fontSize: 8, bold: true },
                { text: fechaActual.toLocaleDateString('es-MX'), fontSize: 8 },
              ],
              alignment: 'right',
            },
          ],
        },
      ],

      footer: (currentPage: number, pageCount: number) => {
        return {
          margin: [30, 10],
          table: {
            widths: ['100%'],
            body: [
              [
                {
                  text: 'Consentimiento Informado - Hospital General San Luis de la Paz - NOM-004-SSA3-2012',
                  fontSize: 6,
                  alignment: 'center',
                  color: '#666666',
                },
              ],
            ],
          },
          layout: 'noBorders',
        };
      },
    };
  }








































































































































<!-- FORMULARIO DE NOTA DE URGENCIAS -->
      <div *ngIf="formularioActivo === 'notaUrgencias'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-ambulance mr-2 text-red-500"></i>
            Nota de Urgencias
          </h3>
          <p class="text-sm text-gray-600 mt-1">Documentar la atenci贸n de urgencias</p>
        </div>

        <form [formGroup]="notaUrgenciasForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Motivo de Atenci贸n *</label>
                <textarea formControlName="motivo_atencion" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Motivo principal de la consulta de urgencia..."></textarea>
                <div *ngIf="notaUrgenciasForm.get('motivo_atencion')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Estado de Conciencia *</label>
                <select formControlName="estado_conciencia"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione...</option>

                  <option value="Consciente y orientado">Consciente y orientado</option>
                  <option value="Consciente desorientado">Consciente desorientado</option>
                  <option value="Somnoliento">Somnoliento</option>
                  <option value="Estuporoso">Estuporoso</option>
                  <option value="Coma superficial">Coma superficial</option>
                  <option value="Coma profundo">Coma profundo</option>
                </select>
                <div *ngIf="notaUrgenciasForm.get('estado_conciencia')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Resumen del Interrogatorio *</label>
              <textarea formControlName="resumen_interrogatorio" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Resumen del interrogatorio dirigido..."></textarea>
              <div *ngIf="notaUrgenciasForm.get('resumen_interrogatorio')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Exploraci贸n F铆sica *</label>
              <textarea formControlName="exploracion_fisica" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Hallazgos de la exploraci贸n f铆sica..."></textarea>
              <div *ngIf="notaUrgenciasForm.get('exploracion_fisica')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Resultados de Estudios</label>
                <textarea formControlName="resultados_estudios" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Laboratorios, radiograf铆as, ECG..."></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Estado Mental</label>
                <textarea formControlName="estado_mental" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Evaluaci贸n del estado mental..."></textarea>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Diagn贸stico *</label>
              <textarea formControlName="diagnostico" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Diagn贸stico de urgencias..."></textarea>
              <div *ngIf="notaUrgenciasForm.get('diagnostico')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Gu铆a Cl铆nica de Diagn贸stico
                <span class="text-blue-500 ml-1 cursor-help"
                  title="Seleccione una gu铆a cl铆nica oficial para el diagn贸stico">
                  <i class="fas fa-question-circle"></i>
                </span>
              </label>

              <div class="relative">
                <div class="flex">
                  <input type="text" [ngModel]="filtroGuiaClinica" (ngModelChange)="onGuiaClinicaInputChange($event)"
                    [ngModelOptions]="{standalone: true}" (input)="onGuiaClinicaInputChange($any($event.target).value)"
                    (focus)="toggleDropdownGuias()" (click)="toggleDropdownGuias()"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Buscar gu铆a cl铆nica por nombre, c贸digo o 谩rea..."
                    [readonly]="!!guiaClinicaSeleccionada">

                  <button type="button" (click)="toggleDropdownGuias()"
                    class="px-3 py-2 bg-blue-500 text-white border border-blue-500 rounded-r-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search"></i>
                  </button>
                </div>

                <div *ngIf="guiaClinicaSeleccionada" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-medium text-blue-900">{{ guiaClinicaSeleccionada.nombre }}</div>
                      <div class="text-sm text-blue-700">
                        <span *ngIf="guiaClinicaSeleccionada.codigo">C贸digo: {{ guiaClinicaSeleccionada.codigo }}</span>
                        <span *ngIf="guiaClinicaSeleccionada.area" class="ml-3">rea: {{ guiaClinicaSeleccionada.area
                          }}</span>
                        <span *ngIf="guiaClinicaSeleccionada.fuente" class="ml-3">Fuente: {{
                          guiaClinicaSeleccionada.fuente }}</span>
                      </div>
                    </div>
                    <button type="button" (click)="limpiarGuiaClinica()" class="text-red-500 hover:text-red-700 ml-4">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>

                <div *ngIf="mostrarDropdownGuias && guiasClinicasFiltradas"
                  class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-64 overflow-y-auto">

                  <div *ngIf="guiasClinicasFiltradas.length === 0" class="p-4 text-gray-500 text-center">
                    No se encontraron gu铆as cl铆nicas
                  </div>

                  <div *ngFor="let guia of guiasClinicasFiltradas; trackBy: trackByGuiaId"
                    (click)="seleccionarGuiaClinica(guia)"
                    class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100">
                    <div class="font-medium text-gray-900">{{ guia.nombre }}</div>
                    <div class="text-sm text-gray-600">
                      <span *ngIf="guia.codigo">{{ guia.codigo }}</span>
                      <span *ngIf="guia.area" class="ml-2"> {{ guia.area }}</span>
                      <span *ngIf="guia.fuente" class="ml-2"> {{ guia.fuente }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Plan de Tratamiento *</label>
              <textarea formControlName="plan_tratamiento" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Tratamiento inmediato y plan de manejo..."></textarea>
              <div *ngIf="notaUrgenciasForm.get('plan_tratamiento')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Pron贸stico *</label>
              <select formControlName="pronostico"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione...</option>
                <option value="Bueno para la vida">Bueno para la vida</option>
                <option value="Bueno para la funci贸n">Bueno para la funci贸n</option>
                <option value="Reservado">Reservado</option>
                <option value="Grave">Grave</option>
                <option value="Malo">Malo</option>
              </select>
              <div *ngIf="notaUrgenciasForm.get('pronostico')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!notaUrgenciasForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Nota de Urgencias' }}
            </button>

            <button type="button" (click)="generarPDF('Nota de Urgencias')" [disabled]="!formularioEstado.notaUrgencias"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.notaUrgencias"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.notaUrgencias">Guardar primero</span>
            </button>
          </div>


        </form>
      </div>

      <!-- FORMULARIO DE NOTA DE EVOLUCIN -->
      <div *ngIf="formularioActivo === 'notaEvolucion'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-chart-line mr-2 text-green-500"></i>
            Nota de Evoluci贸n
          </h3>
          <p class="text-sm text-gray-600 mt-1">Evoluci贸n diaria del paciente</p>
        </div>

        <form [formGroup]="notaEvolucionForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <!-- S铆ntomas y Signos -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                S铆ntomas y Signos *
              </label>
              <textarea formControlName="sintomas_signos" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Describir s铆ntomas y signos del paciente..."></textarea>
              <div *ngIf="notaEvolucionForm.get('sintomas_signos')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Habitus Exterior -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Habitus Exterior *
              </label>
              <textarea formControlName="habitus_exterior" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Descripci贸n del aspecto general del paciente..."></textarea>
              <div *ngIf="notaEvolucionForm.get('habitus_exterior')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Estado Nutricional -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Estado Nutricional *
              </label>
              <textarea formControlName="estado_nutricional" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Evaluaci贸n del estado nutricional..."></textarea>
              <div *ngIf="notaEvolucionForm.get('estado_nutricional')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Estudios de Laboratorio -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Estudios de Laboratorio y Gabinete *
              </label>
              <textarea formControlName="estudios_laboratorio_gabinete" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Resultados de laboratorio y estudios de gabinete..."></textarea>
              <div *ngIf="notaEvolucionForm.get('estudios_laboratorio_gabinete')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Evoluci贸n y An谩lisis -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Evoluci贸n y An谩lisis *
              </label>
              <textarea formControlName="evolucion_analisis" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="An谩lisis de la evoluci贸n cl铆nica del paciente..."></textarea>
              <div *ngIf="notaEvolucionForm.get('evolucion_analisis')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Diagn贸sticos -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Diagn贸sticos *
              </label>
              <textarea formControlName="diagnosticos" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Diagn贸sticos actuales del paciente..."></textarea>
              <div *ngIf="notaEvolucionForm.get('diagnosticos')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!--  COMPONENTE DE SELECTOR DE GUAS CLNICAS CORREGIDO -->
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Gu铆a Cl铆nica de Diagn贸stico
                <span class="text-blue-500 ml-1 cursor-help"
                  title="Seleccione una gu铆a cl铆nica oficial para el diagn贸stico">
                  <i class="fas fa-question-circle"></i>
                </span>
              </label>

              <div class="relative">
                <div class="flex">
                  <input type="text" [ngModel]="filtroGuiaClinica" (ngModelChange)="onGuiaClinicaInputChange($event)"
                    [ngModelOptions]="{standalone: true}" (input)="onGuiaClinicaInputChange($any($event.target).value)"
                    (focus)="toggleDropdownGuias()" (click)="toggleDropdownGuias()"
                    class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Buscar gu铆a cl铆nica por nombre, c贸digo o 谩rea..."
                    [readonly]="!!guiaClinicaSeleccionada">

                  <button type="button" (click)="toggleDropdownGuias()"
                    class="px-3 py-2 bg-blue-500 text-white border border-blue-500 rounded-r-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search"></i>
                  </button>
                </div>

                <!-- Informaci贸n de la gu铆a seleccionada -->
                <div *ngIf="guiaClinicaSeleccionada" class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                  <div class="flex items-center justify-between">
                    <div>
                      <div class="font-medium text-blue-900">{{ guiaClinicaSeleccionada.nombre }}</div>
                      <div class="text-sm text-blue-700">
                        <span *ngIf="guiaClinicaSeleccionada.codigo">C贸digo: {{ guiaClinicaSeleccionada.codigo }}</span>
                        <span *ngIf="guiaClinicaSeleccionada.area" class="ml-3">rea: {{ guiaClinicaSeleccionada.area
                          }}</span>
                        <span *ngIf="guiaClinicaSeleccionada.fuente" class="ml-3">Fuente: {{
                          guiaClinicaSeleccionada.fuente }}</span>
                      </div>
                    </div>
                    <button type="button" (click)="limpiarGuiaClinica()" class="text-red-500 hover:text-red-700 ml-4">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>

                <!-- Dropdown de gu铆as cl铆nicas -->
                <div *ngIf="mostrarDropdownGuias && guiasClinicasFiltradas"
                  class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-64 overflow-y-auto">

                  <div *ngIf="guiasClinicasFiltradas.length === 0" class="p-4 text-gray-500 text-center">
                    No se encontraron gu铆as cl铆nicas
                  </div>

                  <div *ngFor="let guia of guiasClinicasFiltradas; trackBy: trackByGuiaId"
                    (click)="seleccionarGuiaClinica(guia)"
                    class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100">
                    <div class="font-medium text-gray-900">{{ guia.nombre }}</div>
                    <div class="text-sm text-gray-600">
                      <span *ngIf="guia.codigo">{{ guia.codigo }}</span>
                      <span *ngIf="guia.area" class="ml-2"> {{ guia.area }}</span>
                      <span *ngIf="guia.fuente" class="ml-2"> {{ guia.fuente }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Plan de Estudios y Tratamiento -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Plan de Estudios y Tratamiento *
              </label>
              <textarea formControlName="plan_estudios_tratamiento" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Plan de manejo, medicamentos, estudios adicionales..."></textarea>
              <div *ngIf="notaEvolucionForm.get('plan_estudios_tratamiento')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Pron贸stico -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Pron贸stico *
              </label>
              <textarea formControlName="pronostico" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Pron贸stico del paciente..."></textarea>
              <div *ngIf="notaEvolucionForm.get('pronostico')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!notaEvolucionForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Nota de Evoluci贸n' }}
            </button>

            <button type="button" (click)="generarPDF('Nota de Evoluci贸n')" [disabled]="!formularioEstado.notaEvolucion"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.notaEvolucion"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.notaEvolucion">Guardar primero</span>
            </button>
          </div>


        </form>
      </div>


      <!-- ==========================================
       FORMULARIO DE NOTA DE INTERCONSULTA (NOM-004)
       Secci贸n 6.3 - Nota de Interconsulta
       ========================================== -->
      <div *ngIf="formularioActivo === 'notaInterconsulta'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-user-md mr-2 text-purple-500"></i>
            Nota de Interconsulta - NOM-004
          </h3>
          <p class="text-gray-600 text-sm mt-1">
            Solicitud y respuesta de interconsulta m茅dica especializada
          </p>
        </div>

        <form [formGroup]="notaInterconsultaForm" class="p-6 space-y-6">
          <!-- Secci贸n: Informaci贸n de la Solicitud -->
          <div class="bg-purple-50 rounded-lg p-4 space-y-4">
            <h4 class="font-semibold text-purple-800 flex items-center">
              <i class="fas fa-clipboard-list mr-2"></i>
              Informaci贸n de la Solicitud
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- rea de Interconsulta -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  rea de Interconsulta <span class="text-red-500">*</span>
                </label>
                <select formControlName="area_interconsulta"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <option value="">Seleccionar 谩rea</option>
                  <option value="1">Cardiolog铆a</option>
                  <option value="2">Ginecolog铆a</option>
                  <option value="3">Pediatr铆a</option>
                  <option value="4">Neurolog铆a</option>
                  <option value="5">Traumatolog铆a</option>
                  <option value="6">Oftalmolog铆a</option>
                  <option value="7">Otorrinolaringolog铆a</option>
                  <option value="8">Dermatolog铆a</option>
                  <option value="9">Psicolog铆a</option>
                  <option value="10">Nutrici贸n</option>
                  <option value="11">Trabajo Social</option>
                  <option value="12">Medicina Interna</option>
                </select>
              </div>

              <!-- Prioridad -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Prioridad
                </label>
                <select formControlName="prioridad"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <option value="baja">Baja (72 horas)</option>
                  <option value="media">Media (24 horas)</option>
                  <option value="alta">Alta (8 horas)</option>
                  <option value="urgente">Urgente (2 horas)</option>
                </select>
              </div>
            </div>

            <!-- Motivo de Interconsulta -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Motivo de la Interconsulta <span class="text-red-500">*</span>
              </label>
              <textarea formControlName="motivo_interconsulta" rows="3"
                placeholder="Describir claramente el motivo por el cual se solicita la interconsulta..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </textarea>
            </div>

            <!-- Diagn贸stico Presuntivo -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Diagn贸stico Presuntivo
              </label>
              <textarea formControlName="diagnostico_presuntivo" rows="2"
                placeholder="Diagn贸stico presuntivo del m茅dico solicitante..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </textarea>
            </div>

            <!-- Estudios Solicitados -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex items-center space-x-2">
                <input type="checkbox" formControlName="examenes_laboratorio" id="examenes_laboratorio"
                  class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <label for="examenes_laboratorio" class="text-sm text-gray-700">
                  Se requieren ex谩menes de laboratorio
                </label>
              </div>

              <div class="flex items-center space-x-2">
                <input type="checkbox" formControlName="examenes_gabinete" id="examenes_gabinete"
                  class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                <label for="examenes_gabinete" class="text-sm text-gray-700">
                  Se requieren estudios de gabinete
                </label>
              </div>
            </div>
          </div>

          <!-- Secci贸n: Respuesta de Interconsulta -->
          <div class="bg-blue-50 rounded-lg p-4 space-y-4">
            <h4 class="font-semibold text-blue-800 flex items-center">
              <i class="fas fa-stethoscope mr-2"></i>
              Respuesta de la Interconsulta
              <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full ml-2">
                Completar por el m茅dico interconsultante
              </span>
            </h4>

            <!-- Hallazgos -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Hallazgos Relevantes
              </label>
              <textarea formControlName="hallazgos" rows="4"
                placeholder="Hallazgos encontrados durante la interconsulta..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </textarea>
            </div>

            <!-- Impresi贸n Diagn贸stica -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Impresi贸n Diagn贸stica
              </label>
              <textarea formControlName="impresion_diagnostica" rows="3"
                placeholder="Impresi贸n diagn贸stica del m茅dico interconsultante..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </textarea>
            </div>

            <!-- Recomendaciones -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Recomendaciones y Plan de Tratamiento
              </label>
              <textarea formControlName="recomendaciones" rows="4"
                placeholder="Recomendaciones terap茅uticas y plan de seguimiento..."
                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </textarea>
            </div>

            <!-- Seguimiento Requerido -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Seguimiento Requerido
                </label>
                <select formControlName="seguimiento_requerido"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">No especificado</option>
                  <option value="no_requerido">No se requiere seguimiento</option>
                  <option value="seguimiento_ambulatorio">Seguimiento ambulatorio</option>
                  <option value="nueva_cita">Nueva cita programada</option>
                  <option value="seguimiento_urgente">Seguimiento urgente</option>
                  <option value="referencia_tercer_nivel">Referencia a tercer nivel</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Tiempo de Seguimiento
                </label>
                <input type="text" formControlName="tiempo_seguimiento" placeholder="ej: 1 semana, 15 d铆as, 1 mes"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
          </div>

          <!-- Secci贸n: Informaci贸n del M茅dico -->
          <div class="bg-gray-50 rounded-lg p-4 space-y-4">
            <h4 class="font-semibold text-gray-800 flex items-center">
              <i class="fas fa-user-doctor mr-2"></i>
              Informaci贸n del Personal M茅dico
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- M茅dico Solicitante -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  M茅dico Solicitante
                </label>
                <input type="text" formControlName="medico_solicitante" readonly
                  [value]="medicoCompleto?.['nombre_completo'] || 'No especificado'"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100">
              </div>

              <!-- C茅dula Solicitante -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  C茅dula Profesional Solicitante
                </label>
                <input type="text" formControlName="cedula_solicitante" readonly
                  [value]="medicoCompleto?.cedula_profesional || 'No especificada'"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100">
              </div>

              <!-- M茅dico Interconsultante -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  M茅dico Interconsultante
                </label>
                <select formControlName="id_medico_interconsulta"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-500">
                  <option value="">Seleccionar m茅dico interconsultante</option>
                  <!-- Las opciones se cargar谩n din谩micamente -->
                </select>
              </div>

              <!-- Especialidad -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Especialidad del Interconsultante
                </label>
                <input type="text" formControlName="especialidad_interconsulta" placeholder="Especialidad m茅dica"
                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-500">
              </div>
            </div>
          </div>

          <!-- Botones de Acci贸n -->
          <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-gray-200">
            <button type="button" (click)="guardarNotaInterconsulta()"
              [disabled]="!notaInterconsultaForm.valid || guardandoFormulario"
              class="flex-1 px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:bg-gray-300 transition-colors flex items-center justify-center">
              <i class="fas fa-save mr-2"></i>
              <span *ngIf="!guardandoFormulario">Guardar Interconsulta</span>
              <span *ngIf="guardandoFormulario">Guardando...</span>
            </button>

            <button type="button" (click)="generarPDFInterconsulta()" [disabled]="!formularioEstado.notaInterconsulta"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors flex items-center justify-center">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.notaInterconsulta"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.notaInterconsulta">Guardar primero</span>
            </button>

            <button type="button" (click)="limpiarFormulario('notaInterconsulta')"
              class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors flex items-center justify-center">
              <i class="fas fa-broom mr-2"></i>
              Limpiar
            </button>
          </div>

          <!-- Informaci贸n de Estado -->
          <div *ngIf="formularioEstado.notaInterconsulta" class="bg-green-50 border border-green-200 rounded-lg p-3">
            <div class="flex items-center">
              <i class="fas fa-check-circle text-green-500 mr-2"></i>
              <span class="text-green-800 text-sm font-medium">
                Nota de interconsulta guardada exitosamente
              </span>
            </div>
          </div>

          <!-- Validaciones -->
          <div *ngIf="notaInterconsultaForm.errors && notaInterconsultaForm.touched"
            class="bg-red-50 border border-red-200 rounded-lg p-3">
            <div class="flex items-start">
              <i class="fas fa-exclamation-triangle text-red-500 mr-2 mt-0.5"></i>
              <div class="text-red-800 text-sm">
                <p class="font-medium">Por favor corrige los siguientes errores:</p>
                <ul class="list-disc list-inside mt-1 space-y-1">
                  <li *ngIf="notaInterconsultaForm.get('motivo_interconsulta')?.hasError('required')">
                    El motivo de interconsulta es obligatorio
                  </li>
                  <li *ngIf="notaInterconsultaForm.get('area_interconsulta')?.hasError('required')">
                    Debe seleccionar un 谩rea de interconsulta
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </form>
      </div>
      <!-- sIGUE FORMULARIO DE REFERENCIA -->

      <!-- FORMULARIO DE CONSENTIMIENTO INFORMADO -->
      <div *ngIf="formularioActivo === 'consentimiento'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-file-signature mr-2 text-orange-500"></i>
            Consentimiento Informado
          </h3>
          <p class="text-sm text-gray-600 mt-1">Autorizaci贸n para procedimientos m茅dicos</p>
        </div>

        <form [formGroup]="consentimientoForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <!-- Procedimiento -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Procedimiento Autorizado *</label>
              <textarea formControlName="procedimiento" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Describa el procedimiento para el cual se solicita autorizaci贸n..."></textarea>
              <div *ngIf="consentimientoForm.get('procedimiento')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Riesgos -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Riesgos Explicados</label>
              <textarea formControlName="riesgos" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Riesgos y complicaciones posibles del procedimiento..."></textarea>
            </div>

            <!-- Alternativas -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Alternativas de Tratamiento</label>
              <textarea formControlName="alternativas" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Opciones alternativas de tratamiento disponibles..."></textarea>
            </div>

            <!-- Testigos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Testigo 1</label>
                <input type="text" formControlName="nombre_testigo1"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre completo del primer testigo">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Testigo 2</label>
                <input type="text" formControlName="nombre_testigo2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre completo del segundo testigo">
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!consentimientoForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Consentimiento' }}
            </button>

            <button type="button" (click)="generarPDF('Consentimiento Informado')"
              [disabled]="!formularioEstado.consentimiento"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.consentimiento"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.consentimiento">Guardar primero</span>
            </button>
          </div>
        </form>
      </div>


      <!-- FORMULARIO DE SOLICITUD DE ESTUDIO -->
      <div *ngIf="formularioActivo === 'solicitudEstudio'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-vial mr-2 text-gray-500"></i>
            Solicitud de Estudios
          </h3>
          <p class="text-sm text-gray-600 mt-1">Solicitar estudios de laboratorio o gabinete</p>
        </div>

        <form [formGroup]="solicitudEstudioForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <!-- Tipo de Estudio -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Estudio *</label>
              <select formControlName="tipo_estudio"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione el tipo de estudio...</option>
                <option value="LABORATORIO">Laboratorio Cl铆nico</option>
                <option value="RADIOLOGIA">Radiolog铆a</option>
                <option value="ULTRASONIDO">Ultrasonido</option>
                <option value="TOMOGRAFIA">Tomograf铆a</option>
                <option value="RESONANCIA">Resonancia Magn茅tica</option>
                <option value="ENDOSCOPIA">Endoscopia</option>
                <option value="ELECTROCARDIOGRAMA">Electrocardiograma</option>
                <option value="ELECTROENCEFALOGRAMA">Electroencefalograma</option>
                <option value="BIOPSIA">Biopsia</option>
                <option value="OTROS">Otros</option>
              </select>
              <div *ngIf="solicitudEstudioForm.get('tipo_estudio')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Estudios Solicitados -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Estudios Solicitados *</label>
              <textarea formControlName="estudios_solicitados" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Liste los estudios espec铆ficos que solicita..."></textarea>
              <div *ngIf="solicitudEstudioForm.get('estudios_solicitados')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Indicaci贸n Cl铆nica -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Indicaci贸n Cl铆nica *</label>
              <textarea formControlName="indicacion_clinica" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Motivo m茅dico para la solicitud del estudio..."></textarea>
              <div *ngIf="solicitudEstudioForm.get('indicacion_clinica')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Datos Cl铆nicos y Urgencia -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Datos Cl铆nicos Relevantes</label>
                <textarea formControlName="datos_clinicos_relevantes" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Informaci贸n adicional relevante..."></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Urgencia del Estudio *</label>
                <select formControlName="urgencia_estudio"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="rutina">Rutina</option>
                  <option value="urgente">Urgente</option>
                  <option value="stat">STAT (Inmediato)</option>
                </select>

                <div class="mt-3">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Diagn贸stico Presuntivo</label>
                  <input type="text" formControlName="diagnostico_presuntivo"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Diagn贸stico presuntivo">
                </div>
              </div>
            </div>
          </div>

          <!-- Botones -->
          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!solicitudEstudioForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Solicitud' }}
            </button>

            <button type="button" (click)="generarPDF('Solicitud de Estudio')"
              [disabled]="!formularioEstado.solicitudEstudio"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.solicitudEstudio"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.solicitudEstudio">Guardar primero</span>
            </button>
          </div>
        </form>
      </div>
      <!-- FORMULARIO DE REFERENCIA Y TRASLADO -->
      <div *ngIf="formularioActivo === 'referenciaTraslado'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-ambulance mr-2 text-amber-500"></i>
            Referencia y Traslado
          </h3>
          <p class="text-sm text-gray-600 mt-1">Referir paciente a otra unidad m茅dica</p>
        </div>

        <form [formGroup]="referenciaForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <!-- Instituciones -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Instituci贸n de Origen *</label>
                <input type="text" formControlName="institucion_origen"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Hospital o cl铆nica de origen">
                <div *ngIf="referenciaForm.get('institucion_origen')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Instituci贸n de Destino *</label>
                <input type="text" formControlName="institucion_destino"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Hospital o cl铆nica de destino">
                <div *ngIf="referenciaForm.get('institucion_destino')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>
            </div>

            <!-- M茅dico y Especialidad -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">M茅dico de Destino</label>
                <input type="text" formControlName="medico_destino"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre del m茅dico especialista">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Especialidad de Destino</label>
                <input type="text" formControlName="especialidad_destino"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Especialidad m茅dica requerida">
              </div>
            </div>

            <!-- Motivo y Tipo -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Referencia *</label>
                <select formControlName="tipo_referencia"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione el tipo...</option>
                  <option value="INTERCONSULTA">Interconsulta</option>
                  <option value="TRASLADO_DEFINITIVO">Traslado Definitivo</option>
                  <option value="SEGUNDA_OPINION">Segunda Opini贸n</option>
                  <option value="PROCEDIMIENTO_ESPECIAL">Procedimiento Especial</option>
                  <option value="NIVEL_SUPERIOR">Nivel Superior de Atenci贸n</option>
                  <option value="REHABILITACION">Rehabilitaci贸n</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Urgencia del Traslado *</label>
                <select formControlName="urgencia_traslado"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="baja">Baja</option>
                  <option value="media">Media</option>
                  <option value="alta">Alta</option>
                  <option value="critica">Cr铆tica</option>
                </select>
              </div>
            </div>

            <!-- Motivo de Referencia -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Motivo de Referencia *</label>
              <textarea formControlName="motivo_referencia" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Explique el motivo de la referencia..."></textarea>
              <div *ngIf="referenciaForm.get('motivo_referencia')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Estado del Paciente -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Estado del Paciente *</label>
              <textarea formControlName="estado_paciente" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Describe el estado cl铆nico actual del paciente..."></textarea>
              <div *ngIf="referenciaForm.get('estado_paciente')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Resumen del Caso -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Resumen del Caso *</label>
              <textarea formControlName="resumen_caso" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Resumen cl铆nico del caso, antecedentes relevantes..."></textarea>
              <div *ngIf="referenciaForm.get('resumen_caso')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <!-- Informaci贸n Adicional -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tratamiento Actual</label>
                <textarea formControlName="tratamiento_actual" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Medicamentos y tratamientos actuales..."></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Estudios Realizados</label>
                <textarea formControlName="estudios_realizados" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Estudios y resultados previos..."></textarea>
              </div>
            </div>

            <!-- Contacto -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Contacto de la Instituci贸n</label>
              <input type="text" formControlName="contacto_institucion"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Tel茅fono o correo electr贸nico de contacto">
            </div>
          </div>

          <!-- Botones -->
          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!referenciaForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Referencia' }}
            </button>

            <button type="button" (click)="generarPDF('Referencia y Traslado')"
              [disabled]="!formularioEstado.referenciaTraslado"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.referenciaTraslado"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.referenciaTraslado">Guardar primero</span>
            </button>
          </div>
        </form>
      </div>




      <!-- FORMULARIO DE PRESCRIPCIN DE MEDICAMENTOS -->
      <div *ngIf="formularioActivo === 'prescripcionMedicamento'" class="bg-white shadow rounded-lg mb-6">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-pills mr-2 text-green-500"></i>
            Prescripci贸n de Medicamentos
          </h3>
          <p class="text-sm text-gray-600 mt-1">Prescribir medicamentos al paciente</p>
        </div>

        <form [formGroup]="prescripcionForm" class="px-6 py-4">
          <div class="grid grid-cols-1 gap-6">

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Medicamento *</label>
                <input type="text" formControlName="medicamento"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre del medicamento">
                <div *ngIf="prescripcionForm.get('medicamento')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Gen茅rico</label>
                <input type="text" formControlName="nombre_generico"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Denominaci贸n gen茅rica">
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Concentraci贸n</label>
                <input type="text" formControlName="concentracion"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ej: 500mg">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Forma Farmac茅utica</label>
                <select formControlName="forma_farmaceutica"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione...</option>
                  <option value="Tableta">Tableta</option>
                  <option value="C谩psula">C谩psula</option>
                  <option value="Jarabe">Jarabe</option>
                  <option value="Suspensi贸n">Suspensi贸n</option>
                  <option value="Soluci贸n">Soluci贸n</option>
                  <option value="Ampolleta">Ampolleta</option>
                  <option value="Crema">Crema</option>
                  <option value="Ung眉ento">Ung眉ento</option>
                  <option value="Supositorio">Supositorio</option>
                  <option value="Inhalador">Inhalador</option>
                </select>
              </div>
            </div>


            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Dosis *</label>
                <input type="text" formControlName="dosis"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ej: 1 tableta, 5ml">
                <div *ngIf="prescripcionForm.get('dosis')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">V铆a de Administraci贸n *</label>
                <select formControlName="via_administracion"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione la v铆a...</option>
                  <option value="ORAL">Oral (VO)</option>
                  <option value="INTRAVENOSA">Intravenosa (IV)</option>
                  <option value="INTRAMUSCULAR">Intramuscular (IM)</option>
                  <option value="SUBCUTANEA">Subcut谩nea (SC)</option>
                  <option value="TOPICA">T贸pica</option>
                  <option value="INHALATORIA">Inhalatoria</option>
                  <option value="RECTAL">Rectal</option>
                  <option value="VAGINAL">Vaginal</option>
                  <option value="SUBLINGUAL">Sublingual</option>
                  <option value="TRANSDERMICA">Transd茅rmica</option>
                  <option value="OFTLMICA">Oft谩lmica</option>
                  <option value="OTICA">tica</option>
                  <option value="NASAL">Nasal</option>
                  <option value="OTROS">Otros</option>
                </select>
                <div *ngIf="prescripcionForm.get('via_administracion')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>
            </div>


            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia *</label>
                <select formControlName="frecuencia"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione la frecuencia...</option>
                  <option value="Cada 4 horas">Cada 4 horas (6 veces/d铆a)</option>
                  <option value="Cada 6 horas">Cada 6 horas (4 veces/d铆a)</option>
                  <option value="Cada 8 horas">Cada 8 horas (3 veces/d铆a)</option>
                  <option value="Cada 12 horas">Cada 12 horas (2 veces/d铆a)</option>
                  <option value="Cada 24 horas">Cada 24 horas (1 vez/d铆a)</option>
                  <option value="Cada 48 horas">Cada 48 horas</option>
                  <option value="Cada 72 horas">Cada 72 horas</option>
                  <option value="PRN">Seg煤n necesidad (PRN)</option>
                  <option value="Antes de comidas">Antes de comidas</option>
                  <option value="Con alimentos">Con alimentos</option>
                  <option value="En ayunas">En ayunas</option>
                  <option value="Al acostarse">Al acostarse</option>
                  <option value="Personalizada">Personalizada</option>
                </select>
                <div *ngIf="prescripcionForm.get('frecuencia')?.errors?.['required']" class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Duraci贸n del Tratamiento *</label>
                <input type="text" formControlName="duracion_tratamiento"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ej: 7 d铆as, 2 semanas, 1 mes">
                <div *ngIf="prescripcionForm.get('duracion_tratamiento')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio
                </div>
              </div>
            </div>


            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad Prescrita</label>
                <input type="text" formControlName="cantidad_prescrita"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Ej: 30 tabletas">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio</label>
                <input type="date" formControlName="fecha_inicio"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                <input type="date" formControlName="fecha_fin"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>


            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Indicaciones Especiales</label>
              <textarea formControlName="indicaciones_especiales" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Instrucciones especiales para el paciente (tomar con agua, evitar alcohol, etc.)"></textarea>
            </div>


            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Contraindicaciones</label>
              <textarea formControlName="contraindicaciones" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Situaciones en las que no debe tomarse este medicamento"></textarea>
            </div>


            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Renovaciones Permitidas</label>
                <input type="number" formControlName="renovaciones_permitidas" min="0" max="10"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="0">
              </div>

              <div class="flex items-center space-x-4 pt-6">
                <label class="flex items-center">
                  <input type="checkbox" formControlName="activo"
                    class="mr-2 rounded border-gray-300 focus:ring-blue-500">
                  <span class="text-sm text-gray-700">Prescripci贸n activa</span>
                </label>
              </div>
            </div>


            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
              <textarea formControlName="observaciones" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Observaciones adicionales sobre la prescripci贸n"></textarea>
            </div>
          </div>


          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!prescripcionForm.valid || isCreatingDocument"
              class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Prescripci贸n' }}
            </button>

            <button type="button" (click)="generarPDF('Prescripci贸n de Medicamentos')"
              [disabled]="!formularioEstado.prescripcionMedicamento"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.prescripcionMedicamento"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.prescripcionMedicamento">Guardar primero</span>
            </button>
          </div>
        </form>

      </div>
    </div>


    <!-- FORMULARIO DE NOTA PREOPERATORIA -->
    <div *ngIf="formularioActivo === 'notaPreoperatoria'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-clipboard-check mr-2 text-orange-500"></i>
          Nota Preoperatoria - NOM-004
        </h3>
        <p class="text-sm text-gray-600 mt-1">Evaluaci贸n previa a cirug铆a seg煤n NOM-004</p>
      </div>

      <form [formGroup]="notaPreoperatoriaForm" class="px-6 py-4">
        <div class="grid grid-cols-1 gap-6">

          <!-- Fecha de Cirug铆a -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de la Cirug铆a *</label>
            <input type="date" formControlName="fecha_cirugia"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div *ngIf="notaPreoperatoriaForm.get('fecha_cirugia')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

          <!-- Diagn贸stico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Diagn贸stico *</label>
            <textarea formControlName="diagnostico" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Diagn贸stico preoperatorio principal..."></textarea>
            <div *ngIf="notaPreoperatoriaForm.get('diagnostico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

          <!-- Plan Quir煤rgico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Plan Quir煤rgico *</label>
            <textarea formControlName="plan_quirurgico" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Descripci贸n del plan quir煤rgico propuesto..."></textarea>
            <div *ngIf="notaPreoperatoriaForm.get('plan_quirurgico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

          <!-- Tipo de Intervenci贸n Quir煤rgica -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Intervenci贸n Quir煤rgica *</label>
            <select formControlName="tipo_intervencion"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione el tipo...</option>
              <option value="Electiva">Electiva</option>
              <option value="Urgente">Urgente</option>
              <option value="Emergencia">Emergencia</option>
              <option value="Programada">Programada</option>
            </select>
            <div *ngIf="notaPreoperatoriaForm.get('tipo_intervencion')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

          <!-- Riesgo Quir煤rgico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Riesgo Quir煤rgico *</label>
            <select formControlName="riesgo_quirurgico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione el riesgo...</option>
              <option value="ASA I">ASA I - Paciente sano</option>
              <option value="ASA II">ASA II - Enfermedad sist茅mica leve</option>
              <option value="ASA III">ASA III - Enfermedad sist茅mica severa</option>
              <option value="ASA IV">ASA IV - Enfermedad sist茅mica que amenaza la vida</option>
              <option value="ASA V">ASA V - Paciente moribundo</option>
              <option value="ASA VI">ASA VI - Muerte cerebral declarada</option>
            </select>
            <div *ngIf="notaPreoperatoriaForm.get('riesgo_quirurgico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

          <!-- Cuidados y Plan Terap茅utico Preoperatorios -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cuidados y Plan Terap茅utico Preoperatorios
              *</label>
            <textarea formControlName="cuidados_preoperatorios" rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Cuidados espec铆ficos, medicaci贸n preoperatoria, preparaci贸n del paciente..."></textarea>
            <div *ngIf="notaPreoperatoriaForm.get('cuidados_preoperatorios')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

          <!-- Pron贸stico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Pron贸stico *</label>
            <select formControlName="pronostico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione el pron贸stico...</option>
              <option value="Excelente">Excelente</option>
              <option value="Bueno">Bueno</option>
              <option value="Regular">Regular</option>
              <option value="Reservado">Reservado</option>
              <option value="Grave">Grave</option>
              <option value="Malo">Malo</option>
            </select>
            <div *ngIf="notaPreoperatoriaForm.get('pronostico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

          <!-- Informaci贸n Adicional -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Comorbilidades</label>
              <textarea formControlName="comorbilidades" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Enfermedades coexistentes relevantes..."></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Estudios Preoperatorios</label>
              <textarea formControlName="estudios_preoperatorios" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Laboratorios, radiograf铆as, ECG realizados..."></textarea>
            </div>
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
            <textarea formControlName="observaciones" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Observaciones adicionales importantes..."></textarea>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" (click)="guardarFormularioActivo()"
            [disabled]="!notaPreoperatoriaForm.valid || isCreatingDocument"
            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
            <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
            <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
            {{ isCreatingDocument ? 'Guardando...' : 'Guardar Nota Preoperatoria' }}
          </button>

          <button type="button" (click)="generarPDF('Nota Preoperatoria')"
            [disabled]="!formularioEstado.notaPreoperatoria"
            class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
            <i class="fas fa-file-pdf mr-2"></i>
            <span *ngIf="formularioEstado.notaPreoperatoria"> Descargar PDF</span>
            <span *ngIf="!formularioEstado.notaPreoperatoria">Guardar primero</span>
          </button>
        </div>
      </form>
    </div>


    <!-- FORMULARIO DE NOTA PREANESTSICA -->
    <div *ngIf="formularioActivo === 'notaPreanestesica'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-syringe mr-2 text-yellow-500"></i>
          Nota Preanest茅sica - NOM-006
        </h3>
        <p class="text-sm text-gray-600 mt-1">Evaluaci贸n anest茅sica preoperatoria seg煤n NOM-006</p>
      </div>

      <form [formGroup]="notaPreanestesicaForm" class="px-6 py-4">
        <div class="grid grid-cols-1 gap-6">

          <!-- Fecha de Cirug铆a -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de la Cirug铆a</label>
            <input type="date" formControlName="fecha_cirugia"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <!-- Antecedentes Anest茅sicos -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Antecedentes Anest茅sicos *</label>
            <textarea formControlName="antecedentes_anestesicos" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Antecedentes de anestesia previa, reacciones adversas, complicaciones..."></textarea>
            <div *ngIf="notaPreanestesicaForm.get('antecedentes_anestesicos')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Valoraci贸n de V铆a A茅rea -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Valoraci贸n de V铆a A茅rea *</label>
            <textarea formControlName="valoracion_via_aerea" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Mallampati, distancia tiromentoniana, movilidad cervical, dentadura..."></textarea>
            <div *ngIf="notaPreanestesicaForm.get('valoracion_via_aerea')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Clasificaci贸n ASA -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Clasificaci贸n ASA *</label>
            <select formControlName="clasificacion_asa"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione clasificaci贸n ASA...</option>
              <option value="ASA I">ASA I - Paciente sano normal</option>
              <option value="ASA II">ASA II - Paciente con enfermedad sist茅mica leve</option>
              <option value="ASA III">ASA III - Paciente con enfermedad sist茅mica severa</option>
              <option value="ASA IV">ASA IV - Paciente con enfermedad sist茅mica severa que amenaza la vida</option>
              <option value="ASA V">ASA V - Paciente moribundo que no se espera sobreviva sin la operaci贸n</option>
              <option value="ASA VI">ASA VI - Paciente con muerte cerebral declarada</option>
            </select>
            <div *ngIf="notaPreanestesicaForm.get('clasificacion_asa')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Plan Anest茅sico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Plan Anest茅sico *</label>
            <select formControlName="plan_anestesico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione tipo de anestesia...</option>
              <option value="General balanceada">General balanceada</option>
              <option value="General intravenosa">General intravenosa</option>
              <option value="General inhalatoria">General inhalatoria</option>
              <option value="Neuroaxial espinal">Neuroaxial espinal</option>
              <option value="Neuroaxial epidural">Neuroaxial epidural</option>
              <option value="Bloqueo regional">Bloqueo regional</option>
              <option value="Sedaci贸n consciente">Sedaci贸n consciente</option>
              <option value="Anestesia local">Anestesia local</option>
              <option value="Combinada">Combinada</option>
            </select>
            <div *ngIf="notaPreanestesicaForm.get('plan_anestesico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Riesgo Anest茅sico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Riesgo Anest茅sico *</label>
            <select formControlName="riesgo_anestesico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione el riesgo...</option>
              <option value="Bajo">Bajo</option>
              <option value="Moderado">Moderado</option>
              <option value="Alto">Alto</option>
              <option value="Muy alto">Muy alto</option>
            </select>
            <div *ngIf="notaPreanestesicaForm.get('riesgo_anestesico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Medicaci贸n Preanest茅sica -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Medicaci贸n Preanest茅sica</label>
            <textarea formControlName="medicacion_preanestesica" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Medicamentos administrados previos a la anestesia..."></textarea>
          </div>

          <!-- Consideraciones Especiales -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Consideraciones Especiales</label>
              <textarea formControlName="consideraciones_especiales" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Alergias, comorbilidades, medicamentos actuales..."></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Estado de Ayuno</label>
              <textarea formControlName="estado_ayuno" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Tiempo de ayuno, 煤ltima ingesta de s贸lidos y l铆quidos..."></textarea>
            </div>
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
            <textarea formControlName="observaciones" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Observaciones adicionales sobre la evaluaci贸n preanest茅sica..."></textarea>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" (click)="guardarFormularioActivo()"
            [disabled]="!notaPreanestesicaForm.valid || isCreatingDocument"
            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
            <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
            <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
            {{ isCreatingDocument ? 'Guardando...' : 'Guardar Nota Preanest茅sica' }}
          </button>

          <button type="button" (click)="generarPDF('Nota Preanest茅sica')"
            [disabled]="!formularioEstado.notaPreanestesica"
            class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
            <i class="fas fa-file-pdf mr-2"></i>
            <span *ngIf="formularioEstado.notaPreanestesica"> Descargar PDF</span>
            <span *ngIf="!formularioEstado.notaPreanestesica">Guardar primero</span>
          </button>
        </div>
      </form>
    </div>





    <!-- FORMULARIO DE NOTA POSTANESTSICA -->
    <div *ngIf="formularioActivo === 'notaPostanestesica'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-heartbeat mr-2 text-teal-500"></i>
          Nota Postanest茅sica - NOM-006
        </h3>
        <p class="text-sm text-gray-600 mt-1">Registro de recuperaci贸n post-anest茅sica seg煤n NOM-006</p>
      </div>

      <form [formGroup]="notaPostanestesicaForm" class="px-6 py-4">
        <div class="grid grid-cols-1 gap-6">

          <!-- Tipo y Duraci贸n de Anestesia -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Anestesia *</label>
              <select formControlName="tipo_anestesia"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione tipo de anestesia...</option>
                <option value="General balanceada">General balanceada</option>
                <option value="General intravenosa">General intravenosa</option>
                <option value="General inhalatoria">General inhalatoria</option>
                <option value="Neuroaxial espinal">Neuroaxial espinal</option>
                <option value="Neuroaxial epidural">Neuroaxial epidural</option>
                <option value="Bloqueo regional">Bloqueo regional</option>
                <option value="Sedaci贸n consciente">Sedaci贸n consciente</option>
                <option value="Anestesia local">Anestesia local</option>
                <option value="Combinada">Combinada</option>
              </select>
              <div *ngIf="notaPostanestesicaForm.get('tipo_anestesia')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Duraci贸n de la Anestesia (minutos)</label>
              <input type="number" formControlName="duracion_anestesia" min="0" step="5"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="120">
            </div>
          </div>

          <!-- Medicamentos Utilizados -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Medicamentos Utilizados *</label>
            <textarea formControlName="medicamentos_utilizados" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Detallar medicamentos anest茅sicos utilizados, dosis y v铆as de administraci贸n..."></textarea>
            <div *ngIf="notaPostanestesicaForm.get('medicamentos_utilizados')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Estado Cl铆nico de Egreso -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Estado Cl铆nico de Egreso *</label>
            <textarea formControlName="estado_clinico_egreso" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Describir el estado del paciente al egreso de la sala de recuperaci贸n..."></textarea>
            <div *ngIf="notaPostanestesicaForm.get('estado_clinico_egreso')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio
            </div>
          </div>

          <!-- Incidentes y Accidentes -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Incidentes y Accidentes Anest茅sicos</label>
            <textarea formControlName="incidentes_accidentes" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Describir cualquier complicaci贸n anest茅sica (escribir 'Ninguno' si no hubo)..."></textarea>
          </div>

          <!-- Balance H铆drico -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">L铆quidos Administrados (ml)</label>
              <input type="number" formControlName="liquidos_administrados" min="0" step="50"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="1000">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Sangrado Estimado (ml)</label>
              <input type="number" formControlName="sangrado" min="0" step="10"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="100">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Diuresis (ml)</label>
              <input type="number" formControlName="diuresis" min="0" step="10"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="200">
            </div>
          </div>

          <!-- Balance H铆drico Detallado -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Balance H铆drico Detallado</label>
            <textarea formControlName="balance_hidrico" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Resumen del balance de l铆quidos durante el procedimiento..."></textarea>
          </div>

          <!-- Hemoderivados -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Hemoderivados Transfundidos</label>
            <textarea formControlName="hemoderivados_transfundidos" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Describir hemoderivados administrados (escribir 'Ninguno' si no se transfundi贸)..."></textarea>
          </div>

          <!-- Signos Vitales de Egreso -->
          <div class="bg-blue-50 rounded-lg p-4">
            <h4 class="font-medium text-blue-900 mb-3">Signos Vitales de Egreso</h4>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Presi贸n Arterial</label>
                <input type="text" formControlName="presion_arterial_egreso"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="120/80">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia Card铆aca</label>
                <input type="number" formControlName="frecuencia_cardiaca_egreso" min="0" max="200"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="72">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Frecuencia Respiratoria</label>
                <input type="number" formControlName="frecuencia_respiratoria_egreso" min="0" max="60"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="16">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Saturaci贸n O2 (%)</label>
                <input type="number" formControlName="saturacion_oxigeno_egreso" min="0" max="100"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="98">
              </div>
            </div>
          </div>

          <!-- Plan de Tratamiento -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Plan de Tratamiento Postanest茅sico</label>
            <textarea formControlName="plan_tratamiento" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Indicaciones para el manejo postanest茅sico del paciente..."></textarea>
          </div>

          <!-- Pron贸stico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Pron贸stico Anest茅sico</label>
            <select formControlName="pronostico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Seleccione el pron贸stico...</option>
              <option value="Excelente">Excelente</option>
              <option value="Bueno">Bueno</option>
              <option value="Regular">Regular</option>
              <option value="Reservado">Reservado</option>
              <option value="Complicado">Complicado</option>
            </select>
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
            <textarea formControlName="observaciones" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Observaciones adicionales sobre la recuperaci贸n anest茅sica..."></textarea>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" (click)="guardarFormularioActivo()"
            [disabled]="!notaPostanestesicaForm.valid || isCreatingDocument"
            class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
            <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
            <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
            {{ isCreatingDocument ? 'Guardando...' : 'Guardar Nota Postanest茅sica' }}
          </button>

          <button type="button" (click)="generarPDF('Nota Postanest茅sica')"
            [disabled]="!formularioEstado.notaPostanestesica"
            class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
            <i class="fas fa-file-pdf mr-2"></i>
            <span *ngIf="formularioEstado.notaPostanestesica"> Descargar PDF</span>
            <span *ngIf="!formularioEstado.notaPostanestesica">Guardar primero</span>
          </button>
        </div>
      </form>
    </div>




    <!-- FORMULARIO DE NOTA POSTOPERATORIA NOM-004 -->
    <div *ngIf="formularioActivo === 'notaPostoperatoria'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-band-aid mr-2 text-indigo-500"></i>
          Nota Postoperatoria - NOM-004 Secci贸n 8.8
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Resumen de la operaci贸n practicada. Debe elaborarla el cirujano que intervino al paciente al t茅rmino de la
          cirug铆a
        </p>
        <div class="mt-2 text-xs text-blue-700 bg-blue-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-info-circle mr-1"></i>
          Todos los campos marcados con (*) son obligatorios seg煤n NOM-004-SSA3-2012
        </div>
      </div>

      <form [formGroup]="notaPostoperatoriaForm" class="px-6 py-4">
        <div class="grid grid-cols-1 gap-6">

          <!-- SECCIN 1: INFORMACIN BSICA DE LA CIRUGA -->
          <div class="bg-blue-50 rounded-lg p-4">
            <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
              <i class="fas fa-calendar-alt mr-2"></i>
              Informaci贸n B谩sica de la Cirug铆a
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Fecha de la Cirug铆a <span class="text-red-500">*</span>
                </label>
                <input type="date" formControlName="fecha_cirugia"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div *ngIf="notaPostoperatoriaForm.get('fecha_cirugia')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Duraci贸n de la Cirug铆a (minutos)
                </label>
                <input type="number" formControlName="duracion_cirugia" min="0" step="15"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="120">
                <p class="text-xs text-gray-500 mt-1">Tiempo total del procedimiento quir煤rgico</p>
              </div>
            </div>
          </div>

          <!-- SECCIN 2: DIAGNSTICOS (NOM-004 8.8.1 y 8.8.4) -->
          <div class="bg-green-50 rounded-lg p-4">
            <h4 class="font-semibold text-green-800 mb-3 flex items-center">
              <i class="fas fa-stethoscope mr-2"></i>
              Diagn贸sticos (NOM-004: 8.8.1 y 8.8.4)
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Diagn贸stico Preoperatorio <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="diagnostico_preoperatorio" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  placeholder="Diagn贸stico establecido antes de la cirug铆a..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('diagnostico_preoperatorio')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.1)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Diagn贸stico Postoperatorio <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="diagnostico_postoperatorio" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                  placeholder="Diagn贸stico confirmado despu茅s de la cirug铆a..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('diagnostico_postoperatorio')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.4)
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIN 3: PROCEDIMIENTOS QUIRRGICOS (NOM-004 8.8.2 y 8.8.3) -->
          <div class="bg-purple-50 rounded-lg p-4">
            <h4 class="font-semibold text-purple-800 mb-3 flex items-center">
              <i class="fas fa-scissors mr-2"></i>
              Procedimientos Quir煤rgicos (NOM-004: 8.8.2 y 8.8.3)
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Operaci贸n Planeada <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="operacion_planeada" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                  placeholder="Procedimiento quir煤rgico programado inicialmente..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('operacion_planeada')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.2)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Operaci贸n Realizada <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="operacion_realizada" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                  placeholder="Procedimiento quir煤rgico efectivamente realizado..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('operacion_realizada')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.3)
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIN 4: DESCRIPCIN TCNICA Y HALLAZGOS (NOM-004 8.8.5 y 8.8.6) -->
          <div class="bg-yellow-50 rounded-lg p-4">
            <h4 class="font-semibold text-yellow-800 mb-3 flex items-center">
              <i class="fas fa-search mr-2"></i>
              T茅cnica Quir煤rgica y Hallazgos (NOM-004: 8.8.5 y 8.8.6)
            </h4>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Descripci贸n de la T茅cnica Quir煤rgica <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="descripcion_tecnica" rows="4"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                  placeholder="Descripci贸n detallada paso a paso de la t茅cnica quir煤rgica empleada, abordajes, instrumentos utilizados..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('descripcion_tecnica')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.5)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Hallazgos Transoperatorios <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="hallazgos_transoperatorios" rows="4"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                  placeholder="Hallazgos anatomopatol贸gicos, adherencias, lesiones encontradas durante la cirug铆a..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('hallazgos_transoperatorios')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.6)
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIN 5: CONTEO Y CONTROL QUIRRGICO (NOM-004 8.8.7) -->
          <div class="bg-red-50 rounded-lg p-4">
            <h4 class="font-semibold text-red-800 mb-3 flex items-center">
              <i class="fas fa-list-ol mr-2"></i>
              Conteo y Control Quir煤rgico (NOM-004: 8.8.7)
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Conteo de Gasas y Compresas <span class="text-red-500">*</span>
                </label>
                <select formControlName="conteo_gasas_completo"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                  <option value="">Seleccione el estado...</option>
                  <option value="true">   Completo y correcto</option>
                  <option value="false"> Incompleto o con discrepancias</option>
                </select>
                <div *ngIf="notaPostoperatoriaForm.get('conteo_gasas_completo')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.7)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Conteo de Instrumental Quir煤rgico <span class="text-red-500">*</span>
                </label>
                <select formControlName="conteo_instrumental_completo"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                  <option value="">Seleccione el estado...</option>
                  <option value="true">   Completo y correcto</option>
                  <option value="false"> Incompleto o con discrepancias</option>
                </select>
                <div *ngIf="notaPostoperatoriaForm.get('conteo_instrumental_completo')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.7)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Observaciones del Conteo
                </label>
                <textarea formControlName="observaciones_conteo" rows="2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                  placeholder="Detalles sobre discrepancias o hallazgos en el conteo..."></textarea>
              </div>
            </div>
          </div>

          <!-- SECCIN 6: INCIDENTES Y SANGRADO (NOM-004 8.8.8 y 8.8.9) -->
          <div class="bg-orange-50 rounded-lg p-4">
            <h4 class="font-semibold text-orange-800 mb-3 flex items-center">
              <i class="fas fa-exclamation-triangle mr-2"></i>
              Incidentes y Sangrado (NOM-004: 8.8.8 y 8.8.9)
            </h4>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Incidentes y Accidentes <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="incidentes_accidentes" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                  placeholder="Describir cualquier incidente, accidente o complicaci贸n durante la cirug铆a. Si no hubo, escribir 'Ninguno'"></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('incidentes_accidentes')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.8)
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Cuantificaci贸n de Sangrado (ml) <span class="text-red-500">*</span>
                  </label>
                  <input type="number" formControlName="sangrado" min="0" step="10"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                    placeholder="0">
                  <div *ngIf="notaPostoperatoriaForm.get('sangrado')?.errors?.['required']"
                    class="text-red-500 text-xs mt-1">
                    Campo obligatorio seg煤n NOM-004 (8.8.9)
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Transfusiones Realizadas
                  </label>
                  <select formControlName="transfusiones_realizadas"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="false">No se realizaron transfusiones</option>
                    <option value="true">S铆 se realizaron transfusiones</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Detalles de Transfusiones
                  </label>
                  <textarea formControlName="detalles_transfusiones" rows="2"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                    placeholder="Tipo, cantidad y detalles de hemoderivados..."></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIN 7: ESTUDIOS TRANSOPERATORIOS (NOM-004 8.8.10) -->
          <div class="bg-teal-50 rounded-lg p-4">
            <h4 class="font-semibold text-teal-800 mb-3 flex items-center">
              <i class="fas fa-microscope mr-2"></i>
              Estudios Transoperatorios (NOM-004: 8.8.10)
            </h4>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Estudios de Servicios Auxiliares Transoperatorios <span class="text-red-500">*</span>
              </label>
              <textarea formControlName="estudios_transoperatorios" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500"
                placeholder="Estudios realizados durante la cirug铆a: patolog铆a r谩pida, radiograf铆as intraoperatorias, etc. Si no se realizaron, escribir 'Ninguno'"></textarea>
              <div *ngIf="notaPostoperatoriaForm.get('estudios_transoperatorios')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004 (8.8.10)
              </div>
            </div>
          </div>

          <!-- SECCIN 8: EQUIPO QUIRRGICO (NOM-004 8.8.11) -->
          <div class="bg-indigo-50 rounded-lg p-4">
            <h4 class="font-semibold text-indigo-800 mb-3 flex items-center">
              <i class="fas fa-users mr-2"></i>
              Equipo Quir煤rgico (NOM-004: 8.8.11)
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Cirujano Principal <span class="text-red-500">*</span>
                </label>
                <input type="text" formControlName="cirujano_principal"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Nombre completo del cirujano principal">
                <div *ngIf="notaPostoperatoriaForm.get('cirujano_principal')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.11)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Ayudantes <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="ayudantes" rows="2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Nombres de los cirujanos ayudantes..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('ayudantes')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.11)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Instrumentista <span class="text-red-500">*</span>
                </label>
                <input type="text" formControlName="instrumentista"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Nombre del instrumentista">
                <div *ngIf="notaPostoperatoriaForm.get('instrumentista')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.11)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Anestesi贸logo <span class="text-red-500">*</span>
                </label>
                <input type="text" formControlName="anestesiologo"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Nombre del anestesi贸logo">
                <div *ngIf="notaPostoperatoriaForm.get('anestesiologo')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.11)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Circulante <span class="text-red-500">*</span>
                </label>
                <input type="text" formControlName="circulante"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="Nombre del circulante">
                <div *ngIf="notaPostoperatoriaForm.get('circulante')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.11)
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIN 9: ESTADO Y PLAN POSTQUIRRGICO (NOM-004 8.8.12 y 8.8.13) -->
          <div class="bg-cyan-50 rounded-lg p-4">
            <h4 class="font-semibold text-cyan-800 mb-3 flex items-center">
              <i class="fas fa-clipboard-list mr-2"></i>
              Estado y Plan Postquir煤rgico (NOM-004: 8.8.12 y 8.8.13)
            </h4>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Estado Post-quir煤rgico Inmediato <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="estado_postquirurgico" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                  placeholder="Estado del paciente al finalizar la cirug铆a: estable, signos vitales, estado de conciencia..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('estado_postquirurgico')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.12)
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Plan de Manejo y Tratamiento Postoperatorio Inmediato <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="plan_postoperatorio" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500"
                  placeholder="Indicaciones inmediatas: medicamentos, cuidados, dieta, movilizaci贸n..."></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('plan_postoperatorio')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.13)
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIN 10: PRONSTICO (NOM-004 8.8.14) -->
          <div class="bg-emerald-50 rounded-lg p-4">
            <h4 class="font-semibold text-emerald-800 mb-3 flex items-center">
              <i class="fas fa-chart-line mr-2"></i>
              Pron贸stico (NOM-004: 8.8.14)
            </h4>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Pron贸stico <span class="text-red-500">*</span>
              </label>
              <select formControlName="pronostico"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <option value="">Seleccione el pron贸stico...</option>
                <option value="Excelente">Excelente</option>
                <option value="Bueno">Bueno</option>
                <option value="Regular">Regular</option>
                <option value="Reservado">Reservado</option>
                <option value="Grave">Grave</option>
                <option value="Malo">Malo</option>
              </select>
              <div *ngIf="notaPostoperatoriaForm.get('pronostico')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004 (8.8.14)
              </div>
            </div>
          </div>

          <!-- SECCIN 11: ENVO DE PIEZAS (NOM-004 8.8.15) -->
          <div class="bg-pink-50 rounded-lg p-4">
            <h4 class="font-semibold text-pink-800 mb-3 flex items-center">
              <i class="fas fa-flask mr-2"></i>
              Env铆o de Piezas Quir煤rgicas (NOM-004: 8.8.15)
            </h4>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Env铆o de Piezas o Biopsias Quir煤rgicas <span class="text-red-500">*</span>
                </label>
                <textarea formControlName="piezas_enviadas_patologia" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500"
                  placeholder="Describir piezas enviadas para examen macrosc贸pico e histopatol贸gico. Si no se enviaron, escribir 'No se enviaron piezas'"></textarea>
                <div *ngIf="notaPostoperatoriaForm.get('piezas_enviadas_patologia')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004 (8.8.15)
                </div>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    驴Se enviaron piezas a patolog铆a?
                  </label>
                  <select formControlName="se_enviaron_piezas"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500">
                    <option value="false">No se enviaron piezas</option>
                    <option value="true">S铆 se enviaron piezas</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    N煤mero de Registro de Patolog铆a
                  </label>
                  <input type="text" formControlName="numero_registro_patologia"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500"
                    placeholder="N煤mero de folio asignado por patolog铆a">
                </div>
              </div>
            </div>
          </div>

          <!-- SECCIN 12: OTROS HALLAZGOS (NOM-004 8.8.16) -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
              <i class="fas fa-plus-circle mr-2"></i>
              Otros Hallazgos de Importancia (NOM-004: 8.8.16)
            </h4>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Otros Hallazgos de Importancia para el Paciente <span class="text-red-500">*</span>
              </label>
              <textarea formControlName="otros_hallazgos" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                placeholder="Otros hallazgos importantes relacionados con el quehacer m茅dico. Si no hay hallazgos adicionales, escribir 'Sin otros hallazgos relevantes'"></textarea>
              <div *ngIf="notaPostoperatoriaForm.get('otros_hallazgos')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004 (8.8.16)
              </div>
            </div>

            <!-- SECCIN 13: FIRMAS Y RESPONSABILIDAD (NOM-004 8.8.17) -->
            <div class="bg-slate-50 rounded-lg p-4">
              <h4 class="font-semibold text-slate-800 mb-3 flex items-center">
                <i class="fas fa-signature mr-2"></i>
                Responsabilidad M茅dica (NOM-004: 8.8.17)
              </h4>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Nombre Completo del Responsable de la Cirug铆a <span class="text-red-500">*</span>
                  </label>
                  <input type="text" formControlName="nombre_responsable_cirugia"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500"
                    placeholder="Nombre completo del cirujano responsable">
                  <div *ngIf="notaPostoperatoriaForm.get('nombre_responsable_cirugia')?.errors?.['required']"
                    class="text-red-500 text-xs mt-1">
                    Campo obligatorio seg煤n NOM-004 (8.8.17)
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    C茅dula Profesional del Responsable
                  </label>
                  <input type="text" formControlName="cedula_responsable_cirugia"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500"
                    placeholder="N煤mero de c茅dula profesional">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Especialidad del Responsable
                  </label>
                  <input type="text" formControlName="especialidad_responsable"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500"
                    placeholder="Especialidad m茅dica">
                </div>

                <div class="flex items-center pt-6">
                  <label class="flex items-center">
                    <input type="checkbox" formControlName="firma_responsable_verificada"
                      class="mr-2 rounded border-gray-300 focus:ring-slate-500">
                    <span class="text-sm text-gray-700">
                      Confirmo que soy el cirujano responsable de esta operaci贸n
                    </span>
                  </label>
                </div>
              </div>

            </div>

            <!-- SECCIN 14: INFORMACIN ADICIONAL -->
            <div class="bg-blue-50 rounded-lg p-4">
              <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                <i class="fas fa-info mr-2"></i>
                Informaci贸n Adicional
              </h4>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Quir贸fano Utilizado
                  </label>
                  <input type="text" formControlName="quirofano"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ej: Quir贸fano 1, Sala A">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Tipo de Anestesia Utilizada
                  </label>
                  <select formControlName="tipo_anestesia"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Seleccione tipo de anestesia...</option>
                    <option value="General">General</option>
                    <option value="Regional">Regional</option>
                    <option value="Local">Local</option>
                    <option value="Sedaci贸n">Sedaci贸n</option>
                    <option value="Combinada">Combinada</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Hora de Inicio de la Cirug铆a
                  </label>
                  <input type="time" formControlName="hora_inicio"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">
                    Hora de Finalizaci贸n de la Cirug铆a
                  </label>
                  <input type="time" formControlName="hora_fin"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>

              <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Observaciones Adicionales
                </label>
                <textarea formControlName="observaciones_adicionales" rows="3"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Cualquier observaci贸n adicional relevante sobre la cirug铆a..."></textarea>
              </div>
            </div>

          </div>

          <!-- SECCIN DE BOTONES DE ACCIN -->
          <div class="mt-8 border-t border-gray-200 pt-6">
            <div class="flex flex-col sm:flex-row gap-3">

              <!-- Bot贸n Guardar -->
              <button type="button" (click)="guardarFormularioActivo()"
                [disabled]="!notaPostoperatoriaForm.valid || isCreatingDocument"
                class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center">
                <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
                <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
                {{ isCreatingDocument ? 'Guardando Nota...' : 'Guardar Nota Postoperatoria' }}
              </button>

              <!-- Bot贸n Generar PDF -->
              <button type="button" (click)="generarPDF('Nota Postoperatoria')"
                [disabled]="!formularioEstado.notaPostoperatoria"
                class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300 transition-colors flex items-center justify-center">
                <i class="fas fa-file-pdf mr-2"></i>
                <span *ngIf="formularioEstado.notaPostoperatoria"> Descargar PDF</span>
                <span *ngIf="!formularioEstado.notaPostoperatoria">Guardar primero</span>
              </button>

              <!-- Bot贸n Limpiar -->
              <button type="button" (click)="limpiarFormulario('notaPostoperatoria')"
                class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center">
                <i class="fas fa-broom mr-2"></i>
                Limpiar Formulario
              </button>

            </div>

            <!-- Informaci贸n de Estado del Formulario -->
            <div class="mt-4">
              <div *ngIf="formularioEstado.notaPostoperatoria"
                class="bg-green-50 border border-green-200 rounded-lg p-3">
                <div class="flex items-center">
                  <i class="fas fa-check-circle text-green-500 mr-2"></i>
                  <span class="text-green-800 text-sm font-medium">
                       Nota postoperatoria guardada exitosamente y cumple con NOM-004-SSA3-2012
                  </span>
                </div>
              </div>

              <!-- Mensajes de Validaci贸n -->
              <div *ngIf="notaPostoperatoriaForm.errors && notaPostoperatoriaForm.touched"
                class="bg-red-50 border border-red-200 rounded-lg p-3 mt-3">
                <div class="flex items-start">
                  <i class="fas fa-exclamation-triangle text-red-500 mr-2 mt-0.5"></i>
                  <div class="text-red-800 text-sm">
                    <p class="font-medium">Por favor corrige los siguientes errores:</p>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                      <li *ngIf="notaPostoperatoriaForm.get('diagnostico_preoperatorio')?.hasError('required')">
                        Diagn贸stico preoperatorio es obligatorio (NOM-004: 8.8.1)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('operacion_planeada')?.hasError('required')">
                        Operaci贸n planeada es obligatoria (NOM-004: 8.8.2)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('operacion_realizada')?.hasError('required')">
                        Operaci贸n realizada es obligatoria (NOM-004: 8.8.3)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('diagnostico_postoperatorio')?.hasError('required')">
                        Diagn贸stico postoperatorio es obligatorio (NOM-004: 8.8.4)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('descripcion_tecnica')?.hasError('required')">
                        Descripci贸n de t茅cnica quir煤rgica es obligatoria (NOM-004: 8.8.5)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('hallazgos_transoperatorios')?.hasError('required')">
                        Hallazgos transoperatorios son obligatorios (NOM-004: 8.8.6)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('conteo_gasas_completo')?.hasError('required')">
                        Reporte de conteo de gasas es obligatorio (NOM-004: 8.8.7)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('incidentes_accidentes')?.hasError('required')">
                        Reporte de incidentes y accidentes es obligatorio (NOM-004: 8.8.8)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('sangrado')?.hasError('required')">
                        Cuantificaci贸n de sangrado es obligatoria (NOM-004: 8.8.9)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('estudios_transoperatorios')?.hasError('required')">
                        Estudios transoperatorios son obligatorios (NOM-004: 8.8.10)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('ayudantes')?.hasError('required')">
                        Nombres de ayudantes son obligatorios (NOM-004: 8.8.11)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('estado_postquirurgico')?.hasError('required')">
                        Estado post-quir煤rgico inmediato es obligatorio (NOM-004: 8.8.12)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('plan_postoperatorio')?.hasError('required')">
                        Plan de manejo postoperatorio es obligatorio (NOM-004: 8.8.13)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('pronostico')?.hasError('required')">
                        Pron贸stico es obligatorio (NOM-004: 8.8.14)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('piezas_enviadas_patologia')?.hasError('required')">
                        Env铆o de piezas quir煤rgicas es obligatorio (NOM-004: 8.8.15)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('otros_hallazgos')?.hasError('required')">
                        Otros hallazgos de importancia son obligatorios (NOM-004: 8.8.16)
                      </li>
                      <li *ngIf="notaPostoperatoriaForm.get('nombre_responsable_cirugia')?.hasError('required')">
                        Nombre del responsable de la cirug铆a es obligatorio (NOM-004: 8.8.17)
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Informaci贸n sobre Cumplimiento de NOM-004 -->
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
                <div class="flex items-start">
                  <i class="fas fa-info-circle text-blue-500 mr-2 mt-0.5"></i>
                  <div class="text-blue-800 text-sm">
                    <p class="font-medium"> Cumplimiento NOM-004-SSA3-2012 - Secci贸n 8.8</p>
                    <p class="mt-1">
                      Esta nota postoperatoria cumple con todos los requisitos establecidos en la
                      Norma Oficial Mexicana NOM-004-SSA3-2012, Del expediente cl铆nico.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>


    <!-- FORMULARIO DE SOLICITUD DE CULTIVO -->
    <div *ngIf="formularioActivo === 'solicitudCultivo'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-microscope mr-2 text-green-500"></i>
          Solicitud de Cultivo - NOM-004 Secci贸n 9.2
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Solicitud de estudio microbiol贸gico para identificaci贸n de agentes pat贸genos
        </p>
        <div class="mt-2 text-xs text-blue-700 bg-blue-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-info-circle mr-1"></i>
          Campos obligatorios seg煤n NOM-004-SSA3-2012 para servicios auxiliares de diagn贸stico
        </div>
      </div>

      <form [formGroup]="solicitudCultivoForm" class="px-6 py-4">
        <div class="space-y-6">

          <!-- Informaci贸n del Estudio -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cultivo *</label>
              <select formControlName="tipo_cultivo"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione el tipo de cultivo...</option>
                <option value="Urocultivo">Urocultivo</option>
                <option value="Hemocultivo">Hemocultivo</option>
                <option value="Coprocultivo">Coprocultivo</option>
                <option value="Cultivo de expectoraci贸n">Cultivo de expectoraci贸n</option>
                <option value="Cultivo de herida">Cultivo de herida</option>
                <option value="Cultivo de l铆quido cefalorraqu铆deo">Cultivo de l铆quido cefalorraqu铆deo</option>
                <option value="Cultivo vaginal">Cultivo vaginal</option>
                <option value="Cultivo far铆ngeo">Cultivo far铆ngeo</option>
                <option value="Otro">Otro</option>
              </select>
              <div *ngIf="solicitudCultivoForm.get('tipo_cultivo')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Muestra Requerida *</label>
              <input type="text" formControlName="muestra_requerida"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Especifique el tipo de muestra...">
              <div *ngIf="solicitudCultivoForm.get('muestra_requerida')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004
              </div>
            </div>
          </div>

          <!-- Informaci贸n Cl铆nica -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Informaci贸n Cl铆nica Relevante *</label>
            <textarea formControlName="informacion_clinica" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="S铆ntomas, signos cl铆nicos, sospecha diagn贸stica..."></textarea>
            <div *ngIf="solicitudCultivoForm.get('informacion_clinica')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

          <!-- Sospecha Diagn贸stica y Prioridad -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Sospecha Diagn贸stica</label>
              <input type="text" formControlName="sospecha_diagnostica"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Diagn贸stico presuntivo...">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Prioridad *</label>
              <select formControlName="prioridad"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Normal">Normal</option>
                <option value="Urgente">Urgente</option>
                <option value="Stat">Stat (inmediato)</option>
              </select>
            </div>
          </div>

          <!-- Instrucciones de Toma -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Instrucciones para la Toma de Muestra</label>
            <textarea formControlName="instrucciones_toma" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Condiciones de ayuno, asepsia, momento de toma, etc."></textarea>
          </div>

          <!-- Antibi贸ticos -->
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div class="flex items-center mb-3">
              <i class="fas fa-pills text-yellow-600 mr-2"></i>
              <h4 class="text-sm font-semibold text-yellow-800">Uso de Antibi贸ticos</h4>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="flex items-center text-sm">
                  <input type="checkbox" formControlName="antibioticos_previos" class="mr-2">
                  <span>Paciente con antibi贸ticos previos</span>
                </label>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Antibi贸tico Utilizado</label>
                <input type="text" formControlName="antibiotico_usado"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre del antibi贸tico...">
              </div>
            </div>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div class="flex justify-end space-x-3">
            <button type="button" (click)="limpiarFormulario('solicitudCultivo')"
              class="px-6 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
              <i class="fas fa-eraser mr-2"></i>
              Limpiar
            </button>

            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!solicitudCultivoForm.valid || isCreatingDocument"
              class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Solicitud' }}
            </button>

            <button type="button" (click)="generarPDF('Solicitud de Cultivo')"
              [disabled]="!formularioEstado.solicitudCultivo"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.solicitudCultivo"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.solicitudCultivo">Guardar primero</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- FORMULARIO DE SOLICITUD DE GASOMETRA -->
    <div *ngIf="formularioActivo === 'solicitudGasometria'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-lungs mr-2 text-teal-500"></i>
          Solicitud de Gasometr铆a - NOM-004 Secci贸n 9.2
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Solicitud de an谩lisis de gases arteriales para evaluaci贸n del estado 谩cido-base
        </p>
        <div class="mt-2 text-xs text-blue-700 bg-blue-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-info-circle mr-1"></i>
          Campos obligatorios seg煤n NOM-004-SSA3-2012 para servicios auxiliares de diagn贸stico
        </div>
      </div>

      <form [formGroup]="solicitudGasometriaForm" class="px-6 py-4">
        <div class="space-y-6">

          <!-- Tipo de Gasometr铆a -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Gasometr铆a *</label>
              <select formControlName="tipo_gasometria"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione el tipo...</option>
                <option value="Arterial">Gasometr铆a Arterial</option>
                <option value="Venosa">Gasometr铆a Venosa</option>
                <option value="Capilar">Gasometr铆a Capilar</option>
              </select>
              <div *ngIf="solicitudGasometriaForm.get('tipo_gasometria')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Sitio de Punci贸n *</label>
              <select formControlName="sitio_puncion"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione el sitio...</option>
                <option value="Arteria radial">Arteria radial</option>
                <option value="Arteria braquial">Arteria braquial</option>
                <option value="Arteria femoral">Arteria femoral</option>
                <option value="Vena perif茅rica">Vena perif茅rica</option>
                <option value="L铆nea arterial">L铆nea arterial</option>
                <option value="Capilar">Capilar (tal贸n/dedo)</option>
              </select>
              <div *ngIf="solicitudGasometriaForm.get('sitio_puncion')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004
              </div>
            </div>
          </div>

          <!-- Condiciones del Paciente -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-blue-800 mb-3">
              <i class="fas fa-user-injured mr-2"></i>
              Condiciones del Paciente
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Temperatura Corporal (掳C)</label>
                <input type="number" step="0.1" min="30" max="45" formControlName="temperatura_corporal"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="36.5">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FiO2 (%)</label>
                <input type="number" min="21" max="100" formControlName="fio2"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="21">
              </div>
            </div>
          </div>

          <!-- Soporte Ventilatorio -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Soporte Ventilatorio</label>
              <select formControlName="soporte_ventilatorio"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Aire ambiente">Aire ambiente</option>
                <option value="Ox铆geno suplementario">Ox铆geno suplementario</option>
                <option value="Ventilaci贸n mec谩nica">Ventilaci贸n mec谩nica</option>
                <option value="CPAP">CPAP</option>
                <option value="BiPAP">BiPAP</option>
                <option value="C谩nula nasal de alto flujo">C谩nula nasal de alto flujo</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Prioridad *</label>
              <select formControlName="prioridad"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Normal">Normal</option>
                <option value="Urgente">Urgente</option>
                <option value="Stat">Stat (inmediato)</option>
              </select>
            </div>
          </div>

          <!-- Informaci贸n Cl铆nica -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Informaci贸n Cl铆nica Relevante *</label>
            <textarea formControlName="informacion_clinica" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Estado respiratorio, sospecha diagn贸stica, alteraciones 谩cido-base..."></textarea>
            <div *ngIf="solicitudGasometriaForm.get('informacion_clinica')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

          <!-- Sospecha Diagn贸stica -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Sospecha Diagn贸stica</label>
            <input type="text" formControlName="sospecha_diagnostica"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Insuficiencia respiratoria, acidosis metab贸lica, etc.">
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
            <textarea formControlName="observaciones" rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Observaciones adicionales..."></textarea>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div class="flex justify-end space-x-3">
            <button type="button" (click)="limpiarFormulario('solicitudGasometria')"
              class="px-6 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
              <i class="fas fa-eraser mr-2"></i>
              Limpiar
            </button>

            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!solicitudGasometriaForm.valid || isCreatingDocument"
              class="bg-teal-600 hover:bg-teal-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Solicitud' }}
            </button>

            <button type="button" (click)="generarPDF('Solicitud de Gasometr铆a')"
              [disabled]="!formularioEstado.solicitudGasometria"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.solicitudGasometria"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.solicitudGasometria">Guardar primero</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- FORMULARIO DE REGISTRO DE TRANSFUSIN -->
    <div *ngIf="formularioActivo === 'registroTransfusion'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-tint mr-2 text-red-500"></i>
          Registro de Transfusi贸n - NOM-003-SSA2-1993 y NOM-004 Secci贸n D15
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Registro obligatorio de transfusi贸n de sangre o sus componentes seg煤n normatividad vigente
        </p>
        <div class="mt-2 text-xs text-blue-700 bg-blue-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-info-circle mr-1"></i>
          Campos obligatorios seg煤n NOM-003-SSA2-1993 y NOM-004-SSA3-2012
        </div>
      </div>

      <form [formGroup]="registroTransfusionForm" class="px-6 py-4">
        <div class="space-y-6">

          <!-- Informaci贸n del Componente -->
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-red-800 mb-3">
              <i class="fas fa-flask mr-2"></i>
              Informaci贸n del Componente Sangu铆neo
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Componente *</label>
                <select formControlName="tipo_componente"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione el componente...</option>
                  <option value="Sangre total">Sangre total</option>
                  <option value="Concentrado eritrocitario">Concentrado eritrocitario</option>
                  <option value="Plasma fresco congelado">Plasma fresco congelado</option>
                  <option value="Concentrado plaquetario">Concentrado plaquetario</option>
                  <option value="Crioprecipitado">Crioprecipitado</option>
                  <option value="Alb煤mina">Alb煤mina</option>
                  <option value="Inmunoglobulina">Inmunoglobulina</option>
                </select>
                <div *ngIf="registroTransfusionForm.get('tipo_componente')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-003-SSA2-1993
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">N煤mero de Unidad *</label>
                <input type="text" formControlName="numero_unidad"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="N煤mero de identificaci贸n de la unidad">
                <div *ngIf="registroTransfusionForm.get('numero_unidad')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-003-SSA2-1993
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Volumen (mL) *</label>
                <input type="number" min="50" max="2000" formControlName="volumen"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="250">
                <div *ngIf="registroTransfusionForm.get('volumen')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-003-SSA2-1993
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Grupo Sangu铆neo *</label>
                <select formControlName="grupo_sanguineo"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione grupo sangu铆neo...</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                </select>
                <div *ngIf="registroTransfusionForm.get('grupo_sanguineo')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-003-SSA2-1993
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Banco de Sangre *</label>
                <input type="text" formControlName="banco_sangre"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre del banco de sangre">
              </div>
            </div>
          </div>

          <!-- Fechas y Horarios -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora de Inicio *</label>
              <input type="datetime-local" formControlName="fecha_hora_inicio"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div *ngIf="registroTransfusionForm.get('fecha_hora_inicio')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora de Finalizaci贸n</label>
              <input type="datetime-local" formControlName="fecha_hora_fin"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>

          <!-- Signos Vitales -->
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-yellow-800 mb-3">
              <i class="fas fa-heartbeat mr-2"></i>
              Control de Signos Vitales (Antes, Durante y Despu茅s)
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Presi贸n Arterial Inicial</label>
                <input type="text" formControlName="presion_arterial_inicial"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="120/80">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Temperatura Inicial (掳C)</label>
                <input type="number" step="0.1" min="30" max="45" formControlName="temperatura_inicial"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="36.5">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Pulso Inicial (lpm)</label>
                <input type="number" min="40" max="200" formControlName="pulso_inicial"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="72">
              </div>
            </div>
          </div>

          <!-- M茅dico Responsable -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">M茅dico que Indica la Transfusi贸n *</label>
            <input type="text" formControlName="medico_responsable"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Dr. Juan P茅rez Garc铆a"
              [value]="pacienteCompleto?.persona?.['nombre_completo'] || 'Dr. ' + (pacienteCompleto?.persona?.nombre || '')">
            <div *ngIf="registroTransfusionForm.get('medico_responsable')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

          <!-- Reacciones Adversas -->
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
            <div class="flex items-center mb-3">
              <input type="checkbox" formControlName="presenta_reacciones" class="mr-2">
              <label class="text-sm font-semibold text-orange-800">
                El paciente present贸 reacciones adversas durante la transfusi贸n
              </label>
            </div>
            <div *ngIf="registroTransfusionForm.get('presenta_reacciones')?.value">
              <label class="block text-sm font-medium text-gray-700 mb-1">Descripci贸n de Reacciones Adversas</label>
              <textarea formControlName="reacciones_adversas" rows="3"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Descripci贸n detallada de las reacciones presentadas..."></textarea>
            </div>
          </div>

          <!-- Observaciones -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
            <textarea formControlName="observaciones" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Observaciones adicionales sobre el procedimiento..."></textarea>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div class="flex justify-end space-x-3">
            <button type="button" (click)="limpiarFormulario('registroTransfusion')"
              class="px-6 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
              <i class="fas fa-eraser mr-2"></i>
              Limpiar
            </button>

            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!registroTransfusionForm.valid || isCreatingDocument"
              class="bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Registro' }}
            </button>

            <button type="button" (click)="generarPDF('Registro de Transfusi贸n')"
              [disabled]="!formularioEstado.registroTransfusion"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.registroTransfusion"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.registroTransfusion">Guardar primero</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- FORMULARIO DE ALTA VOLUNTARIA -->
    <div *ngIf="formularioActivo === 'altaVoluntaria'" class="bg-white shadow rounded-lg mb-6">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
          <i class="fas fa-sign-out-alt mr-2 text-orange-500"></i>
          Hoja de Egreso Voluntario - NOM-004 Secci贸n 10.2
        </h3>
        <p class="text-sm text-gray-600 mt-1">
          Documento mediante el cual el paciente solicita el egreso voluntario con conocimiento de las consecuencias
        </p>
        <div class="mt-2 text-xs text-blue-700 bg-blue-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-info-circle mr-1"></i>
          Campos obligatorios seg煤n NOM-004-SSA3-2012 Secci贸n 10.2
        </div>
        <div class="mt-2 text-xs text-red-700 bg-red-50 rounded px-2 py-1 inline-block">
          <i class="fas fa-exclamation-triangle mr-1"></i>
          Este documento exime de responsabilidad al establecimiento y al m茅dico tratante
        </div>
      </div>

      <form [formGroup]="altaVoluntariaForm" class="px-6 py-4">
        <div class="space-y-6">

          <!-- Informaci贸n del Egreso -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Egreso *</label>
              <input type="date" formControlName="fecha_egreso"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div *ngIf="altaVoluntariaForm.get('fecha_egreso')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Hora de Egreso *</label>
              <input type="time" formControlName="hora_egreso"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div *ngIf="altaVoluntariaForm.get('hora_egreso')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004
              </div>
            </div>
          </div>

          <!-- Persona que Solicita -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-blue-800 mb-3">
              <i class="fas fa-user mr-2"></i>
              Persona que Solicita el Egreso
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                <input type="text" formControlName="nombre_solicitante"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre completo de quien solicita">
                <div *ngIf="altaVoluntariaForm.get('nombre_solicitante')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Parentesco con el Paciente *</label>
                <select formControlName="parentesco"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione parentesco...</option>
                  <option value="Paciente">El mismo paciente</option>
                  <option value="Padre">Padre</option>
                  <option value="Madre">Madre</option>
                  <option value="Esposo(a)">Esposo(a)</option>
                  <option value="Hijo(a)">Hijo(a)</option>
                  <option value="Hermano(a)">Hermano(a)</option>
                  <option value="Tutor">Tutor legal</option>
                  <option value="Representante legal">Representante legal</option>
                  <option value="Otro">Otro</option>
                </select>
                <div *ngIf="altaVoluntariaForm.get('parentesco')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004
                </div>
              </div>
            </div>

            <div class="mt-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Edad del Solicitante *</label>
              <input type="number" min="18" max="120" formControlName="edad_solicitante"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Edad en a帽os">
              <div *ngIf="altaVoluntariaForm.get('edad_solicitante')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004
              </div>
            </div>
          </div>

          <!-- Resumen Cl铆nico -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Resumen Cl铆nico *</label>
            <textarea formControlName="resumen_clinico" rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Motivo de ingreso, diagn贸stico actual, tratamiento proporcionado..."></textarea>
            <div *ngIf="altaVoluntariaForm.get('resumen_clinico')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004 Secci贸n 6.4.3
            </div>
            <p class="text-xs text-gray-500 mt-1">Debe incluir: motivo de env铆o, impresi贸n diagn贸stica y terap茅utica
              empleada</p>
          </div>

          <!-- Motivo del Egreso Voluntario -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Motivo del Egreso Voluntario</label>
            <textarea formControlName="motivo_egreso" rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Raz贸n por la cual se solicita el egreso voluntario..."></textarea>
          </div>

          <!-- Recomendaciones M茅dicas -->
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-yellow-800 mb-3">
              <i class="fas fa-stethoscope mr-2"></i>
              Medidas Recomendadas para la Protecci贸n de la Salud
            </h4>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Recomendaciones M茅dicas *</label>
              <textarea formControlName="recomendaciones_medicas" rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Cuidados espec铆ficos, medicamentos, signos de alarma, cu谩ndo acudir a urgencias..."></textarea>
              <div *ngIf="altaVoluntariaForm.get('recomendaciones_medicas')?.errors?.['required']"
                class="text-red-500 text-xs mt-1">
                Campo obligatorio seg煤n NOM-004
              </div>
            </div>

            <div class="mt-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Atenci贸n de Factores de Riesgo</label>
              <textarea formControlName="factores_riesgo" rows="2"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Factores de riesgo a vigilar y controlar..."></textarea>
            </div>
          </div>

          <!-- Continuidad del Tratamiento -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="flex items-center text-sm">
                <input type="checkbox" formControlName="continua_tratamiento_externo" class="mr-2">
                <span>Continuar谩 tratamiento en otro establecimiento</span>
              </label>
            </div>
            <div *ngIf="altaVoluntariaForm.get('continua_tratamiento_externo')?.value">
              <label class="block text-sm font-medium text-gray-700 mb-1">Establecimiento de Destino</label>
              <input type="text" formControlName="establecimiento_destino"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Nombre del establecimiento donde continuar谩 tratamiento">
            </div>
          </div>

          <!-- Testigos -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <h4 class="text-sm font-semibold text-gray-800 mb-3">
              <i class="fas fa-users mr-2"></i>
              Testigos (2 requeridos)
            </h4>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Primer Testigo *</label>
                <input type="text" formControlName="testigo1_nombre"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre completo del primer testigo">
                <div *ngIf="altaVoluntariaForm.get('testigo1_nombre')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Segundo Testigo *</label>
                <input type="text" formControlName="testigo2_nombre"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="Nombre completo del segundo testigo">
                <div *ngIf="altaVoluntariaForm.get('testigo2_nombre')?.errors?.['required']"
                  class="text-red-500 text-xs mt-1">
                  Campo obligatorio seg煤n NOM-004
                </div>
              </div>
            </div>
          </div>

          <!-- M茅dico que Autoriza -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">M茅dico que Emite la Hoja *</label>
            <input type="text" formControlName="medico_autoriza"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Dr. Juan P茅rez Garc铆a"
              [value]="pacienteCompleto?.persona?.['nombre_completo'] || 'Dr. ' + (pacienteCompleto?.persona?.nombre || '')">
            <div *ngIf="altaVoluntariaForm.get('medico_autoriza')?.errors?.['required']"
              class="text-red-500 text-xs mt-1">
              Campo obligatorio seg煤n NOM-004
            </div>
          </div>

        </div>

        <!-- Botones -->
        <div class="mt-8 border-t border-gray-200 pt-6">
          <div class="flex justify-end space-x-3">
            <button type="button" (click)="limpiarFormulario('altaVoluntaria')"
              class="px-6 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors">
              <i class="fas fa-eraser mr-2"></i>
              Limpiar
            </button>

            <button type="button" (click)="guardarFormularioActivo()"
              [disabled]="!altaVoluntariaForm.valid || isCreatingDocument"
              class="bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white font-bold py-2 px-6 rounded transition-colors">
              <i *ngIf="isCreatingDocument" class="fas fa-spinner fa-spin mr-2"></i>
              <i *ngIf="!isCreatingDocument" class="fas fa-save mr-2"></i>
              {{ isCreatingDocument ? 'Guardando...' : 'Guardar Hoja de Egreso' }}
            </button>

            <button type="button" (click)="generarPDF('Hoja de Egreso Voluntario')"
              [disabled]="!formularioEstado.altaVoluntaria"
              class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-300 transition-colors">
              <i class="fas fa-file-pdf mr-2"></i>
              <span *ngIf="formularioEstado.altaVoluntaria"> Descargar PDF</span>
              <span *ngIf="!formularioEstado.altaVoluntaria">Guardar primero</span>
            </button>
          </div>
        </div>
      </form>
    </div>

